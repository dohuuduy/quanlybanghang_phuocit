<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>üìã PhuocIT TEST NEW v2.2 - Dashboard Fixed - Qu·∫£n l√Ω b√°n h√†ng offline</title>
    <meta name="description" content="H·ªá th·ªëng qu·∫£n l√Ω b√°n h√†ng PhuocIT cho doanh nghi·ªáp Vi·ªát Nam - ho·∫°t ƒë·ªông ho√†n to√†n offline">
    
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <!-- Login Screen -->
    <div class="login-container" id="loginScreen">
        <div class="login-card">
            <div class="login-header">
                <div class="login-logo">üìã</div>
                <h1 class="login-title">SHOP B√ÅN H√ÄNG</h1>
                <p class="login-subtitle">ƒêƒÉng nh·∫≠p h·ªá th·ªëng qu·∫£n l√Ω</p>
            </div>
            
            <div class="error-message" id="errorMessage">
                T√™n ƒëƒÉng nh·∫≠p ho·∫∑c m·∫≠t kh·∫©u kh√¥ng ƒë√∫ng!
            </div>
            
            <form class="login-form" id="loginForm">
                <div class="form-group">
                    <label for="username">T√™n ƒëƒÉng nh·∫≠p</label>
                    <input type="text" id="username" name="username" placeholder="Nh·∫≠p t√™n ƒëƒÉng nh·∫≠p" required>
                </div>
                
                <div class="form-group">
                    <label for="password">M·∫≠t kh·∫©u</label>
                    <input type="password" id="password" name="password" placeholder="Nh·∫≠p m·∫≠t kh·∫©u" required>
                </div>
                
                <button type="submit" class="login-button">ƒêƒÉng nh·∫≠p</button>
            </form>
            
            <div class="login-info">
                <strong>Th√¥ng tin ƒëƒÉng nh·∫≠p:</strong><br>
                T√™n ƒëƒÉng nh·∫≠p: <strong>Admin</strong><br>
                M·∫≠t kh·∫©u: <strong>Matkhau@123</strong>
            </div>
        </div>
    </div>

    <div class="app-container" id="appContainer">
        <!-- Mobile Menu Toggle -->
        <button class="mobile-menu-toggle" id="mobileMenuToggle" onclick="toggleMobileMenu()">
            ‚ò∞
        </button>
        
        <!-- Mobile Overlay -->
        <div class="mobile-overlay" id="mobileOverlay" onclick="toggleMobileMenu()"></div>
        
        <!-- Sidebar -->
        <div class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="logo">
                    <div class="logo-icon">üìã</div>
                </div>
                <h1 class="app-title">SHOP B√ÅN H√ÄNG</h1>
                <p class="app-subtitle">Qu·∫£n l√Ω b√°n h√†ng offline</p>
            </div>
            
            <nav class="nav-menu">
                <div class="nav-section">
                    <h3>T·ªïng quan</h3>
                    <a href="#dashboard" class="nav-item active" data-page="dashboard">
                        <span class="nav-item-icon">üìä</span>
                        Dashboard
                    </a>
                </div>
                
                <div class="nav-section">
                    <h3>Qu·∫£n l√Ω c∆° b·∫£n</h3>
                    <a href="#customers" class="nav-item" data-page="customers">
                        <span class="nav-item-icon">üë•</span>
                        Kh√°ch h√†ng
                    </a>
                    <a href="#suppliers" class="nav-item" data-page="suppliers">
                        <span class="nav-item-icon">üè¢</span>
                        Nh√† cung c·∫•p
                    </a>
                    <a href="#products" class="nav-item" data-page="products">
                        <span class="nav-item-icon">üì¶</span>
                        S·∫£n ph·∫©m
                    </a>
                    <a href="#categories" class="nav-item" data-page="categories">
                        <span class="nav-item-icon">üìÇ</span>
                        Danh m·ª•c
                    </a>
                    <a href="#inventory" class="nav-item" data-page="inventory">
                        <span class="nav-item-icon">üìã</span>
                        Kho h√†ng
                    </a>
                </div>
                
                <div class="nav-section">
                    <h3>Nghi·ªáp v·ª•</h3>

                    
                    <a href="#debts" class="nav-item" data-page="debts">
                        <span class="nav-item-icon">üí≥</span>
                        C√¥ng n·ª£
                    </a>
                    <a href="#orders" class="nav-item" data-page="orders" style="pointer-events: auto !important; cursor: pointer !important;" onclick="console.log('Orders menu clicked!'); event.preventDefault(); event.stopPropagation(); if(window.app) { window.app.loadPage('orders'); window.app.setActiveNav(this); } else { alert('App not ready yet'); } return false;">
                        <span class="nav-item-icon">üìã</span>
                        Qu·∫£n l√Ω ƒë∆°n h√†ng
                    </a>
                </div>
                
                <div class="nav-section">
                    <h3>B√°o c√°o</h3>
                    <a href="#reports" class="nav-item" data-page="reports">
                        <span class="nav-item-icon">üìà</span>
                        B√°o c√°o
                    </a>
                </div>
                
                <div class="nav-section">
                    <h3>H·ªá th·ªëng</h3>
                    <a href="#settings" class="nav-item" data-page="settings">
                        <span class="nav-item-icon">‚öôÔ∏è</span>
                        C√†i ƒë·∫∑t
                    </a>
                    <a href="#company-info" class="nav-item" data-page="company-info">
                        <span class="nav-item-icon">üè¢</span>
                        Th√¥ng Tin Shop
                    </a>
                </div>
            </nav>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <div class="header">
                <div>
                    <h1 class="header-title" id="page-title">H·ªá th·ªëng Qu·∫£n l√Ω</h1>
                    <p class="header-subtitle" id="page-subtitle">Qu·∫£n l√Ω b√°n h√†ng doanh nghi·ªáp Vi·ªát Nam</p>
                </div>
                
                <div style="display: flex; gap: 12px; align-items: center;">
                    <div class="demo-badge" onclick="app.showCompanyInfo()" style="cursor: pointer;">
                        <span>‚ÑπÔ∏è</span>
                        PITC
                    </div>
                    
                    <button onclick="if(window.app) { window.app.loadPage('orders'); } else { alert('App ch∆∞a s·∫µn s√†ng'); }" style="
                        background: var(--primary-blue);
                        color: white;
                        border: none;
                        padding: 8px 16px;
                        border-radius: 8px;
                        cursor: pointer;
                        font-size: 14px;
                        font-weight: 600;
                        display: flex;
                        align-items: center;
                        gap: 6px;
                        transition: all 0.3s ease;
                        margin-right: 8px;
                    " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(37, 99, 235, 0.3)'" 
                       onmouseout="this.style.transform=''; this.style.boxShadow=''">
                        <span>üìã</span>
                        ƒê∆°n h√†ng
                    </button>
                    

                    
                    <button onclick="logout()" style="
                        background: var(--danger-gradient);
                        color: white;
                        border: none;
                        padding: 8px 16px;
                        border-radius: 8px;
                        cursor: pointer;
                        font-size: 14px;
                        font-weight: 600;
                        display: flex;
                        align-items: center;
                        gap: 6px;
                        transition: all 0.3s ease;
                    " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(220, 38, 38, 0.3)'" 
                       onmouseout="this.style.transform=''; this.style.boxShadow=''">
                        <span>üö™</span>
                        ƒêƒÉng xu·∫•t
                    </button>
                </div>
            </div>
            
            <div class="content" id="main-content">
                <!-- Dashboard Content s·∫Ω ƒë∆∞·ª£c load ƒë·ªông t·ª´ JavaScript -->
            </div>
        </div>
    </div>

    <!-- Notification -->
    <div id="notification" class="notification"></div>

    <script>
        // HOSTING SOLUTION: Global storage v·ªõi localStorage backup
        window.companyAssets = { 
            logo: localStorage.getItem('company_logo') || null, 
            qr: localStorage.getItem('company_qr') || null 
        };
        
        // Auto-restore every 1 second - ensures logo/QR always visible t·ª´ localStorage
        setInterval(function() {
            // Restore logo t·ª´ localStorage n·∫øu c·∫ßn
            const savedLogo = localStorage.getItem('company_logo');
            if (savedLogo) {
                window.companyAssets.logo = savedLogo;
                const logoDisplay = document.getElementById('logo-display');
                if (logoDisplay && !logoDisplay.innerHTML.includes('<img')) {
                    logoDisplay.innerHTML = `<img src="${savedLogo}" alt="Logo" style="max-width: 100%; max-height: 140px; object-fit: contain;">`;
                }
            }
            
            // Restore QR t·ª´ localStorage n·∫øu c·∫ßn
            const savedQR = localStorage.getItem('company_qr');
            if (savedQR) {
                window.companyAssets.qr = savedQR;
                const qrDisplay = document.getElementById('qr-display');
                if (qrDisplay && !qrDisplay.innerHTML.includes('<img')) {
                    qrDisplay.innerHTML = `<img src="${savedQR}" alt="QR Code" style="max-width: 100%; max-height: 140px; object-fit: contain;">`;
                }
            }
        }, 1000);
        
        // Force browser to use latest version (cache buster)
        console.log('üîÑ PAGE LOAD TIME:', new Date().toLocaleString('vi-VN'));
        console.log('üîÑ Cache busting - timestamp:', Date.now());
        
        // Vietnamese PhuocIT Offline Application  
        class VietnamesePhuocIT {
            constructor() {
                this.currentPage = 'dashboard';
                // Clear old data with wrong dates
                this.clearOldDataIfNeeded();
                
                // LU√îN th·ª≠ load t·ª´ localStorage tr∆∞·ªõc, ch·ªâ t·∫°o demo data n·∫øu HO√ÄN TO√ÄN tr·ªëng
                this.initializeData();
                
                this.init();
            }
            
            initializeData() {
                const saved = localStorage.getItem('PhuocIT_vietnam_data');
                if (saved && saved.trim() !== '') {
                    try {
                        this.demoData = JSON.parse(saved);
                        console.log('‚úÖ LOADED EXISTING DATA FROM LOCALSTORAGE');
                        
                        // Migrate data: Th√™m minStock cho s·∫£n ph·∫©m c≈© n·∫øu ch∆∞a c√≥
                        this.migrateProductData();
                        
                        console.log('Customer debts loaded:');
                        this.demoData.customers.forEach(c => {
                            console.log(`  ${c.name}: ${c.debt.toLocaleString('vi-VN')} VNƒê`);
                        });
                        return; // Tho√°t ngay l·∫≠p t·ª©c, KH√îNG t·∫°o demo data
                    } catch (e) {
                        console.log('Error parsing saved data:', e);
                    }
                }
                
                // Ch·ªâ t·∫°o demo data n·∫øu localStorage ho√†n to√†n tr·ªëng
                console.log('üÜï NO SAVED DATA - CREATING FRESH DEMO DATA');
                this.demoData = this.generateDemoData();
                this.saveToLocalStorage();
            }

            // Migrate data ƒë·ªÉ th√™m minStock cho s·∫£n ph·∫©m c≈©
            migrateProductData() {
                let needsSave = false;
                
                // ƒê·∫£m b·∫£o t·∫•t c·∫£ s·∫£n ph·∫©m ƒë·ªÅu c√≥ tr∆∞·ªùng minStock
                if (this.demoData.products) {
                    this.demoData.products.forEach(product => {
                        if (typeof product.minStock === 'undefined') {
                            // ƒê·∫∑t m·∫∑c ƒë·ªãnh minStock d·ª±a tr√™n t·ªìn kho hi·ªán t·∫°i
                            product.minStock = Math.max(5, Math.floor(product.stock * 0.2));
                            needsSave = true;
                            console.log(`üì¶ Th√™m minStock=${product.minStock} cho s·∫£n ph·∫©m ${product.name}`);
                        }
                    });
                }
                
                if (needsSave) {
                    this.saveToLocalStorage();
                    console.log('‚úÖ ƒê√£ c·∫≠p nh·∫≠t d·ªØ li·ªáu s·∫£n ph·∫©m v·ªõi tr∆∞·ªùng minStock');
                }
            }

            // Clear d·ªØ li·ªáu c≈© n·∫øu c√≥ ng√†y th√°ng sai
            clearOldDataIfNeeded() {
                const today = this.getVietnamTime().toISOString().split('T')[0];
                const currentDate = this.getVietnamTime();
                
                // Force clear if date is not August 11, 2025
                const expectedDate = '2025-08-11';
                
                // Check if stored data has old dates or wrong date
                const storedData = localStorage.getItem('PhuocIT_data');
                if (storedData) {
                    try {
                        const data = JSON.parse(storedData);
                        if (data.orders && data.orders.length > 0) {
                            const firstOrderDate = data.orders[0].date;
                            
                            // If date is not today (Aug 11, 2025), clear all data
                            if (!firstOrderDate.startsWith('2025-08-1')) {
                                console.log('Clearing old data with wrong date:', firstOrderDate, 'expected:', expectedDate);
                                localStorage.clear();
                                // Add timestamp to force fresh data
                                localStorage.setItem('last_data_refresh', currentDate.toISOString());
                                return true; // Indicates data was cleared
                            }
                        }
                    } catch (e) {
                        console.log('Error checking stored data, clearing all:', e);
                        localStorage.clear();
                        return true;
                    }
                }
                
                // Force clear if no recent refresh
                const lastRefresh = localStorage.getItem('last_data_refresh');
                if (!lastRefresh) {
                    console.log('No refresh timestamp, clearing data');
                    localStorage.clear();
                    localStorage.setItem('last_data_refresh', currentDate.toISOString());
                    return true;
                }
                
                return false;
            }
            
            init() {
                console.log('Initializing Vietnamese PhuocIT...');
                
                // Debug: Show current Vietnam time
                const vietnamTime = this.getVietnamTime();
                console.log('üïê Th·ªùi gian Vi·ªát Nam hi·ªán t·∫°i:', this.formatVietnameseTime());
                console.log('Sample order date:', this.demoData.orders[0].date);
                
                this.setupNavigation();
                this.setupEventListeners();
                this.loadPage('dashboard');
                
                // Kh·ªüi t·∫°o filter state cho b√°o c√°o
                this.initFilterState();
                
                // Initialize auto backup if enabled
                if (localStorage.getItem('auto_backup_enabled') === 'true') {
                    this.startAutoBackup();
                }
                
                // Force refresh activities every time dashboard loads
                console.log('üîÑ FORCE REFRESH - Testing getRecentActivities()');
                const testActivities = this.getRecentActivities();
                console.log('üîÑ Activities HTML Length:', testActivities.length);
                
                // Show date debug info to user
                this.showNotification(`H·ªá th·ªëng kh·ªüi t·∫°o l√∫c: ${this.formatVietnameseTime()}`, 'info');
                console.log('Vietnamese PhuocIT initialized successfully');
            }
            
            generateDemoData() {
                return {
                    customers: [
                        { id: 'KH001', name: 'Nguy·ªÖn VƒÉn A', type: 'ca-nhan', phone: '0901234567', email: 'nva@gmail.com', address: 'H√† N·ªôi', debt: 0 },
                        { id: 'KH002', name: 'Tr·∫ßn Th·ªã B', type: 'ca-nhan', phone: '0912345678', email: 'ttb@gmail.com', address: 'TP.HCM', debt: 500000 },
                        { id: 'KH003', name: 'L√™ Minh C', type: 'doanh-nghiep', companyName: 'C√¥ng ty TNHH Minh Ch√¢u', department: 'Ph√≤ng mua h√†ng', phone: '0923456789', email: 'lmc@minhchau.com.vn', address: 'ƒê√† N·∫µng', taxCode: '0123456789', debt: 0 },
                        { id: 'KH004', name: 'Ph·∫°m Thu D', type: 'doanh-nghiep', companyName: 'C√¥ng ty C·ªï ph·∫ßn Thu ƒê·ª©c', department: 'Ph√≤ng k·∫ø to√°n', phone: '0934567890', email: 'ptd@thuduc.vn', address: 'C·∫ßn Th∆°', taxCode: '0987654321', debt: 300000 },
                        { id: 'KH005', name: 'Ho√†ng VƒÉn E', type: 'ca-nhan', phone: '0945678901', email: 'hve@gmail.com', address: 'H·∫£i Ph√≤ng', debt: 0 }
                    ],
                    suppliers: [
                        { id: 'NCC001', name: 'C√¥ng ty TNHH ABC', phone: '024-3456-7890', email: 'abc@company.vn', address: 'H√† N·ªôi', products: 'ƒêi·ªán t·ª≠' },
                        { id: 'NCC002', name: 'C√¥ng ty XYZ', phone: '028-3456-7891', email: 'xyz@company.vn', address: 'TP.HCM', products: 'Gia d·ª•ng' },
                        { id: 'NCC003', name: 'C√¥ng ty DEF', phone: '0236-3456-792', email: 'def@company.vn', address: 'ƒê√† N·∫µng', products: 'Th·ªùi trang' }
                    ],
                    products: [
                        { id: 'SP001', name: 'iPhone 15 Pro', category: 'ƒêi·ªán tho·∫°i', price: 28900000, importPrice: 25000000, stock: 5, minStock: 10, supplier: 'NCC001' },
                        { id: 'SP002', name: 'Samsung Galaxy S24', category: 'ƒêi·ªán tho·∫°i', price: 24900000, importPrice: 22000000, stock: 100, minStock: 15, supplier: 'NCC001' },
                        { id: 'SP003', name: 'MacBook Air M2', category: 'Laptop', price: 28900000, importPrice: 26000000, stock: 15, minStock: 5, supplier: 'NCC001' },
                        { id: 'SP004', name: 'iPad Pro 11 inch', category: 'Tablet', price: 19900000, importPrice: 18000000, stock: 8, minStock: 12, supplier: 'NCC001' },
                        { id: 'SP005', name: 'AirPods Pro', category: 'Ph·ª• ki·ªán', price: 6490000, importPrice: 5500000, stock: 25, minStock: 20, supplier: 'NCC001' },
                        { id: 'SP006', name: 'Qu·∫£ b√≥ng ƒë√° FIFA', category: 'S·∫£n ph·∫©m > B√≥ng ƒë√°', price: 500000, importPrice: 350000, stock: 50, minStock: 30, supplier: 'NCC002' },
                        { id: 'SP007', name: 'V·ª£t Pickle Ball Pro', category: 'S·∫£n ph·∫©m > Pickle Ball', price: 800000, importPrice: 650000, stock: 30, minStock: 10, supplier: 'NCC002' }
                    ],
                    categories: [
                        { id: 'CAT001', name: 'S·∫£n ph·∫©m', parent: null },
                        { id: 'CAT002', name: 'B√≥ng ƒë√°', parent: 'CAT001' },
                        { id: 'CAT003', name: 'Pickle Ball', parent: 'CAT001' },
                        { id: 'CAT004', name: 'ƒêi·ªán tho·∫°i', parent: null },
                        { id: 'CAT005', name: 'Laptop', parent: null },
                        { id: 'CAT006', name: 'Tablet', parent: null },
                        { id: 'CAT007', name: 'Ph·ª• ki·ªán', parent: null }
                    ],
                    orders: this.generateOrdersWithCurrentDate(),
                    sales: this.generateSalesWithCurrentDate()
                };
            }

            // T·∫°o orders v·ªõi ng√†y hi·ªán t·∫°i (gi·ªù Vi·ªát Nam)
            generateOrdersWithCurrentDate() {
                const today = this.getVietnamTime();
                const yesterday = new Date(today);
                yesterday.setDate(yesterday.getDate() - 1);
                const twoDaysAgo = new Date(today);
                twoDaysAgo.setDate(twoDaysAgo.getDate() - 2);
                const threeDaysAgo = new Date(today);
                threeDaysAgo.setDate(threeDaysAgo.getDate() - 3);
                const fourDaysAgo = new Date(today);
                fourDaysAgo.setDate(fourDaysAgo.getDate() - 4);

                return [
                    // ƒê∆°n h√†ng t·ª´ kh√°ch h√†ng doanh nghi·ªáp - ƒë·ªÉ test hi·ªÉn th·ªã
                    { 
                        id: 'DH007', 
                        customerId: 'KH003', 
                        customerName: 'L√™ Minh C',
                        date: today.toISOString().split('T')[0], 
                        time: '17:30',
                        products: [
                            { id: 'SP003', name: 'MacBook Air M2', quantity: 2, price: 28900000 }
                        ],
                        total: 57800000,
                        status: 'M·ªõi',
                        paymentMethod: 'Chuy·ªÉn kho·∫£n',
                        paymentStatus: 'C√¥ng n·ª£'
                    },
                    // ƒê∆°n h√†ng m·ªõi nh·∫•t tr∆∞·ªõc (h√¥m nay)
                    { 
                        id: 'DH006', 
                        customerId: 'KH001', 
                        customerName: 'Nguy·ªÖn VƒÉn A',
                        date: today.toISOString().split('T')[0], 
                        time: '16:45',
                        products: [
                            { id: 'SP001', name: 'iPhone 15 Pro', quantity: 1, price: 28900000 }
                        ],
                        total: 28900000,
                        status: 'M·ªõi',
                        paymentMethod: 'Chuy·ªÉn kho·∫£n',
                        paymentStatus: 'C√¥ng n·ª£'
                    },
                    { 
                        id: 'DH002', 
                        customerId: 'KH002', 
                        customerName: 'Tr·∫ßn Th·ªã B',
                        date: today.toISOString().split('T')[0], 
                        time: '14:15',
                        products: [
                            { id: 'SP002', name: 'Samsung Galaxy S24', quantity: 1, price: 24900000 }
                        ],
                        total: 24900000,
                        status: 'ƒêang x·ª≠ l√Ω',
                        paymentMethod: 'Ti·ªÅn m·∫∑t',
                        paymentStatus: 'C√¥ng n·ª£'
                    },
                    { 
                        id: 'DH001', 
                        customerId: 'KH001', 
                        customerName: 'Nguy·ªÖn VƒÉn A',
                        date: today.toISOString().split('T')[0], 
                        time: '10:30',
                        products: [
                            { id: 'SP001', name: 'iPhone 15 Pro', quantity: 1, price: 28900000 },
                            { id: 'SP005', name: 'AirPods Pro', quantity: 1, price: 6490000 }
                        ],
                        total: 35390000,
                        status: 'Ho√†n th√†nh',
                        paymentMethod: 'Chuy·ªÉn kho·∫£n',
                        paymentStatus: 'ƒê√£ thanh to√°n'
                    },
                    { 
                        id: 'DH003', 
                        customerId: 'KH003', 
                        customerName: 'L√™ Minh C',
                        date: yesterday.toISOString().split('T')[0], 
                        time: '16:45',
                        products: [
                            { id: 'SP003', name: 'MacBook Air M2', quantity: 1, price: 28900000 },
                            { id: 'SP004', name: 'iPad Pro 11 inch', quantity: 1, price: 19900000 }
                        ],
                        total: 48800000,
                        status: 'Ho√†n th√†nh',
                        paymentMethod: 'Chuy·ªÉn kho·∫£n',
                        paymentStatus: 'ƒê√£ thanh to√°n'
                    },
                    { 
                        id: 'DH004', 
                        customerId: 'KH004', 
                        customerName: 'Ph·∫°m Thu D',
                        date: twoDaysAgo.toISOString().split('T')[0], 
                        time: '09:20',
                        products: [
                            { id: 'SP006', name: 'Qu·∫£ b√≥ng ƒë√° FIFA', quantity: 2, price: 500000 }
                        ],
                        total: 1000000,
                        status: 'ƒê√£ giao',
                        paymentMethod: 'Ti·ªÅn m·∫∑t',
                        paymentStatus: 'C√¥ng n·ª£'
                    },
                    { 
                        id: 'DH005', 
                        customerId: 'KH005', 
                        customerName: 'Ho√†ng VƒÉn E',
                        date: threeDaysAgo.toISOString().split('T')[0], 
                        time: '11:30',
                        products: [
                            { id: 'SP007', name: 'V·ª£t Pickle Ball Pro', quantity: 1, price: 800000 },
                            { id: 'SP005', name: 'AirPods Pro', quantity: 2, price: 6490000 }
                        ],
                        total: 13780000,
                        status: 'H·ªßy',
                        paymentMethod: 'Chuy·ªÉn kho·∫£n',
                        paymentStatus: 'C√¥ng n·ª£'
                    }
                ];
            }

            // T·∫°o sales v·ªõi ng√†y hi·ªán t·∫°i (gi·ªù Vi·ªát Nam)
            generateSalesWithCurrentDate() {
                const today = this.getVietnamTime();
                const yesterday = new Date(today);
                yesterday.setDate(yesterday.getDate() - 1);
                const twoDaysAgo = new Date(today);
                twoDaysAgo.setDate(twoDaysAgo.getDate() - 2);

                return [
                    { id: 'DH001', date: today.toISOString().split('T')[0], customer: 'Nguy·ªÖn VƒÉn A', total: 2500000, status: 'Ho√†n th√†nh', items: 3 },
                    { id: 'DH002', date: today.toISOString().split('T')[0], customer: 'Tr·∫ßn Th·ªã B', total: 1800000, status: 'Ch·ªù x·ª≠ l√Ω', items: 2 },
                    { id: 'DH003', date: yesterday.toISOString().split('T')[0], customer: 'L√™ Minh C', total: 3200000, status: 'ƒêang giao', items: 4 },
                    { id: 'DH004', date: yesterday.toISOString().split('T')[0], customer: 'Ph·∫°m Thu D', total: 950000, status: 'Ho√†n th√†nh', items: 1 },
                    { id: 'DH005', date: twoDaysAgo.toISOString().split('T')[0], customer: 'Ho√†ng VƒÉn E', total: 4200000, status: 'Ho√†n th√†nh', items: 5 }
                ];
            }

            // Helper function ƒë·ªÉ l·∫•y th·ªùi gian Vi·ªát Nam (UTC+7)
            getVietnamTime() {
                const now = new Date();
                // L·∫•y th·ªùi gian hi·ªán t·∫°i theo m√∫i gi·ªù Vi·ªát Nam (Asia/Ho_Chi_Minh)
                return new Date(now.toLocaleString("en-US", {timeZone: "Asia/Ho_Chi_Minh"}));
            }
            
            // T√≠nh to√°n kho·∫£ng th·ªùi gian t·ª´ th·ªùi ƒëi·ªÉm hi·ªán t·∫°i
            getTimeAgo(pastTime) {
                const now = this.getVietnamTime();
                const diff = now.getTime() - pastTime.getTime();
                const minutes = Math.floor(diff / (1000 * 60));
                const hours = Math.floor(minutes / 60);
                const days = Math.floor(hours / 24);
                
                if (minutes < 1) return "V·ª´a xong";
                if (minutes < 60) return `${minutes} ph√∫t tr∆∞·ªõc`;
                if (hours < 24) return `${hours} gi·ªù tr∆∞·ªõc`;
                if (days < 30) return `${days} ng√†y tr∆∞·ªõc`;
                return pastTime.toLocaleDateString('vi-VN');
            }
            
            // T·∫°o th·ªùi gian ho·∫°t ƒë·ªông th·ª±c t·∫ø
            generateRealisticActivityTimes() {
                const now = this.getVietnamTime();
                return [
                    new Date(now.getTime() - 10 * 60 * 1000), // 10 ph√∫t tr∆∞·ªõc
                    new Date(now.getTime() - 25 * 60 * 1000), // 25 ph√∫t tr∆∞·ªõc  
                    new Date(now.getTime() - 1 * 60 * 60 * 1000), // 1 gi·ªù tr∆∞·ªõc
                    new Date(now.getTime() - 2 * 60 * 60 * 1000), // 2 gi·ªù tr∆∞·ªõc
                    new Date(now.getTime() - 3 * 60 * 60 * 1000), // 3 gi·ªù tr∆∞·ªõc
                ];
            }
            
            // Format hi·ªÉn th·ªã th·ªùi gian Vi·ªát Nam ƒë·∫πp
            formatVietnameseTime(date = null) {
                const targetDate = date || this.getVietnamTime();
                return targetDate.toLocaleString('vi-VN', { 
                    timeZone: 'Asia/Ho_Chi_Minh',
                    year: 'numeric',
                    month: '2-digit', 
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit'
                });
            }

            // Helper function ƒë·ªÉ s·∫Øp x·∫øp ƒë∆°n h√†ng theo ng√†y m·ªõi nh·∫•t
            sortOrdersByDate(orders) {
                return [...orders].sort((a, b) => {
                    // T·∫°o ƒë·ªëi t∆∞·ª£ng Date ƒë·ªÉ so s√°nh
                    const dateA = new Date(a.date + (a.time ? ' ' + a.time : ' 00:00:00'));
                    const dateB = new Date(b.date + (b.time ? ' ' + b.time : ' 00:00:00'));
                    
                    // N·∫øu kh√¥ng parse ƒë∆∞·ª£c date, d√πng fallback
                    const timeA = isNaN(dateA.getTime()) ? new Date(a.date).getTime() : dateA.getTime();
                    const timeB = isNaN(dateB.getTime()) ? new Date(b.date).getTime() : dateB.getTime();
                    
                    return timeB - timeA; // M·ªõi nh·∫•t l√™n tr√™n
                });
            }

            // T·∫°o danh s√°ch ho·∫°t ƒë·ªông v·ªõi th·ªùi gian th·ª±c (UNUSED - d√πng getRecentActivities thay th·∫ø)
            generateActivityItems() {
                const activityTimes = this.generateRealisticActivityTimes();
                console.log('üïê Th·ªùi gian ho·∫°t ƒë·ªông:', activityTimes.map(t => this.getTimeAgo(t)));
                return `
                        <div class="activity-item">
                            <div class="activity-icon success">üí∞</div>
                            <div class="activity-content">
                                <div class="activity-title">ƒê∆°n h√†ng DH001 ƒë√£ ho√†n th√†nh</div>
                                <div class="activity-desc">Kh√°ch h√†ng Nguy·ªÖn VƒÉn A ƒë√£ thanh to√°n ƒë∆°n h√†ng 2.500.000 VNƒê</div>
                            </div>
                            <div class="activity-time">${this.getTimeAgo(activityTimes[0])}</div>
                        </div>
                        
                        <div class="activity-item">
                            <div class="activity-icon info">üìã</div>
                            <div class="activity-content">
                                <div class="activity-title">ƒê∆°n h√†ng m·ªõi DH002</div>
                                <div class="activity-desc">Kh√°ch h√†ng Tr·∫ßn Th·ªã B ƒë·∫∑t h√†ng tr·ªã gi√° 1.800.000 VNƒê</div>
                            </div>
                            <div class="activity-time">${this.getTimeAgo(activityTimes[1])}</div>
                        </div>
                        
                        <div class="activity-item">
                            <div class="activity-icon warning">‚ö†Ô∏è</div>
                            <div class="activity-content">
                                <div class="activity-title">S·∫£n ph·∫©m s·∫Øp h·∫øt h√†ng</div>
                                <div class="activity-desc">iPhone 15 Pro ch·ªâ c√≤n 5 s·∫£n ph·∫©m trong kho</div>
                            </div>
                            <div class="activity-time">${this.getTimeAgo(activityTimes[2])}</div>
                        </div>
                        
                        <div class="activity-item">
                            <div class="activity-icon success">üë•</div>
                            <div class="activity-content">
                                <div class="activity-title">Kh√°ch h√†ng m·ªõi</div>
                                <div class="activity-desc">L√™ Minh C ƒë√£ ƒëƒÉng k√Ω l√†m kh√°ch h√†ng</div>
                            </div>
                            <div class="activity-time">${this.getTimeAgo(activityTimes[3])}</div>
                        </div>
                        
                        <div class="activity-item">
                            <div class="activity-icon info">üì¶</div>
                            <div class="activity-content">
                                <div class="activity-title">Nh·∫≠p kho ho√†n th√†nh</div>
                                <div class="activity-desc">ƒê√£ nh·∫≠p 100 s·∫£n ph·∫©m Samsung Galaxy S24 v√†o kho</div>
                            </div>
                            <div class="activity-time">${this.getTimeAgo(activityTimes[4])}</div>
                        </div>
                `;
            }

            // Force refresh activities
            refreshActivities() {
                const container = document.getElementById('activities-container');
                if (container) {
                    console.log('üîÑ Refreshing activities at:', this.formatVietnameseTime());
                    const newContent = this.getRecentActivities();
                    container.innerHTML = newContent;
                    console.log('‚úÖ Activities manually refreshed at:', this.formatVietnameseTime());
                    this.showNotification(`ƒê√£ c·∫≠p nh·∫≠t l√∫c ${this.formatVietnameseTime()}`, 'success');
                }
            }
            
            setupNavigation() {
                const navItems = document.querySelectorAll('.nav-item');
                console.log('Setting up navigation for', navItems.length, 'items');
                navItems.forEach(item => {
                    item.addEventListener('click', (e) => {
                        e.preventDefault();
                        const page = item.getAttribute('data-page');
                        console.log('Navigation clicked:', page);
                        this.loadPage(page);
                        this.setActiveNav(item);
                    });
                });
            }
            
            setupEventListeners() {
                // Mobile menu toggle (if needed)
                document.addEventListener('click', (e) => {
                    const actionButton = e.target.closest('.action-button');
                    if (actionButton && !actionButton.hasAttribute('onclick')) {
                        const title = actionButton.querySelector('.action-title').textContent;
                        this.showNotification(`Ch·ª©c nƒÉng "${title}" s·∫Ω ƒë∆∞·ª£c ph√°t tri·ªÉn trong phi√™n b·∫£n t·ªõi`, 'info');
                    }
                });
            }
            
            setActiveNav(activeItem) {
                document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
                activeItem.classList.add('active');
            }
            
            loadPage(pageName) {
                console.log('üìÑ Loading page:', pageName);
                this.currentPage = pageName;
                
                // FORCE reload to√†n b·ªô d·ªØ li·ªáu t·ª´ localStorage
                console.log('üîÑ FORCE RELOADING DATA FOR PAGE:', pageName);
                this.initializeData();
                
                const content = this.getPageContent(pageName);
                const titles = this.getPageTitles(pageName);
                
                document.getElementById('page-title').textContent = titles.title;
                document.getElementById('page-subtitle').textContent = titles.subtitle;
                document.getElementById('main-content').innerHTML = content;
                
                // Add fade in animation
                document.getElementById('main-content').classList.add('fade-in');
                setTimeout(() => {
                    document.getElementById('main-content').classList.remove('fade-in');
                    
                    // Restore logo/QR for company-info page
                    if (pageName === 'company-info') {
                        this.restoreLogoAndQR();
                    }
                }, 500);
                console.log('‚úÖ Page loaded with FRESH data:', pageName);
            }
            
            getPageTitles(pageName) {
                const titles = {
                    dashboard: { title: 'H·ªá th·ªëng Qu·∫£n l√Ω', subtitle: 'Qu·∫£n l√Ω b√°n h√†ng doanh nghi·ªáp Vi·ªát Nam' },
                    customers: { title: 'Qu·∫£n l√Ω Kh√°ch h√†ng', subtitle: 'Danh s√°ch v√† th√¥ng tin kh√°ch h√†ng' },
                    suppliers: { title: 'Qu·∫£n l√Ω Nh√† cung c·∫•p', subtitle: 'Danh s√°ch v√† th√¥ng tin nh√† cung c·∫•p' },
                    products: { title: 'Qu·∫£n l√Ω S·∫£n ph·∫©m', subtitle: 'Danh m·ª•c v√† kho h√†ng s·∫£n ph·∫©m' },
                    categories: { title: 'Qu·∫£n l√Ω Danh m·ª•c', subtitle: 'Qu·∫£n l√Ω danh m·ª•c s·∫£n ph·∫©m ph√¢n c·∫•p' },
                    inventory: { title: 'Qu·∫£n l√Ω Kho h√†ng', subtitle: 'Theo d√µi t·ªìn kho v√† nh·∫≠p xu·∫•t' },

                    purchases: { title: 'Qu·∫£n l√Ω Mua h√†ng', subtitle: 'ƒê∆°n mua v√† nh·∫≠p h√†ng t·ª´ nh√† cung c·∫•p' },
                    debts: { title: 'Qu·∫£n l√Ω C√¥ng n·ª£', subtitle: 'Theo d√µi c√¥ng n·ª£ kh√°ch h√†ng v√† nh√† cung c·∫•p' },
                    reports: { title: 'B√°o c√°o T·ªïng h·ª£p', subtitle: 'B√°o c√°o doanh thu v√† ho·∫°t ƒë·ªông kinh doanh' },
                    settings: { title: 'C√†i ƒë·∫∑t H·ªá th·ªëng', subtitle: 'C·∫•u h√¨nh v√† sao l∆∞u d·ªØ li·ªáu' }
                };
                return titles[pageName] || titles.dashboard;
            }
            
            getPageContent(pageName) {
                switch(pageName) {
                    case 'customers':
                        return this.getCustomersContent();
                    case 'suppliers':
                        return this.getSuppliersContent();
                    case 'products':
                        return this.getProductsContent();
                    case 'inventory':
                        return this.getInventoryContent();

                    case 'purchases':
                        return this.getPurchasesContent();
                    case 'categories':
                        return this.getCategoriesContent();
                    case 'debts':
                        return this.getDebtsContent();
                    case 'orders':
                        return this.getOrdersContent();
                    case 'reports':
                        return this.getReportsContent();
                    case 'settings':
                        return this.getSettingsContent();
                    case 'company-info':
                        return this.getCompanyInfoContent();
                    default:
                        return this.getDashboardContent();
                }
            }
            
            getDashboardContent() {
                return `
                    <div class="fade-in">
                        <!-- Stats Grid -->
                        <div class="stats-grid">
                            <div class="stat-card revenue">
                                <div class="stat-header">
                                    <span class="stat-title">Doanh thu h√¥m nay</span>
                                    <span class="stat-icon">üí∞</span>
                                </div>
                                <div class="stat-value">25.800.000 VNƒê</div>
                                <div class="stat-change positive">‚Üó +12.5% so v·ªõi h√¥m qua</div>
                            </div>
                            
                            <div class="stat-card orders">
                                <div class="stat-header">
                                    <span class="stat-title">ƒê∆°n h√†ng m·ªõi</span>
                                    <span class="stat-icon">üìã</span>
                                </div>
                                <div class="stat-value">47</div>
                                <div class="stat-change positive">‚Üó +8.2% so v·ªõi h√¥m qua</div>
                            </div>
                            
                            <div class="stat-card customers">
                                <div class="stat-header">
                                    <span class="stat-title">Kh√°ch h√†ng</span>
                                    <span class="stat-icon">üë•</span>
                                </div>
                                <div class="stat-value">${this.demoData.customers.length}</div>
                                <div class="stat-change positive">‚Üó +5.1% so v·ªõi tu·∫ßn tr∆∞·ªõc</div>
                            </div>
                            
                            <div class="stat-card products">
                                <div class="stat-header">
                                    <span class="stat-title">S·∫£n ph·∫©m</span>
                                    <span class="stat-icon">üì¶</span>
                                </div>
                                <div class="stat-value">${this.demoData.products.length}</div>
                                <div class="stat-change positive">‚Üó +2.3% so v·ªõi tu·∫ßn tr∆∞·ªõc</div>
                            </div>
                        </div>
                        
                        <!-- Quick Actions -->
                        <div class="quick-actions">
                            <h2 class="section-title">Thao t√°c nhanh</h2>
                            <div class="action-grid">
                                <div class="action-button" onclick="console.log('CLICKED: T·∫°o ƒë∆°n b√°n h√†ng - FORM M·ªöI #2'); app.showCreateOrderForm();">
                                    <div class="action-icon">üìù</div>
                                    <div class="action-title">T·∫°o ƒë∆°n b√°n h√†ng</div>
                                    <div class="action-desc">Form m·ªõi v·ªõi chi·∫øt kh·∫•u t·ª´ng s·∫£n ph·∫©m</div>
                                </div>
                                
                                <div class="action-button" onclick="app.showAddCustomerForm()">
                                    <div class="action-icon">üë§</div>
                                    <div class="action-title">Th√™m kh√°ch h√†ng</div>
                                    <div class="action-desc">Th√™m th√¥ng tin kh√°ch h√†ng m·ªõi</div>
                                </div>
                                
                                <div class="action-button" onclick="app.showAddProductForm()">
                                    <div class="action-icon">üì¶</div>
                                    <div class="action-title">Th√™m s·∫£n ph·∫©m</div>
                                    <div class="action-desc">Th√™m s·∫£n ph·∫©m m·ªõi v√†o kho</div>
                                </div>
                                
                                <div class="action-button" onclick="app.loadPage('reports')">
                                    <div class="action-icon">üìä</div>
                                    <div class="action-title">Xem b√°o c√°o</div>
                                    <div class="action-desc">B√°o c√°o doanh thu v√† b√°n h√†ng</div>
                                </div>
                                

                            </div>
                        </div>
                        
                        <!-- Recent Activity -->
                        <div class="recent-activity">
                            <h2 class="section-title">Ho·∫°t ƒë·ªông g·∫ßn ƒë√¢y 
                                <button onclick="app.refreshActivities()" style="background: #059669; color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 12px; margin-left: 8px;" title="Nh·∫•n ƒë·ªÉ c·∫≠p nh·∫≠t th·ªùi gian th·ª±c">üîÑ REFRESH</button>
                                <span style="font-size: 12px; color: #666; margin-left: 8px;">[${this.formatVietnameseTime()}]</span>
                            </h2>
                            <div id="activities-container" data-timestamp="${Date.now()}">
                                ${this.getRecentActivities()}
                            </div>
                        </div>
                    </div>
                `;
            }
            
            getCustomersContent() {
                const customersTable = this.demoData.customers.map((customer, index) => {
                    // X√°c ƒë·ªãnh lo·∫°i kh√°ch h√†ng v√† icon t∆∞∆°ng ·ª©ng
                    const typeDisplay = customer.type === 'doanh-nghiep' ? 'üè¢ Doanh nghi·ªáp' : 'üë§ C√° nh√¢n';
                    const iconClass = customer.type === 'doanh-nghiep' ? 'warning' : 'info';
                    const iconSymbol = customer.type === 'doanh-nghiep' ? 'üè¢' : 'üë§';
                    
                    // Th√¥ng tin b·ªï sung cho doanh nghi·ªáp
                    const companyInfo = customer.type === 'doanh-nghiep' && customer.companyName ? 
                        ` | C√¥ng ty: ${customer.companyName}` : '';
                    const departmentInfo = customer.type === 'doanh-nghiep' && customer.department ? 
                        ` | Ph√≤ng ban: ${customer.department}` : '';
                    const taxCodeInfo = customer.type === 'doanh-nghiep' && customer.taxCode ? 
                        ` | MST: ${customer.taxCode}` : '';
                    
                    return `
                        <div class="activity-item">
                            <div class="activity-icon ${iconClass}">${iconSymbol}</div>
                            <div class="activity-content">
                                <div class="activity-title">${customer.name} (${customer.id})</div>
                                <div class="activity-desc">${typeDisplay}${companyInfo}${departmentInfo}${taxCodeInfo}</div>
                                <div class="activity-desc">üìû ${customer.phone} | üìß ${customer.email} | üìç ${customer.address}</div>
                            </div>
                            <div style="display: flex; gap: 8px; align-items: center;">
                                <div class="activity-time">${customer.debt > 0 ? `N·ª£: ${customer.debt.toLocaleString('vi-VN')} VNƒê` : 'Kh√¥ng n·ª£'}</div>
                                <button onclick="app.showCustomerDetails(${index})" style="background: #059669; color: white; padding: 4px 8px; border: none; border-radius: 4px; cursor: pointer;">Chi ti·∫øt</button>
                                <button onclick="app.editCustomer(${index})" style="background: #3b82f6; color: white; padding: 4px 8px; border: none; border-radius: 4px; cursor: pointer;">S·ª≠a</button>
                                <button onclick="app.deleteCustomer(${index})" style="background: #ef4444; color: white; padding: 4px 8px; border: none; border-radius: 4px; cursor: pointer;">X√≥a</button>
                            </div>
                        </div>
                    `;
                }).join('');
                
                return `
                    <div class="fade-in">
                        <div class="quick-actions">
                            <h2 class="section-title">Danh s√°ch Kh√°ch h√†ng (${this.demoData.customers.length})</h2>
                            <div class="action-grid" style="margin-bottom: 24px;">
                                <div class="action-button" onclick="app.showAddCustomerForm()">
                                    <div class="action-icon">üë§‚ûï</div>
                                    <div class="action-title">Th√™m kh√°ch h√†ng</div>
                                </div>
                                <div class="action-button" onclick="app.showSearchCustomer()">
                                    <div class="action-icon">üîç</div>
                                    <div class="action-title">T√¨m ki·∫øm</div>
                                </div>
                                <div class="action-button" onclick="app.exportCustomers()">
                                    <div class="action-icon">üìä</div>
                                    <div class="action-title">Xu·∫•t b√°o c√°o</div>
                                </div>
                            </div>
                            
                            <!-- Search Box -->
                            <div id="search-box" style="display: none; margin-bottom: 20px;">
                                <input type="text" id="customer-search" placeholder="T√¨m theo t√™n, ƒëi·ªán tho·∫°i ho·∫∑c email..." 
                                       style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 16px;"
                                       onkeyup="app.searchCustomers(this.value)">
                            </div>
                            
                            <div id="customers-list">
                                ${customersTable}
                            </div>
                        </div>
                    </div>
                `;
            }
            
            getSuppliersContent() {
                const suppliersTable = this.demoData.suppliers.map((supplier, index) => {
                    const typeDisplay = supplier.type === 'doanh-nghiep' ? 'üè¢ Doanh nghi·ªáp' : 'üë§ C√° nh√¢n';
                    const taxDisplay = supplier.taxCode ? ` | üÜî MST: ${supplier.taxCode}` : '';
                    const codeDisplay = supplier.supplierCode ? ` | üìã M√£: ${supplier.supplierCode}` : '';
                    const bankDisplay = supplier.bankAccount ? ` | üè¶ ${supplier.bankName}` : '';
                    
                    return `
                        <div class="activity-item">
                            <div class="activity-icon ${supplier.type === 'doanh-nghiep' ? 'warning' : 'success'}">üè¢</div>
                            <div class="activity-content">
                                <div class="activity-title">${supplier.name} (${supplier.id})</div>
                                <div class="activity-desc">${typeDisplay}${codeDisplay}${taxDisplay}</div>
                                <div class="activity-desc">üìû ${supplier.phone} | üìß ${supplier.email || 'Ch∆∞a c√≥'}${bankDisplay}</div>
                                ${supplier.notes ? `<div class="activity-desc">üìù ${supplier.notes}</div>` : ''}
                            </div>
                            <div style="display: flex; gap: 8px; align-items: center;">
                                <div class="activity-time">${supplier.products}</div>
                                <button onclick="app.editSupplier(${index})" style="background: var(--primary-blue); color: white; padding: 4px 8px; border: none; border-radius: 4px; cursor: pointer;">S·ª≠a</button>
                                <button onclick="app.deleteSupplier(${index})" style="background: #ef4444; color: white; padding: 4px 8px; border: none; border-radius: 4px; cursor: pointer;">X√≥a</button>
                            </div>
                        </div>
                    `;
                }).join('');
                
                return `
                    <div class="fade-in">
                        <div class="quick-actions">
                            <h2 class="section-title">Danh s√°ch Nh√† cung c·∫•p (${this.demoData.suppliers.length})</h2>
                            <div class="action-grid" style="margin-bottom: 24px;">
                                <div class="action-button" onclick="app.showAddSupplierForm()">
                                    <div class="action-icon">üè¢‚ûï</div>
                                    <div class="action-title">Th√™m nh√† cung c·∫•p</div>
                                </div>
                                <div class="action-button" onclick="app.showSupplierSearch()">
                                    <div class="action-icon">üîç</div>
                                    <div class="action-title">T√¨m ki·∫øm</div>
                                </div>
                                <div class="action-button" onclick="app.showCreatePurchaseForm()">
                                    <div class="action-icon">üõí</div>
                                    <div class="action-title">T·∫°o ƒë∆°n mua</div>
                                </div>
                            </div>
                            ${suppliersTable}
                        </div>
                    </div>
                `;
            }
            
            getProductsContent() {
                const productsTable = this.demoData.products.map((product, index) => `
                    <div class="activity-item">
                        <div class="activity-icon ${product.stock < 10 ? 'warning' : 'success'}">üì¶</div>
                        <div class="activity-content">
                            <div class="activity-title">${product.name} (${product.id})</div>
                            <div class="activity-desc">üí∞ B√°n: ${product.price.toLocaleString('vi-VN')} VNƒê | üí∏ Nh·∫≠p: ${product.importPrice?.toLocaleString('vi-VN') || 'N/A'} VNƒê | üìÇ ${product.category}</div>
                        </div>
                        <div style="display: flex; gap: 8px; align-items: center;">
                            <div class="activity-time">T·ªìn: ${product.stock} ${product.stock < 10 ? '‚ö†Ô∏è' : '‚úÖ'}</div>
                            <button onclick="app.deleteProduct(${index})" style="background: #ef4444; color: white; padding: 4px 8px; border: none; border-radius: 4px; cursor: pointer;">X√≥a</button>
                        </div>
                    </div>
                `).join('');
                
                return `
                    <div class="fade-in">
                        <div class="stats-grid" style="margin-bottom: 24px;">
                            <div class="stat-card products">
                                <div class="stat-header">
                                    <span class="stat-title">T·ªïng s·∫£n ph·∫©m</span>
                                    <span class="stat-icon">üì¶</span>
                                </div>
                                <div class="stat-value">${this.demoData.products.length}</div>
                                <div class="stat-change positive">ƒêang kinh doanh</div>
                            </div>
                            
                            <div class="stat-card warning">
                                <div class="stat-header">
                                    <span class="stat-title">S·∫Øp h·∫øt h√†ng</span>
                                    <span class="stat-icon">‚ö†Ô∏è</span>
                                </div>
                                <div class="stat-value">${this.demoData.products.filter(p => p.stock < 10).length}</div>
                                <div class="stat-change negative">C·∫ßn nh·∫≠p th√™m</div>
                            </div>
                        </div>
                        
                        <div class="quick-actions">
                            <h2 class="section-title">Danh s√°ch S·∫£n ph·∫©m</h2>
                            <div class="action-grid" style="margin-bottom: 24px; grid-template-columns: repeat(5, 1fr);">
                                <div class="action-button" onclick="app.showAddProductForm()">
                                    <div class="action-icon">üì¶‚ûï</div>
                                    <div class="action-title">Th√™m s·∫£n ph·∫©m</div>
                                </div>
                                <div class="action-button" onclick="app.showUpdatePriceForm()">
                                    <div class="action-icon">üí∞</div>
                                    <div class="action-title">C·∫≠p nh·∫≠t gi√°</div>
                                </div>
                                <div class="action-button" onclick="app.showStockUpdateForm()">
                                    <div class="action-icon">üìä</div>
                                    <div class="action-title">Nh·∫≠p kho</div>
                                </div>
                                <div class="action-button" onclick="app.backupProductsToExcel()">
                                    <div class="action-icon">üì•</div>
                                    <div class="action-title">Backup Excel</div>
                                </div>
                                <div class="action-button" onclick="app.showUploadProductsForm()">
                                    <div class="action-icon">üì§</div>
                                    <div class="action-title">Upload Excel</div>
                                </div>
                            </div>
                            ${productsTable}
                        </div>
                    </div>
                `;
            }
            
            getInventoryContent() {
                // T√≠nh to√°n c√°c th·ªëng k√™ t·ªìn kho
                const totalValue = this.demoData.products.reduce((sum, p) => sum + (p.stock * p.importPrice), 0);
                const lowStockProducts = this.demoData.products.filter(p => p.stock <= p.minStock);
                const outOfStockProducts = this.demoData.products.filter(p => p.stock === 0);
                const overStockProducts = this.demoData.products.filter(p => p.stock > p.minStock * 3);
                
                return `
                    <div class="fade-in">
                        <!-- C·∫£nh b√°o h√†ng s·∫Øp h·∫øt -->
                        ${lowStockProducts.length > 0 ? `
                        <div style="background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); border: 2px solid #f59e0b; border-radius: 12px; padding: 20px; margin-bottom: 24px;">
                            <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 16px;">
                                <span style="font-size: 24px;">‚ö†Ô∏è</span>
                                <div>
                                    <h3 style="margin: 0; color: #92400e; font-size: 18px;">C·∫£nh b√°o: ${lowStockProducts.length} s·∫£n ph·∫©m s·∫Øp h·∫øt h√†ng!</h3>
                                    <p style="margin: 4px 0 0 0; color: #a16207; font-size: 14px;">C√°c s·∫£n ph·∫©m d∆∞·ªõi ƒë√¢y ƒë√£ d∆∞·ªõi ng∆∞·ª°ng t·ªìn kho t·ªëi thi·ªÉu</p>
                                </div>
                            </div>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 12px;">
                                ${lowStockProducts.map(p => `
                                    <div style="background: white; padding: 12px; border-radius: 8px; border: 1px solid #f59e0b;">
                                        <div style="font-weight: 600; color: #1f2937; margin-bottom: 4px;">${p.name}</div>
                                        <div style="color: #ef4444; font-size: 14px;">T·ªìn: ${p.stock} / T·ªëi thi·ªÉu: ${p.minStock}</div>
                                        <div style="color: #6b7280; font-size: 12px;">C·∫ßn nh·∫≠p: ${p.minStock - p.stock + 10} s·∫£n ph·∫©m</div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                        ` : ''}
                        
                        <div class="stats-grid" style="margin-bottom: 24px;">
                            <div class="stat-card success">
                                <div class="stat-header">
                                    <span class="stat-title">T·ªïng gi√° tr·ªã kho</span>
                                    <span class="stat-icon">üíé</span>
                                </div>
                                <div class="stat-value">${totalValue.toLocaleString('vi-VN')} VNƒê</div>
                                <div class="stat-change positive">${this.demoData.products.length} s·∫£n ph·∫©m</div>
                            </div>
                            
                            <div class="stat-card ${lowStockProducts.length > 0 ? 'warning' : 'success'}">
                                <div class="stat-header">
                                    <span class="stat-title">H√†ng s·∫Øp h·∫øt</span>
                                    <span class="stat-icon">‚ö†Ô∏è</span>
                                </div>
                                <div class="stat-value">${lowStockProducts.length}</div>
                                <div class="stat-change ${lowStockProducts.length > 0 ? 'negative' : 'positive'}">
                                    ${lowStockProducts.length > 0 ? 'C·∫ßn nh·∫≠p ngay' : 'T·ªìn kho ·ªïn ƒë·ªãnh'}
                                </div>
                            </div>
                            
                            <div class="stat-card ${outOfStockProducts.length > 0 ? 'danger' : 'info'}">
                                <div class="stat-header">
                                    <span class="stat-title">H·∫øt h√†ng</span>
                                    <span class="stat-icon">üö´</span>
                                </div>
                                <div class="stat-value">${outOfStockProducts.length}</div>
                                <div class="stat-change ${outOfStockProducts.length > 0 ? 'negative' : 'positive'}">
                                    ${outOfStockProducts.length > 0 ? 'Kh√¥ng th·ªÉ b√°n' : 'Kh√¥ng c√≥'}
                                </div>
                            </div>
                            
                            <div class="stat-card info">
                                <div class="stat-header">
                                    <span class="stat-title">D∆∞ th·ª´a</span>
                                    <span class="stat-icon">üìà</span>
                                </div>
                                <div class="stat-value">${overStockProducts.length}</div>
                                <div class="stat-change positive">C√¢n nh·∫Øc gi·∫£m gi√°</div>
                            </div>
                        </div>
                        
                        <div class="quick-actions">
                            <h2 class="section-title">Qu·∫£n l√Ω T·ªìn kho</h2>
                            <div class="action-grid" style="margin-bottom: 24px;">
                                <div class="action-button" onclick="app.showStockUpdateForm()">
                                    <div class="action-icon">üì•</div>
                                    <div class="action-title">Nh·∫≠p kho</div>
                                </div>
                                <div class="action-button" onclick="app.showStockExportForm()">
                                    <div class="action-icon">üì§</div>
                                    <div class="action-title">Xu·∫•t kho</div>
                                </div>
                                <div class="action-button" onclick="app.exportInventoryReport()">
                                    <div class="action-icon">üìã</div>
                                    <div class="action-title">Ki·ªÉm k√™</div>
                                </div>
                            </div>
                            
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                                <h3 style="margin: 0; color: var(--text-primary);">Danh s√°ch s·∫£n ph·∫©m trong kho</h3>
                                <div style="display: flex; gap: 8px; font-size: 12px;">
                                    <span style="display: flex; align-items: center; gap: 4px;"><span style="width: 8px; height: 8px; background: #ef4444; border-radius: 50%; display: inline-block;"></span>S·∫Øp h·∫øt</span>
                                    <span style="display: flex; align-items: center; gap: 4px;"><span style="width: 8px; height: 8px; background: #f59e0b; border-radius: 50%; display: inline-block;"></span>√çt h√†ng</span>
                                    <span style="display: flex; align-items: center; gap: 4px;"><span style="width: 8px; height: 8px; background: #10b981; border-radius: 50%; display: inline-block;"></span>ƒê·ªß h√†ng</span>
                                </div>
                            </div>
                            
                            <div style="background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                                <div style="display: grid; grid-template-columns: 2fr 1fr 1fr 1fr 1fr 100px; gap: 16px; padding: 16px; background: #f8fafc; font-weight: 600; color: #374151; border-bottom: 1px solid #e5e7eb;">
                                    <div>S·∫£n ph·∫©m</div>
                                    <div>Gi√° b√°n</div>
                                    <div>T·ªìn kho</div>
                                    <div>T·ªëi thi·ªÉu</div>
                                    <div>Tr·∫°ng th√°i</div>
                                    <div>Thao t√°c</div>
                                </div>
                                ${this.demoData.products.map((product, index) => {
                                    const stockStatus = product.stock === 0 ? 'out' : product.stock <= product.minStock ? 'low' : product.stock <= product.minStock * 1.5 ? 'warning' : 'good';
                                    const statusColor = stockStatus === 'out' ? '#ef4444' : stockStatus === 'low' ? '#ef4444' : stockStatus === 'warning' ? '#f59e0b' : '#10b981';
                                    const statusText = stockStatus === 'out' ? 'H·∫øt h√†ng' : stockStatus === 'low' ? 'S·∫Øp h·∫øt' : stockStatus === 'warning' ? '√çt h√†ng' : 'ƒê·ªß h√†ng';
                                    const statusIcon = stockStatus === 'out' ? 'üö´' : stockStatus === 'low' ? '‚ö†Ô∏è' : stockStatus === 'warning' ? '‚ö°' : '‚úÖ';
                                    
                                    return `
                                        <div style="display: grid; grid-template-columns: 2fr 1fr 1fr 1fr 1fr 100px; gap: 16px; padding: 16px; border-bottom: 1px solid #f1f5f9; align-items: center; ${index % 2 === 0 ? 'background: #fafbfc;' : 'background: white;'}">
                                            <div>
                                                <div style="font-weight: 600; color: #1f2937; margin-bottom: 4px;">${product.name}</div>
                                                <div style="font-size: 12px; color: #6b7280;">${product.id} ‚Ä¢ ${product.category}</div>
                                            </div>
                                            <div style="font-weight: 500; color: #1f2937;">
                                                ${product.price.toLocaleString('vi-VN')} VNƒê
                                            </div>
                                            <div style="font-weight: 600; color: ${statusColor};">
                                                ${product.stock}
                                            </div>
                                            <div style="color: #6b7280;">
                                                ${product.minStock}
                                            </div>
                                            <div style="display: flex; align-items: center; gap: 6px;">
                                                <span style="font-size: 16px;">${statusIcon}</span>
                                                <span style="color: ${statusColor}; font-weight: 500; font-size: 13px;">${statusText}</span>
                                            </div>
                                            <button onclick="app.showProductDetail('${product.id}')" style="background: #3b82f6; color: white; border: none; padding: 6px 12px; border-radius: 6px; font-size: 12px; cursor: pointer; font-weight: 500;">
                                                Chi ti·∫øt
                                            </button>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                    </div>
                `;
            }
            
            getSalesContent() {
                const salesTable = this.demoData.sales.map(sale => `
                    <div class="activity-item">
                        <div class="activity-icon ${sale.status === 'Ho√†n th√†nh' ? 'success' : sale.status === 'Ch·ªù x·ª≠ l√Ω' ? 'warning' : 'info'}">üí∞</div>
                        <div class="activity-content">
                            <div class="activity-title">ƒê∆°n h√†ng ${sale.id} - ${sale.customer}</div>
                            <div class="activity-desc">üí∞ ${sale.total.toLocaleString('vi-VN')} VNƒê | üì¶ ${sale.items} s·∫£n ph·∫©m | üìû ${sale.customPhuocIThone || ''} | üìÖ ${sale.date}</div>
                        </div>
                        <div class="activity-time">${sale.status}</div>
                    </div>
                `).join('');
                
                const totalRevenue = this.demoData.sales.reduce((sum, sale) => sum + sale.total, 0);
                
                return `
                    <div class="fade-in">
                        <div class="stats-grid" style="margin-bottom: 24px;">
                            <div class="stat-card revenue">
                                <div class="stat-header">
                                    <span class="stat-title">T·ªïng doanh thu</span>
                                    <span class="stat-icon">üí∞</span>
                                </div>
                                <div class="stat-value">${totalRevenue.toLocaleString('vi-VN')} VNƒê</div>
                                <div class="stat-change positive">5 ƒë∆°n h√†ng</div>
                            </div>
                            
                            <div class="stat-card orders">
                                <div class="stat-header">
                                    <span class="stat-title">ƒê∆°n ho√†n th√†nh</span>
                                    <span class="stat-icon">‚úÖ</span>
                                </div>
                                <div class="stat-value">${this.demoData.sales.filter(s => s.status === 'Ho√†n th√†nh').length}</div>
                                <div class="stat-change positive">ƒê√£ thanh to√°n</div>
                            </div>
                        </div>
                        
                        <div class="quick-actions">
                            <h2 class="section-title">Qu·∫£n l√Ω B√°n h√†ng</h2>
                            <div class="action-grid" style="margin-bottom: 24px;">
                                <div class="action-button" onclick="app.showCreateOrderForm()">
                                    <div class="action-icon">üìù</div>
                                    <div class="action-title">T·∫°o ƒë∆°n h√†ng</div>
                                </div>
                                <div class="action-button" onclick="app.exportSalesReport()">
                                    <div class="action-icon">üìä</div>
                                    <div class="action-title">B√°o c√°o doanh thu</div>
                                </div>
                                <div class="action-button" onclick="app.showPromotionForm()">
                                    <div class="action-icon">üéÅ</div>
                                    <div class="action-title">Khuy·∫øn m√£i</div>
                                </div>
                            </div>
                            ${salesTable}
                        </div>
                    </div>
                `;
            }
            
            getPurchasesContent() {
                return `
                    <div class="fade-in">
                        <div class="quick-actions">
                            <h2 class="section-title">Qu·∫£n l√Ω Mua h√†ng</h2>
                            <div class="action-grid" style="margin-bottom: 24px;">
                                <div class="action-button" onclick="app.showCreatePurchaseForm()">
                                    <div class="action-icon">üõí</div>
                                    <div class="action-title">T·∫°o ƒë∆°n mua</div>
                                </div>
                                <div class="action-button" onclick="app.loadPage('suppliers')">
                                    <div class="action-icon">üè¢</div>
                                    <div class="action-title">Nh√† cung c·∫•p</div>
                                </div>
                                <div class="action-button" onclick="app.exportPurchaseReport()">
                                    <div class="action-icon">üìä</div>
                                    <div class="action-title">B√°o c√°o chi ph√≠</div>
                                </div>
                            </div>
                            
                            <div class="activity-item">
                                <div class="activity-icon info">üõí</div>
                                <div class="activity-content">
                                    <div class="activity-title">ƒê∆°n mua h√†ng DM001 - C√¥ng ty TNHH ABC</div>
                                    <div class="activity-desc">üí∞ 15.500.000 ƒë | üì¶ 50 s·∫£n ph·∫©m | üìÖ 2025-01-08</div>
                                </div>
                                <div class="activity-time">ƒêang ch·ªù duy·ªát</div>
                            </div>
                            
                            <div class="activity-item">
                                <div class="activity-icon success">‚úÖ</div>
                                <div class="activity-content">
                                    <div class="activity-title">ƒê∆°n mua h√†ng DM002 - C√¥ng ty XYZ</div>
                                    <div class="activity-desc">üí∞ 8.200.000 ƒë | üì¶ 25 s·∫£n ph·∫©m | üìÖ 2025-01-07</div>
                                </div>
                                <div class="activity-time">ƒê√£ nh·∫≠n h√†ng</div>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            getDebtsContent() {
                const totalCustomerDebt = this.demoData.customers.reduce((sum, customer) => sum + customer.debt, 0);
                const customersWithDebt = this.demoData.customers.filter(c => c.debt > 0);
                
                return `
                    <div class="fade-in">
                        <div class="stats-grid" style="margin-bottom: 24px;">
                            <div class="stat-card warning">
                                <div class="stat-header">
                                    <span class="stat-title">T·ªïng c√¥ng n·ª£</span>
                                    <span class="stat-icon">üí≥</span>
                                </div>
                                <div class="stat-value">${totalCustomerDebt.toLocaleString('vi-VN')} VNƒê</div>
                                <div class="stat-change negative">${customersWithDebt.length} kh√°ch h√†ng</div>
                            </div>
                            
                            <div class="stat-card info">
                                <div class="stat-header">
                                    <span class="stat-title">ƒê√£ thu h√¥m nay</span>
                                    <span class="stat-icon">üí∞</span>
                                </div>
                                <div class="stat-value">2.100.000 VNƒê</div>
                                <div class="stat-change positive">3 l·∫ßn thu</div>
                            </div>
                        </div>
                        
                        <div class="quick-actions">
                            <h2 class="section-title">Qu·∫£n l√Ω C√¥ng n·ª£</h2>
                            <div class="action-grid" style="margin-bottom: 24px;">
                                <div class="action-button" onclick="app.exportDebtReport()">
                                    <div class="action-icon">üìû</div>
                                    <div class="action-title">Nh·∫Øc n·ª£</div>
                                </div>
                            </div>
                            
                            <h3 style="margin-bottom: 16px; color: var(--text-primary);">Kh√°ch h√†ng c√≥ c√¥ng n·ª£:</h3>
                            ${customersWithDebt.map(customer => `
                                <div class="activity-item">
                                    <div class="activity-icon warning">üí≥</div>
                                    <div class="activity-content">
                                        <div class="activity-title">${customer.name} (${customer.id})</div>
                                        <div class="activity-desc">üìû ${customer.phone} | üìç ${customer.address}</div>
                                    </div>
                                    <div style="display: flex; gap: 8px; align-items: center;">
                                        <div class="activity-time" style="color: #dc2626; font-weight: bold;">
                                            ${customer.debt.toLocaleString('vi-VN')} VNƒê
                                        </div>
                                        <button ondblclick="app.toggleCustomerDebtStatus('${customer.id}')" style="
                                            background: #f59e0b; 
                                            color: white; 
                                            border: none; 
                                            padding: 6px 12px; 
                                            border-radius: 6px; 
                                            cursor: pointer; 
                                            font-size: 12px; 
                                            font-weight: 600;
                                            margin-right: 4px;
                                            transition: all 0.3s ease;
                                        " title="Double click ƒë·ªÉ chuy·ªÉn tr·∫°ng th√°i">
                                            C√¥ng n·ª£
                                        </button>
                                        <button onclick="app.showPaymentFormForCustomer('${customer.id}')" style="
                                            background: var(--primary-blue); 
                                            color: white; 
                                            border: none; 
                                            padding: 6px 12px; 
                                            border-radius: 6px; 
                                            cursor: pointer; 
                                            font-size: 12px; 
                                            font-weight: 600;
                                            margin-right: 4px;
                                        ">
                                            Ghi nh·∫≠n thanh to√°n
                                        </button>
                                        <button onclick="app.showCustomerDebtDetail('${customer.id}')" style="
                                            background: #059669; 
                                            color: white; 
                                            border: none; 
                                            padding: 6px 12px; 
                                            border-radius: 6px; 
                                            cursor: pointer; 
                                            font-size: 12px; 
                                            font-weight: 600;
                                        ">
                                            Chi ti·∫øt
                                        </button>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }
            
            getOrdersContent() {
                // S·ª≠ d·ª•ng ng√†y hi·ªán t·∫°i theo m√∫i gi·ªù Vi·ªát Nam (UTC+7)
                const vietnamTime = this.getVietnamTime();
                const todayStr = vietnamTime.toISOString().split('T')[0];
                const todayOrders = this.demoData.orders.filter(order => order.date === todayStr);
                const weekOrders = this.demoData.orders.filter(order => {
                    const orderDate = new Date(order.date);
                    const today = new Date(vietnamTime);
                    const weekAgo = new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000);
                    return orderDate >= weekAgo && orderDate <= today;
                });
                const monthOrders = this.demoData.orders.filter(order => {
                    const orderDate = new Date(order.date);
                    const today = new Date(vietnamTime);
                    return orderDate.getMonth() === today.getMonth() && orderDate.getFullYear() === today.getFullYear();
                });

                // ƒê∆°n h√†ng ƒë√£ ƒë∆∞·ª£c s·∫Øp x·∫øp s·∫µn (m·ªõi nh·∫•t ·ªü ƒë·∫ßu) nh·ªù unshift() trong createOrder()
                const sortedOrders = this.demoData.orders; // Kh√¥ng c·∫ßn reverse v√¨ ƒë√£ unshift()
                console.log('üìã Danh s√°ch ƒë∆°n h√†ng (m·ªõi nh·∫•t ·ªü ƒë·∫ßu):', sortedOrders.map(o => `${o.id} (${o.date} ${o.time})`));

                const ordersTable = sortedOrders.map((order, index) => {
                    const originalIndex = this.demoData.orders.findIndex(o => o.id === order.id);
                    return `
                    <tr data-order-index="${originalIndex}">
                        <td style="padding: 12px; border-bottom: 1px solid #e5e7eb;">${order.id}</td>
                        <td style="padding: 12px; border-bottom: 1px solid #e5e7eb;">${order.customerName}</td>
                        <td style="padding: 12px; border-bottom: 1px solid #e5e7eb;">${order.date} ${order.time}</td>
                        <td style="padding: 12px; border-bottom: 1px solid #e5e7eb;">${order.total.toLocaleString('vi-VN')} VNƒê</td>
                        <td style="padding: 12px; border-bottom: 1px solid #e5e7eb;">${order.paymentMethod}</td>
                        <td class="payment-cell" style="padding: 12px; border-bottom: 1px solid #e5e7eb;">
                            <button ondblclick="app.togglePaymentStatus(${originalIndex})" style="
                                background: ${order.paymentStatus === 'ƒê√£ thanh to√°n' ? '#22c55e' : '#f59e0b'}; 
                                color: white; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: 600;
                                transition: all 0.3s ease;
                            ">
                                ${order.paymentStatus === 'ƒê√£ thanh to√°n' ? '‚úì ƒê√£ TT' : 'C√¥ng n·ª£'}
                            </button>
                        </td>
                        <td style="padding: 12px; border-bottom: 1px solid #e5e7eb;">
                            <button onclick="app.showPrintOptionsPopup(${originalIndex})" style="background: var(--primary-green); color: white; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; margin-right: 4px; font-weight: 600;" title="In h√≥a ƒë∆°n">IN</button>
                            <button onclick="app.viewOrderDetails(${originalIndex})" style="background: var(--primary-blue); color: white; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; margin-right: 4px;">Chi ti·∫øt</button>
                            <button onclick="app.deleteOrder(${originalIndex})" style="background: #ef4444; color: white; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer;">X√≥a</button>
                        </td>
                    </tr>
                    `;
                }).join('');

                return `
                    <div class="fade-in">
                        <!-- Stats Grid -->
                        <div class="stats-grid" style="margin-bottom: 24px;">
                            <div class="stat-card info">
                                <div class="stat-header">
                                    <span class="stat-title">ƒê∆°n h√†ng h√¥m nay</span>
                                    <span class="stat-icon">üìã</span>
                                </div>
                                <div class="stat-value">${todayOrders.length}</div>
                                <div class="stat-change">T·ªïng: ${todayOrders.reduce((sum, order) => sum + order.total, 0).toLocaleString('vi-VN')} VNƒê</div>
                            </div>
                            
                            <div class="stat-card success">
                                <div class="stat-header">
                                    <span class="stat-title">ƒê∆°n h√†ng tu·∫ßn n√†y</span>
                                    <span class="stat-icon">üìä</span>
                                </div>
                                <div class="stat-value">${weekOrders.length}</div>
                                <div class="stat-change">T·ªïng: ${weekOrders.reduce((sum, order) => sum + order.total, 0).toLocaleString('vi-VN')} VNƒê</div>
                            </div>
                            
                            <div class="stat-card revenue">
                                <div class="stat-header">
                                    <span class="stat-title">ƒê∆°n h√†ng th√°ng n√†y</span>
                                    <span class="stat-icon">üí∞</span>
                                </div>
                                <div class="stat-value">${monthOrders.length}</div>
                                <div class="stat-change">T·ªïng: ${monthOrders.reduce((sum, order) => sum + order.total, 0).toLocaleString('vi-VN')} VNƒê</div>
                            </div>
                            
                            <div class="stat-card orders">
                                <div class="stat-header">
                                    <span class="stat-title">T·ªïng ƒë∆°n h√†ng</span>
                                    <span class="stat-icon">üìà</span>
                                </div>
                                <div class="stat-value">${this.demoData.orders.length}</div>
                                <div class="stat-change">T·∫•t c·∫£ th·ªùi gian</div>
                            </div>
                        </div>
                        
                        <div class="quick-actions">
                            <h2 class="section-title">Qu·∫£n l√Ω ƒë∆°n h√†ng</h2>
                            <div class="action-grid" style="margin-bottom: 24px;">
                                <div class="action-button" onclick="app.showCreateOrderForm()">
                                    <div class="action-icon">üìù</div>
                                    <div class="action-title">T·∫°o ƒë∆°n h√†ng m·ªõi</div>
                                </div>
                                <div class="action-button" onclick="event.stopPropagation(); app.filterOrdersByPeriod('today');">
                                    <div class="action-icon">üìÖ</div>
                                    <div class="action-title">ƒê∆°n h√†ng h√¥m nay</div>
                                </div>
                                <div class="action-button" onclick="event.stopPropagation(); app.filterOrdersByPeriod('week');">
                                    <div class="action-icon">üìä</div>
                                    <div class="action-title">ƒê∆°n h√†ng tu·∫ßn</div>
                                </div>
                                <div class="action-button" onclick="app.exportOrdersReport()">
                                    <div class="action-icon">üìã</div>
                                    <div class="action-title">Xu·∫•t b√°o c√°o</div>
                                </div>
                            </div>
                            
                            <div style="background: white; border-radius: 12px; padding: 24px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                                <h3 style="margin-bottom: 16px; color: var(--text-primary); display: flex; align-items: center; gap: 8px;">
                                    <span>üìã</span> Danh s√°ch ƒë∆°n h√†ng (${this.demoData.orders.length})
                                </h3>
                                
                                <div style="margin-bottom: 16px;">
                                    <input type="text" id="order-search" placeholder="T√¨m ki·∫øm theo m√£ ƒë∆°n, kh√°ch h√†ng..." 
                                           style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 14px;"
                                           oninput="app.searchOrders(this.value)">
                                </div>
                                
                                <div style="overflow-x: auto;">
                                    <table id="orders-table" style="width: 100%; border-collapse: collapse; background: white;">
                                        <thead>
                                            <tr style="background: #f8fafc;">
                                                <th style="padding: 12px; text-align: left; border-bottom: 2px solid #e5e7eb; font-weight: 600;">M√£ ƒë∆°n</th>
                                                <th style="padding: 12px; text-align: left; border-bottom: 2px solid #e5e7eb; font-weight: 600;">Kh√°ch h√†ng</th>
                                                <th style="padding: 12px; text-align: left; border-bottom: 2px solid #e5e7eb; font-weight: 600;">Th·ªùi gian</th>
                                                <th style="padding: 12px; text-align: left; border-bottom: 2px solid #e5e7eb; font-weight: 600;">T·ªïng ti·ªÅn</th>
                                                <th style="padding: 12px; text-align: left; border-bottom: 2px solid #e5e7eb; font-weight: 600;">Thanh to√°n</th>
                                                <th style="padding: 12px; text-align: left; border-bottom: 2px solid #e5e7eb; font-weight: 600;">TT Nhanh</th>
                                                <th style="padding: 12px; text-align: left; border-bottom: 2px solid #e5e7eb; font-weight: 600;">Thao t√°c</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${ordersTable}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }

            getReportsContent() {
                return `
                    <div class="fade-in">
                        <!-- B·ªô l·ªçc ng√†y th√°ng -->
                        <div class="filter-section" style="background: white; border-radius: 12px; padding: 24px; margin-bottom: 24px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                            <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px;">
                                <h3 style="margin: 0; color: var(--text-primary); display: flex; align-items: center; gap: 8px;">
                                    <span>üìÖ</span> B·ªô l·ªçc th·ªùi gian
                                </h3>
                                <button onclick="app.toggleFilterSection()" style="background: none; border: 1px solid #e5e7eb; padding: 8px 12px; border-radius: 6px; cursor: pointer;">
                                    <span id="filter-toggle-icon">üìÅ</span> Thu g·ªçn
                                </button>
                            </div>
                            
                            <div id="filter-content" class="filter-content">
                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 16px;">
                                    <div>
                                        <label style="display: block; margin-bottom: 6px; font-weight: 600; color: var(--text-secondary);">T·ª´ ng√†y:</label>
                                        <input type="date" id="filter-from-date" value="${this.getDefaultFromDate()}" 
                                               style="width: 100%; padding: 8px 12px; border: 2px solid #e5e7eb; border-radius: 6px; font-size: 14px;">
                                    </div>
                                    
                                    <div>
                                        <label style="display: block; margin-bottom: 6px; font-weight: 600; color: var(--text-secondary);">ƒê·∫øn ng√†y:</label>
                                        <input type="date" id="filter-to-date" value="${this.getDefaultToDate()}" 
                                               style="width: 100%; padding: 8px 12px; border: 2px solid #e5e7eb; border-radius: 6px; font-size: 14px;">
                                    </div>
                                    
                                    <div>
                                        <label style="display: block; margin-bottom: 6px; font-weight: 600; color: var(--text-secondary);">L·ª±a ch·ªçn nhanh:</label>
                                        <select id="filter-quick-select" onchange="app.applyQuickFilter(this.value)"
                                                style="width: 100%; padding: 8px 12px; border: 2px solid #e5e7eb; border-radius: 6px; font-size: 14px;">
                                            <option value="">T√πy ch·ªânh</option>
                                            <option value="today">H√¥m nay</option>
                                            <option value="yesterday">H√¥m qua</option>
                                            <option value="this-week">Tu·∫ßn n√†y</option>
                                            <option value="last-week">Tu·∫ßn tr∆∞·ªõc</option>
                                            <option value="this-month">Th√°ng n√†y</option>
                                            <option value="last-month">Th√°ng tr∆∞·ªõc</option>
                                            <option value="last-30-days">30 ng√†y qua</option>
                                            <option value="last-90-days">90 ng√†y qua</option>
                                            <option value="this-year">NƒÉm n√†y</option>
                                            <option value="last-year">NƒÉm tr∆∞·ªõc</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <div style="display: flex; gap: 12px; align-items: center;">
                                    <button onclick="app.applyDateFilter()" 
                                            style="background: var(--primary-blue); color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-weight: 600;">
                                        üîç √Åp d·ª•ng b·ªô l·ªçc
                                    </button>
                                    <button onclick="app.resetDateFilter()" 
                                            style="background: white; color: var(--text-secondary); border: 2px solid #e5e7eb; padding: 10px 20px; border-radius: 6px; cursor: pointer;">
                                        üîÑ ƒê·∫∑t l·∫°i
                                    </button>
                                    <div id="filter-info" style="color: var(--text-secondary); font-size: 14px; margin-left: 8px;">
                                        Hi·ªÉn th·ªã d·ªØ li·ªáu t·ª´ <strong>${this.formatDateForDisplay(this.getDefaultFromDate())}</strong> ƒë·∫øn <strong>${this.formatDateForDisplay(this.getDefaultToDate())}</strong>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="stats-grid" style="margin-bottom: 24px;">
                            <div class="stat-card revenue">
                                <div class="stat-header">
                                    <span class="stat-title">Doanh thu th√°ng n√†y</span>
                                    <span class="stat-icon">üìà</span>
                                </div>
                                <div class="stat-value">125.800.000 VNƒê</div>
                                <div class="stat-change positive">+18.5% so v·ªõi th√°ng tr∆∞·ªõc</div>
                            </div>
                            
                            <div class="stat-card info">
                                <div class="stat-header">
                                    <span class="stat-title">L·ª£i nhu·∫≠n</span>
                                    <span class="stat-icon">üíé</span>
                                </div>
                                <div class="stat-value">45.200.000 VNƒê</div>
                                <div class="stat-change positive">Bi√™n l·ª£i nhu·∫≠n 35.9%</div>
                            </div>
                        </div>
                        
                        <div class="quick-actions">
                            <h2 class="section-title">B√°o c√°o v√† Th·ªëng k√™</h2>
                            <div class="action-grid" style="margin-bottom: 24px;">
                                <div class="action-button" onclick="app.exportSalesReport()">
                                    <div class="action-icon">üìä</div>
                                    <div class="action-title">B√°o c√°o doanh thu</div>
                                    <div class="action-desc">Theo ng√†y, tu·∫ßn, th√°ng</div>
                                </div>
                                
                                <div class="action-button" onclick="app.exportTopProductsReport()">
                                    <div class="action-icon">üí∞</div>
                                    <div class="action-title">B√°o c√°o b√°n h√†ng</div>
                                    <div class="action-desc">Top s·∫£n ph·∫©m b√°n ch·∫°y</div>
                                </div>
                                
                                <div class="action-button" onclick="app.exportInventoryReport()">
                                    <div class="action-icon">üì¶</div>
                                    <div class="action-title">B√°o c√°o t·ªìn kho</div>
                                    <div class="action-desc">Gi√° tr·ªã v√† s·ªë l∆∞·ª£ng</div>
                                </div>
                                
                                <div class="action-button" onclick="app.exportDebtReport()">
                                    <div class="action-icon">üí≥</div>
                                    <div class="action-title">B√°o c√°o c√¥ng n·ª£</div>
                                    <div class="action-desc">Theo kh√°ch h√†ng v√† nh√† cung c·∫•p</div>
                                </div>
                                
                                <div class="action-button" onclick="app.exportFinancialReport()">
                                    <div class="action-icon">üìã</div>
                                    <div class="action-title">B√°o c√°o t√†i ch√≠nh</div>
                                    <div class="action-desc">Theo chu·∫©n Vi·ªát Nam</div>
                                </div>
                                
                                <div class="action-button" onclick="app.showTrendAnalysis()">
                                    <div class="action-icon">üìà</div>
                                    <div class="action-title">Ph√¢n t√≠ch xu h∆∞·ªõng</div>
                                    <div class="action-desc">D·ª± b√°o v√† k·∫ø ho·∫°ch</div>
                                </div>
                            </div>
                            
                            <div class="recent-activity">
                                <h3 style="margin-bottom: 16px;">T√≥m t·∫Øt ho·∫°t ƒë·ªông kinh doanh:</h3>
                                <div class="activity-item">
                                    <div class="activity-icon success">üìà</div>
                                    <div class="activity-content">
                                        <div class="activity-title">TƒÉng tr∆∞·ªüng doanh thu</div>
                                        <div class="activity-desc">Doanh thu th√°ng n√†y tƒÉng 18.5% so v·ªõi th√°ng tr∆∞·ªõc, ƒë·∫°t 125.800.000 VNƒê</div>
                                    </div>
                                </div>
                                
                                <div class="activity-item">
                                    <div class="activity-icon info">üë•</div>
                                    <div class="activity-content">
                                        <div class="activity-title">Kh√°ch h√†ng m·ªõi</div>
                                        <div class="activity-desc">Th√°ng n√†y c√≥ ${this.demoData.customers.length} kh√°ch h√†ng, tƒÉng 5.1% so v·ªõi tu·∫ßn tr∆∞·ªõc</div>
                                    </div>
                                </div>
                                
                                <div class="activity-item">
                                    <div class="activity-icon warning">üì¶</div>
                                    <div class="activity-content">
                                        <div class="activity-title">Qu·∫£n l√Ω h√†ng t·ªìn kho</div>
                                        <div class="activity-desc">C√≥ ${this.demoData.products.filter(p => p.stock < 10).length} s·∫£n ph·∫©m s·∫Øp h·∫øt h√†ng c·∫ßn nh·∫≠p th√™m</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            getRecentActivities() {
                const activities = [];
                const now = this.getVietnamTime();
                
                // S·ª≠ d·ª•ng th·ªùi gian TH·ª∞C T·∫æ d·ª±a tr√™n ƒë∆°n h√†ng trong h·ªá th·ªëng
                const recentOrders = this.demoData.orders.slice(0, 3);
                
                recentOrders.forEach((order, index) => {
                    // T·∫°o th·ªùi gian th·ª±c t·∫ø d·ª±a tr√™n th·ªùi gian ƒë∆°n h√†ng
                    const orderDateTime = new Date(order.date + 'T' + order.time + ':00');
                    
                    // N·∫øu ƒë∆°n h√†ng l√† h√¥m nay, s·ª≠ d·ª•ng th·ªùi gian th·ª±c
                    const todayStr = now.toISOString().split('T')[0];
                    let activityTime;
                    
                    if (order.date === todayStr) {
                        // ƒê∆°n h√†ng h√¥m nay - s·ª≠ d·ª•ng th·ªùi gian th·ª±c t·ª´ gi·ªù trong ƒë∆°n h√†ng
                        activityTime = orderDateTime;
                    } else {
                        // ƒê∆°n h√†ng ng√†y kh√°c - t·∫°o th·ªùi gian gi·∫£ ƒë·ªãnh g·∫ßn ƒë√¢y
                        activityTime = new Date(now.getTime() - (30 + index * 45) * 60 * 1000);
                    }
                    
                    const icon = order.paymentStatus === 'ƒê√£ thanh to√°n' ? 'success' : 'info';
                    const emoji = order.paymentStatus === 'ƒê√£ thanh to√°n' ? 'üí∞' : 'üìã';
                    const title = order.paymentStatus === 'ƒê√£ thanh to√°n' ? 
                        `ƒê∆°n h√†ng ${order.id} ƒë√£ ho√†n th√†nh` : 
                        `ƒê∆°n h√†ng m·ªõi ${order.id}`;
                    const desc = order.paymentStatus === 'ƒê√£ thanh to√°n' ? 
                        `Kh√°ch h√†ng ${order.customerName} ƒë√£ thanh to√°n ${order.total.toLocaleString('vi-VN')} VNƒê` :
                        `Kh√°ch h√†ng ${order.customerName} ƒë·∫∑t h√†ng tr·ªã gi√° ${order.total.toLocaleString('vi-VN')} VNƒê`;
                        
                    activities.push({ icon, emoji, title, desc, time: activityTime });
                });
                
                // S·∫£n ph·∫©m s·∫Øp h·∫øt h√†ng
                const lowStockProducts = this.demoData.products.filter(p => p.stock < 10);
                if (lowStockProducts.length > 0) {
                    const product = lowStockProducts[0];
                    const timeAgo = new Date(now.getTime() - 2 * 60 * 60 * 1000); // 2 gi·ªù tr∆∞·ªõc TH·∫¨T
                    activities.push({
                        icon: 'warning',
                        emoji: '‚ö†Ô∏è',
                        title: 'S·∫£n ph·∫©m s·∫Øp h·∫øt h√†ng',
                        desc: `${product.name} ch·ªâ c√≤n ${product.stock} s·∫£n ph·∫©m trong kho`,
                        time: timeAgo
                    });
                }
                
                // Kh√°ch h√†ng c√≥ c√¥ng n·ª£
                const debtCustomers = this.demoData.customers.filter(c => c.debt > 0);
                if (debtCustomers.length > 0) {
                    const customer = debtCustomers[0];
                    const timeAgo = new Date(now.getTime() - 3 * 60 * 60 * 1000); // 3 gi·ªù tr∆∞·ªõc TH·∫¨T
                    activities.push({
                        icon: 'warning',
                        emoji: 'üí≥',
                        title: 'Nh·∫Øc n·ª£ kh√°ch h√†ng',
                        desc: `${customer.name} c√≥ c√¥ng n·ª£ ${customer.debt.toLocaleString('vi-VN')} VNƒê`,
                        time: timeAgo
                    });
                }
                
                console.log('üïê Th·ªùi gian Vi·ªát Nam hi·ªán t·∫°i:', this.formatVietnameseTime(now));
                console.log('üïê Ho·∫°t ƒë·ªông v·ªõi th·ªùi gian TH·ª∞C T·∫æ:', activities.map(a => {
                    const timeStr = this.getTimeAgo(a.time);
                    const actualTime = this.formatVietnameseTime(a.time);
                    return `${a.title} - ${timeStr} (th·ª±c t·∫ø: ${actualTime})`;
                }));
                console.log('üìù KI·ªÇM TRA: N·∫øu v·∫´n th·∫•y "ƒê∆°n h√†ng m·ªõi ƒë∆∞·ª£c t·∫°o" c√≥ nghƒ©a l√† ƒëang cache - h√£y nh·∫•n Ctrl+F5!');
                console.log('‚è∞ TH·ªúI GIAN HI·ªÜN T·∫†I:', this.formatVietnameseTime(now));
                
                // Th√™m th√¥ng b√°o n·∫øu c√≥ v·∫•n ƒë·ªÅ cache
                if (activities.length === 0) {
                    console.log('‚ùå WARNING: No activities generated - possible cache issue!');
                }
                
                return activities.slice(0, 5).map(activity => `
                    <div class="activity-item">
                        <div class="activity-icon ${activity.icon}">${activity.emoji}</div>
                        <div class="activity-content">
                            <div class="activity-title">${activity.title}</div>
                            <div class="activity-desc">${activity.desc}</div>
                        </div>
                        <div class="activity-time">${this.getTimeAgo(activity.time)}</div>
                    </div>
                `).join('');
            }
            
            getCompanyInfoContent() {
                // Get company settings from localStorage with debugging
                const companySettings = this.getCompanySettings();
                console.log('=== LOADING COMPANY INFO PAGE ===');
                console.log('Logo exists:', !!companySettings.logo);
                console.log('QR exists:', !!companySettings.qrCode);
                if (companySettings.logo) {
                    console.log('Logo data length:', companySettings.logo.length);
                }
                if (companySettings.qrCode) {
                    console.log('QR data length:', companySettings.qrCode.length);
                }
                
                return `
                    <div class="fade-in">
                        <!-- Company Information Settings -->
                        <div class="quick-actions" style="margin-bottom: 24px;">
                            <h2 class="section-title">üè¢ Th√¥ng tin C√¥ng ty/C·ª≠a h√†ng</h2>
                            
                            <!-- Logo v√† QR Code Section -->
                            <div style="background: white; padding: 24px; border-radius: 12px; border: 2px solid #e5e7eb; margin-bottom: 24px;">
                                <h3 style="margin-bottom: 16px; color: var(--text-primary); border-bottom: 2px solid #e5e7eb; padding-bottom: 8px;">üì∏ Logo & M√£ QR</h3>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px; align-items: start;">
                                    <!-- Logo Section -->
                                    <div style="text-align: center;">
                                        <h4 style="margin-bottom: 12px; color: var(--text-secondary);">Logo C√¥ng ty</h4>
                                        <div id="logo-display" style="border: 2px dashed #e5e7eb; border-radius: 8px; padding: 20px; margin-bottom: 12px; min-height: 150px; display: flex; align-items: center; justify-content: center; background: #f9fafb;">
                                            ${companySettings.logo ? 
                                                `<img src="${companySettings.logo}" alt="Logo" style="max-width: 100%; max-height: 140px; object-fit: contain;">` :
                                                '<div style="color: #9ca3af; font-size: 14px;">Ch∆∞a c√≥ logo</div>'
                                            }
                                        </div>
                                        <input type="file" id="logo-input" accept="image/*" onchange="app.uploadLogoSimple(event)" style="display: none;">
                                        <div style="display: flex; gap: 8px; justify-content: center;">
                                            <button type="button" onclick="document.getElementById('logo-input').click()" 
                                                    style="background: var(--primary-blue); color: white; padding: 8px 16px; border: none; border-radius: 6px; cursor: pointer; font-size: 14px;">
                                                üìÅ Ch·ªçn Logo
                                            </button>
                                            ${companySettings.logo ? 
                                                `<button type="button" onclick="app.removeLogo()" 
                                                        style="background: #dc2626; color: white; padding: 8px 16px; border: none; border-radius: 6px; cursor: pointer; font-size: 14px;">
                                                    üóëÔ∏è X√≥a
                                                </button>` : ''
                                            }
                                        </div>
                                    </div>
                                    
                                    <!-- QR Code Section -->
                                    <div style="text-align: center;">
                                        <h4 style="margin-bottom: 12px; color: var(--text-secondary);">M√£ QR Li√™n h·ªá</h4>
                                        <div id="qr-display" style="border: 2px dashed #e5e7eb; border-radius: 8px; padding: 20px; margin-bottom: 12px; min-height: 150px; display: flex; align-items: center; justify-content: center; background: #f9fafb;">
                                            ${companySettings.qrCode ? 
                                                `<img src="${companySettings.qrCode}" alt="QR Code" style="max-width: 100%; max-height: 140px; object-fit: contain;">` :
                                                '<div style="color: #9ca3af; font-size: 14px;">Ch∆∞a c√≥ m√£ QR</div>'
                                            }
                                        </div>
                                        <input type="file" id="qr-input" accept="image/*" onchange="app.uploadQRSimple(event)" style="display: none;">
                                        <div style="display: flex; gap: 8px; justify-content: center; flex-wrap: wrap;">
                                            <button type="button" onclick="app.generateQRCode()" 
                                                    style="background: #059669; color: white; padding: 8px 16px; border: none; border-radius: 6px; cursor: pointer; font-size: 14px;">
                                                üîÑ T·∫°o QR
                                            </button>
                                            <button type="button" onclick="document.getElementById('qr-input').click()" 
                                                    style="background: var(--primary-blue); color: white; padding: 8px 16px; border: none; border-radius: 6px; cursor: pointer; font-size: 14px;">
                                                üìÅ Upload QR
                                            </button>
                                            ${companySettings.qrCode ? 
                                                `<button type="button" onclick="app.removeQR()" 
                                                        style="background: #dc2626; color: white; padding: 8px 16px; border: none; border-radius: 6px; cursor: pointer; font-size: 14px;">
                                                    üóëÔ∏è X√≥a
                                                </button>` : ''
                                            }
                                        </div>
                                        <div style="margin-top: 8px; font-size: 12px; color: #6b7280;">
                                            T·∫°o t·ª± ƒë·ªông ho·∫∑c upload file ri√™ng
                                        </div>
                                        <button type="button" onclick="app.testLocalStorage()" 
                                                style="background: #f59e0b; color: white; padding: 4px 8px; border: none; border-radius: 4px; cursor: pointer; font-size: 11px; margin-top: 8px;">
                                            üîç Debug Data
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <div style="background: white; padding: 24px; border-radius: 12px; border: 2px solid #e5e7eb;">
                                <h3 style="margin-bottom: 16px; color: var(--text-primary); border-bottom: 2px solid #e5e7eb; padding-bottom: 8px;">üìã Th√¥ng tin chi ti·∫øt</h3>
                                <form onsubmit="app.saveCompanySettings(event)" style="display: grid; gap: 16px;">
                                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                                        <div>
                                            <label style="display: block; margin-bottom: 8px; font-weight: 600;">T√™n c√¥ng ty/c·ª≠a h√†ng: *</label>
                                            <input type="text" name="companyName" value="${companySettings.companyName || ''}" 
                                                   placeholder="VD: C√¥ng ty TNHH ABC" required
                                                   style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px;">
                                        </div>
                                        
                                        <div>
                                            <label style="display: block; margin-bottom: 8px; font-weight: 600;">M√£ s·ªë thu·∫ø:</label>
                                            <input type="text" name="taxCode" value="${companySettings.taxCode || ''}" 
                                                   placeholder="VD: 0123456789"
                                                   style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px;">
                                        </div>
                                    </div>
                                    
                                    <div>
                                        <label style="display: block; margin-bottom: 8px; font-weight: 600;">ƒê·ªãa ch·ªâ: *</label>
                                        <input type="text" name="address" value="${companySettings.address || ''}" 
                                               placeholder="VD: 123 ƒê∆∞·ªùng ABC, Qu·∫≠n XYZ, TP.HCM" required
                                               style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px;">
                                    </div>
                                    
                                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                                        <div>
                                            <label style="display: block; margin-bottom: 8px; font-weight: 600;">S·ªë ƒëi·ªán tho·∫°i: *</label>
                                            <input type="tel" name="phone" value="${companySettings.phone || ''}" 
                                                   placeholder="VD: 0123456789" required
                                                   style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px;">
                                        </div>
                                        
                                        <div>
                                            <label style="display: block; margin-bottom: 8px; font-weight: 600;">Email:</label>
                                            <input type="email" name="email" value="${companySettings.email || ''}" 
                                                   placeholder="VD: info@company.com"
                                                   style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px;">
                                        </div>
                                    </div>
                                    
                                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                                        <div>
                                            <label style="display: block; margin-bottom: 8px; font-weight: 600;">Ng∆∞·ªùi ƒë·∫°i di·ªán:</label>
                                            <input type="text" name="representative" value="${companySettings.representative || ''}" 
                                                   placeholder="VD: Nguy·ªÖn VƒÉn A"
                                                   style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px;">
                                        </div>
                                        
                                        <div>
                                            <label style="display: block; margin-bottom: 8px; font-weight: 600;">Ch·ª©c v·ª•:</label>
                                            <input type="text" name="position" value="${companySettings.position || ''}" 
                                                   placeholder="VD: Gi√°m ƒë·ªëc"
                                                   style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px;">
                                        </div>
                                    </div>
                                    
                                    <div>
                                        <label style="display: block; margin-bottom: 8px; font-weight: 600;">Slogan/M√¥ t·∫£:</label>
                                        <textarea name="description" rows="2" placeholder="VD: Ch·∫•t l∆∞·ª£ng - Uy t√≠n - Gi√° t·ªët"
                                                  style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; resize: vertical;">${companySettings.description || ''}</textarea>
                                    </div>
                                    
                                    <div style="display: flex; justify-content: flex-end; gap: 12px; margin-top: 8px;">
                                        <button type="button" onclick="app.resetCompanySettings()" 
                                                style="padding: 12px 24px; border: 2px solid #ef4444; color: #ef4444; background: white; border-radius: 8px; cursor: pointer; font-weight: 600;">
                                            üîÑ Reset
                                        </button>
                                        <button type="submit" 
                                                style="padding: 12px 24px; background: var(--success-gradient); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">
                                            üíæ L∆∞u th√¥ng tin
                                        </button>
                                    </div>
                                </form>
                                
                                <div style="margin-top: 16px; padding: 12px; background: #f0f9ff; border-radius: 8px; font-size: 14px; color: #1e40af;">
                                    <strong>üí° L∆∞u √Ω:</strong> Th√¥ng tin n√†y s·∫Ω hi·ªÉn th·ªã tr√™n t·∫•t c·∫£ h√≥a ƒë∆°n in ra. Vui l√≤ng ki·ªÉm tra k·ªπ tr∆∞·ªõc khi l∆∞u.
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }

            getSettingsContent() {
                const lastBackupTime = localStorage.getItem('last_backup_time');
                const autoBackupEnabled = localStorage.getItem('auto_backup_enabled') === 'true';
                const backupInterval = localStorage.getItem('backup_interval') || '30';
                
                return `
                    <div class="fade-in">
                        <div class="quick-actions" style="margin-bottom: 24px;">
                            <h2 class="section-title">‚öôÔ∏è C√†i ƒë·∫∑t Sao l∆∞u</h2>
                            
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 24px;">
                                <div style="background: white; padding: 20px; border-radius: 12px; border: 2px solid #e5e7eb;">
                                    <h3 style="margin-bottom: 16px; color: var(--text-primary); display: flex; align-items: center; gap: 8px;">
                                        <span>üîÑ</span> T·ª± ƒë·ªông sao l∆∞u
                                    </h3>
                                    <div style="margin-bottom: 16px;">
                                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                            <input type="checkbox" id="auto-backup-toggle" ${autoBackupEnabled ? 'checked' : ''} 
                                                   onchange="app.toggleAutoBackup(this.checked)" 
                                                   style="width: 16px; height: 16px;">
                                            <span>B·∫≠t t·ª± ƒë·ªông sao l∆∞u</span>
                                        </label>
                                    </div>
                                    
                                    <div style="margin-bottom: 16px;">
                                        <label style="display: block; margin-bottom: 8px; font-weight: 600;">T·∫ßn su·∫•t:</label>
                                        <select id="backup-interval" onchange="app.setBackupInterval(this.value)" 
                                                style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 6px;">
                                            <option value="15" ${backupInterval === '15' ? 'selected' : ''}>15 ph√∫t</option>
                                            <option value="30" ${backupInterval === '30' ? 'selected' : ''}>30 ph√∫t</option>
                                            <option value="60" ${backupInterval === '60' ? 'selected' : ''}>60 ph√∫t</option>
                                        </select>
                                    </div>
                                    
                                    <div style="font-size: 12px; color: #6b7280;">
                                        Tr·∫°ng th√°i: <span id="backup-status">${autoBackupEnabled ? 'üü¢ ƒêang ho·∫°t ƒë·ªông' : 'üî¥ T·∫Øt'}</span><br>
                                        L·∫ßn cu·ªëi: ${lastBackupTime ? new Date(lastBackupTime).toLocaleString('vi-VN') : 'Ch∆∞a c√≥'}
                                    </div>
                                </div>
                                
                                <div style="background: white; padding: 20px; border-radius: 12px; border: 2px solid #e5e7eb;">
                                    <h3 style="margin-bottom: 16px; color: var(--text-primary); display: flex; align-items: center; gap: 8px;">
                                        <span>üíæ</span> Sao l∆∞u th·ªß c√¥ng
                                    </h3>
                                    
                                    <button onclick="app.manualBackup()" 
                                            style="width: 100%; background: var(--success-gradient); color: white; padding: 12px; 
                                                   border: none; border-radius: 8px; cursor: pointer; margin-bottom: 12px; font-weight: 600;">
                                        üìÅ T·∫£i xu·ªëng b·∫£n sao l∆∞u
                                    </button>
                                    
                                    <div style="margin-bottom: 12px;">
                                        <input type="file" id="restore-file" accept=".json" style="display: none;" onchange="app.restoreFromFile(event)">
                                        <button onclick="document.getElementById('restore-file').click()" 
                                                style="width: 100%; background: var(--header-gradient); color: white; padding: 12px; 
                                                       border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">
                                            üì§ Kh√¥i ph·ª•c t·ª´ file
                                        </button>
                                    </div>
                                    
                                    <div style="font-size: 12px; color: #6b7280; text-align: center;">
                                        File ƒë∆∞·ª£c l∆∞u ƒë·ªãnh d·∫°ng JSON<br>
                                        T·ª± ƒë·ªông t·∫£i v·ªÅ th∆∞ m·ª•c Downloads
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="quick-actions">
                            <h2 class="section-title">üìä Th√¥ng tin H·ªá th·ªëng</h2>
                            <div class="stats-grid" style="margin-bottom: 20px;">
                                <div class="stat-card info">
                                    <div class="stat-header">
                                        <span class="stat-title">D·ªØ li·ªáu l∆∞u tr·ªØ</span>
                                        <span class="stat-icon">üíæ</span>
                                    </div>
                                    <div class="stat-value" id="storage-size">${this.calculateStorageSize()}</div>
                                    <div class="stat-change">LocalStorage</div>
                                </div>
                                
                                <div class="stat-card success">
                                    <div class="stat-header">
                                        <span class="stat-title">T·ªïng b·∫£n ghi</span>
                                        <span class="stat-icon">üìã</span>
                                    </div>
                                    <div class="stat-value">${Object.values(this.demoData).reduce((total, arr) => total + (Array.isArray(arr) ? arr.length : 0), 0)}</div>
                                    <div class="stat-change">B·∫£n ghi</div>
                                </div>
                            </div>
                            
                            <div class="recent-activity">
                                <h3 style="margin-bottom: 16px;">Chi ti·∫øt d·ªØ li·ªáu:</h3>
                                <div class="activity-item">
                                    <div class="activity-icon info">üë•</div>
                                    <div class="activity-content">
                                        <div class="activity-title">Kh√°ch h√†ng</div>
                                        <div class="activity-desc">${this.demoData.customers.length} kh√°ch h√†ng ƒë√£ ƒë∆∞·ª£c l∆∞u tr·ªØ</div>
                                    </div>
                                    <div class="activity-time">${this.demoData.customers.length}</div>
                                </div>
                                
                                <div class="activity-item">
                                    <div class="activity-icon info">üè¢</div>
                                    <div class="activity-content">
                                        <div class="activity-title">Nh√† cung c·∫•p</div>
                                        <div class="activity-desc">${this.demoData.suppliers.length} nh√† cung c·∫•p ƒë√£ ƒë∆∞·ª£c l∆∞u tr·ªØ</div>
                                    </div>
                                    <div class="activity-time">${this.demoData.suppliers.length}</div>
                                </div>
                                
                                <div class="activity-item">
                                    <div class="activity-icon info">üì¶</div>
                                    <div class="activity-content">
                                        <div class="activity-title">S·∫£n ph·∫©m</div>
                                        <div class="activity-desc">${this.demoData.products.length} s·∫£n ph·∫©m trong danh m·ª•c</div>
                                    </div>
                                    <div class="activity-time">${this.demoData.products.length}</div>
                                </div>
                                
                                <div class="activity-item">
                                    <div class="activity-icon info">üí∞</div>
                                    <div class="activity-content">
                                        <div class="activity-title">ƒê∆°n h√†ng</div>
                                        <div class="activity-desc">${this.demoData.sales.length} ƒë∆°n b√°n h√†ng ƒë√£ l∆∞u tr·ªØ</div>
                                    </div>
                                    <div class="activity-time">${this.demoData.sales.length}</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Ph·∫ßn l·ªãch s·ª≠ ho·∫°t ƒë·ªông -->
                        <div class="quick-actions" style="margin-top: 24px;">
                            <h2 class="section-title">üìã L·ªãch s·ª≠ Ho·∫°t ƒë·ªông</h2>
                            <div style="background: white; border-radius: 12px; border: 2px solid #e5e7eb; padding: 20px;">
                                ${this.getSystemActivityHistory()}
                            </div>
                        </div>
                    </div>
                `;
            }
            
            getSystemActivityHistory() {
                // L·∫•y t·∫•t c·∫£ ho·∫°t ƒë·ªông t·ª´ localStorage v√† h·ªá th·ªëng
                let activities = JSON.parse(localStorage.getItem('system_activity_history') || '[]');
                
                // N·∫øu ch∆∞a c√≥ l·ªãch s·ª≠, t·∫°o m·ªôt s·ªë ho·∫°t ƒë·ªông m·∫´u t·ª´ d·ªØ li·ªáu hi·ªán t·∫°i
                if (activities.length === 0) {
                    activities = this.generateInitialActivityHistory();
                    localStorage.setItem('system_activity_history', JSON.stringify(activities));
                }
                
                // S·∫Øp x·∫øp theo th·ªùi gian m·ªõi nh·∫•t
                activities.sort((a, b) => new Date(b.time) - new Date(a.time));
                
                // Hi·ªÉn th·ªã 20 ho·∫°t ƒë·ªông g·∫ßn nh·∫•t
                const recentActivities = activities.slice(0, 20);
                
                let html = `
                    <div style="margin-bottom: 16px;">
                        <h3 style="margin: 0; display: flex; align-items: center; gap: 8px;">
                            <span>üïí</span> L·ªãch s·ª≠ Ho·∫°t ƒë·ªông G·∫ßn ƒë√¢y
                        </h3>
                    </div>
                    
                    <div style="max-height: 400px; overflow-y: auto; border: 1px solid #e5e7eb; border-radius: 8px; background: #f9fafb;">
                `;
                
                if (recentActivities.length === 0) {
                    html += `
                        <div style="padding: 40px; text-align: center; color: #6b7280;">
                            <div style="font-size: 48px; margin-bottom: 16px;">üìù</div>
                            <p>Ch∆∞a c√≥ ho·∫°t ƒë·ªông n√†o ƒë∆∞·ª£c ghi nh·∫≠n</p>
                        </div>
                    `;
                } else {
                    recentActivities.forEach((activity, index) => {
                        const timeAgo = this.getTimeAgoText(activity.time);
                        const borderBottom = index < recentActivities.length - 1 ? 'border-bottom: 1px solid #e5e7eb;' : '';
                        
                        html += `
                            <div style="padding: 12px 16px; ${borderBottom} display: flex; align-items: flex-start; gap: 12px;">
                                <div class="activity-icon ${activity.type}" style="width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 12px; flex-shrink: 0;">
                                    ${activity.icon}
                                </div>
                                <div style="flex: 1; min-width: 0;">
                                    <div style="font-weight: 600; color: var(--text-primary); margin-bottom: 4px;">
                                        ${activity.title}
                                    </div>
                                    <div style="color: #6b7280; font-size: 14px; margin-bottom: 4px;">
                                        ${activity.description}
                                    </div>
                                    <div style="color: #9ca3af; font-size: 12px;">
                                        ${timeAgo}
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                }
                
                html += `
                    </div>
                    <div style="margin-top: 12px; padding: 12px; background: #f0f9ff; border-radius: 8px; font-size: 14px; color: #1e40af;">
                        <strong>üí° Th√¥ng tin:</strong> H·ªá th·ªëng t·ª± ƒë·ªông ghi nh·∫≠n t·∫•t c·∫£ c√°c ho·∫°t ƒë·ªông quan tr·ªçng ƒë·ªÉ b·∫°n theo d√µi.
                    </div>
                `;
                
                return html;
            }
            
            generateInitialActivityHistory() {
                const now = this.getVietnamTime();
                const activities = [];
                
                // Ho·∫°t ƒë·ªông t·ª´ ƒë∆°n h√†ng g·∫ßn ƒë√¢y
                this.demoData.orders.slice(0, 5).forEach((order, index) => {
                    const orderTime = new Date(now.getTime() - (30 + index * 15) * 60 * 1000);
                    activities.push({
                        id: 'order_' + order.id,
                        type: order.paymentStatus === 'ƒê√£ thanh to√°n' ? 'success' : 'info',
                        icon: order.paymentStatus === 'ƒê√£ thanh to√°n' ? 'üí∞' : 'üìã',
                        title: `ƒê∆°n h√†ng ${order.id}`,
                        description: `${order.paymentStatus === 'ƒê√£ thanh to√°n' ? 'ƒê√£ thanh to√°n' : 'T·∫°o m·ªõi'} - Kh√°ch h√†ng: ${order.customerName} - Gi√° tr·ªã: ${order.total.toLocaleString('vi-VN')} VNƒê`,
                        time: orderTime.toISOString(),
                        category: 'order'
                    });
                });
                
                // Ho·∫°t ƒë·ªông h·ªá th·ªëng
                activities.push({
                    id: 'system_start',
                    type: 'info',
                    icon: 'üöÄ',
                    title: 'Kh·ªüi ƒë·ªông h·ªá th·ªëng',
                    description: 'H·ªá th·ªëng PhuocIT ƒë√£ ƒë∆∞·ª£c kh·ªüi ƒë·ªông v√† s·∫µn s√†ng ho·∫°t ƒë·ªông',
                    time: new Date(now.getTime() - 2 * 60 * 60 * 1000).toISOString(),
                    category: 'system'
                });
                
                activities.push({
                    id: 'data_loaded',
                    type: 'success',
                    icon: 'üíæ',
                    title: 'T·∫£i d·ªØ li·ªáu th√†nh c√¥ng',
                    description: `ƒê√£ t·∫£i ${this.demoData.customers.length} kh√°ch h√†ng, ${this.demoData.products.length} s·∫£n ph·∫©m, ${this.demoData.orders.length} ƒë∆°n h√†ng`,
                    time: new Date(now.getTime() - 90 * 60 * 1000).toISOString(),
                    category: 'system'
                });
                
                return activities;
            }
            
            addActivityLog(type, icon, title, description, category = 'user') {
                let activities = JSON.parse(localStorage.getItem('system_activity_history') || '[]');
                
                const newActivity = {
                    id: 'activity_' + Date.now(),
                    type: type,
                    icon: icon,
                    title: title,
                    description: description,
                    time: this.getVietnamTime().toISOString(),
                    category: category
                };
                
                activities.unshift(newActivity);
                
                // Gi·ªØ l·∫°i t·ªëi ƒëa 100 ho·∫°t ƒë·ªông
                if (activities.length > 100) {
                    activities = activities.slice(0, 100);
                }
                
                localStorage.setItem('system_activity_history', JSON.stringify(activities));
            }
            

            
            getTimeAgoText(timeString) {
                const now = this.getVietnamTime();
                const time = new Date(timeString);
                const diffMs = now - time;
                const diffMins = Math.floor(diffMs / (1000 * 60));
                const diffHours = Math.floor(diffMins / 60);
                const diffDays = Math.floor(diffHours / 24);
                
                if (diffMins < 1) return 'V·ª´a xong';
                if (diffMins < 60) return `${diffMins} ph√∫t tr∆∞·ªõc`;
                if (diffHours < 24) return `${diffHours} gi·ªù tr∆∞·ªõc`;
                if (diffDays < 7) return `${diffDays} ng√†y tr∆∞·ªõc`;
                
                return time.toLocaleDateString('vi-VN', {
                    day: '2-digit',
                    month: '2-digit', 
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
            }
            
            showNotification(message, type = 'info') {
                const notification = document.getElementById('notification');
                if (!notification) return;
                
                notification.textContent = message;
                notification.className = `notification show ${type}`;
                
                setTimeout(() => {
                    notification.classList.remove('show');
                }, 3000);
            }
            
            showCompanyInfo() {
                const infoHTML = `
                    <div style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1001; display: flex; justify-content: center; align-items: center;" onclick="closeModal(this)">
                        <div style="background: white; padding: 32px; border-radius: 16px; width: 500px; max-width: 90vw; text-align: center; box-shadow: 0 20px 50px rgba(0,0,0,0.3);" onclick="event.stopPropagation()">
                            <div style="font-size: 48px; margin-bottom: 16px;">üè™</div>
                            <h3 style="color: var(--primary-blue); margin-bottom: 20px; font-size: 24px; font-weight: bold;">PITC - PhuocIT.com</h3>
                            
                            <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 12px; margin-bottom: 20px;">
                                <h4 style="margin-bottom: 12px; font-size: 18px;">üì¶ S·∫£n ph·∫©m thu·ªôc PhuocIT.com</h4>
                                <p style="margin-bottom: 0; font-size: 16px; line-height: 1.4;">‚ú® Chia s·∫ª Mi·ªÖn Ph√≠</p>
                            </div>
                            
                            <div style="background: #f8fafc; padding: 16px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid var(--success-color);">
                                <p style="margin: 0; color: #374151; line-height: 1.5;">
                                    üí° N·∫øu c·∫ßn b·ªï sung t√≠nh nƒÉng c√≥ th·ªÉ li√™n h·ªá ƒë·ªÉ ƒë∆∞·ª£c h·ªó tr·ª£ t·ªët nh·∫•t.
                                </p>
                            </div>
                            
                            <div style="display: flex; gap: 12px; justify-content: center;">
                                <a href="https://phuocit.com" target="_blank" style="background: var(--header-gradient); color: white; padding: 12px 24px; border-radius: 8px; text-decoration: none; font-weight: 600;">
                                    üåê Truy c·∫≠p Website
                                </a>
                               
                            </div>
                        </div>
                    </div>
                `;
                document.body.insertAdjacentHTML('beforeend', infoHTML);
            }
            
            // Customer Management Functions
            showAddCustomerForm() {
                const formHTML = `
                    <div style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1001; display: flex; justify-content: center; align-items: center;" onclick="closeModal(this)">
                        <div style="background: white; padding: 32px; border-radius: 12px; width: 600px; max-width: 90vw;" onclick="event.stopPropagation()">
                            <h3 style="margin-bottom: 24px; color: var(--text-primary);">‚ûï Th√™m kh√°ch h√†ng m·ªõi</h3>
                            <form onsubmit="app.addCustomer(event)">
                                <!-- H√†ng 1: T√™n KH v√† Lo·∫°i KH -->
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px;">
                                    <div>
                                        <label style="display: block; margin-bottom: 8px; font-weight: 600;">T√™n kh√°ch h√†ng: *</label>
                                        <input type="text" name="name" required 
                                               style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px;">
                                    </div>
                                    <div>
                                        <label style="display: block; margin-bottom: 8px; font-weight: 600;">Lo·∫°i kh√°ch h√†ng: *</label>
                                        <select name="type" required onchange="app.toggleAddCustomerFields(this.value)"
                                               style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px;">
                                            <option value="">Ch·ªçn lo·∫°i</option>
                                            <option value="ca-nhan">C√° nh√¢n</option>
                                            <option value="doanh-nghiep">Doanh nghi·ªáp</option>
                                        </select>
                                    </div>
                                </div>

                                <!-- H√†ng 2: T√™n c√¥ng ty v√† Ph√≤ng ban (·∫©n/hi·ªán) -->
                                <div id="add-company-field" style="margin-bottom: 16px; display: none;">
                                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                                        <div>
                                            <label style="display: block; margin-bottom: 8px; font-weight: 600;">T√™n c√¥ng ty: *</label>
                                            <input type="text" name="companyName" 
                                                   style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px;">
                                        </div>
                                        <div>
                                            <label style="display: block; margin-bottom: 8px; font-weight: 600;">Ph√≤ng ban:</label>
                                            <input type="text" name="department" placeholder="VD: Ph√≤ng k·∫ø to√°n, Ph√≤ng kinh doanh..."
                                                   style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px;">
                                        </div>
                                    </div>
                                </div>

                                <!-- H√†ng 3: ƒêi·ªán tho·∫°i v√† M√£ s·ªë thu·∫ø -->
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px;">
                                    <div>
                                        <label style="display: block; margin-bottom: 8px; font-weight: 600;">S·ªë ƒëi·ªán tho·∫°i: *</label>
                                        <input type="tel" name="phone" required 
                                               style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px;">
                                    </div>
                                    <div id="add-tax-field" style="display: none;">
                                        <label style="display: block; margin-bottom: 8px; font-weight: 600;">M√£ s·ªë thu·∫ø:</label>
                                        <input type="text" name="taxCode"
                                               style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px;">
                                    </div>
                                </div>
                                
                                <!-- H√†ng 4: Email -->
                                <div style="margin-bottom: 16px;">
                                    <label style="display: block; margin-bottom: 8px; font-weight: 600;">Email:</label>
                                    <input type="email" name="email"
                                           style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px;">
                                </div>
                                
                                <!-- H√†ng 5: ƒê·ªãa ch·ªâ -->
                                <div style="margin-bottom: 16px;">
                                    <label style="display: block; margin-bottom: 8px; font-weight: 600;">ƒê·ªãa ch·ªâ:</label>
                                    <textarea name="address" rows="2"
                                              style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; resize: vertical;"></textarea>
                                </div>

                                <!-- H√†ng 6: Ghi ch√∫ -->
                                <div style="margin-bottom: 24px;">
                                    <label style="display: block; margin-bottom: 8px; font-weight: 600;">Ghi ch√∫ kh√°ch h√†ng:</label>
                                    <textarea name="notes" rows="3" placeholder="Nh·∫≠p ghi ch√∫ v·ªÅ kh√°ch h√†ng (kh√¥ng b·∫Øt bu·ªôc)"
                                              style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; resize: vertical;"></textarea>
                                </div>
                                
                                <div style="display: flex; gap: 12px; justify-content: flex-end;">
                                    <button type="button" onclick="closeModal(this.closest('div[style*=fixed]'))" 
                                            style="padding: 12px 24px; border: 2px solid #e5e7eb; background: white; border-radius: 8px; cursor: pointer;">H·ªßy</button>
                                    <button type="submit" 
                                            style="padding: 12px 24px; background: var(--primary-blue); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">Th√™m kh√°ch h√†ng</button>
                                </div>
                            </form>
                        </div>
                    </div>
                `;
                document.body.insertAdjacentHTML('beforeend', formHTML);
            }
            
            toggleAddCustomerFields(customerType) {
                const companyField = document.getElementById('add-company-field');
                const taxField = document.getElementById('add-tax-field');
                const companyInput = document.querySelector('input[name="companyName"]');
                
                if (customerType === 'doanh-nghiep') {
                    companyField.style.display = 'block';
                    taxField.style.display = 'block';
                    companyInput.required = true;
                } else {
                    companyField.style.display = 'none';
                    taxField.style.display = 'none';
                    if (companyInput) {
                        companyInput.required = false;
                        companyInput.value = '';
                    }
                    const taxInput = document.querySelector('input[name="taxCode"]');
                    if (taxInput) taxInput.value = '';
                }
            }

            addCustomer(event) {
                event.preventDefault();
                const form = event.target;
                const formData = new FormData(form);
                
                const newCustomer = {
                    id: 'KH' + String(this.demoData.customers.length + 1).padStart(3, '0'),
                    name: formData.get('name'),
                    type: formData.get('type'),
                    companyName: formData.get('companyName') || '',
                    department: formData.get('department') || '',
                    phone: formData.get('phone'),
                    email: formData.get('email') || '',
                    address: formData.get('address') || '',
                    taxCode: formData.get('taxCode') || '',
                    notes: formData.get('notes') || '',
                    debt: 0,
                    totalOrders: 0
                };
                
                this.demoData.customers.push(newCustomer);
                this.saveToLocalStorage();
                this.showNotification(`ƒê√£ th√™m kh√°ch h√†ng ${newCustomer.name}`, 'success');
                this.loadPage('customers');
                const modal = form.closest("div[style*=\"fixed\"]"); if(modal) modal.remove();
            }
            
            editCustomer(index) {
                const customer = this.demoData.customers[index];
                const customerType = customer.type || 'ca-nhan';
                const companyDisplay = customerType === 'doanh-nghiep' ? 'block' : 'none';
                const taxDisplay = customerType === 'doanh-nghiep' ? 'block' : 'none';
                
                const formHTML = `
                    <div style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1001; display: flex; justify-content: center; align-items: center;" onclick="closeModal(this)">
                        <div style="background: white; padding: 32px; border-radius: 12px; width: 600px; max-width: 90vw;" onclick="event.stopPropagation()">
                            <h3 style="margin-bottom: 24px; color: var(--text-primary);">‚úèÔ∏è S·ª≠a th√¥ng tin kh√°ch h√†ng</h3>
                            <form onsubmit="app.updateCustomer(event, ${index})">
                                <!-- H√†ng 1: T√™n KH v√† Lo·∫°i KH -->
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px;">
                                    <div>
                                        <label style="display: block; margin-bottom: 8px; font-weight: 600;">T√™n kh√°ch h√†ng: *</label>
                                        <input type="text" name="name" value="${customer.name}" required 
                                               style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px;">
                                    </div>
                                    <div>
                                        <label style="display: block; margin-bottom: 8px; font-weight: 600;">Lo·∫°i kh√°ch h√†ng: *</label>
                                        <select name="type" required onchange="app.toggleEditCustomerFields(this.value)"
                                               style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px;">
                                            <option value="ca-nhan" ${customerType === 'ca-nhan' ? 'selected' : ''}>C√° nh√¢n</option>
                                            <option value="doanh-nghiep" ${customerType === 'doanh-nghiep' ? 'selected' : ''}>Doanh nghi·ªáp</option>
                                        </select>
                                    </div>
                                </div>

                                <!-- H√†ng 2: T√™n c√¥ng ty v√† Ph√≤ng ban (·∫©n/hi·ªán) -->
                                <div id="edit-company-field" style="margin-bottom: 16px; display: ${companyDisplay};">
                                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                                        <div>
                                            <label style="display: block; margin-bottom: 8px; font-weight: 600;">T√™n c√¥ng ty: *</label>
                                            <input type="text" name="companyName" value="${customer.companyName || ''}"
                                                   style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px;">
                                        </div>
                                        <div>
                                            <label style="display: block; margin-bottom: 8px; font-weight: 600;">Ph√≤ng ban:</label>
                                            <input type="text" name="department" value="${customer.department || ''}" placeholder="VD: Ph√≤ng k·∫ø to√°n, Ph√≤ng kinh doanh..."
                                                   style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px;">
                                        </div>
                                    </div>
                                </div>

                                <!-- H√†ng 3: ƒêi·ªán tho·∫°i v√† M√£ s·ªë thu·∫ø -->
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px;">
                                    <div>
                                        <label style="display: block; margin-bottom: 8px; font-weight: 600;">S·ªë ƒëi·ªán tho·∫°i: *</label>
                                        <input type="tel" name="phone" value="${customer.phone}" required 
                                               style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px;">
                                    </div>
                                    <div id="edit-tax-field" style="display: ${taxDisplay};">
                                        <label style="display: block; margin-bottom: 8px; font-weight: 600;">M√£ s·ªë thu·∫ø:</label>
                                        <input type="text" name="taxCode" value="${customer.taxCode || ''}"
                                               style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px;">
                                    </div>
                                </div>
                                
                                <!-- H√†ng 4: Email -->
                                <div style="margin-bottom: 16px;">
                                    <label style="display: block; margin-bottom: 8px; font-weight: 600;">Email:</label>
                                    <input type="email" name="email" value="${customer.email || ''}"
                                           style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px;">
                                </div>
                                
                                <!-- H√†ng 5: ƒê·ªãa ch·ªâ -->
                                <div style="margin-bottom: 16px;">
                                    <label style="display: block; margin-bottom: 8px; font-weight: 600;">ƒê·ªãa ch·ªâ:</label>
                                    <textarea name="address" rows="2"
                                              style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; resize: vertical;">${customer.address || ''}</textarea>
                                </div>

                                <!-- H√†ng 6: Ghi ch√∫ -->
                                <div style="margin-bottom: 16px;">
                                    <label style="display: block; margin-bottom: 8px; font-weight: 600;">Ghi ch√∫ kh√°ch h√†ng:</label>
                                    <textarea name="notes" rows="3" placeholder="Nh·∫≠p ghi ch√∫ v·ªÅ kh√°ch h√†ng (kh√¥ng b·∫Øt bu·ªôc)"
                                              style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; resize: vertical;">${customer.notes || ''}</textarea>
                                </div>

                                <!-- H√†ng 7: C√¥ng n·ª£ -->
                                <div style="margin-bottom: 24px;">
                                    <label style="display: block; margin-bottom: 8px; font-weight: 600;">C√¥ng n·ª£:</label>
                                    <input type="number" name="debt" value="${customer.debt}" 
                                           style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px;">
                                </div>
                                
                                <div style="display: flex; gap: 12px; justify-content: flex-end;">
                                    <button type="button" onclick="closeModal(this.closest('div[style*=fixed]'))" 
                                            style="padding: 12px 24px; border: 2px solid #e5e7eb; background: white; border-radius: 8px; cursor: pointer;">H·ªßy</button>
                                    <button type="submit" 
                                            style="padding: 12px 24px; background: var(--primary-blue); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">C·∫≠p nh·∫≠t</button>
                                </div>
                            </form>
                        </div>
                    </div>
                `;
                document.body.insertAdjacentHTML('beforeend', formHTML);
            }
            
            toggleEditCustomerFields(customerType) {
                const companyField = document.getElementById('edit-company-field');
                const taxField = document.getElementById('edit-tax-field');
                const companyInput = document.querySelector('input[name="companyName"]');
                
                if (customerType === 'doanh-nghiep') {
                    companyField.style.display = 'block';
                    taxField.style.display = 'block';
                    if (companyInput) companyInput.required = true;
                } else {
                    companyField.style.display = 'none';
                    taxField.style.display = 'none';
                    if (companyInput) {
                        companyInput.required = false;
                        companyInput.value = '';
                    }
                    const taxInput = document.querySelector('input[name="taxCode"]');
                    if (taxInput) taxInput.value = '';
                }
            }

            updateCustomer(event, index) {
                event.preventDefault();
                const form = event.target;
                const formData = new FormData(form);
                
                this.demoData.customers[index] = {
                    ...this.demoData.customers[index],
                    name: formData.get('name'),
                    type: formData.get('type'),
                    companyName: formData.get('companyName') || '',
                    department: formData.get('department') || '',
                    phone: formData.get('phone'),
                    email: formData.get('email') || '',
                    address: formData.get('address') || '',
                    taxCode: formData.get('taxCode') || '',
                    notes: formData.get('notes') || '',
                    debt: parseInt(formData.get('debt')) || 0
                };
                
                this.saveToLocalStorage();
                this.showNotification(`ƒê√£ c·∫≠p nh·∫≠t th√¥ng tin kh√°ch h√†ng`, 'success');
                this.loadPage('customers');
                const modal = form.closest("div[style*=\"fixed\"]"); if(modal) modal.remove();
            }
            
            deleteCustomer(index) {
                const customer = this.demoData.customers[index];
                if (confirm(`B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a kh√°ch h√†ng ${customer.name}?`)) {
                    this.demoData.customers.splice(index, 1);
                    this.saveToLocalStorage();
                    this.showNotification(`ƒê√£ x√≥a kh√°ch h√†ng ${customer.name}`, 'success');
                    this.loadPage('customers');
                }
            }

            showCustomerDetails(index) {
                console.log('üîç showCustomerDetails ƒë∆∞·ª£c g·ªçi v·ªõi index:', index);
                console.log('üë• T·ªïng s·ªë kh√°ch h√†ng:', this.demoData.customers.length);
                
                const customer = this.demoData.customers[index];
                if (!customer) {
                    console.error('‚ùå Kh√¥ng t√¨m th·∫•y kh√°ch h√†ng ·ªü index:', index);
                    this.showNotification('Kh√¥ng t√¨m th·∫•y kh√°ch h√†ng', 'error');
                    return;
                }
                
                console.log('‚úÖ T√¨m th·∫•y kh√°ch h√†ng:', customer);
                
                // T√¨m t·∫•t c·∫£ ƒë∆°n h√†ng c·ªßa kh√°ch h√†ng n√†y
                const customerOrders = this.demoData.orders.filter(order => order.customerId === customer.id);
                
                // T√≠nh t·ªïng ti·ªÅn ƒë√£ mua
                const totalPurchased = customerOrders.reduce((sum, order) => sum + order.total, 0);
                
                // T√≠nh t·ªïng ti·ªÅn ƒë√£ thanh to√°n
                const totalPaid = customerOrders
                    .filter(order => order.paymentStatus === 'ƒê√£ thanh to√°n')
                    .reduce((sum, order) => sum + order.total, 0);
                
                // T√≠nh c√¥ng n·ª£ th·ª±c t·∫ø t·ª´ c√°c ƒë∆°n h√†ng ch∆∞a thanh to√°n (kh√¥ng d√πng customer.debt c≈©)
                const actualDebt = customerOrders
                    .filter(order => order.paymentStatus !== 'ƒê√£ thanh to√°n')
                    .reduce((sum, order) => sum + order.total, 0);
                
                // Danh s√°ch ƒë∆°n h√†ng (s·∫Øp x·∫øp m·ªõi nh·∫•t l√™n tr√™n)
                const sortedCustomerOrders = this.sortOrdersByDate(customerOrders);
                const ordersTable = sortedCustomerOrders.length > 0 ? sortedCustomerOrders.map((order, orderIndex) => {
                    const originalOrderIndex = this.demoData.orders.findIndex(o => o.id === order.id);
                    return `
                    <tr style="border-bottom: 1px solid #e5e7eb;">
                        <td style="padding: 8px; font-weight: 600;">${order.id}</td>
                        <td style="padding: 8px;">${order.date} ${order.time}</td>
                        <td style="padding: 8px; font-weight: 600; color: var(--primary-blue);">${order.total.toLocaleString('vi-VN')} VNƒê</td>
                        <td style="padding: 8px;">
                            <span style="padding: 3px 8px; border-radius: 12px; font-size: 11px; font-weight: 600;
                                ${order.status === 'Ho√†n th√†nh' ? 'background: #dcfce7; color: #166534;' : ''}
                                ${order.status === 'ƒêang x·ª≠ l√Ω' ? 'background: #fef3c7; color: #92400e;' : ''}
                                ${order.status === 'H·ªßy' ? 'background: #fee2e2; color: #dc2626;' : ''}
                            ">${order.status}</span>
                        </td>
                        <td style="padding: 8px;">
                            <span style="padding: 3px 8px; border-radius: 12px; font-size: 11px; font-weight: 600;
                                ${order.paymentStatus === 'ƒê√£ thanh to√°n' ? 'background: #dcfce7; color: #166534;' : 'background: #fef3c7; color: #92400e;'}
                            ">${order.paymentStatus}</span>
                        </td>
                        <td style="padding: 8px;">
                            <button onclick="app.viewOrderDetails(${originalOrderIndex})" 
                                    style="background: var(--primary-blue); color: white; padding: 4px 8px; border: none; border-radius: 4px; cursor: pointer; font-size: 11px;">
                                Chi ti·∫øt
                            </button>
                        </td>
                    </tr>
                    `;
                }).join('') : `<tr><td colspan="6" style="padding: 20px; text-align: center; color: #6b7280;">Ch∆∞a c√≥ ƒë∆°n h√†ng n√†o</td></tr>`;

                const detailHTML = `
                    <div style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1001; display: flex; justify-content: center; align-items: center;" onclick="closeModal(this)">
                        <div style="background: white; padding: 32px; border-radius: 12px; width: 800px; max-width: 95vw; max-height: 90vh; overflow-y: auto;" onclick="event.stopPropagation()">
                            <h3 style="margin-bottom: 24px; color: var(--text-primary); display: flex; align-items: center; gap: 8px;">
                                <span>üë§</span> Chi ti·∫øt kh√°ch h√†ng: ${customer.name}
                            </h3>
                            
                            <!-- Th√¥ng tin c∆° b·∫£n -->
                            <div style="background: #f8fafc; padding: 20px; border-radius: 8px; margin-bottom: 24px; border-left: 4px solid var(--primary-blue);">
                                <h4 style="margin-bottom: 12px; color: var(--text-primary);">
                                    üìã Th√¥ng tin c∆° b·∫£n 
                                    ${customer.type === 'doanh-nghiep' ? '<span style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 2px 8px; border-radius: 12px; font-size: 11px; margin-left: 8px;">üè¢ DOANH NGHI·ªÜP</span>' : '<span style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white; padding: 2px 8px; border-radius: 12px; font-size: 11px; margin-left: 8px;">üë§ C√Å NH√ÇN</span>'}
                                </h4>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                                    <div><strong>M√£ KH:</strong> ${customer.id}</div>
                                    <div><strong>T√™n:</strong> ${customer.name}</div>
                                    ${customer.type === 'doanh-nghiep' && customer.companyName ? `<div><strong>T√™n c√¥ng ty:</strong> ${customer.companyName}</div>` : ''}
                                    ${customer.type === 'doanh-nghiep' && customer.department ? `<div><strong>Ph√≤ng ban:</strong> ${customer.department}</div>` : ''}
                                    <div><strong>ƒêi·ªán tho·∫°i:</strong> ${customer.phone}</div>
                                    <div><strong>Email:</strong> ${customer.email || 'Ch∆∞a c√≥'}</div>
                                    ${customer.type === 'doanh-nghiep' && customer.taxCode ? `<div style="grid-column: 1 / -1;"><strong>M√£ s·ªë thu·∫ø:</strong> ${customer.taxCode}</div>` : ''}
                                    <div style="grid-column: 1 / -1;"><strong>ƒê·ªãa ch·ªâ:</strong> ${customer.address || 'Ch∆∞a c√≥'}</div>
                                    ${customer.notes ? `<div style="grid-column: 1 / -1;"><strong>Ghi ch√∫:</strong> ${customer.notes}</div>` : ''}
                                </div>
                            </div>
                            
                            <!-- Th·ªëng k√™ mua h√†ng -->
                            <div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 12px; margin-bottom: 24px;">
                                <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 12px; border-radius: 8px; text-align: center;">
                                    <div style="font-size: 18px; font-weight: bold; margin-bottom: 4px;">${customerOrders.length}</div>
                                    <div style="font-size: 12px; opacity: 0.9;">T·ªïng ƒë∆°n h√†ng</div>
                                </div>
                                <div style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; padding: 12px; border-radius: 8px; text-align: center;">
                                    <div style="font-size: 16px; font-weight: bold; margin-bottom: 4px;">${totalPurchased.toLocaleString('vi-VN')} VNƒê</div>
                                    <div style="font-size: 12px; opacity: 0.9;">T·ªïng ti·ªÅn mua</div>
                                </div>
                                <div style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white; padding: 12px; border-radius: 8px; text-align: center;">
                                    <div style="font-size: 16px; font-weight: bold; margin-bottom: 4px;">${totalPaid.toLocaleString('vi-VN')} VNƒê</div>
                                    <div style="font-size: 12px; opacity: 0.9;">ƒê√£ thanh to√°n</div>
                                </div>
                                <div style="background: ${actualDebt > 0 ? 'linear-gradient(135deg, #fa709a 0%, #fee140 100%)' : 'linear-gradient(135deg, #a8edea 0%, #fed6e3 100%)'}; color: ${actualDebt > 0 ? 'white' : '#374151'}; padding: 12px; border-radius: 8px; text-align: center;">
                                    <div style="font-size: 16px; font-weight: bold; margin-bottom: 4px;">${actualDebt.toLocaleString('vi-VN')} VNƒê</div>
                                    <div style="font-size: 12px; opacity: 0.9;">C√¥ng n·ª£ hi·ªán t·∫°i</div>
                                </div>
                                <div onclick="app.exportCustomerReport('${customer.id}', '${customer.name}')" style="background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%); color: #374151; padding: 12px; border-radius: 8px; text-align: center; cursor: pointer; transition: transform 0.2s; position: relative;" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
                                    <div style="font-size: 16px; font-weight: bold; margin-bottom: 4px;">üìÑ</div>
                                    <div style="font-size: 12px; font-weight: 600;">Xu·∫•t b√°o c√°o kh√°ch</div>
                                </div>
                            </div>
                            
                            <!-- L·ªãch s·ª≠ ƒë∆°n h√†ng -->
                            <div>
                                <h4 style="margin-bottom: 16px; color: var(--text-primary); display: flex; align-items: center; gap: 8px;">
                                    <span>üìä</span> L·ªãch s·ª≠ ƒë∆°n h√†ng (${customerOrders.length})
                                </h4>
                                <div style="overflow-x: auto; background: white; border-radius: 8px; border: 1px solid #e5e7eb;">
                                    <table style="width: 100%; border-collapse: collapse;">
                                        <thead style="background: #f8fafc;">
                                            <tr>
                                                <th style="padding: 12px; text-align: left; font-weight: 600; color: #374151; border-bottom: 2px solid #e5e7eb;">M√£ ƒêH</th>
                                                <th style="padding: 12px; text-align: left; font-weight: 600; color: #374151; border-bottom: 2px solid #e5e7eb;">Ng√†y/Gi·ªù</th>
                                                <th style="padding: 12px; text-align: left; font-weight: 600; color: #374151; border-bottom: 2px solid #e5e7eb;">T·ªïng ti·ªÅn</th>
                                                <th style="padding: 12px; text-align: left; font-weight: 600; color: #374151; border-bottom: 2px solid #e5e7eb;">Tr·∫°ng th√°i</th>
                                                <th style="padding: 12px; text-align: left; font-weight: 600; color: #374151; border-bottom: 2px solid #e5e7eb;">Thanh to√°n</th>
                                                <th style="padding: 12px; text-align: left; font-weight: 600; color: #374151; border-bottom: 2px solid #e5e7eb;">Thao t√°c</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${ordersTable}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            
                            <div style="display: flex; justify-content: flex-end; margin-top: 24px;">
                                <button type="button" onclick="closeModal(this.closest('div[style*=fixed]'))" 
                                        style="padding: 12px 24px; background: var(--primary-blue); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">
                                    ƒê√≥ng
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                
                // C·∫≠p nh·∫≠t c√¥ng n·ª£ th·ª±c t·∫ø c·ªßa kh√°ch h√†ng trong d·ªØ li·ªáu
                if (this.demoData.customers[index].debt !== actualDebt) {
                    this.demoData.customers[index].debt = actualDebt;
                    this.saveToLocalStorage();
                }
                
                document.body.insertAdjacentHTML('beforeend', detailHTML);
            }

            exportCustomerReport(customerId, customerName) {
                // Hi·ªÉn th·ªã popup ch·ªçn ng√†y ƒë·ªÉ xu·∫•t b√°o c√°o
                this.showDateRangePickerForCustomerReport(customerId, customerName);
            }
            
            showDateRangePickerForCustomerReport(customerId, customerName) {
                const formHTML = `
                    <div style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.6); z-index: 1001; display: flex; justify-content: center; align-items: center;" onclick="closeModal(this)">
                        <div style="background: white; padding: 32px; border-radius: 12px; width: 500px; max-width: 90vw;" onclick="event.stopPropagation()">
                            <h3 style="margin-bottom: 24px; color: var(--text-primary); text-align: center;">üìä Xu·∫•t b√°o c√°o kh√°ch h√†ng</h3>
                            <p style="text-align: center; color: #6b7280; margin-bottom: 24px; font-size: 16px; font-weight: 500;">
                                Kh√°ch h√†ng: <span style="color: var(--text-primary);">${customerName}</span>
                            </p>
                            
                            <form onsubmit="app.generateCustomerReport(event, '${customerId}', '${customerName}')">
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 20px;">
                                    <div>
                                        <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151;">T·ª´ ng√†y:</label>
                                        <input type="date" name="startDate" required 
                                               style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 14px;">
                                    </div>
                                    <div>
                                        <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151;">ƒê·∫øn ng√†y:</label>
                                        <input type="date" name="endDate" required 
                                               style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 14px;">
                                    </div>
                                </div>
                                
                                <!-- Quick date selection buttons -->
                                <div style="margin-bottom: 20px;">
                                    <p style="margin-bottom: 10px; font-weight: 600; color: #374151; font-size: 14px;">Ho·∫∑c ch·ªçn nhanh:</p>
                                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px;">
                                        <button type="button" onclick="app.setDateRange('7days', '${customerId}-${customerName}')" 
                                                style="padding: 8px 12px; background: #f3f4f6; border: 1px solid #d1d5db; border-radius: 6px; font-size: 12px; cursor: pointer; transition: all 0.2s;"
                                                onmouseover="this.style.background='#e5e7eb'" onmouseout="this.style.background='#f3f4f6'">
                                            7 ng√†y qua
                                        </button>
                                        <button type="button" onclick="app.setDateRange('30days', '${customerId}-${customerName}')" 
                                                style="padding: 8px 12px; background: #f3f4f6; border: 1px solid #d1d5db; border-radius: 6px; font-size: 12px; cursor: pointer; transition: all 0.2s;"
                                                onmouseover="this.style.background='#e5e7eb'" onmouseout="this.style.background='#f3f4f6'">
                                            30 ng√†y qua
                                        </button>
                                        <button type="button" onclick="app.setDateRange('thismonth', '${customerId}-${customerName}')" 
                                                style="padding: 8px 12px; background: #f3f4f6; border: 1px solid #d1d5db; border-radius: 6px; font-size: 12px; cursor: pointer; transition: all 0.2s;"
                                                onmouseover="this.style.background='#e5e7eb'" onmouseout="this.style.background='#f3f4f6'">
                                            Th√°ng n√†y
                                        </button>
                                    </div>
                                </div>
                                
                                <div style="display: flex; gap: 12px; justify-content: flex-end;">
                                    <button type="button" onclick="closeModal(this.closest('div[style*=fixed]'))" 
                                            style="padding: 12px 24px; border: 2px solid #e5e7eb; background: white; border-radius: 8px; cursor: pointer;">H·ªßy</button>
                                    <button type="submit" 
                                            style="padding: 12px 24px; background: var(--primary-blue); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">
                                        üìä Xu·∫•t b√°o c√°o
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                `;
                document.body.insertAdjacentHTML('beforeend', formHTML);
                
                // Set default dates (last 30 days)
                const endDate = new Date();
                const startDate = new Date();
                startDate.setDate(startDate.getDate() - 30);
                
                const form = document.querySelector('input[name="startDate"]').closest('form');
                form.querySelector('input[name="startDate"]').value = startDate.toISOString().split('T')[0];
                form.querySelector('input[name="endDate"]').value = endDate.toISOString().split('T')[0];
            }
            
            setDateRange(period, customerInfo) {
                const [customerId, customerName] = customerInfo.split('-', 2);
                const form = document.querySelector('input[name="startDate"]').closest('form');
                if (!form) return;
                
                const endDate = new Date();
                const startDate = new Date();
                
                switch(period) {
                    case '7days':
                        startDate.setDate(startDate.getDate() - 7);
                        break;
                    case '30days':
                        startDate.setDate(startDate.getDate() - 30);
                        break;
                    case 'thismonth':
                        startDate.setDate(1); // First day of current month
                        break;
                }
                
                form.querySelector('input[name="startDate"]').value = startDate.toISOString().split('T')[0];
                form.querySelector('input[name="endDate"]').value = endDate.toISOString().split('T')[0];
            }
            
            generateCustomerReport(event, customerId, customerName) {
                event.preventDefault();
                const form = event.target;
                const formData = new FormData(form);
                const startDate = formData.get('startDate');
                const endDate = formData.get('endDate');
                
                // Validate dates
                if (new Date(startDate) > new Date(endDate)) {
                    this.showNotification('Ng√†y b·∫Øt ƒë·∫ßu kh√¥ng th·ªÉ l·ªõn h∆°n ng√†y k·∫øt th√∫c', 'error');
                    return;
                }
                
                // Close the modal
                const modal = form.closest("div[style*=\"fixed\"]"); 
                if(modal) modal.remove();
                
                // Generate report with date filter
                this.exportCustomerReportWithDateRange(customerId, customerName, startDate, endDate);
            }
            
            exportCustomerReportWithDateRange(customerId, customerName, startDate, endDate) {
                // T√¨m t·∫•t c·∫£ ƒë∆°n h√†ng c·ªßa kh√°ch h√†ng trong kho·∫£ng th·ªùi gian
                const customerOrders = this.demoData.orders.filter(order => {
                    if (order.customerId !== customerId) return false;
                    
                    // Convert order date to comparable format
                    const orderDate = new Date(order.date.split('/').reverse().join('-'));
                    const filterStartDate = new Date(startDate);
                    const filterEndDate = new Date(endDate);
                    
                    return orderDate >= filterStartDate && orderDate <= filterEndDate;
                });
                
                if (customerOrders.length === 0) {
                    this.showNotification(`Kh√°ch h√†ng ${customerName} kh√¥ng c√≥ ƒë∆°n h√†ng n√†o trong kho·∫£ng th·ªùi gian ${startDate} ƒë·∫øn ${endDate}`, 'warning');
                    return;
                }

                // S·∫Øp x·∫øp ƒë∆°n h√†ng theo ng√†y m·ªõi nh·∫•t
                const sortedOrders = this.sortOrdersByDate(customerOrders);

                // T√≠nh to√°n th·ªëng k√™
                const totalOrders = customerOrders.length;
                const totalAmount = customerOrders.reduce((sum, order) => sum + order.total, 0);
                const paidAmount = customerOrders.filter(o => o.paymentStatus === 'ƒê√£ thanh to√°n').reduce((sum, order) => sum + order.total, 0);
                const debtAmount = customerOrders.filter(o => o.paymentStatus !== 'ƒê√£ thanh to√°n').reduce((sum, order) => sum + order.total, 0);

                // Format dates for display
                const formatStartDate = new Date(startDate).toLocaleDateString('vi-VN');
                const formatEndDate = new Date(endDate).toLocaleDateString('vi-VN');
                
                // T·∫°o n·ªôi dung b√°o c√°o HTML
                let reportContent = `
                    <div style="max-width: 800px; margin: 0 auto; padding: 20px; font-family: Arial, sans-serif; line-height: 1.6;">
                        <div style="text-align: center; border-bottom: 3px solid #3b82f6; padding-bottom: 20px; margin-bottom: 30px;">
                            <h1 style="color: #1f2937; margin: 0; font-size: 24px;">B√ÅO C√ÅO MUA H√ÄNG KH√ÅCH H√ÄNG</h1>
                            <h2 style="color: #3b82f6; margin: 10px 0 0 0; font-size: 20px;">${customerName}</h2>
                            <p style="color: #6b7280; margin: 5px 0;">M√£ kh√°ch h√†ng: ${customerId}</p>
                            <p style="color: #e11d48; margin: 5px 0; font-weight: 600; font-size: 16px;">T·ª´ ${formatStartDate} ƒë·∫øn ${formatEndDate}</p>
                            <p style="color: #6b7280; margin: 0;">Ng√†y xu·∫•t b√°o c√°o: ${this.formatVietnameseTime()}</p>
                        </div>

                        <!-- Th·ªëng k√™ t·ªïng quan -->
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-bottom: 30px;">
                            <div style="background: #f8fafc; padding: 15px; border-radius: 8px; border-left: 4px solid #3b82f6;">
                                <h3 style="margin: 0 0 5px 0; color: #1f2937; font-size: 16px;">T·ªïng ƒë∆°n h√†ng</h3>
                                <p style="margin: 0; font-size: 24px; font-weight: bold; color: #3b82f6;">${totalOrders}</p>
                            </div>
                            <div style="background: #f8fafc; padding: 15px; border-radius: 8px; border-left: 4px solid #059669;">
                                <h3 style="margin: 0 0 5px 0; color: #1f2937; font-size: 16px;">T·ªïng ti·ªÅn mua</h3>
                                <p style="margin: 0; font-size: 20px; font-weight: bold; color: #059669;">${totalAmount.toLocaleString('vi-VN')} VNƒê</p>
                            </div>
                            <div style="background: #f8fafc; padding: 15px; border-radius: 8px; border-left: 4px solid #10b981;">
                                <h3 style="margin: 0 0 5px 0; color: #1f2937; font-size: 16px;">ƒê√£ thanh to√°n</h3>
                                <p style="margin: 0; font-size: 20px; font-weight: bold; color: #10b981;">${paidAmount.toLocaleString('vi-VN')} VNƒê</p>
                            </div>
                            <div style="background: #f8fafc; padding: 15px; border-radius: 8px; border-left: 4px solid ${debtAmount > 0 ? '#ef4444' : '#10b981'};">
                                <h3 style="margin: 0 0 5px 0; color: #1f2937; font-size: 16px;">C√≤n n·ª£</h3>
                                <p style="margin: 0; font-size: 20px; font-weight: bold; color: ${debtAmount > 0 ? '#ef4444' : '#10b981'};">${debtAmount.toLocaleString('vi-VN')} VNƒê</p>
                            </div>
                        </div>

                        <!-- Danh s√°ch ƒë∆°n h√†ng -->
                        <div>
                            <h3 style="color: #1f2937; border-bottom: 2px solid #e5e7eb; padding-bottom: 10px;">CHI TI·∫æT C√ÅC ƒê·ªñN H√ÄNG</h3>
                            <table style="width: 100%; border-collapse: collapse; margin-top: 15px;">
                                <thead>
                                    <tr style="background: #f8fafc;">
                                        <th style="padding: 12px; text-align: left; border: 1px solid #e5e7eb; font-weight: 600;">M√£ ƒêH</th>
                                        <th style="padding: 12px; text-align: left; border: 1px solid #e5e7eb; font-weight: 600;">Ng√†y</th>
                                        <th style="padding: 12px; text-align: right; border: 1px solid #e5e7eb; font-weight: 600;">T·ªïng ti·ªÅn</th>
                                        <th style="padding: 12px; text-align: center; border: 1px solid #e5e7eb; font-weight: 600;">Tr·∫°ng th√°i</th>
                                        <th style="padding: 12px; text-align: center; border: 1px solid #e5e7eb; font-weight: 600;">Thanh to√°n</th>
                                        <th style="padding: 12px; text-align: left; border: 1px solid #e5e7eb; font-weight: 600;">S·∫£n ph·∫©m</th>
                                    </tr>
                                </thead>
                                <tbody>
                `;

                // Th√™m t·ª´ng ƒë∆°n h√†ng v√†o b√°o c√°o
                sortedOrders.forEach(order => {
                    const productList = order.products.map(p => `${p.name} (SL: ${p.quantity})`).join(', ');
                    reportContent += `
                        <tr>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; font-weight: 600;">${order.id}</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb;">${order.date}</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: right; font-weight: 600;">${order.total.toLocaleString('vi-VN')} VNƒê</td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">
                                <span style="padding: 3px 8px; border-radius: 12px; font-size: 11px; font-weight: 600; background: ${order.status === 'Ho√†n th√†nh' ? '#dcfce7; color: #166534' : order.status === 'ƒêang x·ª≠ l√Ω' ? '#fef3c7; color: #92400e' : '#fee2e2; color: #dc2626'};">${order.status}</span>
                            </td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">
                                <span style="padding: 3px 8px; border-radius: 12px; font-size: 11px; font-weight: 600; background: ${order.paymentStatus === 'ƒê√£ thanh to√°n' ? '#dcfce7; color: #166534' : '#fef3c7; color: #92400e'};">${order.paymentStatus}</span>
                            </td>
                            <td style="padding: 10px; border: 1px solid #e5e7eb; font-size: 12px;">${productList}</td>
                        </tr>
                    `;
                });

                reportContent += `
                                </tbody>
                            </table>
                        </div>

                        <!-- Footer -->
                        <div style="margin-top: 40px; padding-top: 20px; border-top: 2px solid #e5e7eb; text-align: center; color: #6b7280;">
                            <p>B√°o c√°o ƒë∆∞·ª£c t·∫°o t·ª± ƒë·ªông t·ª´ H·ªá th·ªëng PhuocIT Vi·ªát Nam</p>
                            <p style="font-size: 12px;">¬© ${new Date().getFullYear()} - B·∫£n quy·ªÅn thu·ªôc v·ªÅ c·ª≠a h√†ng</p>
                        </div>
                    </div>
                `;

                // M·ªü c·ª≠a s·ªï m·ªõi v√† in b√°o c√°o
                const printWindow = window.open('', '_blank', 'width=800,height=600');
                printWindow.document.write(`
                    <!DOCTYPE html>
                    <html>
                    <head>
                        <title>B√°o c√°o kh√°ch h√†ng - ${customerName}</title>
                        <meta charset="UTF-8">
                        <style>
                            @media print {
                                body { margin: 0; }
                                .no-print { display: none; }
                            }
                        </style>
                    </head>
                    <body>
                        <div style="padding: 20px; margin-bottom: 20px;" class="no-print">
                            <button onclick="window.print()" style="background: #3b82f6; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; margin-right: 10px;">üñ®Ô∏è In b√°o c√°o</button>
                            <button onclick="window.close()" style="background: #6b7280; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer;">‚ùå ƒê√≥ng</button>
                        </div>
                        ${reportContent}
                    </body>
                    </html>
                `);
                printWindow.document.close();

                this.showNotification(`ƒê√£ xu·∫•t b√°o c√°o cho kh√°ch h√†ng ${customerName}`, 'success');
            }

            backupProductsToExcel() {
                if (this.demoData.products.length === 0) {
                    this.showNotification('Kh√¥ng c√≥ s·∫£n ph·∫©m n√†o ƒë·ªÉ backup', 'warning');
                    return;
                }

                // T·∫°o d·ªØ li·ªáu Excel v·ªõi ti√™u ƒë·ªÅ ti·∫øng Vi·ªát
                const headers = ['M√£ SP', 'T√™n s·∫£n ph·∫©m', 'Danh m·ª•c', 'Gi√° b√°n', 'Gi√° nh·∫≠p', 'T·ªìn kho', 'Nh√† cung c·∫•p'];
                const excelData = [headers];
                
                this.demoData.products.forEach(product => {
                    excelData.push([
                        product.id,
                        product.name,
                        product.category,
                        product.price,
                        product.importPrice || '',
                        product.stock,
                        product.supplier || ''
                    ]);
                });

                // T·∫°o n·ªôi dung CSV
                const csvContent = excelData.map(row => 
                    row.map(field => {
                        // X·ª≠ l√Ω field c√≥ d·∫•u ph·∫©y ho·∫∑c d·∫•u ngo·∫∑c k√©p
                        if (typeof field === 'string' && (field.includes(',') || field.includes('"'))) {
                            return `"${field.replace(/"/g, '""')}"`;
                        }
                        return field;
                    }).join(',')
                ).join('\n');

                // Th√™m BOM ƒë·ªÉ Excel hi·ªÉn th·ªã ƒë√∫ng ti·∫øng Vi·ªát
                const BOM = '\uFEFF';
                const csvWithBOM = BOM + csvContent;

                // T·∫°o v√† download file
                const blob = new Blob([csvWithBOM], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                
                link.setAttribute('href', url);
                link.setAttribute('download', `SanPham_Backup_${this.formatDateForFilename()}.csv`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);

                this.showNotification(`ƒê√£ backup ${this.demoData.products.length} s·∫£n ph·∫©m ra file Excel`, 'success');
            }

            showUploadProductsForm() {
                const formHTML = `
                    <div style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1001; display: flex; justify-content: center; align-items: center;" onclick="closeModal(this)">
                        <div style="background: white; padding: 32px; border-radius: 12px; width: 600px; max-width: 95vw; max-height: 90vh; overflow-y: auto;" onclick="event.stopPropagation()">
                            <h3 style="margin-bottom: 24px; color: var(--text-primary); display: flex; align-items: center; gap: 8px;">
                                <span>üì§</span> Upload file Excel s·∫£n ph·∫©m
                            </h3>
                            
                            <!-- H∆∞·ªõng d·∫´n -->
                            <div style="background: #f0f9ff; padding: 16px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #0ea5e9;">
                                <h4 style="margin: 0 0 8px 0; color: #0c4a6e;">üìã ƒê·ªãnh d·∫°ng file Excel:</h4>
                                <p style="margin: 0; font-size: 14px; line-height: 1.5;">
                                    File Excel ph·∫£i c√≥ c√°c c·ªôt theo th·ª© t·ª±:<br>
                                    <strong>M√£ SP | T√™n s·∫£n ph·∫©m | Danh m·ª•c | Gi√° b√°n | Gi√° nh·∫≠p | T·ªìn kho | Nh√† cung c·∫•p</strong>
                                </p>
                            </div>

                            <!-- V√≠ d·ª• -->
                            <div style="background: #f8fafc; padding: 16px; border-radius: 8px; margin-bottom: 20px;">
                                <h4 style="margin: 0 0 8px 0; color: #374151;">üí° V√≠ d·ª•:</h4>
                                <table style="width: 100%; border-collapse: collapse; font-size: 12px;">
                                    <thead>
                                        <tr style="background: #e5e7eb;">
                                            <th style="padding: 4px; border: 1px solid #d1d5db;">M√£ SP</th>
                                            <th style="padding: 4px; border: 1px solid #d1d5db;">T√™n s·∫£n ph·∫©m</th>
                                            <th style="padding: 4px; border: 1px solid #d1d5db;">Danh m·ª•c</th>
                                            <th style="padding: 4px; border: 1px solid #d1d5db;">Gi√° b√°n</th>
                                            <th style="padding: 4px; border: 1px solid #d1d5db;">Gi√° nh·∫≠p</th>
                                            <th style="padding: 4px; border: 1px solid #d1d5db;">T·ªìn kho</th>
                                            <th style="padding: 4px; border: 1px solid #d1d5db;">Nh√† cung c·∫•p</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td style="padding: 4px; border: 1px solid #d1d5db;">SP001</td>
                                            <td style="padding: 4px; border: 1px solid #d1d5db;">√Åo thun nam</td>
                                            <td style="padding: 4px; border: 1px solid #d1d5db;">Th·ªùi trang</td>
                                            <td style="padding: 4px; border: 1px solid #d1d5db;">150000</td>
                                            <td style="padding: 4px; border: 1px solid #d1d5db;">100000</td>
                                            <td style="padding: 4px; border: 1px solid #d1d5db;">50</td>
                                            <td style="padding: 4px; border: 1px solid #d1d5db;">NCC ABC</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>

                            <!-- Upload form -->
                            <form onsubmit="app.uploadProductsFromExcel(event)">
                                <div style="margin-bottom: 20px;">
                                    <label style="display: block; margin-bottom: 8px; font-weight: 600;">Ch·ªçn file Excel (.csv): *</label>
                                    <input type="file" name="excelFile" accept=".csv,.xlsx,.xls" required
                                           style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px;">
                                    <p style="margin: 4px 0 0 0; font-size: 12px; color: #6b7280;">H·ªó tr·ª£ file .csv, .xlsx, .xls</p>
                                </div>

                                <!-- T√πy ch·ªçn x·ª≠ l√Ω -->
                                <div style="margin-bottom: 20px;">
                                    <label style="display: block; margin-bottom: 8px; font-weight: 600;">X·ª≠ l√Ω s·∫£n ph·∫©m tr√πng m√£:</label>
                                    <div style="display: flex; gap: 16px;">
                                        <label style="display: flex; align-items: center; gap: 6px;">
                                            <input type="radio" name="duplicateAction" value="skip" checked>
                                            <span style="font-size: 14px;">B·ªè qua</span>
                                        </label>
                                        <label style="display: flex; align-items: center; gap: 6px;">
                                            <input type="radio" name="duplicateAction" value="update">
                                            <span style="font-size: 14px;">C·∫≠p nh·∫≠t</span>
                                        </label>
                                    </div>
                                </div>
                                
                                <div style="display: flex; gap: 12px; justify-content: flex-end;">
                                    <button type="button" onclick="closeModal(this.closest('div[style*=fixed]'))" 
                                            style="padding: 12px 24px; border: 2px solid #e5e7eb; background: white; border-radius: 8px; cursor: pointer;">H·ªßy</button>
                                    <button type="submit" 
                                            style="padding: 12px 24px; background: var(--primary-blue); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">Upload Excel</button>
                                </div>
                            </form>
                        </div>
                    </div>
                `;
                document.body.insertAdjacentHTML('beforeend', formHTML);
            }

            uploadProductsFromExcel(event) {
                event.preventDefault();
                const form = event.target;
                const fileInput = form.querySelector('input[type="file"]');
                const duplicateAction = form.querySelector('input[name="duplicateAction"]:checked').value;
                
                if (!fileInput.files[0]) {
                    this.showNotification('Vui l√≤ng ch·ªçn file Excel', 'error');
                    return;
                }

                const file = fileInput.files[0];
                const reader = new FileReader();

                reader.onload = (e) => {
                    try {
                        let csvData = e.target.result;
                        
                        // Lo·∫°i b·ªè BOM n·∫øu c√≥
                        if (csvData.charCodeAt(0) === 0xFEFF) {
                            csvData = csvData.slice(1);
                        }
                        
                        // Debug: Log raw data
                        console.log('Raw CSV Data:', csvData.substring(0, 200));
                        
                        const lines = csvData.split('\n').filter(line => line.trim());
                        console.log('S·ªë d√≤ng ƒë·ªçc ƒë∆∞·ª£c:', lines.length);
                        console.log('D√≤ng ƒë·∫ßu ti√™n:', lines[0]);
                        
                        if (lines.length < 2) {
                            this.showNotification('File Excel ph·∫£i c√≥ √≠t nh·∫•t 1 d√≤ng ti√™u ƒë·ªÅ v√† 1 d√≤ng d·ªØ li·ªáu', 'error');
                            return;
                        }

                        // B·ªè qua d√≤ng ti√™u ƒë·ªÅ
                        const dataLines = lines.slice(1);
                        let addedCount = 0;
                        let updatedCount = 0;
                        let skippedCount = 0;
                        let errorLines = [];

                        console.log('B·∫Øt ƒë·∫ßu x·ª≠ l√Ω', dataLines.length, 'd√≤ng d·ªØ li·ªáu');

                        dataLines.forEach((line, index) => {
                            if (!line.trim()) return; // B·ªè qua d√≤ng tr·ªëng
                            
                            console.log(`X·ª≠ l√Ω d√≤ng ${index + 2}:`, line);
                            const columns = this.parseCSVLine(line);
                            console.log('Columns parsed:', columns);
                            
                            if (columns.length < 7) {
                                console.warn(`D√≤ng ${index + 2}: Ch·ªâ c√≥ ${columns.length} c·ªôt, c·∫ßn 7 c·ªôt`);
                                errorLines.push(`D√≤ng ${index + 2}: Kh√¥ng ƒë·ªß 7 c·ªôt`);
                                skippedCount++;
                                return;
                            }

                            const [id, name, category, price, importPrice, stock, supplier] = columns;
                            
                            // Ki·ªÉm tra d·ªØ li·ªáu b·∫Øt bu·ªôc
                            if (!id?.trim() || !name?.trim() || !category?.trim() || !price?.trim()) {
                                console.warn(`D√≤ng ${index + 2}: Thi·∫øu th√¥ng tin b·∫Øt bu·ªôc:`, {id, name, category, price});
                                errorLines.push(`D√≤ng ${index + 2}: Thi·∫øu th√¥ng tin b·∫Øt bu·ªôc`);
                                skippedCount++;
                                return;
                            }

                            // Ki·ªÉm tra s·∫£n ph·∫©m ƒë√£ t·ªìn t·∫°i
                            const cleanId = id.trim();
                            const existingIndex = this.demoData.products.findIndex(p => p.id === cleanId);
                            
                            const productData = {
                                id: cleanId,
                                name: name.trim(),
                                category: category.trim(),
                                price: parseInt(price) || 0,
                                importPrice: parseInt(importPrice) || 0,
                                stock: parseInt(stock) || 0,
                                supplier: supplier ? supplier.trim() : ''
                            };

                            console.log('Product data created:', productData);

                            if (existingIndex !== -1) {
                                if (duplicateAction === 'update') {
                                    this.demoData.products[existingIndex] = productData;
                                    updatedCount++;
                                    console.log('Updated existing product:', cleanId);
                                } else {
                                    skippedCount++;
                                    console.log('Skipped duplicate product:', cleanId);
                                }
                            } else {
                                this.demoData.products.push(productData);
                                addedCount++;
                                console.log('Added new product:', cleanId);
                            }
                        });

                        console.log('Upload results:', {addedCount, updatedCount, skippedCount});

                        this.saveToLocalStorage();
                        this.loadPage('products');

                        let message = `Upload ho√†n t·∫•t: `;
                        if (addedCount > 0) message += `${addedCount} s·∫£n ph·∫©m m·ªõi, `;
                        if (updatedCount > 0) message += `${updatedCount} s·∫£n ph·∫©m c·∫≠p nh·∫≠t, `;
                        if (skippedCount > 0) message += `${skippedCount} s·∫£n ph·∫©m b·ªè qua`;
                        
                        // Hi·ªÉn th·ªã l·ªói n·∫øu c√≥
                        if (errorLines.length > 0) {
                            message += `\n\nChi ti·∫øt l·ªói:\n${errorLines.join('\n')}`;
                        }
                        
                        this.showNotification(message, addedCount > 0 || updatedCount > 0 ? 'success' : 'warning');
                        const modal = form.closest("div[style*=\"fixed\"]"); 
                        if(modal) modal.remove();

                    } catch (error) {
                        console.error('L·ªói ƒë·ªçc file Excel:', error);
                        this.showNotification(`L·ªói ƒë·ªçc file Excel: ${error.message}`, 'error');
                    }
                };

                reader.readAsText(file, 'UTF-8');
            }

            parseCSVLine(line) {
                const columns = [];
                let current = '';
                let inQuotes = false;
                
                for (let i = 0; i < line.length; i++) {
                    const char = line[i];
                    
                    if (char === '"' && !inQuotes) {
                        inQuotes = true;
                    } else if (char === '"' && inQuotes) {
                        if (line[i + 1] === '"') {
                            current += '"';
                            i++; // Skip next quote
                        } else {
                            inQuotes = false;
                        }
                    } else if (char === ',' && !inQuotes) {
                        columns.push(current.trim());
                        current = '';
                    } else {
                        current += char;
                    }
                }
                
                columns.push(current.trim());
                return columns;
            }

            formatDateForFilename() {
                const now = new Date();
                const year = now.getFullYear();
                const month = String(now.getMonth() + 1).padStart(2, '0');
                const day = String(now.getDate()).padStart(2, '0');
                const hour = String(now.getHours()).padStart(2, '0');
                const minute = String(now.getMinutes()).padStart(2, '0');
                return `${year}${month}${day}_${hour}${minute}`;
            }

            deleteSupplier(index) {
                const supplier = this.demoData.suppliers[index];
                if (confirm(`B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a nh√† cung c·∫•p ${supplier.name}?`)) {
                    this.demoData.suppliers.splice(index, 1);
                    this.saveToLocalStorage();
                    this.showNotification(`ƒê√£ x√≥a nh√† cung c·∫•p ${supplier.name}`, 'success');
                    this.loadPage('suppliers');
                }
            }

            deleteProduct(index) {
                const product = this.demoData.products[index];
                if (confirm(`B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a s·∫£n ph·∫©m ${product.name}?`)) {
                    this.demoData.products.splice(index, 1);
                    this.saveToLocalStorage();
                    this.showNotification(`ƒê√£ x√≥a s·∫£n ph·∫©m ${product.name}`, 'success');
                    this.loadPage('products');
                }
            }
            
            showSearchCustomer() {
                const searchBox = document.getElementById('search-box');
                const searchInput = document.getElementById('customer-search');
                
                if (searchBox.style.display === 'none') {
                    searchBox.style.display = 'block';
                    searchInput.focus();
                } else {
                    searchBox.style.display = 'none';
                    searchInput.value = '';
                    this.loadPage('customers');
                }
            }
            
            searchCustomers(query) {
                if (!query.trim()) {
                    this.loadPage('customers');
                    return;
                }
                
                const filteredCustomers = this.demoData.customers.filter(customer => 
                    customer.name.toLowerCase().includes(query.toLowerCase()) ||
                    customer.phone.includes(query) ||
                    customer.email.toLowerCase().includes(query.toLowerCase()) ||
                    (customer.companyName && customer.companyName.toLowerCase().includes(query.toLowerCase())) ||
                    (customer.department && customer.department.toLowerCase().includes(query.toLowerCase())) ||
                    (customer.taxCode && customer.taxCode.includes(query))
                );
                
                const customersTable = filteredCustomers.map((customer, index) => {
                    // S·ª≠ d·ª•ng c√πng logic hi·ªÉn th·ªã nh∆∞ danh s√°ch ch√≠nh
                    const typeDisplay = customer.type === 'doanh-nghiep' ? 'üè¢ Doanh nghi·ªáp' : 'üë§ C√° nh√¢n';
                    const iconClass = customer.type === 'doanh-nghiep' ? 'warning' : 'info';
                    const iconSymbol = customer.type === 'doanh-nghiep' ? 'üè¢' : 'üë§';
                    
                    const companyInfo = customer.type === 'doanh-nghiep' && customer.companyName ? 
                        ` | üè¢ ${customer.companyName}` : '';
                    const departmentInfo = customer.type === 'doanh-nghiep' && customer.department ? 
                        ` | üè¨ ${customer.department}` : '';
                    const taxCodeInfo = customer.type === 'doanh-nghiep' && customer.taxCode ? 
                        ` | üÜî MST: ${customer.taxCode}` : '';
                    
                    return `
                        <div class="activity-item">
                            <div class="activity-icon ${iconClass}">${iconSymbol}</div>
                            <div class="activity-content">
                                <div class="activity-title">${customer.name} (${customer.id})</div>
                                <div class="activity-desc">${typeDisplay}${companyInfo}${departmentInfo}${taxCodeInfo}</div>
                                <div class="activity-desc">üìû ${customer.phone} | üìß ${customer.email} | üìç ${customer.address}</div>
                            </div>
                            <div style="display: flex; gap: 8px; align-items: center;">
                                <div class="activity-time">${customer.debt > 0 ? `N·ª£: ${customer.debt.toLocaleString('vi-VN')} VNƒê` : 'Kh√¥ng n·ª£'}</div>
                                <button onclick="app.showCustomerDetails(${this.demoData.customers.indexOf(customer)})" style="background: #059669; color: white; padding: 4px 8px; border: none; border-radius: 4px; cursor: pointer;">Chi ti·∫øt</button>
                                <button onclick="app.editCustomer(${this.demoData.customers.indexOf(customer)})" style="background: #3b82f6; color: white; padding: 4px 8px; border: none; border-radius: 4px; cursor: pointer;">S·ª≠a</button>
                                <button onclick="app.deleteCustomer(${this.demoData.customers.indexOf(customer)})" style="background: #ef4444; color: white; padding: 4px 8px; border: none; border-radius: 4px; cursor: pointer;">X√≥a</button>
                            </div>
                        </div>
                    `;
                }).join('');
                
                document.getElementById('customers-list').innerHTML = customersTable || '<div style="text-align: center; padding: 40px; color: #6b7280;">Kh√¥ng t√¨m th·∫•y kh√°ch h√†ng n√†o</div>';
            }
            
            exportCustomers(mode = null) {
                if (!mode) {
                    this.showExportOptions('Xu·∫•t d·ªØ li·ªáu kh√°ch h√†ng', 'customers', 'exportCustomers');
                    return;
                }

                if (mode === 'view') {
                    const columns = [
                        { header: 'M√£ KH', getValue: customer => customer.id },
                        { header: 'T√™n kh√°ch h√†ng', getValue: customer => customer.name },
                        { header: 'ƒêi·ªán tho·∫°i', getValue: customer => customer.phone || 'N/A' },
                        { header: 'Email', getValue: customer => customer.email || 'N/A' },
                        { header: 'ƒê·ªãa ch·ªâ', getValue: customer => customer.address || 'N/A' },
                        { header: 'C√¥ng n·ª£ (VNƒê)', getValue: customer => customer.debt.toLocaleString('vi-VN') }
                    ];
                    this.showDataViewer('Danh s√°ch kh√°ch h√†ng', this.demoData.customers, columns);
                } else if (mode === 'download') {
                    const csvContent = "data:text/csv;charset=utf-8,\uFEFF" + 
                        "M√£ KH,T√™n kh√°ch h√†ng,ƒêi·ªán tho·∫°i,Email,ƒê·ªãa ch·ªâ,C√¥ng n·ª£\n" +
                        this.demoData.customers.map(c => 
                            `${c.id},"${c.name}","${c.phone}","${c.email}","${c.address}",${c.debt}`
                        ).join('\n');
                    
                    const encodedUri = encodeURI(csvContent);
                    const link = document.createElement("a");
                    link.setAttribute("href", encodedUri);
                    link.setAttribute("download", `khach_hang_${this.getVietnamTime().toISOString().split('T')[0]}.csv`);
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    
                    this.showNotification('ƒê√£ t·∫£i xu·ªëng danh s√°ch kh√°ch h√†ng', 'success');
                }
            }
            
            // Local Storage Management
            saveToLocalStorage() {
                localStorage.setItem('PhuocIT_vietnam_data', JSON.stringify(this.demoData));
            }
            
            loadFromLocalStorage() {
                const saved = localStorage.getItem('PhuocIT_vietnam_data');
                if (saved) {
                    this.demoData = JSON.parse(saved);
                    console.log('=== FORCE RELOAD FROM LOCALSTORAGE ===');
                    this.demoData.customers.forEach(customer => {
                        console.log(`Force Loaded: ${customer.name} - N·ª£: ${customer.debt.toLocaleString('vi-VN')} VNƒê`);
                    });
                    console.log('=== END FORCE LOAD DEBUG ===');
                    return true; // Indicate successful load
                }
                return false; // No data found
            }
            
            // Backup Management Functions
            toggleAutoBackup(enabled) {
                localStorage.setItem('auto_backup_enabled', enabled.toString());
                if (enabled) {
                    this.startAutoBackup();
                    document.getElementById('backup-status').innerHTML = 'üü¢ ƒêang ho·∫°t ƒë·ªông';
                    this.showNotification('ƒê√£ b·∫≠t t·ª± ƒë·ªông sao l∆∞u', 'success');
                } else {
                    this.stopAutoBackup();
                    document.getElementById('backup-status').innerHTML = 'üî¥ T·∫Øt';
                    this.showNotification('ƒê√£ t·∫Øt t·ª± ƒë·ªông sao l∆∞u', 'info');
                }
            }
            
            setBackupInterval(minutes) {
                localStorage.setItem('backup_interval', minutes);
                if (localStorage.getItem('auto_backup_enabled') === 'true') {
                    this.stopAutoBackup();
                    this.startAutoBackup();
                    this.showNotification(`ƒê√£ ƒë·∫∑t t·∫ßn su·∫•t sao l∆∞u ${minutes} ph√∫t`, 'success');
                }
            }
            
            startAutoBackup() {
                this.stopAutoBackup();
                const interval = parseInt(localStorage.getItem('backup_interval') || '30');
                this.autoBackupTimer = setInterval(() => {
                    this.performBackup();
                }, interval * 60 * 1000);
            }
            
            stopAutoBackup() {
                if (this.autoBackupTimer) {
                    clearInterval(this.autoBackupTimer);
                    this.autoBackupTimer = null;
                }
            }
            
            manualBackup() {
                this.performBackup();
                this.showNotification('ƒê√£ t·∫£i xu·ªëng file sao l∆∞u', 'success');
            }
            
            performBackup() {
                const backupData = {
                    version: '1.0',
                    timestamp: this.getVietnamTime().toISOString(),
                    data: this.demoData,
                    metadata: {
                        totalCustomers: this.demoData.customers.length,
                        totalSuppliers: this.demoData.suppliers.length,
                        totalProducts: this.demoData.products.length,
                        totalSales: this.demoData.sales.length
                    }
                };
                
                const jsonString = JSON.stringify(backupData, null, 2);
                const blob = new Blob([jsonString], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                
                const link = document.createElement('a');
                link.href = url;
                const vietnamTime = this.getVietnamTime();
                link.download = `PhuocIT_vietnam_backup_${vietnamTime.toISOString().split('T')[0]}_${vietnamTime.toTimeString().split(' ')[0].replace(/:/g, '')}.json`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                URL.revokeObjectURL(url);
                localStorage.setItem('last_backup_time', this.getVietnamTime().toISOString());
                
                // Update UI if on settings page
                if (this.currentPage === 'settings') {
                    this.loadPage('settings');
                }
            }
            
            restoreFromFile(event) {
                const file = event.target.files[0];
                if (!file) return;
                
                if (file.type !== 'application/json') {
                    this.showNotification('Vui l√≤ng ch·ªçn file JSON h·ª£p l·ªá', 'error');
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const backupData = JSON.parse(e.target.result);
                        
                        if (!backupData.data || !backupData.version) {
                            throw new Error('File backup kh√¥ng ƒë√∫ng ƒë·ªãnh d·∫°ng');
                        }
                        
                        // Confirm before restore
                        if (confirm('Kh√¥i ph·ª•c d·ªØ li·ªáu s·∫Ω ghi ƒë√® to√†n b·ªô d·ªØ li·ªáu hi·ªán t·∫°i. B·∫°n c√≥ ch·∫Øc ch·∫Øn?')) {
                            this.demoData = backupData.data;
                            this.saveToLocalStorage();
                            this.showNotification('ƒê√£ kh√¥i ph·ª•c d·ªØ li·ªáu th√†nh c√¥ng', 'success');
                            
                            // Refresh current page
                            this.loadPage(this.currentPage);
                        }
                    } catch (error) {
                        console.error('Error restoring backup:', error);
                        this.showNotification('Kh√¥ng th·ªÉ kh√¥i ph·ª•c d·ªØ li·ªáu. File c√≥ th·ªÉ b·ªã l·ªói', 'error');
                    }
                };
                reader.readAsText(file);
                
                // Reset file input
                event.target.value = '';
            }
            
            calculateStorageSize() {
                const data = localStorage.getItem('PhuocIT_vietnam_data');
                if (data) {
                    const sizeInBytes = new Blob([data]).size;
                    const sizeInKB = (sizeInBytes / 1024).toFixed(1);
                    const sizeInMB = (sizeInBytes / (1024 * 1024)).toFixed(2);
                    
                    if (sizeInBytes < 1024) {
                        return `${sizeInBytes} B`;
                    } else if (sizeInBytes < 1024 * 1024) {
                        return `${sizeInKB} KB`;
                    } else {
                        return `${sizeInMB} MB`;
                    }
                }
                return '0 B';
            }
            
            // Company Settings Functions
            saveCompanySettings(event) {
                event.preventDefault();
                
                const formData = new FormData(event.target);
                const companySettings = {
                    companyName: formData.get('companyName'),
                    taxCode: formData.get('taxCode'),
                    address: formData.get('address'),
                    phone: formData.get('phone'),
                    email: formData.get('email'),
                    representative: formData.get('representative'),
                    position: formData.get('position'),
                    description: formData.get('description'),
                    updatedAt: this.getVietnamTime().toISOString()
                };
                
                // Validate required fields
                if (!companySettings.companyName.trim() || !companySettings.address.trim() || !companySettings.phone.trim()) {
                    this.showNotification('Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin b·∫Øt bu·ªôc (c√≥ d·∫•u *)', 'error');
                    return;
                }
                
                // Save to localStorage
                localStorage.setItem('company_settings', JSON.stringify(companySettings));
                this.showNotification('ƒê√£ l∆∞u th√¥ng tin c√¥ng ty th√†nh c√¥ng! Th√¥ng tin n√†y s·∫Ω hi·ªÉn th·ªã tr√™n h√≥a ƒë∆°n in ra.', 'success');
                
                console.log('üíæ Company settings saved:', companySettings);
            }
            
            resetCompanySettings() {
                if (confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a t·∫•t c·∫£ th√¥ng tin c√¥ng ty ƒë√£ l∆∞u?')) {
                    localStorage.removeItem('company_settings');
                    this.showNotification('ƒê√£ x√≥a th√¥ng tin c√¥ng ty', 'success');
                    
                    // Reload settings page to show empty form
                    this.loadPage('settings');
                }
            }
            
            getCompanySettings() {
                try {
                    const settings = localStorage.getItem('company_settings');
                    if (!settings) return {};
                    
                    const parsed = JSON.parse(settings);
                    
                    // Validate that logo and QR data exist
                    console.log('Loading company settings...');
                    console.log('Logo exists:', !!parsed.logo);
                    console.log('QR exists:', !!parsed.qrCode);
                    
                    return parsed;
                } catch (error) {
                    console.error('Error loading company settings:', error);
                    return {};
                }
            }

            // Debug function to check localStorage
            testLocalStorage() {
                const settings = localStorage.getItem('company_settings');
                console.log('=== FULL DEBUG LOCALSTORAGE ===');
                console.log('Raw data exists:', !!settings);
                console.log('Data length:', settings ? settings.length : 0);
                console.log('Size estimate:', this.getLocalStorageSize());
                
                if (settings) {
                    try {
                        const parsed = JSON.parse(settings);
                        console.log('Parsed successfully');
                        console.log('Company name:', parsed.companyName || 'Not set');
                        console.log('Logo exists:', !!parsed.logo, parsed.logo ? `(${(parsed.logo.length/1024).toFixed(1)}KB)` : '');
                        console.log('QR exists:', !!parsed.qrCode, parsed.qrCode ? `(${(parsed.qrCode.length/1024).toFixed(1)}KB)` : '');
                    } catch (error) {
                        console.error('JSON Parse Error:', error);
                    }
                }
                alert('Ki·ªÉm tra console ƒë·ªÉ xem chi ti·∫øt localStorage');
            }

            // Check localStorage usage
            getLocalStorageSize() {
                let total = 0;
                for (let key in localStorage) {
                    if (localStorage.hasOwnProperty(key)) {
                        total += localStorage[key].length + key.length;
                    }
                }
                return `${(total / 1024).toFixed(1)} KB`;
            }

            // Restore logo and QR after page load
            restoreLogoAndQR() {
                console.log('=== RESTORING LOGO/QR AFTER PAGE LOAD ===');
                const companySettings = this.getCompanySettings();
                
                // Restore logo if exists
                if (companySettings.logo) {
                    const logoDisplay = document.getElementById('logo-display');
                    if (logoDisplay) {
                        logoDisplay.innerHTML = `<img src="${companySettings.logo}" alt="Logo" style="max-width: 100%; max-height: 140px; object-fit: contain;">`;
                        console.log('‚úÖ Logo restored successfully');
                    }
                }
                
                // Restore QR if exists  
                if (companySettings.qrCode) {
                    const qrDisplay = document.getElementById('qr-display');
                    if (qrDisplay) {
                        qrDisplay.innerHTML = `<img src="${companySettings.qrCode}" alt="QR Code" style="max-width: 100%; max-height: 140px; object-fit: contain;">`;
                        console.log('‚úÖ QR Code restored successfully');
                    }
                }
                
                console.log('Restore complete - Logo:', !!companySettings.logo, 'QR:', !!companySettings.qrCode);
            }

            // Compress image before saving to localStorage
            compressImage(file, quality = 0.7, maxWidth = 300, maxHeight = 300) {
                return new Promise((resolve, reject) => {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    const img = new Image();
                    
                    img.onload = () => {
                        // Calculate new dimensions maintaining aspect ratio
                        let { width, height } = img;
                        
                        if (width > height) {
                            if (width > maxWidth) {
                                height = height * (maxWidth / width);
                                width = maxWidth;
                            }
                        } else {
                            if (height > maxHeight) {
                                width = width * (maxHeight / height);
                                height = maxHeight;
                            }
                        }
                        
                        canvas.width = width;
                        canvas.height = height;
                        
                        // Draw and compress
                        ctx.drawImage(img, 0, 0, width, height);
                        const compressedDataUrl = canvas.toDataURL('image/jpeg', quality);
                        resolve(compressedDataUrl);
                    };
                    
                    img.onerror = () => reject(new Error('Failed to load image'));
                    
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        img.src = e.target.result;
                    };
                    reader.onerror = () => reject(new Error('Failed to read file'));
                    reader.readAsDataURL(file);
                });
            }

            // HOSTING SOLUTION: Simple logo upload v·ªõi localStorage
            uploadLogoSimple(event) {
                const file = event.target.files[0];
                if (!file) return;
                
                if (!file.type.startsWith('image/')) {
                    alert('Vui l√≤ng ch·ªçn file h√¨nh ·∫£nh!');
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = (e) => {
                    const imageData = e.target.result;
                    
                    // L∆∞u v√†o global variable
                    window.companyAssets.logo = imageData;
                    
                    // ‚úÖ L∆ØU V√ÄO LOCALSTORAGE - KH√îNG M·∫§T KHI F5
                    localStorage.setItem('company_logo', imageData);
                    
                    // Update display ngay l·∫≠p t·ª©c
                    const logoDisplay = document.getElementById('logo-display');
                    logoDisplay.innerHTML = `<img src="${imageData}" alt="Logo" style="max-width: 100%; max-height: 140px; object-fit: contain;">`;
                    
                    alert('‚úÖ Upload logo th√†nh c√¥ng! Logo ƒë√£ l∆∞u vƒ©nh vi·ªÖn, kh√¥ng m·∫•t khi F5.');
                };
                reader.readAsDataURL(file);
            }
            
            // HOSTING SOLUTION: Simple QR upload v·ªõi localStorage
            uploadQRSimple(event) {
                const file = event.target.files[0];
                if (!file) return;
                
                if (!file.type.startsWith('image/')) {
                    alert('Vui l√≤ng ch·ªçn file h√¨nh ·∫£nh!');
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = (e) => {
                    const imageData = e.target.result;
                    
                    // L∆∞u v√†o global variable
                    window.companyAssets.qr = imageData;
                    
                    // ‚úÖ L∆ØU V√ÄO LOCALSTORAGE - KH√îNG M·∫§T KHI F5
                    localStorage.setItem('company_qr', imageData);
                    
                    // Update display ngay l·∫≠p t·ª©c
                    const qrDisplay = document.getElementById('qr-display');
                    qrDisplay.innerHTML = `<img src="${imageData}" alt="QR Code" style="max-width: 100%; max-height: 140px; object-fit: contain;">`;
                    
                    alert('‚úÖ Upload QR code th√†nh c√¥ng! QR ƒë√£ l∆∞u vƒ©nh vi·ªÖn, kh√¥ng m·∫•t khi F5.');
                };
                reader.readAsDataURL(file);
            }

            // Logo upload function - Save to uploads folder
            uploadLogo(event) {
                const file = event.target.files[0];
                if (!file) return;
                
                // Check file type
                if (!file.type.startsWith('image/')) {
                    this.showNotification('Vui l√≤ng ch·ªçn file h√¨nh ·∫£nh (PNG, JPG, GIF)', 'error');
                    return;
                }
                
                // Check file size (max 2MB)
                if (file.size > 2 * 1024 * 1024) {
                    this.showNotification('K√≠ch th∆∞·ªõc file qu√° l·ªõn. Vui l√≤ng ch·ªçn file d∆∞·ªõi 2MB', 'error');
                    return;
                }
                
                // Create unique filename
                const timestamp = Date.now();
                const fileName = `logo_${timestamp}.${file.name.split('.').pop()}`;
                const logoPath = `uploads/${fileName}`;
                
                // Compress and save file
                this.compressImage(file, 0.7, 300, 300).then(compressedImageData => {
                    
                    // Save logo to company settings with error handling
                    const companySettings = this.getCompanySettings();
                    companySettings.logo = compressedImageData;
                    companySettings.logoPath = logoPath;
                    companySettings.logoFileName = fileName;
                    companySettings.logoTimestamp = timestamp;
                    
                    // Save with error handling
                    try {
                        localStorage.setItem('company_settings', JSON.stringify(companySettings));
                        // Double check save
                        const testSave = localStorage.getItem('company_settings');
                        if (testSave && JSON.parse(testSave).logo) {
                            console.log('Logo successfully saved to localStorage');
                        } else {
                            throw new Error('Save verification failed');
                        }
                    } catch (error) {
                        console.error('Error saving logo:', error);
                        this.showNotification('L·ªói l∆∞u logo. Th·ª≠ l·∫°i v·ªõi file nh·ªè h∆°n.', 'error');
                        return;
                    }
                    
                    // Debug log
                    console.log('Logo saved with path:', logoPath);
                    console.log('Logo data saved:', !!companySettings.logo);
                    
                    // Update display
                    const logoDisplay = document.getElementById('logo-display');
                    logoDisplay.innerHTML = `<img src="${compressedImageData}" alt="Logo" style="max-width: 100%; max-height: 140px; object-fit: contain;">`;
                    
                    // Add remove button
                    const buttonContainer = logoDisplay.parentElement.querySelector('div:last-child');
                    if (!buttonContainer.querySelector('button[onclick*="removeLogo"]')) {
                        buttonContainer.innerHTML = `
                            <button type="button" onclick="document.getElementById('logo-input').click()" 
                                    style="background: var(--primary-blue); color: white; padding: 8px 16px; border: none; border-radius: 6px; cursor: pointer; font-size: 14px;">
                                üìÅ Ch·ªçn Logo
                            </button>
                            <button type="button" onclick="app.removeLogo()" 
                                    style="background: #dc2626; color: white; padding: 8px 16px; border: none; border-radius: 6px; cursor: pointer; font-size: 14px;">
                                üóëÔ∏è X√≥a
                            </button>
                        `;
                    }
                    
                    this.showNotification(`ƒê√£ l∆∞u logo n√©n v√†o ${logoPath}!`, 'success');
                    console.log('Compressed logo size:', (compressedImageData.length/1024).toFixed(1) + 'KB');
                }).catch(error => {
                    console.error('Compression error:', error);
                    this.showNotification('L·ªói n√©n ·∫£nh. Th·ª≠ v·ªõi file kh√°c.', 'error');
                });
            }

            // Remove logo function
            removeLogo() {
                if (!confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a logo?')) return;
                
                // Remove logo from company settings
                const companySettings = this.getCompanySettings();
                delete companySettings.logo;
                localStorage.setItem('company_settings', JSON.stringify(companySettings));
                
                // Update display
                const logoDisplay = document.getElementById('logo-display');
                logoDisplay.innerHTML = '<div style="color: #9ca3af; font-size: 14px;">Ch∆∞a c√≥ logo</div>';
                
                // Remove delete button
                const buttonContainer = logoDisplay.parentElement.querySelector('div:last-child');
                buttonContainer.innerHTML = `
                    <button type="button" onclick="document.getElementById('logo-input').click()" 
                            style="background: var(--primary-blue); color: white; padding: 8px 16px; border: none; border-radius: 6px; cursor: pointer; font-size: 14px;">
                        üìÅ Ch·ªçn Logo
                    </button>
                `;
                
                this.showNotification('ƒê√£ x√≥a logo', 'success');
            }

            // Generate QR Code function
            generateQRCode() {
                const companySettings = this.getCompanySettings();
                
                if (!companySettings.companyName && !companySettings.phone) {
                    this.showNotification('Vui l√≤ng ƒëi·ªÅn th√¥ng tin c√¥ng ty tr∆∞·ªõc khi t·∫°o m√£ QR', 'error');
                    return;
                }
                
                // Create contact info string
                let contactInfo = '';
                if (companySettings.companyName) contactInfo += `C√¥ng ty: ${companySettings.companyName}\n`;
                if (companySettings.address) contactInfo += `ƒê·ªãa ch·ªâ: ${companySettings.address}\n`;
                if (companySettings.phone) contactInfo += `SƒêT: ${companySettings.phone}\n`;
                if (companySettings.email) contactInfo += `Email: ${companySettings.email}\n`;
                if (companySettings.taxCode) contactInfo += `MST: ${companySettings.taxCode}`;
                
                // Generate QR code using qr-server.com API
                const qrSize = 150;
                const qrURL = `https://api.qrserver.com/v1/create-qr-code/?size=${qrSize}x${qrSize}&data=${encodeURIComponent(contactInfo)}&format=png&bgcolor=FFFFFF&color=000000&margin=10`;
                
                // Update QR display
                const qrDisplay = document.getElementById('qr-display');
                qrDisplay.innerHTML = `<img src="${qrURL}" alt="QR Code" style="max-width: 100%; max-height: 140px; object-fit: contain;" 
                     onload="app.showNotification('ƒê√£ t·∫°o m√£ QR th√†nh c√¥ng!', 'success')"
                     onerror="app.showNotification('Kh√¥ng th·ªÉ t·∫°o m√£ QR. Vui l√≤ng ki·ªÉm tra k·∫øt n·ªëi internet', 'error')">`;
                
                // Save QR URL to company settings
                companySettings.qrCode = qrURL;
                localStorage.setItem('company_settings', JSON.stringify(companySettings));
                
                // Debug log
                console.log('QR saved to localStorage:', !!companySettings.qrCode);
                console.log('QR URL:', qrURL);
                
                // Test localStorage immediately
                setTimeout(() => {
                    const testSettings = this.getCompanySettings();
                    console.log('Test read QR back from localStorage:', !!testSettings.qrCode);
                }, 100);
                
                // Reload page to show delete button WITHOUT clearing localStorage
                setTimeout(() => {
                    this.loadPage('company-info');
                }, 200);
            }

            // Upload QR Code function - Save to uploads folder
            uploadQR(event) {
                const file = event.target.files[0];
                if (!file) return;

                // Validate file type
                if (!file.type.startsWith('image/')) {
                    this.showNotification('Vui l√≤ng ch·ªçn file h√¨nh ·∫£nh (PNG, JPG, GIF)', 'error');
                    return;
                }

                // Validate file size (2MB limit)
                if (file.size > 2 * 1024 * 1024) {
                    this.showNotification('File qu√° l·ªõn! Vui l√≤ng ch·ªçn file d∆∞·ªõi 2MB', 'error');
                    return;
                }

                // Create unique filename
                const timestamp = Date.now();
                const fileName = `qr_${timestamp}.${file.name.split('.').pop()}`;
                const qrPath = `uploads/${fileName}`;

                // Compress and save QR code
                this.compressImage(file, 0.8, 200, 200).then(compressedQrData => {
                    // Update QR display
                    const qrDisplay = document.getElementById('qr-display');
                    qrDisplay.innerHTML = `<img src="${compressedQrData}" alt="QR Code" style="max-width: 100%; max-height: 140px; object-fit: contain;">`;
                    
                    // Save QR to company settings with error handling
                    const companySettings = this.getCompanySettings();
                    companySettings.qrCode = compressedQrData;
                    companySettings.qrPath = qrPath;
                    companySettings.qrFileName = fileName;
                    companySettings.qrTimestamp = timestamp;
                    
                    // Save with error handling
                    try {
                        localStorage.setItem('company_settings', JSON.stringify(companySettings));
                        // Double check save
                        const testSave = localStorage.getItem('company_settings');
                        if (testSave && JSON.parse(testSave).qrCode) {
                            console.log('QR successfully saved to localStorage');
                        } else {
                            throw new Error('QR save verification failed');
                        }
                    } catch (error) {
                        console.error('Error saving QR:', error);
                        this.showNotification('L·ªói l∆∞u QR. Th·ª≠ l·∫°i v·ªõi file nh·ªè h∆°n.', 'error');
                        return;
                    }
                    
                    this.showNotification(`ƒê√£ l∆∞u m√£ QR n√©n v√†o ${qrPath}!`, 'success');
                    console.log('QR saved with path:', qrPath);
                    console.log('Compressed QR size:', (compressedQrData.length/1024).toFixed(1) + 'KB');
                    
                    // Reload page to show delete button
                    setTimeout(() => {
                        this.loadPage('company-info');
                    }, 200);
                }).catch(error => {
                    console.error('QR compression error:', error);
                    this.showNotification('L·ªói n√©n ·∫£nh QR. Th·ª≠ v·ªõi file kh√°c.', 'error');
                });
            }

            // Remove QR Code function  
            removeQR() {
                if (!confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a m√£ QR?')) return;
                
                // Remove QR from company settings
                const companySettings = this.getCompanySettings();
                delete companySettings.qrCode;
                localStorage.setItem('company_settings', JSON.stringify(companySettings));
                
                // Update display
                const qrDisplay = document.getElementById('qr-display');
                qrDisplay.innerHTML = '<div style="color: #9ca3af; font-size: 14px;">Ch∆∞a c√≥ m√£ QR</div>';
                
                this.showNotification('ƒê√£ x√≥a m√£ QR', 'success');
                
                // Reload page to hide delete button
                this.loadPage('company-info');
            }
            
            // Sales Management Functions
            showCreateSaleForm() {
                const customerOptions = this.demoData.customers.map(c => 
                    `<option value="${c.id}">${c.name} - ${c.phone}</option>`
                ).join('');
                
                const productOptions = this.demoData.products.map(p => 
                    `<option value="${p.id}" data-price="${p.price}" data-stock="${p.stock}">${p.name} - ${p.price.toLocaleString('vi-VN')} VNƒê (C√≤n: ${p.stock})</option>`
                ).join('');
                
                const formHTML = `
                    <div style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1001; display: flex; justify-content: center; align-items: center; overflow-y: auto;" onclick="closeModal(this)">
                        <div style="background: white; padding: 32px; border-radius: 12px; width: 1000px; max-width: 95vw;" onclick="event.stopPropagation()">
                            <h3 style="margin-bottom: 24px; color: var(--text-primary);">T·∫°o ƒë∆°n b√°n h√†ng m·ªõi</h3>
                            <form onsubmit="app.createSaleOrder(event)">
                                <div style="margin-bottom: 16px;">
                                    <label style="display: block; margin-bottom: 8px; font-weight: 600;">T√™n kh√°ch h√†ng:</label>
                                    <input type="text" name="customerName" required placeholder="Nh·∫≠p t√™n kh√°ch h√†ng" style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px;">
                                </div>
                                <div style="display: flex; gap: 12px; margin-bottom: 16px;">
                                    <div style="flex: 1;">
                                        <label style="display: block; margin-bottom: 8px; font-weight: 600;">S·ªë ƒëi·ªán tho·∫°i:</label>
                                        <input type="tel" name="customPhuocIThone" required placeholder="Nh·∫≠p s·ªë ƒëi·ªán tho·∫°i" style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px;">
                                    </div>
                                    <div style="flex: 2;">
                                        <label style="display: block; margin-bottom: 8px; font-weight: 600;">ƒê·ªãa ch·ªâ:</label>
                                        <input type="text" name="customerAddress" required placeholder="Nh·∫≠p ƒë·ªãa ch·ªâ giao h√†ng" style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px;">
                                    </div>
                                </div>
                                
                                <div style="margin-bottom: 16px;">
                                    <label style="display: block; margin-bottom: 8px; font-weight: 600;">S·∫£n ph·∫©m:</label>
                                    <div id="product-items">
                                        <div class="product-item" style="display: flex; gap: 8px; margin-bottom: 8px; align-items: center;">
                                            <div class="custom-dropdown" style="flex: 2; position: relative;">
                                                <div class="dropdown-selected" onclick="app.toggleProductDropdown(this)" 
                                                     style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; background: white; cursor: pointer; display: flex; justify-content: space-between; align-items: center;">
                                                    <span class="selected-text" style="color: #9ca3af;">Ch·ªçn s·∫£n ph·∫©m</span>
                                                    <span class="dropdown-arrow" style="transform: rotate(0deg); transition: transform 0.3s;">‚ñº</span>
                                                </div>
                                                <div class="dropdown-list" style="position: absolute; top: 100%; left: 0; right: 0; background: white; border: 2px solid #e5e7eb; border-top: none; border-radius: 0 0 8px 8px; max-height: 200px; overflow-y: auto; z-index: 1000; display: none;">
                                                    <div style="padding: 8px; border-bottom: 1px solid #e5e7eb;">
                                                        <input type="text" class="dropdown-search" placeholder="üîç T√¨m s·∫£n ph·∫©m..." 
                                                               style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 4px; font-size: 14px;" 
                                                               oninput="app.filterDropdownItems(this, 'product')" 
                                                               onclick="event.stopPropagation()">
                                                    </div>
                                                    <div class="dropdown-options">
                                                        ${this.demoData.products.map(p => 
                                                            `<div class="dropdown-option" data-value="${p.id}" data-price="${p.price}" data-stock="${p.stock}" 
                                                                  onclick="app.selectProduct(this, '${p.id}', '${p.name} - ${p.price.toLocaleString('vi-VN')} VNƒê', ${p.price})" 
                                                                  style="padding: 10px; cursor: pointer; border-bottom: 1px solid #f3f4f6;" 
                                                                  onmouseover="this.style.background='#f3f4f6'" onmouseout="this.style.background='white'">
                                                                ${p.name} - ${p.price.toLocaleString('vi-VN')} VNƒê (C√≤n: ${p.stock})
                                                            </div>`
                                                        ).join('')}
                                                    </div>
                                                </div>
                                                <input type="hidden" name="products[]" required>
                                            </div>
                                            <input type="number" name="quantities[]" placeholder="S·ªë l∆∞·ª£ng" min="1" required style="flex: 1; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px;" onchange="app.calculateTotal()">
                                            <input type="number" name="prices[]" placeholder="Gi√°" readonly style="flex: 1; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; background: #f9fafb;">
                                            <button type="button" onclick="this.parentElement.remove(); app.calculateTotal();" style="background: #ef4444; color: white; padding: 12px; border: none; border-radius: 8px; cursor: pointer;">X√≥a</button>
                                        </div>
                                    </div>
                                    <button type="button" onclick="app.addProductItem()" style="background: #10b981; color: white; padding: 8px 16px; border: none; border-radius: 8px; cursor: pointer; margin-top: 8px;">+ Th√™m s·∫£n ph·∫©m</button>
                                </div>
                                
                                <div style="margin-bottom: 16px; border: 2px solid red; padding: 10px;">
                                    <label style="display: block; margin-bottom: 8px; font-weight: 600; color: red;">‚≠ê GHI CH√ö ƒê∆†N H√ÄNG (ƒê√É C√ì R·ªíII!):</label>
                                    <textarea name="orderNotes" placeholder="Nh·∫≠p ghi ch√∫ cho ƒë∆°n h√†ng (kh√¥ng b·∫Øt bu·ªôc)" style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; min-height: 80px; resize: vertical;"></textarea>
                                </div>
                                
                                <div style="margin-bottom: 24px; padding: 16px; background: #f9fafb; border-radius: 8px;">
                                    <div style="display: flex; justify-content: space-between; align-items: center;">
                                        <strong>T·ªïng ti·ªÅn:</strong>
                                        <strong id="total-amount" style="color: #059669; font-size: 18px;">0 VNƒê</strong>
                                    </div>
                                </div>
                                
                                <div style="display: flex; gap: 12px; justify-content: flex-end;">
                                    <button type="button" onclick="closeModal(this.closest('div[style*=fixed]'))" 
                                            style="padding: 12px 24px; border: 2px solid #e5e7eb; background: white; border-radius: 8px; cursor: pointer;">H·ªßy</button>
                                    <button type="submit" 
                                            style="padding: 12px 24px; background: var(--primary-blue); color: white; border: none; border-radius: 8px; cursor: pointer;">T·∫°o ƒë∆°n h√†ng</button>
                                </div>
                            </form>
                        </div>
                    </div>
                `;
                document.body.insertAdjacentHTML('beforeend', formHTML);
            }
            
            addProductItem() {
                const productItemHTML = `
                    <div class="product-item" style="display: flex; gap: 8px; margin-bottom: 8px; align-items: center;">
                        <div class="custom-dropdown" style="flex: 2; position: relative;">
                            <div class="dropdown-selected" onclick="app.toggleProductDropdown(this)" 
                                 style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; background: white; cursor: pointer; display: flex; justify-content: space-between; align-items: center;">
                                <span class="selected-text" style="color: #9ca3af;">Ch·ªçn s·∫£n ph·∫©m</span>
                                <span class="dropdown-arrow" style="transform: rotate(0deg); transition: transform 0.3s;">‚ñº</span>
                            </div>
                            <div class="dropdown-list" style="position: absolute; top: 100%; left: 0; right: 0; background: white; border: 2px solid #e5e7eb; border-top: none; border-radius: 0 0 8px 8px; max-height: 200px; overflow-y: auto; z-index: 1000; display: none;">
                                <div style="padding: 8px; border-bottom: 1px solid #e5e7eb;">
                                    <input type="text" class="dropdown-search" placeholder="üîç T√¨m s·∫£n ph·∫©m..." 
                                           style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 4px; font-size: 14px;" 
                                           oninput="app.filterDropdownItems(this, 'product')" 
                                           onclick="event.stopPropagation()">
                                </div>
                                <div class="dropdown-options">
                                    ${this.demoData.products.map(p => 
                                        `<div class="dropdown-option" data-value="${p.id}" data-price="${p.price}" data-stock="${p.stock}" 
                                              onclick="app.selectProduct(this, '${p.id}', '${p.name} - ${p.price.toLocaleString('vi-VN')} VNƒê', ${p.price})" 
                                              style="padding: 10px; cursor: pointer; border-bottom: 1px solid #f3f4f6;" 
                                              onmouseover="this.style.background='#f3f4f6'" onmouseout="this.style.background='white'">
                                            ${p.name} - ${p.price.toLocaleString('vi-VN')} VNƒê (C√≤n: ${p.stock})
                                        </div>`
                                    ).join('')}
                                </div>
                            </div>
                            <input type="hidden" name="products[]" required>
                        </div>
                        <input type="number" name="quantities[]" placeholder="S·ªë l∆∞·ª£ng" min="1" required style="flex: 1; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px;" onchange="app.calculateTotal()">
                        <input type="number" name="prices[]" placeholder="Gi√°" readonly style="flex: 1; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; background: #f9fafb;">
                        <button type="button" onclick="this.parentElement.remove(); app.calculateTotal();" style="background: #ef4444; color: white; padding: 12px; border: none; border-radius: 8px; cursor: pointer;">X√≥a</button>
                    </div>
                `;
                document.getElementById('product-items').insertAdjacentHTML('beforeend', productItemHTML);
            }
            
            updateProductPrice(selectElement) {
                console.log('=== updateProductPrice ƒë∆∞·ª£c g·ªçi ===');
                console.log('selectElement:', selectElement);
                
                const selectedOption = selectElement.options[selectElement.selectedIndex];
                console.log('selectedOption:', selectedOption);
                
                const price = selectedOption.getAttribute('data-price') || 0;
                console.log('Gi√° t·ª´ data-price:', price);
                
                // T√¨m input price trong c√πng div product-item
                const productItem = selectElement.closest('.product-item');
                console.log('productItem t√¨m th·∫•y:', productItem);
                
                const priceInput = productItem ? productItem.querySelector('input[name="prices[]"]') : null;
                console.log('priceInput t√¨m th·∫•y:', priceInput);
                
                if (priceInput) {
                    priceInput.value = price;
                    console.log('‚úÖ ƒê√É C·∫¨P NH·∫¨T GI√Å TH√ÄNH C√îNG:', price);
                    // Force trigger event ƒë·ªÉ ƒë·∫£m b·∫£o UI update
                    priceInput.dispatchEvent(new Event('change'));
                } else {
                    console.error('‚ùå KH√îNG T√åM TH·∫§Y INPUT PRICE - DEBUG INFO:');
                    console.error('- selectElement parent:', selectElement.parentElement);
                    console.error('- T·∫•t c·∫£ input trong productItem:', productItem ? productItem.querySelectorAll('input') : 'productItem null');
                }
                
                this.calculateTotal();
                console.log('=== updateProductPrice k·∫øt th√∫c ===');
            }
            
            calculateTotal() {
                console.log('=== calculateTotal ƒë∆∞·ª£c g·ªçi ===');
                const quantities = document.querySelectorAll('input[name="quantities[]"]');
                const prices = document.querySelectorAll('input[name="prices[]"]');
                let total = 0;
                
                console.log('S·ªë l∆∞·ª£ng input quantities:', quantities.length);
                console.log('S·ªë l∆∞·ª£ng input prices:', prices.length);
                
                for (let i = 0; i < quantities.length; i++) {
                    const qty = parseInt(quantities[i].value) || 0;
                    const price = parseInt(prices[i].value) || 0;
                    console.log(`Item ${i}: qty=${qty}, price=${price}, subtotal=${qty * price}`);
                    total += qty * price;
                }
                
                console.log('T·ªïng ti·ªÅn:', total);
                const totalElement = document.getElementById('total-amount');
                if (totalElement) {
                    totalElement.textContent = total.toLocaleString('vi-VN') + ' VNƒê';
                    console.log('‚úÖ ƒê√£ c·∫≠p nh·∫≠t total-amount');
                } else {
                    console.error('‚ùå Kh√¥ng t√¨m th·∫•y element total-amount');
                }
                console.log('=== calculateTotal k·∫øt th√∫c ===');
            }
            
            createSaleOrder(event) {
                event.preventDefault();
                const form = event.target;
                const formData = new FormData(form);
                
                const products = formData.getAll('products[]');
                const quantities = formData.getAll('quantities[]');
                const prices = formData.getAll('prices[]');
                
                if (products.length === 0 || products[0] === '') {
                    this.showNotification('Vui l√≤ng ch·ªçn √≠t nh·∫•t m·ªôt s·∫£n ph·∫©m', 'error');
                    return;
                }
                
                // T·∫°o th√¥ng tin kh√°ch h√†ng t·ª´ form
                const customerInfo = {
                    name: formData.get('customerName'),
                    phone: formData.get('customPhuocIThone'),
                    address: formData.get('customerAddress')
                };
                let total = 0;
                const items = [];
                
                for (let i = 0; i < products.length; i++) {
                    if (products[i] && quantities[i] && prices[i]) {
                        const product = this.demoData.products.find(p => p.id === products[i]);
                        const qty = parseInt(quantities[i]);
                        const price = parseInt(prices[i]);
                        
                        // Check stock
                        if (qty > product.stock) {
                            this.showNotification(`Kh√¥ng ƒë·ªß h√†ng cho s·∫£n ph·∫©m ${product.name}. C√≤n l·∫°i: ${product.stock}`, 'error');
                            return;
                        }
                        
                        items.push({
                            productId: products[i],
                            productName: product.name,
                            quantity: qty,
                            price: price,
                            subtotal: qty * price
                        });
                        
                        total += qty * price;
                        
                        // Update stock
                        product.stock -= qty;
                    }
                }
                
                const newSale = {
                    id: 'DH' + String(this.demoData.sales.length + 1).padStart(3, '0'),
                    date: this.getVietnamTime().toISOString().split('T')[0],
                    customer: customerInfo.name,
                    customPhuocIThone: customerInfo.phone,
                    customerAddress: customerInfo.address,
                    notes: formData.get('orderNotes') || '',
                    total: total,
                    status: 'Ch·ªù x·ª≠ l√Ω',
                    items: items.length,
                    itemDetails: items
                };
                
                this.demoData.sales.unshift(newSale);
                this.saveToLocalStorage();
                this.showNotification(`ƒê√£ t·∫°o ƒë∆°n h√†ng ${newSale.id} th√†nh c√¥ng`, 'success');
                this.loadPage('sales');
                const modal = form.closest("div[style*=\"fixed\"]"); if(modal) modal.remove();
            }
            
            // Product Management Functions  
            showAddProductForm() {
                const supplierOptions = this.demoData.suppliers.map(s => 
                    `<option value="${s.id}">${s.name}</option>`
                ).join('');
                
                const formHTML = `
                    <div style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1001; display: flex; justify-content: center; align-items: center;" onclick="closeModal(this)">
                        <div style="background: white; padding: 32px; border-radius: 12px; width: 500px; max-width: 90vw;" onclick="event.stopPropagation()">
                            <h3 style="margin-bottom: 24px; color: var(--text-primary);">Th√™m s·∫£n ph·∫©m m·ªõi</h3>
                            <form onsubmit="app.addProduct(event)">
                                <div style="margin-bottom: 16px;">
                                    <label style="display: block; margin-bottom: 8px; font-weight: 600;">T√™n s·∫£n ph·∫©m:</label>
                                    <input type="text" name="name" required style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px;">
                                </div>
                                <div style="margin-bottom: 16px;">
                                    <label style="display: block; margin-bottom: 8px; font-weight: 600;">Danh m·ª•c:</label>
                                    <select name="category" required style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px;" id="categorySelect">
                                        ${this.getCategoryOptions()}
                                    </select>
                                </div>
                                <div style="margin-bottom: 16px;">
                                    <label style="display: block; margin-bottom: 8px; font-weight: 600;">Gi√° nh·∫≠p:</label>
                                    <input type="number" name="importPrice" required style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px;">
                                </div>
                                <div style="margin-bottom: 16px;">
                                    <label style="display: block; margin-bottom: 8px; font-weight: 600;">Gi√° b√°n:</label>
                                    <input type="number" name="price" required style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px;">
                                </div>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px;">
                                    <div>
                                        <label style="display: block; margin-bottom: 8px; font-weight: 600;">S·ªë l∆∞·ª£ng t·ªìn kho:</label>
                                        <input type="number" name="stock" required min="0" style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px;">
                                    </div>
                                    <div>
                                        <label style="display: block; margin-bottom: 8px; font-weight: 600;">üîî T·ªìn kho t·ªëi thi·ªÉu:</label>
                                        <input type="number" name="minStock" value="10" required min="0" style="width: 100%; padding: 12px; border: 2px solid #f59e0b; border-radius: 8px;" placeholder="C·∫£nh b√°o khi d∆∞·ªõi...">
                                    </div>
                                </div>
                                <div style="background: #fef3c7; border: 1px solid #f59e0b; border-radius: 8px; padding: 12px; margin-bottom: 16px;">
                                    <div style="display: flex; align-items: center; gap: 8px; color: #92400e; font-size: 14px;">
                                        <span>üí°</span>
                                        <span><strong>M·∫πo:</strong> H·ªá th·ªëng s·∫Ω c·∫£nh b√°o khi t·ªìn kho th·∫•p h∆°n ho·∫∑c b·∫±ng ng∆∞·ª°ng t·ªëi thi·ªÉu</span>
                                    </div>
                                </div>
                                <div style="margin-bottom: 24px;">
                                    <label style="display: block; margin-bottom: 8px; font-weight: 600;">Nh√† cung c·∫•p:</label>
                                    <select name="supplier" required style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px;">
                                        <option value="">Ch·ªçn nh√† cung c·∫•p</option>
                                        ${supplierOptions}
                                    </select>
                                </div>
                                <div style="display: flex; gap: 12px; justify-content: flex-end;">
                                    <button type="button" onclick="closeModal(this.closest('div[style*=fixed]'))" 
                                            style="padding: 12px 24px; border: 2px solid #e5e7eb; background: white; border-radius: 8px; cursor: pointer;">H·ªßy</button>
                                    <button type="submit" 
                                            style="padding: 12px 24px; background: var(--primary-blue); color: white; border: none; border-radius: 8px; cursor: pointer;">Th√™m s·∫£n ph·∫©m</button>
                                </div>
                            </form>
                        </div>
                    </div>
                `;
                document.body.insertAdjacentHTML('beforeend', formHTML);
            }
            
            addProduct(event) {
                event.preventDefault();
                const form = event.target;
                const formData = new FormData(form);
                
                const newProduct = {
                    id: 'SP' + String(this.demoData.products.length + 1).padStart(3, '0'),
                    name: formData.get('name'),
                    category: formData.get('category'),
                    importPrice: parseInt(formData.get('importPrice')),
                    price: parseInt(formData.get('price')),
                    stock: parseInt(formData.get('stock')),
                    minStock: parseInt(formData.get('minStock')),
                    supplier: formData.get('supplier')
                };
                
                this.demoData.products.push(newProduct);
                this.saveToLocalStorage();
                this.showNotification(`ƒê√£ th√™m s·∫£n ph·∫©m ${newProduct.name}`, 'success');
                this.loadPage('products');
                const modal = form.closest("div[style*=\"fixed\"]"); if(modal) modal.remove();
            }

            // Ch·ªânh s·ª≠a s·∫£n ph·∫©m
            showEditProductForm(productId) {
                console.log('üõ†Ô∏è showEditProductForm ƒë∆∞·ª£c g·ªçi v·ªõi productId:', productId);
                const product = this.demoData.products.find(p => p.id === productId);
                console.log('üì¶ S·∫£n ph·∫©m t√¨m th·∫•y:', product);
                if (!product) {
                    this.showNotification('Kh√¥ng t√¨m th·∫•y s·∫£n ph·∫©m', 'error');
                    return;
                }

                const supplierOptions = this.demoData.suppliers.map(s => 
                    `<option value="${s.id}" ${s.id === product.supplier ? 'selected' : ''}>${s.name}</option>`
                ).join('');
                
                const formHTML = `
                    <div style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1001; display: flex; justify-content: center; align-items: center;" onclick="closeModal(this)">
                        <div style="background: white; padding: 32px; border-radius: 12px; width: 500px; max-width: 90vw;" onclick="event.stopPropagation()">
                            <h3 style="margin-bottom: 24px; color: var(--text-primary);">‚úèÔ∏è Ch·ªânh s·ª≠a s·∫£n ph·∫©m</h3>
                            <form onsubmit="app.updateProduct(event, '${productId}')">
                                <div style="margin-bottom: 16px;">
                                    <label style="display: block; margin-bottom: 8px; font-weight: 600;">T√™n s·∫£n ph·∫©m:</label>
                                    <input type="text" name="name" value="${product.name}" required style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px;">
                                </div>
                                <div style="margin-bottom: 16px;">
                                    <label style="display: block; margin-bottom: 8px; font-weight: 600;">Danh m·ª•c:</label>
                                    <select name="category" required style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px;">
                                        ${this.getCategoryOptionsWithSelected(product.category)}
                                    </select>
                                </div>
                                <div style="margin-bottom: 16px;">
                                    <label style="display: block; margin-bottom: 8px; font-weight: 600;">Gi√° nh·∫≠p:</label>
                                    <input type="number" name="importPrice" value="${product.importPrice || 0}" required style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px;">
                                </div>
                                <div style="margin-bottom: 16px;">
                                    <label style="display: block; margin-bottom: 8px; font-weight: 600;">Gi√° b√°n:</label>
                                    <input type="number" name="price" value="${product.price}" required style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px;">
                                </div>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px;">
                                    <div>
                                        <label style="display: block; margin-bottom: 8px; font-weight: 600;">S·ªë l∆∞·ª£ng t·ªìn kho:</label>
                                        <input type="number" name="stock" value="${product.stock}" required min="0" style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px;">
                                    </div>
                                    <div>
                                        <label style="display: block; margin-bottom: 8px; font-weight: 600;">üîî T·ªìn kho t·ªëi thi·ªÉu:</label>
                                        <input type="number" name="minStock" value="${product.minStock || 10}" required min="0" style="width: 100%; padding: 12px; border: 2px solid #f59e0b; border-radius: 8px;" placeholder="C·∫£nh b√°o khi d∆∞·ªõi...">
                                    </div>
                                </div>
                                <div style="background: #fef3c7; border: 1px solid #f59e0b; border-radius: 8px; padding: 12px; margin-bottom: 16px;">
                                    <div style="display: flex; align-items: center; gap: 8px; color: #92400e; font-size: 14px;">
                                        <span>üí°</span>
                                        <span><strong>M·∫πo:</strong> H·ªá th·ªëng s·∫Ω c·∫£nh b√°o khi t·ªìn kho th·∫•p h∆°n ho·∫∑c b·∫±ng ng∆∞·ª°ng t·ªëi thi·ªÉu</span>
                                    </div>
                                </div>
                                <div style="margin-bottom: 24px;">
                                    <label style="display: block; margin-bottom: 8px; font-weight: 600;">Nh√† cung c·∫•p:</label>
                                    <select name="supplier" required style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px;">
                                        <option value="">Ch·ªçn nh√† cung c·∫•p</option>
                                        ${supplierOptions}
                                    </select>
                                </div>
                                <div style="display: flex; gap: 12px; justify-content: flex-end;">
                                    <button type="button" onclick="closeModal(this.closest('div[style*=fixed]'))" 
                                            style="padding: 12px 24px; border: 2px solid #e5e7eb; background: white; border-radius: 8px; cursor: pointer;">H·ªßy</button>
                                    <button type="submit" 
                                            style="padding: 12px 24px; background: var(--primary-blue); color: white; border: none; border-radius: 8px; cursor: pointer;">C·∫≠p nh·∫≠t</button>
                                </div>
                            </form>
                        </div>
                    </div>
                `;
                document.body.insertAdjacentHTML('beforeend', formHTML);
            }

            // C·∫≠p nh·∫≠t s·∫£n ph·∫©m
            updateProduct(event, productId) {
                event.preventDefault();
                const form = event.target;
                const formData = new FormData(form);
                
                const productIndex = this.demoData.products.findIndex(p => p.id === productId);
                if (productIndex === -1) {
                    this.showNotification('Kh√¥ng t√¨m th·∫•y s·∫£n ph·∫©m', 'error');
                    return;
                }
                
                // C·∫≠p nh·∫≠t th√¥ng tin s·∫£n ph·∫©m
                this.demoData.products[productIndex] = {
                    ...this.demoData.products[productIndex],
                    name: formData.get('name'),
                    category: formData.get('category'),
                    importPrice: parseInt(formData.get('importPrice')),
                    price: parseInt(formData.get('price')),
                    stock: parseInt(formData.get('stock')),
                    minStock: parseInt(formData.get('minStock')),
                    supplier: formData.get('supplier')
                };
                
                this.saveToLocalStorage();
                this.showNotification(`ƒê√£ c·∫≠p nh·∫≠t s·∫£n ph·∫©m ${formData.get('name')}`, 'success');
                this.loadPage('products');
                const modal = form.closest("div[style*=\"fixed\"]"); if(modal) modal.remove();
            }

            // Helper function ƒë·ªÉ t·∫°o category options v·ªõi selected
            getCategoryOptionsWithSelected(selectedCategory) {
                const categories = JSON.parse(localStorage.getItem('categories')) || [];
                let options = '<option value="">Ch·ªçn danh m·ª•c</option>';
                
                categories.forEach(category => {
                    const selected = category.name === selectedCategory ? 'selected' : '';
                    options += `<option value="${category.name}" ${selected}>${category.name}</option>`;
                    
                    // Th√™m danh m·ª•c con n·∫øu c√≥
                    const subCategories = categories.filter(c => c.parent === category.id);
                    subCategories.forEach(subCat => {
                        const subSelected = subCat.name === selectedCategory ? 'selected' : '';
                        options += `<option value="${subCat.name}" ${subSelected}>-- ${subCat.name}</option>`;
                    });
                });
                
                return options;
            }
            
            // Supplier Management Functions
            showAddSupplierForm() {
                const formHTML = `
                    <div style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1001; display: flex; justify-content: center; align-items: center;" onclick="closeModal(this)">
                        <div style="background: white; padding: 32px; border-radius: 12px; width: 700px; max-width: 95vw; max-height: 90vh; overflow-y: auto;" onclick="event.stopPropagation()">
                            <h3 style="margin-bottom: 24px; color: var(--text-primary);">üè≠ Th√™m nh√† cung c·∫•p m·ªõi</h3>
                            <form onsubmit="app.addSupplier(event)">
                                <!-- H√†ng 1: T√™n NCC v√† Lo·∫°i NCC -->
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px;">
                                    <div>
                                        <label style="display: block; margin-bottom: 8px; font-weight: 600;">T√™n nh√† cung c·∫•p: *</label>
                                        <input type="text" name="name" required 
                                               style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px;">
                                    </div>
                                    <div>
                                        <label style="display: block; margin-bottom: 8px; font-weight: 600;">Lo·∫°i nh√† cung c·∫•p: *</label>
                                        <select name="type" required onchange="app.toggleSupplierFields(this.value)"
                                               style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px;">
                                            <option value="">Ch·ªçn lo·∫°i</option>
                                            <option value="ca-nhan">C√° nh√¢n</option>
                                            <option value="doanh-nghiep">Doanh nghi·ªáp</option>
                                        </select>
                                    </div>
                                </div>

                                <!-- H√†ng 2: M√£ NCC v√† M√£ s·ªë thu·∫ø (doanh nghi·ªáp) -->
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px;">
                                    <div id="supplier-code-field" style="display: none;">
                                        <label style="display: block; margin-bottom: 8px; font-weight: 600;">M√£ nh√† cung c·∫•p: *</label>
                                        <input type="text" name="supplierCode" 
                                               style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px;">
                                    </div>
                                    <div id="supplier-tax-field" style="display: none;">
                                        <label style="display: block; margin-bottom: 8px; font-weight: 600;">M√£ s·ªë thu·∫ø:</label>
                                        <input type="text" name="taxCode"
                                               style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px;">
                                    </div>
                                </div>

                                <!-- H√†ng 3: ƒê·∫°i di·ªán ph√°p lu·∫≠t v√† Ch·ª©c v·ª• -->
                                <div id="legal-info-fields" style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px; display: none;">
                                    <div>
                                        <label style="display: block; margin-bottom: 8px; font-weight: 600;">ƒê·∫°i di·ªán ph√°p lu·∫≠t:</label>
                                        <input type="text" name="legalRepresentative"
                                               style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px;">
                                    </div>
                                    <div>
                                        <label style="display: block; margin-bottom: 8px; font-weight: 600;">Ch·ª©c v·ª• ng∆∞·ªùi li√™n h·ªá:</label>
                                        <input type="text" name="contactPosition"
                                               style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px;">
                                    </div>
                                </div>

                                <!-- H√†ng 4: ƒêi·ªán tho·∫°i v√† Email -->
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px;">
                                    <div>
                                        <label style="display: block; margin-bottom: 8px; font-weight: 600;">S·ªë ƒëi·ªán tho·∫°i: *</label>
                                        <input type="tel" name="phone" required 
                                               style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px;">
                                    </div>
                                    <div>
                                        <label style="display: block; margin-bottom: 8px; font-weight: 600;">Email:</label>
                                        <input type="email" name="email"
                                               style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px;">
                                    </div>
                                </div>
                                
                                <!-- H√†ng 5: ƒê·ªãa ch·ªâ -->
                                <div style="margin-bottom: 16px;">
                                    <label style="display: block; margin-bottom: 8px; font-weight: 600;">ƒê·ªãa ch·ªâ:</label>
                                    <textarea name="address" rows="2"
                                              style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; resize: vertical;"></textarea>
                                </div>

                                <!-- Th√¥ng tin ng√¢n h√†ng (ch·ªâ doanh nghi·ªáp) -->
                                <div id="bank-info-section" style="display: none;">
                                    <h4 style="margin-bottom: 16px; color: var(--primary-blue); border-bottom: 2px solid #e5e7eb; padding-bottom: 8px;">üè¶ Th√¥ng tin ng√¢n h√†ng</h4>
                                    
                                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px;">
                                        <div>
                                            <label style="display: block; margin-bottom: 8px; font-weight: 600;">S·ªë t√†i kho·∫£n:</label>
                                            <input type="text" name="bankAccount"
                                                   style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px;">
                                        </div>
                                        <div>
                                            <label style="display: block; margin-bottom: 8px; font-weight: 600;">T√™n ng√¢n h√†ng:</label>
                                            <input type="text" name="bankName"
                                                   style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px;">
                                        </div>
                                    </div>
                                    
                                    <div style="margin-bottom: 16px;">
                                        <label style="display: block; margin-bottom: 8px; font-weight: 600;">Chi nh√°nh:</label>
                                        <input type="text" name="bankBranch"
                                               style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px;">
                                    </div>
                                </div>

                                <!-- Ghi ch√∫ -->
                                <div style="margin-bottom: 24px;">
                                    <label style="display: block; margin-bottom: 8px; font-weight: 600;">Ghi ch√∫ nh√† cung c·∫•p:</label>
                                    <textarea name="notes" rows="3" placeholder="Nh·∫≠p ghi ch√∫ v·ªÅ nh√† cung c·∫•p (kh√¥ng b·∫Øt bu·ªôc)"
                                              style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; resize: vertical;"></textarea>
                                </div>
                                
                                <div style="display: flex; gap: 12px; justify-content: flex-end;">
                                    <button type="button" onclick="closeModal(this.closest('div[style*=fixed]'))" 
                                            style="padding: 12px 24px; border: 2px solid #e5e7eb; background: white; border-radius: 8px; cursor: pointer;">H·ªßy</button>
                                    <button type="submit" 
                                            style="padding: 12px 24px; background: var(--primary-blue); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">Th√™m nh√† cung c·∫•p</button>
                                </div>
                            </form>
                        </div>
                    </div>
                `;
                document.body.insertAdjacentHTML('beforeend', formHTML);
            }
            
            toggleSupplierFields(supplierType) {
                const codeField = document.getElementById('supplier-code-field');
                const taxField = document.getElementById('supplier-tax-field');
                const legalFields = document.getElementById('legal-info-fields');
                const bankSection = document.getElementById('bank-info-section');
                const codeInput = document.querySelector('input[name="supplierCode"]');
                
                if (supplierType === 'doanh-nghiep') {
                    codeField.style.display = 'block';
                    taxField.style.display = 'block';
                    legalFields.style.display = 'grid';
                    bankSection.style.display = 'block';
                    if (codeInput) codeInput.required = true;
                } else {
                    codeField.style.display = 'none';
                    taxField.style.display = 'none';
                    legalFields.style.display = 'none';
                    bankSection.style.display = 'none';
                    if (codeInput) {
                        codeInput.required = false;
                        codeInput.value = '';
                    }
                    // Clear business fields
                    const fieldsToReset = ['taxCode', 'legalRepresentative', 'contactPosition', 'bankAccount', 'bankName', 'bankBranch'];
                    fieldsToReset.forEach(field => {
                        const input = document.querySelector(`input[name="${field}"]`);
                        if (input) input.value = '';
                    });
                }
            }

            addSupplier(event) {
                event.preventDefault();
                const form = event.target;
                const formData = new FormData(form);
                
                const newSupplier = {
                    id: 'NCC' + String(this.demoData.suppliers.length + 1).padStart(3, '0'),
                    name: formData.get('name'),
                    type: formData.get('type'),
                    supplierCode: formData.get('supplierCode') || '',
                    phone: formData.get('phone'),
                    email: formData.get('email') || '',
                    address: formData.get('address') || '',
                    taxCode: formData.get('taxCode') || '',
                    legalRepresentative: formData.get('legalRepresentative') || '',
                    contactPosition: formData.get('contactPosition') || '',
                    bankAccount: formData.get('bankAccount') || '',
                    bankName: formData.get('bankName') || '',
                    bankBranch: formData.get('bankBranch') || '',
                    notes: formData.get('notes') || '',
                    products: 'Ch∆∞a c√≥ s·∫£n ph·∫©m'
                };
                
                this.demoData.suppliers.push(newSupplier);
                this.saveToLocalStorage();
                this.showNotification(`ƒê√£ th√™m nh√† cung c·∫•p ${newSupplier.name}`, 'success');
                this.loadPage('suppliers');
                const modal = form.closest("div[style*=\"fixed\"]"); if(modal) modal.remove();
            }
            
            editSupplier(index) {
                const supplier = this.demoData.suppliers[index];
                const supplierType = supplier.type || 'ca-nhan';
                
                const codeDisplay = supplierType === 'doanh-nghiep' ? 'block' : 'none';
                const taxDisplay = supplierType === 'doanh-nghiep' ? 'block' : 'none';
                const legalDisplay = supplierType === 'doanh-nghiep' ? 'grid' : 'none';
                const bankDisplay = supplierType === 'doanh-nghiep' ? 'block' : 'none';
                
                const formHTML = `
                    <div style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1001; display: flex; justify-content: center; align-items: center;" onclick="closeModal(this)">
                        <div style="background: white; padding: 32px; border-radius: 12px; width: 700px; max-width: 95vw; max-height: 90vh; overflow-y: auto;" onclick="event.stopPropagation()">
                            <h3 style="margin-bottom: 24px; color: var(--text-primary);">‚úèÔ∏è S·ª≠a th√¥ng tin nh√† cung c·∫•p</h3>
                            <form onsubmit="app.updateSupplier(event, ${index})">
                                <!-- H√†ng 1: T√™n NCC v√† Lo·∫°i NCC -->
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px;">
                                    <div>
                                        <label style="display: block; margin-bottom: 8px; font-weight: 600;">T√™n nh√† cung c·∫•p: *</label>
                                        <input type="text" name="name" value="${supplier.name}" required 
                                               style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px;">
                                    </div>
                                    <div>
                                        <label style="display: block; margin-bottom: 8px; font-weight: 600;">Lo·∫°i nh√† cung c·∫•p: *</label>
                                        <select name="type" required onchange="app.toggleEditSupplierFields(this.value)"
                                               style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px;">
                                            <option value="ca-nhan" ${supplierType === 'ca-nhan' ? 'selected' : ''}>C√° nh√¢n</option>
                                            <option value="doanh-nghiep" ${supplierType === 'doanh-nghiep' ? 'selected' : ''}>Doanh nghi·ªáp</option>
                                        </select>
                                    </div>
                                </div>

                                <!-- H√†ng 2: M√£ NCC v√† M√£ s·ªë thu·∫ø -->
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px;">
                                    <div id="edit-supplier-code-field" style="display: ${codeDisplay};">
                                        <label style="display: block; margin-bottom: 8px; font-weight: 600;">M√£ nh√† cung c·∫•p: *</label>
                                        <input type="text" name="supplierCode" value="${supplier.supplierCode || ''}"
                                               style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px;">
                                    </div>
                                    <div id="edit-supplier-tax-field" style="display: ${taxDisplay};">
                                        <label style="display: block; margin-bottom: 8px; font-weight: 600;">M√£ s·ªë thu·∫ø:</label>
                                        <input type="text" name="taxCode" value="${supplier.taxCode || ''}"
                                               style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px;">
                                    </div>
                                </div>

                                <!-- H√†ng 3: ƒê·∫°i di·ªán ph√°p lu·∫≠t v√† Ch·ª©c v·ª• -->
                                <div id="edit-legal-info-fields" style="display: ${legalDisplay}; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px;">
                                    <div>
                                        <label style="display: block; margin-bottom: 8px; font-weight: 600;">ƒê·∫°i di·ªán ph√°p lu·∫≠t:</label>
                                        <input type="text" name="legalRepresentative" value="${supplier.legalRepresentative || ''}"
                                               style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px;">
                                    </div>
                                    <div>
                                        <label style="display: block; margin-bottom: 8px; font-weight: 600;">Ch·ª©c v·ª• ng∆∞·ªùi li√™n h·ªá:</label>
                                        <input type="text" name="contactPosition" value="${supplier.contactPosition || ''}"
                                               style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px;">
                                    </div>
                                </div>

                                <!-- H√†ng 4: ƒêi·ªán tho·∫°i v√† Email -->
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px;">
                                    <div>
                                        <label style="display: block; margin-bottom: 8px; font-weight: 600;">S·ªë ƒëi·ªán tho·∫°i: *</label>
                                        <input type="tel" name="phone" value="${supplier.phone}" required 
                                               style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px;">
                                    </div>
                                    <div>
                                        <label style="display: block; margin-bottom: 8px; font-weight: 600;">Email:</label>
                                        <input type="email" name="email" value="${supplier.email || ''}"
                                               style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px;">
                                    </div>
                                </div>
                                
                                <!-- H√†ng 5: ƒê·ªãa ch·ªâ -->
                                <div style="margin-bottom: 16px;">
                                    <label style="display: block; margin-bottom: 8px; font-weight: 600;">ƒê·ªãa ch·ªâ:</label>
                                    <textarea name="address" rows="2"
                                              style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; resize: vertical;">${supplier.address || ''}</textarea>
                                </div>

                                <!-- Th√¥ng tin ng√¢n h√†ng -->
                                <div id="edit-bank-info-section" style="display: ${bankDisplay};">
                                    <h4 style="margin-bottom: 16px; color: var(--primary-blue); border-bottom: 2px solid #e5e7eb; padding-bottom: 8px;">üè¶ Th√¥ng tin ng√¢n h√†ng</h4>
                                    
                                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px;">
                                        <div>
                                            <label style="display: block; margin-bottom: 8px; font-weight: 600;">S·ªë t√†i kho·∫£n:</label>
                                            <input type="text" name="bankAccount" value="${supplier.bankAccount || ''}"
                                                   style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px;">
                                        </div>
                                        <div>
                                            <label style="display: block; margin-bottom: 8px; font-weight: 600;">T√™n ng√¢n h√†ng:</label>
                                            <input type="text" name="bankName" value="${supplier.bankName || ''}"
                                                   style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px;">
                                        </div>
                                    </div>
                                    
                                    <div style="margin-bottom: 16px;">
                                        <label style="display: block; margin-bottom: 8px; font-weight: 600;">Chi nh√°nh:</label>
                                        <input type="text" name="bankBranch" value="${supplier.bankBranch || ''}"
                                               style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px;">
                                    </div>
                                </div>

                                <!-- Ghi ch√∫ -->
                                <div style="margin-bottom: 24px;">
                                    <label style="display: block; margin-bottom: 8px; font-weight: 600;">Ghi ch√∫ nh√† cung c·∫•p:</label>
                                    <textarea name="notes" rows="3" placeholder="Nh·∫≠p ghi ch√∫ v·ªÅ nh√† cung c·∫•p (kh√¥ng b·∫Øt bu·ªôc)"
                                              style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; resize: vertical;">${supplier.notes || ''}</textarea>
                                </div>
                                
                                <div style="display: flex; gap: 12px; justify-content: flex-end;">
                                    <button type="button" onclick="closeModal(this.closest('div[style*=fixed]'))" 
                                            style="padding: 12px 24px; border: 2px solid #e5e7eb; background: white; border-radius: 8px; cursor: pointer;">H·ªßy</button>
                                    <button type="submit" 
                                            style="padding: 12px 24px; background: var(--primary-blue); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">C·∫≠p nh·∫≠t</button>
                                </div>
                            </form>
                        </div>
                    </div>
                `;
                document.body.insertAdjacentHTML('beforeend', formHTML);
            }

            toggleEditSupplierFields(supplierType) {
                const codeField = document.getElementById('edit-supplier-code-field');
                const taxField = document.getElementById('edit-supplier-tax-field');
                const legalFields = document.getElementById('edit-legal-info-fields');
                const bankSection = document.getElementById('edit-bank-info-section');
                const codeInput = document.querySelector('input[name="supplierCode"]');
                
                if (supplierType === 'doanh-nghiep') {
                    codeField.style.display = 'block';
                    taxField.style.display = 'block';
                    legalFields.style.display = 'grid';
                    bankSection.style.display = 'block';
                    if (codeInput) codeInput.required = true;
                } else {
                    codeField.style.display = 'none';
                    taxField.style.display = 'none';
                    legalFields.style.display = 'none';
                    bankSection.style.display = 'none';
                    if (codeInput) {
                        codeInput.required = false;
                        codeInput.value = '';
                    }
                    // Clear business fields
                    const fieldsToReset = ['taxCode', 'legalRepresentative', 'contactPosition', 'bankAccount', 'bankName', 'bankBranch'];
                    fieldsToReset.forEach(field => {
                        const input = document.querySelector(`input[name="${field}"]`);
                        if (input) input.value = '';
                    });
                }
            }

            updateSupplier(event, index) {
                event.preventDefault();
                const form = event.target;
                const formData = new FormData(form);
                
                this.demoData.suppliers[index] = {
                    ...this.demoData.suppliers[index],
                    name: formData.get('name'),
                    type: formData.get('type'),
                    supplierCode: formData.get('supplierCode') || '',
                    phone: formData.get('phone'),
                    email: formData.get('email') || '',
                    address: formData.get('address') || '',
                    taxCode: formData.get('taxCode') || '',
                    legalRepresentative: formData.get('legalRepresentative') || '',
                    contactPosition: formData.get('contactPosition') || '',
                    bankAccount: formData.get('bankAccount') || '',
                    bankName: formData.get('bankName') || '',
                    bankBranch: formData.get('bankBranch') || '',
                    notes: formData.get('notes') || ''
                };
                
                this.saveToLocalStorage();
                this.showNotification(`ƒê√£ c·∫≠p nh·∫≠t nh√† cung c·∫•p ${this.demoData.suppliers[index].name}`, 'success');
                this.loadPage('suppliers');
                const modal = form.closest("div[style*=\"fixed\"]"); if(modal) modal.remove();
            }

            showSupplierSearch() {
                this.showNotification('T√¨m ki·∫øm nh√† cung c·∫•p theo t√™n ho·∫∑c s·∫£n ph·∫©m', 'info');
            }
            
            showCreatePurchaseForm() {
                const supplierOptions = this.demoData.suppliers.map(s => 
                    `<option value="${s.id}">${s.name}</option>`
                ).join('');
                
                const formHTML = `
                    <div style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1001; display: flex; justify-content: center; align-items: center;" onclick="closeModal(this)">
                        <div style="background: white; padding: 32px; border-radius: 12px; width: 500px; max-width: 90vw;" onclick="event.stopPropagation()">
                            <h3 style="margin-bottom: 24px; color: var(--text-primary);">T·∫°o ƒë∆°n mua h√†ng</h3>
                            <form onsubmit="app.createPurchaseOrder(event)">
                                <div style="margin-bottom: 16px;">
                                    <label style="display: block; margin-bottom: 8px; font-weight: 600;">Nh√† cung c·∫•p:</label>
                                    <select name="supplier" required style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px;">
                                        <option value="">Ch·ªçn nh√† cung c·∫•p</option>
                                        ${supplierOptions}
                                    </select>
                                </div>
                                <div style="margin-bottom: 16px;">
                                    <label style="display: block; margin-bottom: 8px; font-weight: 600;">T√™n s·∫£n ph·∫©m:</label>
                                    <input type="text" name="productName" required style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px;">
                                </div>
                                <div style="margin-bottom: 16px;">
                                    <label style="display: block; margin-bottom: 8px; font-weight: 600;">S·ªë l∆∞·ª£ng:</label>
                                    <input type="number" name="quantity" required min="1" style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px;">
                                </div>
                                <div style="margin-bottom: 24px;">
                                    <label style="display: block; margin-bottom: 8px; font-weight: 600;">Gi√° mua:</label>
                                    <input type="number" name="price" required style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px;">
                                </div>
                                <div style="display: flex; gap: 12px; justify-content: flex-end;">
                                    <button type="button" onclick="closeModal(this.closest('div[style*=fixed]'))" 
                                            style="padding: 12px 24px; border: 2px solid #e5e7eb; background: white; border-radius: 8px; cursor: pointer;">H·ªßy</button>
                                    <button type="submit" 
                                            style="padding: 12px 24px; background: var(--primary-blue); color: white; border: none; border-radius: 8px; cursor: pointer;">T·∫°o ƒë∆°n mua</button>
                                </div>
                            </form>
                        </div>
                    </div>
                `;
                document.body.insertAdjacentHTML('beforeend', formHTML);
            }
            
            createPurchaseOrder(event) {
                event.preventDefault();
                const form = event.target;
                const formData = new FormData(form);
                
                const supplier = this.demoData.suppliers.find(s => s.id === formData.get('supplier'));
                const productName = formData.get('productName');
                const quantity = parseInt(formData.get('quantity'));
                const price = parseInt(formData.get('price'));
                
                // Check if product exists, if not create new one
                let product = this.demoData.products.find(p => p.name.toLowerCase() === productName.toLowerCase());
                if (!product) {
                    product = {
                        id: 'SP' + String(this.demoData.products.length + 1).padStart(3, '0'),
                        name: productName,
                        category: 'Nh·∫≠p m·ªõi',
                        price: price,
                        stock: quantity,
                        supplier: supplier.name
                    };
                    this.demoData.products.push(product);
                } else {
                    product.stock += quantity;
                }
                
                this.saveToLocalStorage();
                this.showNotification(`ƒê√£ t·∫°o ƒë∆°n mua h√†ng t·ª´ ${supplier.name}`, 'success');
                const modal = form.closest("div[style*=\"fixed\"]"); if(modal) modal.remove();
            }
            
            // Categories Management
            getCategoriesContent() {
                // Get categories from localStorage or initialize default ones
                const categories = JSON.parse(localStorage.getItem('categories')) || [
                    { id: 'cat1', name: 'ƒêi·ªán tho·∫°i', parent: null, level: 0 },
                    { id: 'cat2', name: 'Laptop', parent: null, level: 0 },
                    { id: 'cat3', name: 'Tablet', parent: null, level: 0 },
                    { id: 'cat4', name: 'Ph·ª• ki·ªán', parent: null, level: 0 },
                    { id: 'cat5', name: 'S·∫£n ph·∫©m', parent: null, level: 0 },
                    { id: 'cat6', name: 'B√≥ng ƒë√°', parent: 'cat5', level: 1 },
                    { id: 'cat7', name: 'Pickle Ball', parent: 'cat5', level: 1 }
                ];

                const categoryTree = this.buildCategoryTree(categories);
                
                return `
                    <div class="fade-in">
                        <div class="stats-grid" style="margin-bottom: 24px;">
                            <div class="stat-card info">
                                <div class="stat-header">
                                    <span class="stat-title">T·ªïng danh m·ª•c</span>
                                    <span class="stat-icon">üìÇ</span>
                                </div>
                                <div class="stat-value">${categories.length}</div>
                                <div class="stat-change positive">Danh m·ª•c ph√¢n c·∫•p</div>
                            </div>
                            
                            <div class="stat-card success">
                                <div class="stat-header">
                                    <span class="stat-title">Danh m·ª•c g·ªëc</span>
                                    <span class="stat-icon">üå≥</span>
                                </div>
                                <div class="stat-value">${categories.filter(c => c.parent === null).length}</div>
                                <div class="stat-change positive">C·∫•p 1</div>
                            </div>
                        </div>
                        
                        <div class="quick-actions">
                            <h2 class="section-title">Qu·∫£n l√Ω Danh m·ª•c</h2>
                            <div class="action-grid" style="margin-bottom: 24px;">
                                <div class="action-button" onclick="app.showAddCategoryForm()">
                                    <div class="action-icon">üìÇ‚ûï</div>
                                    <div class="action-title">Th√™m danh m·ª•c</div>
                                </div>
                                <div class="action-button" onclick="app.showAddSubCategoryForm()">
                                    <div class="action-icon">üìÅ‚ûï</div>
                                    <div class="action-title">Th√™m danh m·ª•c con</div>
                                </div>
                                <div class="action-button" onclick="app.exportCategoriesData()">
                                    <div class="action-icon">üìä</div>
                                    <div class="action-title">Xu·∫•t d·ªØ li·ªáu</div>
                                </div>
                            </div>
                            
                            <h3 style="margin-bottom: 16px; color: var(--text-primary);">C·∫•u tr√∫c danh m·ª•c</h3>
                            ${this.renderCategoryTree(categoryTree)}
                        </div>
                    </div>
                `;
            }

            buildCategoryTree(categories) {
                const tree = [];
                const categoryMap = {};
                
                // Create a map for quick lookup
                categories.forEach(cat => {
                    categoryMap[cat.id] = { ...cat, children: [] };
                });
                
                // Build the tree structure
                categories.forEach(cat => {
                    if (cat.parent === null) {
                        tree.push(categoryMap[cat.id]);
                    } else {
                        if (categoryMap[cat.parent]) {
                            categoryMap[cat.parent].children.push(categoryMap[cat.id]);
                        }
                    }
                });
                
                return tree;
            }

            renderCategoryTree(tree, level = 0) {
                return tree.map(category => {
                    const indent = '&nbsp;&nbsp;'.repeat(level * 4);
                    const hasChildren = category.children.length > 0;
                    
                    let html = `
                        <div class="activity-item" style="margin-left: ${level * 20}px;">
                            <div class="activity-icon ${level === 0 ? 'success' : 'info'}">${level === 0 ? 'üìÇ' : 'üìÅ'}</div>
                            <div class="activity-content">
                                <div class="activity-title">${category.name}</div>
                                <div class="activity-desc">ID: ${category.id} | C·∫•p: ${level + 1} ${hasChildren ? `| ${category.children.length} danh m·ª•c con` : ''}</div>
                            </div>
                            <div style="display: flex; gap: 8px;">
                                <button onclick="app.editCategory('${category.id}')" style="padding: 6px 12px; background: var(--primary-blue); color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">S·ª≠a</button>
                                <button onclick="app.deleteCategory('${category.id}')" style="padding: 6px 12px; background: #dc2626; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">X√≥a</button>
                            </div>
                        </div>
                    `;
                    
                    if (hasChildren) {
                        html += this.renderCategoryTree(category.children, level + 1);
                    }
                    
                    return html;
                }).join('');
            }

            showAddCategoryForm() {
                const formHTML = `
                    <div style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1001; display: flex; justify-content: center; align-items: center;" onclick="closeModal(this)">
                        <div style="background: white; padding: 32px; border-radius: 12px; width: 500px; max-width: 90vw;" onclick="event.stopPropagation()">
                            <h3 style="margin-bottom: 24px; color: var(--text-primary);">Th√™m danh m·ª•c m·ªõi</h3>
                            <form onsubmit="app.addCategory(event)">
                                <div style="margin-bottom: 16px;">
                                    <label style="display: block; margin-bottom: 8px; font-weight: 600;">T√™n danh m·ª•c:</label>
                                    <input type="text" name="categoryName" required style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px;">
                                </div>
                                <div style="display: flex; gap: 12px; justify-content: flex-end;">
                                    <button type="button" onclick="closeModal(this.closest('div[style*=fixed]'))" 
                                            style="padding: 12px 24px; border: 2px solid #e5e7eb; background: white; border-radius: 8px; cursor: pointer;">H·ªßy</button>
                                    <button type="submit" 
                                            style="padding: 12px 24px; background: var(--primary-blue); color: white; border: none; border-radius: 8px; cursor: pointer;">Th√™m danh m·ª•c</button>
                                </div>
                            </form>
                        </div>
                    </div>
                `;
                document.body.insertAdjacentHTML('beforeend', formHTML);
            }

            showAddSubCategoryForm() {
                const categories = JSON.parse(localStorage.getItem('categories')) || [];
                const parentCategories = categories.filter(c => c.parent === null);
                const parentOptions = parentCategories.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
                
                const formHTML = `
                    <div style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1001; display: flex; justify-content: center; align-items: center;" onclick="closeModal(this)">
                        <div style="background: white; padding: 32px; border-radius: 12px; width: 500px; max-width: 90vw;" onclick="event.stopPropagation()">
                            <h3 style="margin-bottom: 24px; color: var(--text-primary);">Th√™m danh m·ª•c con</h3>
                            <form onsubmit="app.addSubCategory(event)">
                                <div style="margin-bottom: 16px;">
                                    <label style="display: block; margin-bottom: 8px; font-weight: 600;">Danh m·ª•c cha:</label>
                                    <select name="parentCategory" required style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px;">
                                        <option value="">Ch·ªçn danh m·ª•c cha</option>
                                        ${parentOptions}
                                    </select>
                                </div>
                                <div style="margin-bottom: 16px;">
                                    <label style="display: block; margin-bottom: 8px; font-weight: 600;">T√™n danh m·ª•c con:</label>
                                    <input type="text" name="categoryName" required style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px;">
                                </div>
                                <div style="display: flex; gap: 12px; justify-content: flex-end;">
                                    <button type="button" onclick="closeModal(this.closest('div[style*=fixed]'))" 
                                            style="padding: 12px 24px; border: 2px solid #e5e7eb; background: white; border-radius: 8px; cursor: pointer;">H·ªßy</button>
                                    <button type="submit" 
                                            style="padding: 12px 24px; background: var(--primary-blue); color: white; border: none; border-radius: 8px; cursor: pointer;">Th√™m danh m·ª•c con</button>
                                </div>
                            </form>
                        </div>
                    </div>
                `;
                document.body.insertAdjacentHTML('beforeend', formHTML);
            }

            addCategory(event) {
                event.preventDefault();
                const form = event.target;
                const formData = new FormData(form);
                const categoryName = formData.get('categoryName');
                
                const categories = JSON.parse(localStorage.getItem('categories')) || [];
                const newCategory = {
                    id: 'cat' + Date.now(),
                    name: categoryName,
                    parent: null,
                    level: 0
                };
                
                categories.push(newCategory);
                localStorage.setItem('categories', JSON.stringify(categories));
                
                this.showNotification(`ƒê√£ th√™m danh m·ª•c "${categoryName}"`, 'success');
                this.loadPage('categories');
                const modal = form.closest("div[style*=\"fixed\"]"); if(modal) modal.remove();
            }

            addSubCategory(event) {
                event.preventDefault();
                const form = event.target;
                const formData = new FormData(form);
                const categoryName = formData.get('categoryName');
                const parentId = formData.get('parentCategory');
                
                const categories = JSON.parse(localStorage.getItem('categories')) || [];
                const newCategory = {
                    id: 'cat' + Date.now(),
                    name: categoryName,
                    parent: parentId,
                    level: 1
                };
                
                categories.push(newCategory);
                localStorage.setItem('categories', JSON.stringify(categories));
                
                this.showNotification(`ƒê√£ th√™m danh m·ª•c con "${categoryName}"`, 'success');
                this.loadPage('categories');
                const modal = form.closest("div[style*=\"fixed\"]"); if(modal) modal.remove();
            }

            editCategory(categoryId) {
                const categories = JSON.parse(localStorage.getItem('categories')) || [];
                const category = categories.find(c => c.id === categoryId);
                
                if (!category) {
                    this.showNotification('Kh√¥ng t√¨m th·∫•y danh m·ª•c', 'error');
                    return;
                }
                
                const formHTML = `
                    <div style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1001; display: flex; justify-content: center; align-items: center;" onclick="closeModal(this)">
                        <div style="background: white; padding: 32px; border-radius: 12px; width: 500px; max-width: 90vw;" onclick="event.stopPropagation()">
                            <h3 style="margin-bottom: 24px; color: var(--text-primary);">S·ª≠a danh m·ª•c</h3>
                            <form onsubmit="app.updateCategory(event, '${categoryId}')">
                                <div style="margin-bottom: 16px;">
                                    <label style="display: block; margin-bottom: 8px; font-weight: 600;">T√™n danh m·ª•c:</label>
                                    <input type="text" name="categoryName" value="${category.name}" required style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px;">
                                </div>
                                <div style="display: flex; gap: 12px; justify-content: flex-end;">
                                    <button type="button" onclick="closeModal(this.closest('div[style*=fixed]'))" 
                                            style="padding: 12px 24px; border: 2px solid #e5e7eb; background: white; border-radius: 8px; cursor: pointer;">H·ªßy</button>
                                    <button type="submit" 
                                            style="padding: 12px 24px; background: var(--primary-blue); color: white; border: none; border-radius: 8px; cursor: pointer;">C·∫≠p nh·∫≠t</button>
                                </div>
                            </form>
                        </div>
                    </div>
                `;
                document.body.insertAdjacentHTML('beforeend', formHTML);
            }

            updateCategory(event, categoryId) {
                event.preventDefault();
                const form = event.target;
                const formData = new FormData(form);
                const categoryName = formData.get('categoryName');
                
                const categories = JSON.parse(localStorage.getItem('categories')) || [];
                const categoryIndex = categories.findIndex(c => c.id === categoryId);
                
                if (categoryIndex !== -1) {
                    categories[categoryIndex].name = categoryName;
                    localStorage.setItem('categories', JSON.stringify(categories));
                    
                    this.showNotification(`ƒê√£ c·∫≠p nh·∫≠t danh m·ª•c "${categoryName}"`, 'success');
                    this.loadPage('categories');
                    const modal = form.closest("div[style*=\"fixed\"]"); 
                    if(modal) modal.remove();
                } else {
                    this.showNotification('Kh√¥ng t√¨m th·∫•y danh m·ª•c ƒë·ªÉ c·∫≠p nh·∫≠t', 'error');
                }
            }

            deleteCategory(categoryId) {
                if (!confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a danh m·ª•c n√†y?')) return;
                
                const categories = JSON.parse(localStorage.getItem('categories')) || [];
                const updatedCategories = categories.filter(c => c.id !== categoryId && c.parent !== categoryId);
                localStorage.setItem('categories', JSON.stringify(updatedCategories));
                
                this.showNotification('ƒê√£ x√≥a danh m·ª•c', 'success');
                this.loadPage('categories');
            }

            getCategoryOptions() {
                const categories = JSON.parse(localStorage.getItem('categories')) || [
                    { id: 'cat1', name: 'ƒêi·ªán tho·∫°i', parent: null, level: 0 },
                    { id: 'cat2', name: 'Laptop', parent: null, level: 0 },
                    { id: 'cat3', name: 'Tablet', parent: null, level: 0 },
                    { id: 'cat4', name: 'Ph·ª• ki·ªán', parent: null, level: 0 },
                    { id: 'cat5', name: 'S·∫£n ph·∫©m', parent: null, level: 0 },
                    { id: 'cat6', name: 'B√≥ng ƒë√°', parent: 'cat5', level: 1 },
                    { id: 'cat7', name: 'Pickle Ball', parent: 'cat5', level: 1 }
                ];
                
                // Save default categories if not exist
                if (!localStorage.getItem('categories')) {
                    localStorage.setItem('categories', JSON.stringify(categories));
                }
                
                let options = '<option value="">Ch·ªçn danh m·ª•c</option>';
                
                // Group by parent
                const parentCategories = categories.filter(c => c.parent === null);
                const childCategories = categories.filter(c => c.parent !== null);
                
                parentCategories.forEach(parent => {
                    const children = childCategories.filter(c => c.parent === parent.id);
                    
                    if (children.length > 0) {
                        options += `<optgroup label="${parent.name}">`;
                        options += `<option value="${parent.name}">${parent.name}</option>`;
                        children.forEach(child => {
                            options += `<option value="${parent.name} > ${child.name}">${child.name}</option>`;
                        });
                        options += `</optgroup>`;
                    } else {
                        options += `<option value="${parent.name}">${parent.name}</option>`;
                    }
                });
                
                return options;
            }

            // Enhanced Export Function with View/Download Options
            showExportOptions(title, dataType, generateFunction) {
                const modal = document.createElement('div');
                modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1001; display: flex; justify-content: center; align-items: center;';
                modal.onclick = () => modal.remove();
                
                const content = document.createElement('div');
                content.style.cssText = 'background: white; padding: 32px; border-radius: 12px; width: 400px; max-width: 90vw;';
                content.onclick = (e) => e.stopPropagation();
                
                content.innerHTML = `
                    <h3 style="margin-bottom: 24px; color: var(--text-primary); text-align: center;">${title}</h3>
                    <p style="margin-bottom: 24px; text-align: center; color: #666;">B·∫°n mu·ªën xem d·ªØ li·ªáu hay t·∫£i v·ªÅ file?</p>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                        <button id="viewBtn" style="padding: 16px 24px; background: var(--primary-blue); color: white; border: none; border-radius: 8px; cursor: pointer; display: flex; flex-direction: column; align-items: center; gap: 8px;">
                            <span style="font-size: 24px;">üëÅÔ∏è</span>
                            <span>Xem d·ªØ li·ªáu</span>
                        </button>
                        
                        <button id="downloadBtn" style="padding: 16px 24px; background: #16a34a; color: white; border: none; border-radius: 8px; cursor: pointer; display: flex; flex-direction: column; align-items: center; gap: 8px;">
                            <span style="font-size: 24px;">üì•</span>
                            <span>T·∫£i v·ªÅ</span>
                        </button>
                    </div>
                    

                `;
                
                modal.appendChild(content);
                document.body.appendChild(modal);
                
                // Add event listeners
                content.querySelector('#viewBtn').onclick = () => {
                    this[generateFunction]('view');
                    modal.remove();
                };
                
                content.querySelector('#downloadBtn').onclick = () => {
                    this[generateFunction]('download');
                    modal.remove();
                };
                

            }

            // Generic data viewer function
            showDataViewer(title, data, columns) {
                const tableHeaders = columns.map(col => `<th style="padding: 12px; background: var(--primary-blue); color: white; text-align: left; border-bottom: 2px solid #1e40af;">${col.header}</th>`).join('');
                
                const tableRows = data.map((row, index) => {
                    const cells = columns.map(col => {
                        const value = col.getValue(row, index);
                        return `<td style="padding: 12px; border-bottom: 1px solid #e5e7eb;">${value}</td>`;
                    }).join('');
                    return `<tr>${cells}</tr>`;
                }).join('');
                
                const viewerHTML = `
                    <div style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1001; display: flex; justify-content: center; align-items: center;" onclick="closeModal(this)">
                        <div style="background: white; padding: 32px; border-radius: 12px; width: 90%; max-width: 1200px; max-height: 90vh; overflow: hidden; display: flex; flex-direction: column;" onclick="event.stopPropagation()">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                                <h3 style="color: var(--text-primary); margin: 0;">${title}</h3>
                            </div>
                            
                            <div style="overflow-y: auto; flex: 1; border: 1px solid #e5e7eb; border-radius: 8px;">
                                <table style="width: 100%; border-collapse: collapse; font-family: 'Inter', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;">
                                    <thead>
                                        <tr>${tableHeaders}</tr>
                                    </thead>
                                    <tbody>
                                        ${tableRows || '<tr><td colspan="' + columns.length + '" style="text-align: center; padding: 24px; color: #666;">Kh√¥ng c√≥ d·ªØ li·ªáu</td></tr>'}
                                    </tbody>
                                </table>
                            </div>
                            
                            <div style="margin-top: 16px; padding: 12px; background: #f8fafc; border-radius: 8px; font-size: 14px; color: #666;">
                                <strong>T·ªïng s·ªë b·∫£n ghi:</strong> ${data.length}
                            </div>
                        </div>
                    </div>
                `;
                document.body.insertAdjacentHTML('beforeend', viewerHTML);
            }

            // Product Detail Function
            showProductDetail(productId) {
                console.log('Showing product detail for ID:', productId);
                console.log('Available products:', this.demoData.products.map(p => p.id));
                
                const product = this.demoData.products.find(p => p.id === productId);
                if (!product) {
                    console.error('Product not found:', productId);
                    this.showNotification('Kh√¥ng t√¨m th·∫•y s·∫£n ph·∫©m', 'error');
                    return;
                }
                
                console.log('Found product:', product);
                
                const profit = product.importPrice ? product.price - product.importPrice : 0;
                const profitPercent = product.importPrice ? ((profit / product.importPrice) * 100).toFixed(1) : 0;
                const totalValue = product.price * product.stock;
                const totalCost = product.importPrice ? product.importPrice * product.stock : 0;
                
                const detailHTML = `
                    <div style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1001; display: flex; justify-content: center; align-items: center;" onclick="closeModal(this)">
                        <div style="background: white; padding: 32px; border-radius: 12px; width: 900px; max-width: 95vw;" onclick="event.stopPropagation()">
                            <h3 style="margin-bottom: 24px; color: var(--text-primary); text-align: center;">Chi ti·∫øt s·∫£n ph·∫©m</h3>
                            
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 24px;">
                                <div style="background: #f8fafc; padding: 16px; border-radius: 8px;">
                                    <h4 style="color: var(--primary-blue); margin-bottom: 8px;">Th√¥ng tin c∆° b·∫£n</h4>
                                    <p><strong>M√£ SP:</strong> ${product.id}</p>
                                    <p><strong>T√™n:</strong> ${product.name}</p>
                                    <p><strong>Danh m·ª•c:</strong> ${product.category}</p>
                                    <p><strong>Nh√† cung c·∫•p:</strong> ${product.supplier || 'N/A'}</p>
                                </div>
                                
                                <div style="background: #f0f9ff; padding: 16px; border-radius: 8px;">
                                    <h4 style="color: var(--primary-blue); margin-bottom: 8px;">T·ªìn kho & Gi√°</h4>
                                    <p><strong>S·ªë l∆∞·ª£ng t·ªìn:</strong> <span style="color: ${product.stock <= product.minStock ? '#dc2626' : '#16a34a'}">${product.stock} ${product.stock <= product.minStock ? '‚ö†Ô∏è' : '‚úÖ'}</span></p>
                                    <p><strong>T·ªëi thi·ªÉu:</strong> <span style="color: #6b7280">${product.minStock}</span> ${product.stock <= product.minStock ? '<span style="color: #dc2626; font-size: 12px;">(D∆∞·ªõi ng∆∞·ª°ng!)</span>' : ''}</p>
                                    <p><strong>Gi√° nh·∫≠p:</strong> ${product.importPrice?.toLocaleString('vi-VN') || 'N/A'} VNƒê</p>
                                    <p><strong>Gi√° b√°n:</strong> ${product.price.toLocaleString('vi-VN')} VNƒê</p>
                                    ${profit > 0 ? `<p><strong>L·ª£i nhu·∫≠n/SP:</strong> <span style="color: #16a34a">${profit.toLocaleString('vi-VN')} VNƒê (${profitPercent}%)</span></p>` : ''}
                                </div>
                            </div>
                            
                            <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 12px; margin-bottom: 24px;">
                                <h4 style="margin-bottom: 12px; color: white;">Ph√¢n t√≠ch t√†i ch√≠nh</h4>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                                    <div>
                                        <p style="opacity: 0.9;">T·ªïng gi√° tr·ªã t·ªìn kho</p>
                                        <p style="font-size: 18px; font-weight: bold;">${totalValue.toLocaleString('vi-VN')} VNƒê</p>
                                    </div>
                                    ${totalCost > 0 ? `
                                    <div>
                                        <p style="opacity: 0.9;">T·ªïng gi√° v·ªën</p>
                                        <p style="font-size: 18px; font-weight: bold;">${totalCost.toLocaleString('vi-VN')} VNƒê</p>
                                    </div>` : ''}
                                </div>
                                ${profit > 0 ? `<p style="margin-top: 12px; opacity: 0.9;">üí° L·ª£i nhu·∫≠n ti·ªÅm nƒÉng: <strong>${(totalValue - totalCost).toLocaleString('vi-VN')} VNƒê</strong></p>` : ''}
                            </div>
                            
                            <div style="display: flex; gap: 12px; justify-content: center;">
                                <button onclick="closeModal(this.closest('div[style*=fixed]'))" 
                                        style="padding: 12px 24px; border: 2px solid #e5e7eb; background: white; border-radius: 8px; cursor: pointer;">ƒê√≥ng</button>
                                <button onclick="app.showEditProductForm('${product.id}');" 
                                        style="padding: 12px 24px; background: var(--primary-blue); color: white; border: none; border-radius: 8px; cursor: pointer;">Ch·ªânh s·ª≠a</button>
                            </div>
                        </div>
                    </div>
                `;
                document.body.insertAdjacentHTML('beforeend', detailHTML);
            }
            
            // Payment and Debt Management
            showPaymentForm() {
                const customersWithDebt = this.demoData.customers.filter(c => c.debt > 0);
                const customerOptions = customersWithDebt.map(c => 
                    `<option value="${c.id}" data-debt="${c.debt}">${c.name} - N·ª£: ${c.debt.toLocaleString('vi-VN')} VNƒê</option>`
                ).join('');
                
                const formHTML = `
                    <div style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1001; display: flex; justify-content: center; align-items: center;" onclick="closeModal(this)">
                        <div style="background: white; padding: 32px; border-radius: 12px; width: 500px; max-width: 90vw;" onclick="event.stopPropagation()">
                            <h3 style="margin-bottom: 24px; color: var(--text-primary);">Ghi nh·∫≠n thanh to√°n</h3>
                            <form onsubmit="app.recordPayment(event)">
                                <div style="margin-bottom: 16px;">
                                    <label style="display: block; margin-bottom: 8px; font-weight: 600;">Kh√°ch h√†ng:</label>
                                    <select name="customer" required style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px;" onchange="app.updateDebtAmount(this)">
                                        <option value="">Ch·ªçn kh√°ch h√†ng</option>
                                        ${customerOptions}
                                    </select>
                                </div>
                                <div style="margin-bottom: 16px;">
                                    <label style="display: block; margin-bottom: 8px; font-weight: 600;">S·ªë ti·ªÅn thanh to√°n:</label>
                                    <input type="number" name="amount" required min="0" style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px;">
                                </div>
                                <div style="margin-bottom: 24px;">
                                    <div id="debt-info" style="padding: 12px; background: #f3f4f6; border-radius: 8px; color: #374151;"></div>
                                </div>
                                <div style="display: flex; gap: 12px; justify-content: flex-end;">
                                    <button type="button" onclick="closeModal(this.closest('div[style*=fixed]'))" 
                                            style="padding: 12px 24px; border: 2px solid #e5e7eb; background: white; border-radius: 8px; cursor: pointer;">H·ªßy</button>
                                    <button type="submit" 
                                            style="padding: 12px 24px; background: var(--primary-blue); color: white; border: none; border-radius: 8px; cursor: pointer;">Ghi nh·∫≠n</button>
                                </div>
                            </form>
                        </div>
                    </div>
                `;
                document.body.insertAdjacentHTML('beforeend', formHTML);
            }
            
            updateDebtAmount(selectElement) {
                const selectedOption = selectElement.options[selectElement.selectedIndex];
                const debt = selectedOption.getAttribute('data-debt') || 0;
                const debtInfo = document.getElementById('debt-info');
                if (debt > 0) {
                    debtInfo.innerHTML = `T·ªïng n·ª£ hi·ªán t·∫°i: <strong>${parseInt(debt).toLocaleString('vi-VN')} VNƒê</strong>`;
                } else {
                    debtInfo.innerHTML = '';
                }
            }
            
            recordPayment(event) {
                event.preventDefault();
                const form = event.target;
                const formData = new FormData(form);
                
                const customerId = formData.get('customer');
                const amount = parseInt(formData.get('amount'));
                
                console.log('üî¥ === RECORD PAYMENT DEBUG ===');
                console.log('Customer ID:', customerId);
                console.log('Amount:', amount);
                
                const customer = this.demoData.customers.find(c => c.id === customerId);
                if (customer && amount > 0) {
                    const oldDebt = customer.debt;
                    console.log(`üî¥ BEFORE: ${customer.name} n·ª£ ${oldDebt.toLocaleString('vi-VN')} VNƒê`);
                    
                    customer.debt = Math.max(0, customer.debt - amount);
                    console.log(`üü¢ AFTER: ${customer.name} n·ª£ ${customer.debt.toLocaleString('vi-VN')} VNƒê`);
                    
                    // L∆∞u v√† ƒë·ªìng b·ªô d·ªØ li·ªáu ngay l·∫≠p t·ª©c
                    this.saveToLocalStorage();
                    console.log('üíæ Data saved to localStorage');
                    
                    // Ki·ªÉm tra localStorage ngay sau khi l∆∞u
                    const savedData = JSON.parse(localStorage.getItem('PhuocIT_vietnam_data'));
                    const savedCustomer = savedData.customers.find(c => c.id === customerId);
                    console.log(`‚úÖ VERIFIED IN LOCALSTORAGE: ${savedCustomer.name} n·ª£ ${savedCustomer.debt.toLocaleString('vi-VN')} VNƒê`);
                    
                    // ƒê·ªíNG B·ªò 2 CHI·ªÄU: N·∫øu kh√°ch h√†ng ƒë√£ tr·∫£ h·∫øt n·ª£, c·∫≠p nh·∫≠t t·∫•t c·∫£ ƒë∆°n h√†ng th√†nh "ƒê√£ thanh to√°n"
                    let syncMessage = '';
                    if (customer.debt === 0) {
                        const unpaidOrders = this.demoData.orders.filter(order => 
                            order.customerId === customerId && 
                            (order.paymentStatus === 'C√¥ng n·ª£')
                        );
                        
                        if (unpaidOrders.length > 0) {
                            unpaidOrders.forEach(order => {
                                order.paymentStatus = 'ƒê√£ thanh to√°n';
                                console.log(`üîÑ ƒê·ªìng b·ªô: ƒê∆°n h√†ng ${order.id} ‚Üí ƒê√£ thanh to√°n (do ƒë√£ tr·∫£ h·∫øt n·ª£)`);
                            });
                            syncMessage = ` v√† c·∫≠p nh·∫≠t ${unpaidOrders.length} ƒë∆°n h√†ng th√†nh "ƒê√£ thanh to√°n"`;
                        }
                    }
                    
                    // FORCE reload to√†n b·ªô ·ª©ng d·ª•ng ƒë·ªÉ ƒë·∫£m b·∫£o ƒë·ªìng b·ªô
                    console.log('üîÑ FORCE RELOADING APP DATA...');
                    this.initializeData(); // Reload t·ª´ localStorage
                    
                    this.showNotification(`‚úÖ ƒê√£ ghi nh·∫≠n thanh to√°n ${amount.toLocaleString('vi-VN')} VNƒê t·ª´ ${customer.name}. N·ª£ c√≤n l·∫°i: ${customer.debt.toLocaleString('vi-VN')} VNƒê${syncMessage}`, 'success');
                    
                    // Delay ƒë·ªÉ ƒë·∫£m b·∫£o d·ªØ li·ªáu ƒë∆∞·ª£c c·∫≠p nh·∫≠t
                    setTimeout(() => {
                        this.loadPage('debts');
                    }, 100);
                }
                const modal = form.closest("div[style*=\"fixed\"]"); if(modal) modal.remove();
            }
            
            // Hi·ªÉn th·ªã form thanh to√°n v·ªõi kh√°ch h√†ng ƒë∆∞·ª£c ch·ªçn s·∫µn
            showPaymentFormForCustomer(customerId) {
                const customer = this.demoData.customers.find(c => c.id === customerId);
                if (!customer) {
                    this.showNotification('Kh√¥ng t√¨m th·∫•y kh√°ch h√†ng', 'error');
                    return;
                }
                
                const formHTML = `
                    <div style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1001; display: flex; justify-content: center; align-items: center;" onclick="closeModal(this)">
                        <div style="background: white; padding: 32px; border-radius: 12px; width: 500px; max-width: 90vw;" onclick="event.stopPropagation()">
                            <h3 style="margin-bottom: 24px; color: var(--text-primary);">Ghi nh·∫≠n thanh to√°n - ${customer.name}</h3>
                            <form onsubmit="app.recordPayment(event)">
                                <input type="hidden" name="customer" value="${customer.id}">
                                <div style="margin-bottom: 16px;">
                                    <label style="display: block; margin-bottom: 8px; font-weight: 600;">Kh√°ch h√†ng:</label>
                                    <input type="text" value="${customer.name} (${customer.id})" disabled style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; background: #f9fafb;">
                                </div>
                                <div style="margin-bottom: 16px;">
                                    <label style="display: block; margin-bottom: 8px; font-weight: 600;">S·ªë ti·ªÅn thanh to√°n:</label>
                                    <input type="number" name="amount" required min="0" max="${customer.debt}" style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px;" placeholder="T·ªëi ƒëa: ${customer.debt.toLocaleString('vi-VN')} VNƒê">
                                </div>
                                <div style="margin-bottom: 24px;">
                                    <div style="padding: 12px; background: #fef3c7; border-radius: 8px; color: #92400e;">
                                        <strong>T·ªïng n·ª£ hi·ªán t·∫°i: ${customer.debt.toLocaleString('vi-VN')} VNƒê</strong>
                                    </div>
                                </div>
                                <div style="display: flex; gap: 12px; justify-content: flex-end;">
                                    <button type="button" onclick="closeModal(this.closest('div[style*=fixed]'))" 
                                            style="padding: 12px 24px; border: 2px solid #e5e7eb; background: white; border-radius: 8px; cursor: pointer;">H·ªßy</button>
                                    <button type="submit" 
                                            style="padding: 12px 24px; background: var(--primary-blue); color: white; border: none; border-radius: 8px; cursor: pointer;">Ghi nh·∫≠n</button>
                                </div>
                            </form>
                        </div>
                    </div>
                `;
                document.body.insertAdjacentHTML('beforeend', formHTML);
            }
            
            // T·∫°o d·ªØ li·ªáu s·∫£n ph·∫©m demo t·ª´ t·ªïng ti·ªÅn ƒë∆°n h√†ng
            generateOrderItemsFromTotal(total) {
                const sampleProducts = [
                    { name: 'M√°y t√≠nh x√°ch tay Dell Inspiron', price: 15000000, sku: 'DELL001' },
                    { name: 'ƒêi·ªán tho·∫°i Samsung Galaxy', price: 8000000, sku: 'SAM001' },
                    { name: 'Tai nghe Sony WH-1000XM4', price: 6000000, sku: 'SONY001' },
                    { name: 'B√†n ph√≠m c∆° Logitech', price: 2500000, sku: 'LOG001' },
                    { name: 'Chu·ªôt gaming Razer', price: 1800000, sku: 'RAZ001' },
                    { name: 'M√†n h√¨nh LG 24 inch', price: 4500000, sku: 'LG001' },
                    { name: '·ªî c·ª©ng SSD Samsung 500GB', price: 2200000, sku: 'SSD001' },
                    { name: 'Camera web Logitech C920', price: 1500000, sku: 'CAM001' },
                    { name: 'Loa Bluetooth JBL', price: 3000000, sku: 'JBL001' },
                    { name: 'ƒê·∫ø t·∫£n nhi·ªát laptop', price: 800000, sku: 'FAN001' }
                ];
                
                const items = [];
                let remainingTotal = total;
                let attempts = 0;
                
                // T·∫°o 1-4 s·∫£n ph·∫©m ng·∫´u nhi√™n
                const numItems = Math.min(Math.floor(Math.random() * 3) + 1, 4);
                
                for (let i = 0; i < numItems && remainingTotal > 0 && attempts < 10; i++) {
                    const product = sampleProducts[Math.floor(Math.random() * sampleProducts.length)];
                    
                    // T√≠nh s·ªë l∆∞·ª£ng ph√π h·ª£p
                    const maxQty = Math.min(Math.floor(remainingTotal / product.price), 5);
                    const quantity = maxQty > 0 ? Math.floor(Math.random() * maxQty) + 1 : 1;
                    
                    // ƒêi·ªÅu ch·ªânh gi√° ƒë·ªÉ ph√π h·ª£p v·ªõi s·ªë ti·ªÅn c√≤n l·∫°i
                    let itemPrice = product.price;
                    if (i === numItems - 1) {
                        // S·∫£n ph·∫©m cu·ªëi c√πng: ƒëi·ªÅu ch·ªânh gi√° ƒë·ªÉ t·ªïng kh·ªõp
                        itemPrice = Math.floor(remainingTotal / quantity);
                    }
                    
                    const itemTotal = quantity * itemPrice;
                    if (itemTotal <= remainingTotal) {
                        items.push({
                            name: product.name,
                            quantity: quantity,
                            price: itemPrice,
                            sku: product.sku,
                            productId: `prod_${product.sku.toLowerCase()}`
                        });
                        remainingTotal -= itemTotal;
                    }
                    attempts++;
                }
                
                // N·∫øu c√≤n d∆∞ ti·ªÅn, th√™m v√†o s·∫£n ph·∫©m cu·ªëi
                if (remainingTotal > 0 && items.length > 0) {
                    const lastItem = items[items.length - 1];
                    const extraPerUnit = Math.floor(remainingTotal / lastItem.quantity);
                    lastItem.price += extraPerUnit;
                }
                
                return items;
            }
            
            // Hi·ªÉn th·ªã chi ti·∫øt ƒë∆°n h√†ng
            showOrderDetail(orderId) {
                const order = this.demoData.orders.find(o => o.id === orderId);
                if (!order) {
                    this.showNotification('Kh√¥ng t√¨m th·∫•y ƒë∆°n h√†ng', 'error');
                    return;
                }
                
                // T√¨m kh√°ch h√†ng t·ª´ c·∫£ demoData v√† localStorage
                let customer = this.demoData.customers.find(c => c.id === order.customerId);
                if (!customer) {
                    // T√¨m trong localStorage n·∫øu kh√¥ng c√≥ trong demoData
                    const storedCustomers = JSON.parse(localStorage.getItem('customers') || '[]');
                    customer = storedCustomers.find(c => c.id === order.customerId);
                }
                
                // Debug log ƒë·ªÉ ki·ªÉm tra
                console.log('Order customer ID:', order.customerId);
                console.log('Found customer:', customer);
                
                // T·∫°o d·ªØ li·ªáu s·∫£n ph·∫©m demo d·ª±a tr√™n ƒë∆°n h√†ng (v√¨ d·ªØ li·ªáu th·ª±c kh√¥ng c√≥ items)
                let orderItems = order.items;
                if (!orderItems || orderItems.length === 0) {
                    // T·∫°o d·ªØ li·ªáu demo d·ª±a tr√™n t·ªïng ti·ªÅn
                    orderItems = this.generateOrderItemsFromTotal(order.total);
                }
                
                const orderItemsHTML = orderItems && orderItems.length > 0 ? 
                    orderItems.map(item => {
                        const product = this.demoData.products.find(p => p.id === item.productId);
                        const productName = product ? product.name : item.name || item.productName || 'S·∫£n ph·∫©m kh√¥ng x√°c ƒë·ªãnh';
                        
                        return `
                            <tr style="border-bottom: 1px solid #e5e7eb;">
                                <td style="padding: 12px; text-align: left;">
                                    <div style="font-weight: 600;">${productName}</div>
                                    <div style="color: #6b7280; font-size: 12px;">SKU: ${item.sku || 'SP' + Math.floor(Math.random() * 1000)}</div>
                                </td>
                                <td style="padding: 12px; text-align: center; font-weight: 600;">${item.quantity}</td>
                                <td style="padding: 12px; text-align: right;">${item.price.toLocaleString('vi-VN')} VNƒê</td>
                                <td style="padding: 12px; text-align: right; font-weight: 600; color: #dc2626;">
                                    ${(item.quantity * item.price).toLocaleString('vi-VN')} VNƒê
                                </td>
                            </tr>
                        `;
                    }).join('') :
                    '<tr><td colspan="4" style="padding: 20px; text-align: center; color: #6b7280;">Kh√¥ng c√≥ s·∫£n ph·∫©m</td></tr>';
                
                const orderDetailHTML = `
                    <div style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1002; display: flex; justify-content: center; align-items: center;" onclick="closeModal(this)">
                        <div style="background: white; padding: 32px; border-radius: 12px; width: 900px; max-width: 95vw; max-height: 90vh; overflow-y: auto;" onclick="event.stopPropagation()">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                                <h3 style="margin: 0; color: var(--text-primary);">üìã Chi ti·∫øt ƒë∆°n h√†ng ${order.id}</h3>
                                <button onclick="closeModal(this.closest('div[style*=fixed]'))" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #6b7280;">√ó</button>
                            </div>
                            
                            <!-- Th√¥ng tin ƒë∆°n h√†ng -->
                            <div style="background: #f9fafb; padding: 20px; border-radius: 8px; margin-bottom: 24px;">
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                                    <div>
                                        <div style="color: #6b7280; font-size: 14px; margin-bottom: 4px;">M√£ ƒë∆°n h√†ng:</div>
                                        <div style="font-weight: 600; color: var(--text-primary);">${order.id}</div>
                                    </div>
                                    <div>
                                        <div style="color: #6b7280; font-size: 14px; margin-bottom: 4px;">Ng√†y t·∫°o:</div>
                                        <div style="font-weight: 600; color: var(--text-primary);">${order.date}</div>
                                    </div>
                                    <div>
                                        <div style="color: #6b7280; font-size: 14px; margin-bottom: 4px;">Kh√°ch h√†ng:</div>
                                        <div style="font-weight: 600; color: var(--text-primary);">
                                            ${customer ? customer.name : order.customerName || 'N/A'}
                                            ${customer && customer.type === 'doanh-nghiep' ? `
                                                <div style="font-size: 13px; color: #6b7280; margin-top: 4px;">
                                                    <div><strong>C√¥ng ty:</strong> ${customer.companyName || 'Ch∆∞a c√≥'}</div>
                                                    ${customer.department ? `<div><strong>Ph√≤ng ban:</strong> ${customer.department}</div>` : ''}
                                                    ${customer.taxCode ? `<div><strong>MST:</strong> ${customer.taxCode}</div>` : ''}
                                                </div>
                                            ` : ''}
                                        </div>
                                    </div>
                                    <div>
                                        <div style="color: #6b7280; font-size: 14px; margin-bottom: 4px;">Tr·∫°ng th√°i thanh to√°n:</div>
                                        <div style="font-weight: 600;">
                                            <span style="background: ${order.paymentStatus === 'ƒê√£ thanh to√°n' ? '#16a34a' : '#f59e0b'}; color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px;">
                                                ${order.paymentStatus}
                                            </span>
                                        </div>
                                    </div>
                                </div>
                                <div style="margin-top: 16px;">
                                    <div style="color: #6b7280; font-size: 14px; margin-bottom: 4px;">T·ªïng ti·ªÅn:</div>
                                    <div style="font-weight: 700; color: #dc2626; font-size: 18px;">${order.total.toLocaleString('vi-VN')} VNƒê</div>
                                </div>
                                ${order.notes ? `
                                <div style="margin-top: 16px;">
                                    <div style="color: #6b7280; font-size: 14px; margin-bottom: 4px;">Ghi ch√∫:</div>
                                    <div style="font-weight: 600; color: var(--text-primary);">${order.notes}</div>
                                </div>
                                ` : ''}
                            </div>
                            
                            <!-- Danh s√°ch s·∫£n ph·∫©m -->
                            <div>
                                <h4 style="margin-bottom: 16px; color: var(--text-primary);">
                                    üõí S·∫£n ph·∫©m trong ƒë∆°n h√†ng (${order.items ? order.items.length : 0} s·∫£n ph·∫©m)
                                </h4>
                                <div style="overflow-x: auto;">
                                    <table style="width: 100%; border-collapse: collapse; background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                                        <thead>
                                            <tr style="background: #f3f4f6;">
                                                <th style="padding: 12px; text-align: left; font-weight: 600; color: var(--text-primary);">T√™n s·∫£n ph·∫©m</th>
                                                <th style="padding: 12px; text-align: center; font-weight: 600; color: var(--text-primary);">S·ªë l∆∞·ª£ng</th>
                                                <th style="padding: 12px; text-align: right; font-weight: 600; color: var(--text-primary);">ƒê∆°n gi√°</th>
                                                <th style="padding: 12px; text-align: right; font-weight: 600; color: var(--text-primary);">Th√†nh ti·ªÅn</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${orderItemsHTML}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            
                            <div style="display: flex; gap: 12px; justify-content: flex-end; margin-top: 24px;">
                                <button onclick="closeModal(this.closest('div[style*=fixed]'))" style="
                                    background: #6b7280; 
                                    color: white; 
                                    border: none; 
                                    padding: 12px 24px; 
                                    border-radius: 8px; 
                                    cursor: pointer; 
                                    font-weight: 600;
                                ">
                                    ƒê√≥ng
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                
                document.body.insertAdjacentHTML('beforeend', orderDetailHTML);
            }
            
            // Hi·ªÉn th·ªã chi ti·∫øt c√¥ng n·ª£ kh√°ch h√†ng
            showCustomerDebtDetail(customerId) {
                // T√¨m kh√°ch h√†ng t·ª´ c·∫£ demoData v√† localStorage
                let customer = this.demoData.customers.find(c => c.id === customerId);
                if (!customer) {
                    const storedCustomers = JSON.parse(localStorage.getItem('customers') || '[]');
                    customer = storedCustomers.find(c => c.id === customerId);
                }
                
                if (!customer) {
                    this.showNotification('Kh√¥ng t√¨m th·∫•y kh√°ch h√†ng', 'error');
                    return;
                }
                
                console.log('üîç DEBUG - Customer:', customer);
                console.log('üîç DEBUG - All orders:', this.demoData.orders);
                
                // T√¨m t·∫•t c·∫£ ƒë∆°n h√†ng ch∆∞a thanh to√°n c·ªßa kh√°ch h√†ng (t√¨m theo nhi·ªÅu c√°ch)
                const unpaidOrders = this.demoData.orders.filter(order => {
                    // T√¨m theo customerId ho·∫∑c customer name
                    const matchById = order.customerId === customerId;
                    const matchByName = order.customer === customer.name || order.customerName === customer.name;
                    
                    const isUnpaid = order.paymentStatus === 'C√¥ng n·ª£' ||
                                    order.status === 'C√¥ng n·ª£';
                    
                    console.log(`üîç Order ${order.id}: matchById=${matchById}, matchByName=${matchByName}, isUnpaid=${isUnpaid}`);
                    
                    return (matchById || matchByName) && isUnpaid;
                });
                
                console.log('üîç DEBUG - Unpaid orders found:', unpaidOrders);
                
                const unpaidOrdersHTML = unpaidOrders.length > 0 ? 
                    unpaidOrders.map(order => `
                        <tr style="border-bottom: 1px solid #e5e7eb;">
                            <td style="padding: 12px; text-align: left;">${order.id}</td>
                            <td style="padding: 12px; text-align: left;">${order.date}</td>
                            <td style="padding: 12px; text-align: right; color: #dc2626; font-weight: 600;">
                                ${order.total.toLocaleString('vi-VN')} VNƒê
                            </td>
                            <td style="padding: 12px; text-align: center;">
                                <span style="background: #f59e0b; color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px;">
                                    ${order.paymentStatus}
                                </span>
                            </td>
                            <td style="padding: 12px; text-align: center;">
                                <button onclick="app.showOrderDetail('${order.id}')" style="
                                    background: #3b82f6; 
                                    color: white; 
                                    border: none; 
                                    padding: 6px 12px; 
                                    border-radius: 4px; 
                                    cursor: pointer; 
                                    font-size: 12px; 
                                    font-weight: 600;
                                ">
                                    Chi ti·∫øt
                                </button>
                            </td>
                        </tr>
                    `).join('') :
                    '<tr><td colspan="5" style="padding: 20px; text-align: center; color: #6b7280;">Kh√¥ng c√≥ ƒë∆°n h√†ng n√†o ƒëang n·ª£</td></tr>';
                
                const detailHTML = `
                    <div style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1001; display: flex; justify-content: center; align-items: center;" onclick="closeModal(this)">
                        <div style="background: white; padding: 32px; border-radius: 12px; width: 800px; max-width: 95vw; max-height: 90vh; overflow-y: auto;" onclick="event.stopPropagation()">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                                <h3 style="margin: 0; color: var(--text-primary);">üìä Chi ti·∫øt c√¥ng n·ª£ - ${customer.name}</h3>
                                <button onclick="closeModal(this.closest('div[style*=fixed]'))" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #6b7280;">√ó</button>
                            </div>
                            
                            <!-- Th√¥ng tin kh√°ch h√†ng -->
                            <div style="background: #f9fafb; padding: 20px; border-radius: 8px; margin-bottom: 24px;">
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                                    <div>
                                        <div style="color: #6b7280; font-size: 14px; margin-bottom: 4px;">T√™n kh√°ch h√†ng:</div>
                                        <div style="font-weight: 600; color: var(--text-primary);">${customer.name}</div>
                                        ${customer.type === 'doanh-nghiep' && customer.companyName ? `
                                            <div style="font-size: 13px; color: #6b7280; margin-top: 4px;">
                                                <div><strong>C√¥ng ty:</strong> ${customer.companyName}</div>
                                            </div>
                                        ` : ''}
                                    </div>
                                    <div>
                                        <div style="color: #6b7280; font-size: 14px; margin-bottom: 4px;">M√£ kh√°ch h√†ng:</div>
                                        <div style="font-weight: 600; color: var(--text-primary);">${customer.id}</div>
                                        ${customer.type === 'doanh-nghiep' && customer.department ? `
                                            <div style="font-size: 13px; color: #6b7280; margin-top: 4px;">
                                                <div><strong>Ph√≤ng ban:</strong> ${customer.department}</div>
                                            </div>
                                        ` : ''}
                                    </div>
                                    <div>
                                        <div style="color: #6b7280; font-size: 14px; margin-bottom: 4px;">S·ªë ƒëi·ªán tho·∫°i:</div>
                                        <div style="font-weight: 600; color: var(--text-primary);">${customer.phone}</div>
                                        ${customer.type === 'doanh-nghiep' && customer.taxCode ? `
                                            <div style="font-size: 13px; color: #6b7280; margin-top: 4px;">
                                                <div><strong>MST:</strong> ${customer.taxCode}</div>
                                            </div>
                                        ` : ''}
                                    </div>
                                    <div>
                                        <div style="color: #6b7280; font-size: 14px; margin-bottom: 4px;">T·ªïng c√¥ng n·ª£:</div>
                                        <div style="font-weight: 700; color: #dc2626; font-size: 18px;">${customer.debt.toLocaleString('vi-VN')} VNƒê</div>
                                    </div>
                                </div>
                                <div style="margin-top: 16px;">
                                    <div style="color: #6b7280; font-size: 14px; margin-bottom: 4px;">ƒê·ªãa ch·ªâ:</div>
                                    <div style="font-weight: 600; color: var(--text-primary);">${customer.address}</div>
                                </div>
                            </div>
                            
                            <!-- Danh s√°ch ƒë∆°n h√†ng ƒëang n·ª£ -->
                            <div>
                                <h4 style="margin-bottom: 16px; color: var(--text-primary);">
                                    üìù ƒê∆°n h√†ng ƒëang n·ª£ (${unpaidOrders.length} ƒë∆°n)
                                </h4>
                                <div style="overflow-x: auto;">
                                    <table style="width: 100%; border-collapse: collapse; background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                                        <thead>
                                            <tr style="background: #f3f4f6;">
                                                <th style="padding: 12px; text-align: left; font-weight: 600; color: var(--text-primary);">M√£ ƒë∆°n</th>
                                                <th style="padding: 12px; text-align: left; font-weight: 600; color: var(--text-primary);">Ng√†y t·∫°o</th>
                                                <th style="padding: 12px; text-align: right; font-weight: 600; color: var(--text-primary);">S·ªë ti·ªÅn</th>
                                                <th style="padding: 12px; text-align: center; font-weight: 600; color: var(--text-primary);">Tr·∫°ng th√°i</th>
                                                <th style="padding: 12px; text-align: center; font-weight: 600; color: var(--text-primary);">H√†nh ƒë·ªông</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${unpaidOrdersHTML}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            
                            <div style="display: flex; gap: 12px; justify-content: space-between; margin-top: 24px;">
                                <button onclick="app.printDebtReport('${customer.id}'); closeModal(this.closest('div[style*=fixed]'));" style="
                                    background: var(--primary-green); 
                                    color: white; 
                                    border: none; 
                                    padding: 12px 24px; 
                                    border-radius: 8px; 
                                    cursor: pointer; 
                                    font-weight: 600;
                                ">
                                    üñ®Ô∏è IN b√°o c√°o c√¥ng n·ª£
                                </button>
                                <div style="display: flex; gap: 12px;">
                                    <button onclick="app.showPaymentFormForCustomer('${customer.id}'); closeModal(this.closest('div[style*=fixed]'));" style="
                                        background: var(--primary-blue); 
                                        color: white; 
                                        border: none; 
                                        padding: 12px 24px; 
                                        border-radius: 8px; 
                                        cursor: pointer; 
                                        font-weight: 600;
                                    ">
                                        üí∞ Ghi nh·∫≠n thanh to√°n
                                    </button>
                                    <button onclick="closeModal(this.closest('div[style*=fixed]'))" style="
                                        background: #6b7280; 
                                        color: white; 
                                        border: none; 
                                        padding: 12px 24px; 
                                        border-radius: 8px; 
                                        cursor: pointer; 
                                        font-weight: 600;
                                    ">
                                        ƒê√≥ng
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                document.body.insertAdjacentHTML('beforeend', detailHTML);
            }
            
            // Toggle tr·∫°ng th√°i c√¥ng n·ª£/ƒë√£ thanh to√°n cho kh√°ch h√†ng
            toggleCustomerDebtStatus(customerId) {
                const customer = this.demoData.customers.find(c => c.id === customerId);
                if (!customer) {
                    this.showNotification('Kh√¥ng t√¨m th·∫•y kh√°ch h√†ng', 'error');
                    return;
                }
                
                if (customer.debt > 0) {
                    // Chuy·ªÉn t·ª´ c√≥ n·ª£ sang ƒë√£ thanh to√°n
                    const oldDebt = customer.debt;
                    customer.debt = 0;
                    
                    // ƒê·ªíNG B·ªò 2 CHI·ªÄU: C·∫≠p nh·∫≠t t·∫•t c·∫£ ƒë∆°n h√†ng ch∆∞a thanh to√°n c·ªßa kh√°ch h√†ng n√†y
                    const unpaidOrders = this.demoData.orders.filter(order => 
                        order.customerId === customerId && 
                        (order.paymentStatus === 'C√¥ng n·ª£')
                    );
                    
                    let updatedOrdersCount = 0;
                    unpaidOrders.forEach(order => {
                        order.paymentStatus = 'ƒê√£ thanh to√°n';
                        updatedOrdersCount++;
                        console.log(`üîÑ ƒê·ªìng b·ªô: ƒê∆°n h√†ng ${order.id} ‚Üí ƒê√£ thanh to√°n`);
                    });
                    
                    this.saveToLocalStorage();
                    this.refreshAllCustomerDisplays();
                    
                    const message = updatedOrdersCount > 0 
                        ? `ƒê√£ ƒë√°nh d·∫•u ${customer.name} thanh to√°n xong ${oldDebt.toLocaleString('vi-VN')} VNƒê v√† c·∫≠p nh·∫≠t ${updatedOrdersCount} ƒë∆°n h√†ng th√†nh "ƒê√£ thanh to√°n"`
                        : `ƒê√£ ƒë√°nh d·∫•u ${customer.name} ƒë√£ thanh to√°n to√†n b·ªô c√¥ng n·ª£ ${oldDebt.toLocaleString('vi-VN')} VNƒê`;
                    
                    this.showNotification(message, 'success');
                    this.loadPage('debts');
                } else {
                    // Hi·ªÉn th·ªã form nh·∫≠p s·ªë ti·ªÅn n·ª£ m·ªõi
                    const formHTML = `
                        <div style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1001; display: flex; justify-content: center; align-items: center;" onclick="closeModal(this)">
                            <div style="background: white; padding: 32px; border-radius: 12px; width: 500px; max-width: 90vw;" onclick="event.stopPropagation()">
                                <h3 style="margin-bottom: 24px; color: var(--text-primary);">T·∫°o c√¥ng n·ª£ - ${customer.name}</h3>
                                <form onsubmit="app.createDebtForCustomer(event, '${customer.id}')">
                                    <div style="margin-bottom: 16px;">
                                        <label style="display: block; margin-bottom: 8px; font-weight: 600;">Kh√°ch h√†ng:</label>
                                        <input type="text" value="${customer.name} (${customer.id})" disabled style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; background: #f9fafb;">
                                    </div>
                                    <div style="margin-bottom: 24px;">
                                        <label style="display: block; margin-bottom: 8px; font-weight: 600;">S·ªë ti·ªÅn c√¥ng n·ª£:</label>
                                        <input type="number" name="debtAmount" required min="1" style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px;" placeholder="Nh·∫≠p s·ªë ti·ªÅn c√¥ng n·ª£">
                                    </div>
                                    <div style="display: flex; gap: 12px; justify-content: flex-end;">
                                        <button type="button" onclick="closeModal(this.closest('div[style*=fixed]'))" 
                                                style="padding: 12px 24px; border: 2px solid #e5e7eb; background: white; border-radius: 8px; cursor: pointer;">H·ªßy</button>
                                        <button type="submit" 
                                                style="padding: 12px 24px; background: #f59e0b; color: white; border: none; border-radius: 8px; cursor: pointer;">T·∫°o c√¥ng n·ª£</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    `;
                    document.body.insertAdjacentHTML('beforeend', formHTML);
                }
            }
            
            // T·∫°o c√¥ng n·ª£ cho kh√°ch h√†ng
            createDebtForCustomer(event, customerId) {
                event.preventDefault();
                const form = event.target;
                const formData = new FormData(form);
                const debtAmount = parseInt(formData.get('debtAmount'));
                
                const customer = this.demoData.customers.find(c => c.id === customerId);
                if (customer && debtAmount > 0) {
                    customer.debt = debtAmount;
                    this.saveToLocalStorage();
                    this.refreshAllCustomerDisplays();
                    this.showNotification(`ƒê√£ t·∫°o c√¥ng n·ª£ ${debtAmount.toLocaleString('vi-VN')} VNƒê cho ${customer.name}`, 'success');
                    this.loadPage('debts');
                }
                const modal = form.closest("div[style*=\"fixed\"]"); if(modal) modal.remove();
            }
            
            // Refresh t·∫•t c·∫£ ph·∫ßn hi·ªÉn th·ªã kh√°ch h√†ng ƒë·ªÉ ƒë·ªìng b·ªô d·ªØ li·ªáu
            refreshAllCustomerDisplays() {
                // Force reload d·ªØ li·ªáu t·ª´ localStorage ƒë·ªÉ ƒë·∫£m b·∫£o ƒë·ªìng b·ªô
                this.loadFromLocalStorage();
                
                // Debug: Log d·ªØ li·ªáu kh√°ch h√†ng hi·ªán t·∫°i
                console.log('=== DEBUG CUSTOMER DATA ===');
                this.demoData.customers.forEach(customer => {
                    console.log(`${customer.name}: ${customer.debt.toLocaleString('vi-VN')} VNƒê`);
                });
                console.log('=== END DEBUG ===');
                
                // C·∫≠p nh·∫≠t cache ƒë·ªÉ tr√°nh hi·ªÉn th·ªã d·ªØ li·ªáu c≈©
                if (typeof window !== 'undefined') {
                    // Trigger event ƒë·ªÉ c√°c component kh√°c bi·∫øt d·ªØ li·ªáu ƒë√£ thay ƒë·ªïi
                    window.dispatchEvent(new CustomEvent('customerDataUpdated', {
                        detail: { customers: this.demoData.customers }
                    }));
                }
                
                console.log('ƒê√£ refresh t·∫•t c·∫£ d·ªØ li·ªáu kh√°ch h√†ng');
            }
            
            exportDebtReport(mode = null) {
                this.showDebtExportWithFilter();
            }
            
            // Additional Product Management Functions
            showUpdatePriceForm() {
                const productOptions = this.demoData.products.map(p => 
                    `<option value="${p.id}">${p.name} - Gi√° hi·ªán t·∫°i: ${p.price.toLocaleString('vi-VN')} VNƒê</option>`
                ).join('');
                
                const formHTML = `
                    <div style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1001; display: flex; justify-content: center; align-items: center;" onclick="closeModal(this)">
                        <div style="background: white; padding: 32px; border-radius: 12px; width: 500px; max-width: 90vw;" onclick="event.stopPropagation()">
                            <h3 style="margin-bottom: 24px; color: var(--text-primary);">C·∫≠p nh·∫≠t gi√° s·∫£n ph·∫©m</h3>
                            <form onsubmit="app.submitProductUpdate(event)">
                                <div style="margin-bottom: 16px;">
                                    <label style="display: block; margin-bottom: 8px; font-weight: 600;">S·∫£n ph·∫©m:</label>
                                    <select name="product" required style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px;">
                                        <option value="">Ch·ªçn s·∫£n ph·∫©m</option>
                                        ${productOptions}
                                    </select>
                                </div>
                                <div style="margin-bottom: 24px;">
                                    <label style="display: block; margin-bottom: 8px; font-weight: 600;">Gi√° m·ªõi:</label>
                                    <input type="number" name="price" required min="0" style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px;">
                                </div>
                                <div style="display: flex; gap: 12px; justify-content: flex-end;">
                                    <button type="button" onclick="closeModal(this.closest('div[style*=fixed]'))" 
                                            style="padding: 12px 24px; border: 2px solid #e5e7eb; background: white; border-radius: 8px; cursor: pointer;">H·ªßy</button>
                                    <button type="submit" 
                                            style="padding: 12px 24px; background: var(--primary-blue); color: white; border: none; border-radius: 8px; cursor: pointer;">C·∫≠p nh·∫≠t gi√°</button>
                                </div>
                            </form>
                        </div>
                    </div>
                `;
                document.body.insertAdjacentHTML('beforeend', formHTML);
            }
            
            submitProductUpdate(event) {
                event.preventDefault();
                const form = event.target;
                const formData = new FormData(form);
                
                const productId = formData.get('product');
                const newPrice = parseInt(formData.get('price'));
                
                const product = this.demoData.products.find(p => p.id === productId);
                if (product) {
                    const oldPrice = product.price;
                    product.price = newPrice;
                    this.saveToLocalStorage();
                    this.showNotification(`ƒê√£ c·∫≠p nh·∫≠t gi√° ${product.name} t·ª´ ${oldPrice.toLocaleString('vi-VN')} VNƒê th√†nh ${newPrice.toLocaleString('vi-VN')} VNƒê`, 'success');
                    this.loadPage('products');
                }
                const modal = form.closest("div[style*=\"fixed\"]"); if(modal) modal.remove();
            }
            
            showStockUpdateForm() {
                const productOptions = this.demoData.products.map(p => 
                    `<option value="${p.id}">${p.name} - T·ªìn kho: ${p.stock}</option>`
                ).join('');
                
                const formHTML = `
                    <div style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1001; display: flex; justify-content: center; align-items: center;" onclick="closeModal(this)">
                        <div style="background: white; padding: 32px; border-radius: 12px; width: 500px; max-width: 90vw;" onclick="event.stopPropagation()">
                            <h3 style="margin-bottom: 24px; color: var(--text-primary);">Nh·∫≠p kho</h3>
                            <form onsubmit="app.updateStock(event)">
                                <div style="margin-bottom: 16px;">
                                    <label style="display: block; margin-bottom: 8px; font-weight: 600;">S·∫£n ph·∫©m:</label>
                                    <select name="product" required style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px;">
                                        <option value="">Ch·ªçn s·∫£n ph·∫©m</option>
                                        ${productOptions}
                                    </select>
                                </div>
                                <div style="margin-bottom: 24px;">
                                    <label style="display: block; margin-bottom: 8px; font-weight: 600;">S·ªë l∆∞·ª£ng nh·∫≠p th√™m:</label>
                                    <input type="number" name="quantity" required min="1" style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px;">
                                </div>
                                <div style="display: flex; gap: 12px; justify-content: flex-end;">
                                    <button type="button" onclick="closeModal(this.closest('div[style*=fixed]'))" 
                                            style="padding: 12px 24px; border: 2px solid #e5e7eb; background: white; border-radius: 8px; cursor: pointer;">H·ªßy</button>
                                    <button type="submit" 
                                            style="padding: 12px 24px; background: var(--primary-blue); color: white; border: none; border-radius: 8px; cursor: pointer;">Nh·∫≠p kho</button>
                                </div>
                            </form>
                        </div>
                    </div>
                `;
                document.body.insertAdjacentHTML('beforeend', formHTML);
            }
            
            updateStock(event) {
                event.preventDefault();
                const form = event.target;
                const formData = new FormData(form);
                
                const productId = formData.get('product');
                const quantity = parseInt(formData.get('quantity'));
                
                const product = this.demoData.products.find(p => p.id === productId);
                if (product) {
                    product.stock += quantity;
                    this.saveToLocalStorage();
                    this.showNotification(`ƒê√£ nh·∫≠p ${quantity} ${product.name} v√†o kho. T·ªìn kho m·ªõi: ${product.stock}`, 'success');
                    this.loadPage('inventory');
                }
                const modal = form.closest("div[style*=\"fixed\"]"); if(modal) modal.remove();
            }
            
            showStockExportForm() {
                const productOptions = this.demoData.products.filter(p => p.stock > 0).map(p => 
                    `<option value="${p.id}">${p.name} - T·ªìn kho: ${p.stock}</option>`
                ).join('');
                
                const formHTML = `
                    <div style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1001; display: flex; justify-content: center; align-items: center;" onclick="closeModal(this)">
                        <div style="background: white; padding: 32px; border-radius: 12px; width: 500px; max-width: 90vw;" onclick="event.stopPropagation()">
                            <h3 style="margin-bottom: 24px; color: var(--text-primary);">Xu·∫•t kho</h3>
                            <form onsubmit="app.exportStock(event)">
                                <div style="margin-bottom: 16px;">
                                    <label style="display: block; margin-bottom: 8px; font-weight: 600;">S·∫£n ph·∫©m:</label>
                                    <select name="product" required style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px;">
                                        <option value="">Ch·ªçn s·∫£n ph·∫©m</option>
                                        ${productOptions}
                                    </select>
                                </div>
                                <div style="margin-bottom: 16px;">
                                    <label style="display: block; margin-bottom: 8px; font-weight: 600;">L√Ω do xu·∫•t:</label>
                                    <select name="reason" required style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px;">
                                        <option value="">Ch·ªçn l√Ω do</option>
                                        <option value="B√°n h√†ng">B√°n h√†ng</option>
                                        <option value="Khuy·∫øn m√£i">Khuy·∫øn m√£i</option>
                                        <option value="H·ªèng h√≥c">H·ªèng h√≥c</option>
                                        <option value="Ki·ªÉm k√™">Ki·ªÉm k√™</option>
                                        <option value="Kh√°c">Kh√°c</option>
                                    </select>
                                </div>
                                <div style="margin-bottom: 24px;">
                                    <label style="display: block; margin-bottom: 8px; font-weight: 600;">S·ªë l∆∞·ª£ng xu·∫•t:</label>
                                    <input type="number" name="quantity" required min="1" style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px;">
                                </div>
                                <div style="display: flex; gap: 12px; justify-content: flex-end;">
                                    <button type="button" onclick="closeModal(this.closest('div[style*=fixed]'))" 
                                            style="padding: 12px 24px; border: 2px solid #e5e7eb; background: white; border-radius: 8px; cursor: pointer;">H·ªßy</button>
                                    <button type="submit" 
                                            style="padding: 12px 24px; background: var(--primary-blue); color: white; border: none; border-radius: 8px; cursor: pointer;">Xu·∫•t kho</button>
                                </div>
                            </form>
                        </div>
                    </div>
                `;
                document.body.insertAdjacentHTML('beforeend', formHTML);
            }
            
            exportStock(event) {
                event.preventDefault();
                const form = event.target;
                const formData = new FormData(form);
                
                const productId = formData.get('product');
                const quantity = parseInt(formData.get('quantity'));
                const reason = formData.get('reason');
                
                const product = this.demoData.products.find(p => p.id === productId);
                if (product && product.stock >= quantity) {
                    product.stock -= quantity;
                    this.saveToLocalStorage();
                    this.showNotification(`ƒê√£ xu·∫•t ${quantity} ${product.name} - L√Ω do: ${reason}. T·ªìn kho c√≤n: ${product.stock}`, 'success');
                    this.loadPage('inventory');
                } else if (product) {
                    this.showNotification(`Kh√¥ng ƒë·ªß h√†ng trong kho. T·ªìn kho hi·ªán t·∫°i: ${product.stock}`, 'error');
                }
                const modal = form.closest("div[style*=\"fixed\"]"); if(modal) modal.remove();
            }
            
            exportInventoryReport(mode = null) {
                this.showInventoryExportWithFilter();
            }
            
            exportSalesReport(mode = null) {
                this.showSalesExportWithFilter();
            }
            
            exportPurchaseReport(mode = null) {
                if (!mode) {
                    this.showExportOptions('Xu·∫•t b√°o c√°o chi ph√≠ mua h√†ng', 'purchases', 'exportPurchaseReport');
                    return;
                }

                // T·∫°o d·ªØ li·ªáu mua h√†ng m·∫´u
                const purchaseData = [
                    { id: 'PH001', supplier: 'C√¥ng ty ABC', date: '2024-01-15', products: 'ƒêi·ªán tho·∫°i, Tai nghe', total: 15000000, status: 'Ho√†n th√†nh' },
                    { id: 'PH002', supplier: 'Nh√† cung c·∫•p XYZ', date: '2024-01-10', products: 'Laptop, Chu·ªôt', total: 25000000, status: 'ƒêang x·ª≠ l√Ω' },
                    { id: 'PH003', supplier: 'C√¥ng ty DEF', date: '2024-01-05', products: 'M√°y t√≠nh b·∫£ng', total: 8000000, status: 'Ho√†n th√†nh' }
                ];

                if (mode === 'view') {
                    const columns = [
                        { header: 'M√£ PH', getValue: purchase => purchase.id },
                        { header: 'Nh√† cung c·∫•p', getValue: purchase => purchase.supplier },
                        { header: 'Ng√†y', getValue: purchase => purchase.date },
                        { header: 'S·∫£n ph·∫©m', getValue: purchase => purchase.products },
                        { header: 'T·ªïng ti·ªÅn (VNƒê)', getValue: purchase => purchase.total.toLocaleString('vi-VN') },
                        { header: 'Tr·∫°ng th√°i', getValue: purchase => purchase.status }
                    ];
                    this.showDataViewer('B√°o c√°o chi ph√≠ mua h√†ng', purchaseData, columns);
                } else if (mode === 'download') {
                    const csvContent = "data:text/csv;charset=utf-8,\uFEFF" + 
                        "M√£ PH,Nh√† cung c·∫•p,Ng√†y,S·∫£n ph·∫©m,T·ªïng ti·ªÅn,Tr·∫°ng th√°i\n" +
                        purchaseData.map(p => 
                            `${p.id},"${p.supplier}","${p.date}","${p.products}",${p.total},"${p.status}"`
                        ).join('\n');
                    
                    const encodedUri = encodeURI(csvContent);
                    const link = document.createElement("a");
                    link.setAttribute("href", encodedUri);
                    link.setAttribute("download", `mua_hang_${this.getVietnamTime().toISOString().split('T')[0]}.csv`);
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    
                    this.showNotification('ƒê√£ t·∫£i xu·ªëng b√°o c√°o chi ph√≠ mua h√†ng', 'success');
                }
            }

            exportSuppliers(mode = null) {
                if (!mode) {
                    this.showExportOptions('Xu·∫•t d·ªØ li·ªáu nh√† cung c·∫•p', 'suppliers', 'exportSuppliers');
                    return;
                }

                if (mode === 'view') {
                    const columns = [
                        { header: 'M√£ NCC', getValue: supplier => supplier.id },
                        { header: 'T√™n nh√† cung c·∫•p', getValue: supplier => supplier.name },
                        { header: 'ƒêi·ªán tho·∫°i', getValue: supplier => supplier.phone || 'N/A' },
                        { header: 'Email', getValue: supplier => supplier.email || 'N/A' },
                        { header: 'ƒê·ªãa ch·ªâ', getValue: supplier => supplier.address || 'N/A' },
                        { header: 'S·∫£n ph·∫©m cung c·∫•p', getValue: supplier => supplier.products || 'N/A' }
                    ];
                    this.showDataViewer('Danh s√°ch nh√† cung c·∫•p', this.demoData.suppliers, columns);
                } else if (mode === 'download') {
                    const csvContent = "data:text/csv;charset=utf-8,\uFEFF" + 
                        "M√£ NCC,T√™n nh√† cung c·∫•p,ƒêi·ªán tho·∫°i,Email,ƒê·ªãa ch·ªâ,S·∫£n ph·∫©m cung c·∫•p\n" +
                        this.demoData.suppliers.map(s => 
                            `${s.id},"${s.name}","${s.phone || ''}","${s.email || ''}","${s.address || ''}","${s.products || ''}"`
                        ).join('\n');
                    
                    const encodedUri = encodeURI(csvContent);
                    const link = document.createElement("a");
                    link.setAttribute("href", encodedUri);
                    link.setAttribute("download", `nha_cung_cap_${this.getVietnamTime().toISOString().split('T')[0]}.csv`);
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    
                    this.showNotification('ƒê√£ t·∫£i xu·ªëng danh s√°ch nh√† cung c·∫•p', 'success');
                }
            }

            exportProducts(mode = null) {
                if (!mode) {
                    this.showExportOptions('Xu·∫•t d·ªØ li·ªáu s·∫£n ph·∫©m', 'products', 'exportProducts');
                    return;
                }

                if (mode === 'view') {
                    const columns = [
                        { header: 'M√£ SP', getValue: product => product.id },
                        { header: 'T√™n s·∫£n ph·∫©m', getValue: product => product.name },
                        { header: 'Danh m·ª•c', getValue: product => product.category },
                        { header: 'Gi√° b√°n (VNƒê)', getValue: product => product.price.toLocaleString('vi-VN') },
                        { header: 'Gi√° v·ªën (VNƒê)', getValue: product => (product.importPrice || 0).toLocaleString('vi-VN') },
                        { header: 'T·ªìn kho', getValue: product => product.stock },
                        { header: 'Nh√† cung c·∫•p', getValue: product => product.supplier || 'N/A' }
                    ];
                    this.showDataViewer('Danh s√°ch s·∫£n ph·∫©m', this.demoData.products, columns);
                } else if (mode === 'download') {
                    const csvContent = "data:text/csv;charset=utf-8,\uFEFF" + 
                        "M√£ SP,T√™n s·∫£n ph·∫©m,Danh m·ª•c,Gi√° b√°n,Gi√° v·ªën,T·ªìn kho,Nh√† cung c·∫•p\n" +
                        this.demoData.products.map(p => 
                            `${p.id},"${p.name}","${p.category}",${p.price},${p.importPrice || 0},${p.stock},"${p.supplier || ''}"`
                        ).join('\n');
                    
                    const encodedUri = encodeURI(csvContent);
                    const link = document.createElement("a");
                    link.setAttribute("href", encodedUri);
                    link.setAttribute("download", `san_pham_${this.getVietnamTime().toISOString().split('T')[0]}.csv`);
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    
                    this.showNotification('ƒê√£ t·∫£i xu·ªëng danh s√°ch s·∫£n ph·∫©m', 'success');
                }
            }

            exportCategoriesData(mode = null) {
                if (!mode) {
                    this.showExportOptions('Xu·∫•t d·ªØ li·ªáu danh m·ª•c', 'categories', 'exportCategoriesData');
                    return;
                }

                if (mode === 'view') {
                    const columns = [
                        { header: 'M√£ danh m·ª•c', getValue: category => category.id },
                        { header: 'T√™n danh m·ª•c', getValue: category => category.name },
                        { header: 'Danh m·ª•c cha', getValue: category => {
                            if (!category.parent) return 'Danh m·ª•c g·ªëc';
                            const parent = this.demoData.categories.find(c => c.id === category.parent);
                            return parent ? parent.name : 'N/A';
                        }},
                        { header: 'S·ªë s·∫£n ph·∫©m', getValue: category => {
                            const fullCategoryName = category.parent ? 
                                this.demoData.categories.find(c => c.id === category.parent)?.name + ' > ' + category.name :
                                category.name;
                            return this.demoData.products.filter(p => p.category === fullCategoryName || p.category === category.name).length;
                        }}
                    ];
                    this.showDataViewer('Danh s√°ch danh m·ª•c', this.demoData.categories, columns);
                } else if (mode === 'download') {
                    const csvContent = "data:text/csv;charset=utf-8,\uFEFF" + 
                        "M√£ danh m·ª•c,T√™n danh m·ª•c,Danh m·ª•c cha,S·ªë s·∫£n ph·∫©m\n" +
                        this.demoData.categories.map(c => {
                            const parentName = c.parent ? (this.demoData.categories.find(p => p.id === c.parent)?.name || 'N/A') : 'Danh m·ª•c g·ªëc';
                            const fullCategoryName = c.parent ? 
                                this.demoData.categories.find(p => p.id === c.parent)?.name + ' > ' + c.name :
                                c.name;
                            const productCount = this.demoData.products.filter(p => p.category === fullCategoryName || p.category === c.name).length;
                            return `${c.id},"${c.name}","${parentName}",${productCount}`;
                        }).join('\n');
                    
                    const encodedUri = encodeURI(csvContent);
                    const link = document.createElement("a");
                    link.setAttribute("href", encodedUri);
                    link.setAttribute("download", `danh_muc_${this.getVietnamTime().toISOString().split('T')[0]}.csv`);
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    
                    this.showNotification('ƒê√£ t·∫£i xu·ªëng d·ªØ li·ªáu danh m·ª•c', 'success');
                }
            }
            
            showPromotionForm() {
                this.showNotification('Ch·ª©c nƒÉng qu·∫£n l√Ω khuy·∫øn m√£i - Coming soon!', 'info');
            }

            // Order Management Functions
            showCreateOrderForm() {
                // Create customer dropdown options
                const customerDropdownOptions = this.demoData.customers.map(c => 
                    `<div class="dropdown-option" data-value="${c.id}" onclick="app.selectCustomer(this, '${c.id}', '${c.name} - ${c.phone}')" 
                          style="padding: 10px; cursor: pointer; border-bottom: 1px solid #f3f4f6;" 
                          onmouseover="this.style.background='#f3f4f6'" onmouseout="this.style.background='white'">
                        ${c.name} - ${c.phone}
                    </div>`
                ).join('');
                
                // Create product dropdown options
                const productDropdownOptions = this.demoData.products.map(p => 
                    `<div class="dropdown-option" data-value="${p.id}" data-price="${p.price}" data-stock="${p.stock}" 
                          onclick="app.selectProduct(this, '${p.id}', '${p.name} - ${p.price.toLocaleString('vi-VN')} VNƒê', ${p.price})" 
                          style="padding: 10px; cursor: pointer; border-bottom: 1px solid #f3f4f6;" 
                          onmouseover="this.style.background='#f3f4f6'" onmouseout="this.style.background='white'">
                        ${p.name} - ${p.price.toLocaleString('vi-VN')} VNƒê (C√≤n: ${p.stock})
                    </div>`
                ).join('');

                const formHTML = `
                    <div style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1001; display: flex; justify-content: center; align-items: center;" onclick="closeModal(this)">
                        <div style="background: white; padding: 32px; border-radius: 12px; width: 900px; max-width: 90vw;" onclick="event.stopPropagation()">
                            <h3 style="margin-bottom: 24px; color: var(--text-primary);">üÜï T·∫°o ƒë∆°n h√†ng m·ªõi </h3>
                            <form onsubmit="app.createOrder(event)">
                                <div style="margin-bottom: 16px;">
                                    <label style="display: block; margin-bottom: 8px; font-weight: 600;">Kh√°ch h√†ng:</label>
                                    <div style="display: flex; gap: 8px; align-items: flex-end;">
                                        <div style="flex: 1; position: relative;">
                                            <div class="custom-dropdown" style="position: relative;">
                                                <div class="dropdown-selected" onclick="app.toggleCustomerDropdown(this)" 
                                                     style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; background: white; cursor: pointer; display: flex; justify-content: space-between; align-items: center;">
                                                    <span class="selected-text" style="color: #9ca3af;">Ch·ªçn kh√°ch h√†ng</span>
                                                    <span class="dropdown-arrow" style="transform: rotate(0deg); transition: transform 0.3s;">‚ñº</span>
                                                </div>
                                                <div class="dropdown-list" style="position: absolute; top: 100%; left: 0; right: 0; background: white; border: 2px solid #e5e7eb; border-top: none; border-radius: 0 0 8px 8px; max-height: 250px; overflow-y: auto; z-index: 1000; display: none;">
                                                    <div style="padding: 8px; border-bottom: 1px solid #e5e7eb;">
                                                        <input type="text" class="dropdown-search" placeholder="üîç T√¨m kh√°ch h√†ng..." 
                                                               style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 4px; font-size: 14px;" 
                                                               oninput="app.filterDropdownItems(this, 'customer')" 
                                                               onclick="event.stopPropagation()">
                                                    </div>
                                                    <div class="dropdown-options">
                                                        ${customerDropdownOptions}
                                                    </div>
                                                </div>
                                                <input type="hidden" name="customer" id="customer-select" required>
                                            </div>
                                        </div>
                                        <button type="button" onclick="app.showQuickAddCustomer()" 
                                                style="background: var(--primary-green); color: white; border: none; padding: 12px 16px; border-radius: 8px; cursor: pointer; white-space: nowrap; font-weight: 600;">
                                            + Th√™m KH m·ªõi
                                        </button>
                                    </div>
                                </div>
                                
                                <div style="margin-bottom: 16px;">
                                    <label style="display: block; margin-bottom: 8px; font-weight: 600;">S·∫£n ph·∫©m:</label>
                                    
                                    <!-- Header row -->
                                    <div style="display: flex; gap: 8px; margin-bottom: 8px; padding: 8px; background: #f8fafc; border-radius: 6px; font-weight: 600; font-size: 12px; color: #374151;">
                                        <div style="flex: 2;">T√™n s·∫£n ph·∫©m</div>
                                        <div style="width: 80px; text-align: center;">S·ªë l∆∞·ª£ng</div>
                                        <div style="width: 120px; text-align: center;">ƒê∆°n gi√°</div>
                                        <div style="width: 100px; text-align: center;">Gi·∫£m gi√° (%)</div>
                                        <div style="width: 120px; text-align: center;">Th√†nh ti·ªÅn</div>
                                        <div style="width: 60px; text-align: center;">Thao t√°c</div>
                                    </div>
                                    
                                    <div id="product-list">
                                        <div class="product-row" style="display: flex; gap: 8px; margin-bottom: 8px; align-items: center;">
                                            <div class="custom-dropdown" style="flex: 2; position: relative;">
                                                <div class="dropdown-selected" onclick="app.toggleProductDropdown(this)" 
                                                     style="width: 100%; padding: 8px; border: 2px solid #e5e7eb; border-radius: 6px; background: white; cursor: pointer; display: flex; justify-content: space-between; align-items: center;">
                                                    <span class="selected-text" style="color: #9ca3af;">Ch·ªçn s·∫£n ph·∫©m</span>
                                                    <span class="dropdown-arrow" style="transform: rotate(0deg); transition: transform 0.3s;">‚ñº</span>
                                                </div>
                                                <div class="dropdown-list" style="position: absolute; top: 100%; left: 0; right: 0; background: white; border: 2px solid #e5e7eb; border-top: none; border-radius: 0 0 6px 6px; max-height: 200px; overflow-y: auto; z-index: 1000; display: none;">
                                                    <div style="padding: 6px; border-bottom: 1px solid #e5e7eb;">
                                                        <input type="text" class="dropdown-search" placeholder="üîç T√¨m s·∫£n ph·∫©m..." 
                                                               style="width: 100%; padding: 6px; border: 1px solid #d1d5db; border-radius: 4px; font-size: 13px;" 
                                                               oninput="app.filterDropdownItems(this, 'product')" 
                                                               onclick="event.stopPropagation()">
                                                    </div>
                                                    <div class="dropdown-options">
                                                        ${productDropdownOptions}
                                                    </div>
                                                </div>
                                                <input type="hidden" name="product[]">
                                            </div>
                                            <input type="number" name="quantity[]" placeholder="SL" min="1" value="1" style="width: 80px; padding: 8px; border: 2px solid #e5e7eb; border-radius: 6px;" onchange="app.calculateRowTotal(this)">
                                            <input type="number" name="price[]" placeholder="ƒê∆°n gi√°" style="width: 120px; padding: 8px; border: 2px solid #e5e7eb; border-radius: 6px; background: #fff3cd; cursor: pointer;" title="Click ƒë·ªÉ s·ª≠a gi√°" onchange="app.calculateRowTotal(this)">
                                            <input type="number" name="discount[]" placeholder="0" min="0" max="100" value="0" style="width: 100px; padding: 8px; border: 2px solid #e5e7eb; border-radius: 6px;" oninput="app.calculateRowTotal(this)">
                                            <input type="text" name="subtotal[]" placeholder="Th√†nh ti·ªÅn" readonly style="width: 120px; padding: 8px; border: 2px solid #e5e7eb; border-radius: 6px; background: #f0f9ff; font-weight: 600; color: #1e40af;">
                                            <button type="button" onclick="app.removeProductRow(this)" style="background: #ef4444; color: white; border: none; padding: 8px 12px; border-radius: 6px; cursor: pointer; width: 60px;">X√≥a</button>
                                        </div>
                                    </div>
                                    <button type="button" onclick="app.addProductRow()" style="background: var(--primary-green); color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; margin-top: 8px;">+ Th√™m s·∫£n ph·∫©m</button>
                                </div>
                                
                                <div style="margin-bottom: 16px;">
                                    <label style="display: block; margin-bottom: 8px; font-weight: 600;">Ph∆∞∆°ng th·ª©c thanh to√°n:</label>
                                    <select name="paymentMethod" required style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px;">
                                        <option value="Ti·ªÅn m·∫∑t">Ti·ªÅn m·∫∑t</option>
                                        <option value="Chuy·ªÉn kho·∫£n">Chuy·ªÉn kho·∫£n</option>
                                        <option value="Th·∫ª t√≠n d·ª•ng">Th·∫ª t√≠n d·ª•ng</option>
                                    </select>
                                </div>
                                
                                <div style="margin-bottom: 16px;">
                                    <label style="display: block; margin-bottom: 8px; font-weight: 600;">Tr·∫°ng th√°i thanh to√°n:</label>
                                    <select name="paymentStatus" required style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px;">
                                        <option value="C√¥ng n·ª£">C√¥ng n·ª£</option>
                                        <option value="ƒê√£ thanh to√°n">ƒê√£ thanh to√°n</option>
                                    </select>
                                </div>
                                
                                <div style="margin-bottom: 16px;">
                                    <label style="display: block; margin-bottom: 8px; font-weight: 600;">Ghi ch√∫:</label>
                                    <textarea name="orderNotes" placeholder="Nh·∫≠p ghi ch√∫ cho ƒë∆°n h√†ng (kh√¥ng b·∫Øt bu·ªôc)" style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; min-height: 80px; resize: vertical;"></textarea>
                                </div>
                                
                                <div style="margin-bottom: 24px; padding: 16px; background: #f3f4f6; border-radius: 8px;">
                                    <div style="display: flex; justify-content: space-between; align-items: center;">
                                        <span style="font-weight: 600; font-size: 18px;">T·ªïng ti·ªÅn:</span>
                                        <span id="order-total" style="font-weight: 700; font-size: 20px; color: var(--primary-blue);">0 VNƒê</span>
                                    </div>
                                </div>
                                
                                <div style="display: flex; gap: 12px; justify-content: flex-end;">
                                    <button type="button" onclick="closeModal(this.closest('div[style*=fixed]'))" 
                                            style="padding: 12px 24px; border: 2px solid #e5e7eb; background: white; border-radius: 8px; cursor: pointer;">H·ªßy</button>
                                    <button type="submit" 
                                            style="padding: 12px 24px; background: var(--primary-blue); color: white; border: none; border-radius: 8px; cursor: pointer;">T·∫°o ƒë∆°n h√†ng</button>
                                </div>
                            </form>
                        </div>
                    </div>
                `;
                document.body.insertAdjacentHTML('beforeend', formHTML);
                
                // Add click outside listener to close dropdowns
                document.addEventListener('click', (event) => {
                    if (!event.target.closest('.custom-dropdown')) {
                        this.closeAllDropdowns();
                    }
                });
            }

            addProductRow() {
                // Create product dropdown options
                const productDropdownOptions = this.demoData.products.map(p => 
                    `<div class="dropdown-option" data-value="${p.id}" data-price="${p.price}" data-stock="${p.stock}" 
                          onclick="app.selectProduct(this, '${p.id}', '${p.name} - ${p.price.toLocaleString('vi-VN')} VNƒê', ${p.price})" 
                          style="padding: 10px; cursor: pointer; border-bottom: 1px solid #f3f4f6;" 
                          onmouseover="this.style.background='#f3f4f6'" onmouseout="this.style.background='white'">
                        ${p.name} - ${p.price.toLocaleString('vi-VN')} VNƒê (C√≤n: ${p.stock})
                    </div>`
                ).join('');
                
                const newRow = `
                    <div class="product-row" style="display: flex; gap: 8px; margin-bottom: 8px; align-items: center;">
                        <div class="custom-dropdown" style="flex: 2; position: relative;">
                            <div class="dropdown-selected" onclick="app.toggleProductDropdown(this)" 
                                 style="width: 100%; padding: 8px; border: 2px solid #e5e7eb; border-radius: 6px; background: white; cursor: pointer; display: flex; justify-content: space-between; align-items: center;">
                                <span class="selected-text" style="color: #9ca3af;">Ch·ªçn s·∫£n ph·∫©m</span>
                                <span class="dropdown-arrow" style="transform: rotate(0deg); transition: transform 0.3s;">‚ñº</span>
                            </div>
                            <div class="dropdown-list" style="position: absolute; top: 100%; left: 0; right: 0; background: white; border: 2px solid #e5e7eb; border-top: none; border-radius: 0 0 6px 6px; max-height: 200px; overflow-y: auto; z-index: 1000; display: none;">
                                <div style="padding: 6px; border-bottom: 1px solid #e5e7eb;">
                                    <input type="text" class="dropdown-search" placeholder="üîç T√¨m s·∫£n ph·∫©m..." 
                                           style="width: 100%; padding: 6px; border: 1px solid #d1d5db; border-radius: 4px; font-size: 13px;" 
                                           oninput="app.filterDropdownItems(this, 'product')" 
                                           onclick="event.stopPropagation()">
                                </div>
                                <div class="dropdown-options">
                                    ${productDropdownOptions}
                                </div>
                            </div>
                            <input type="hidden" name="product[]">
                        </div>
                        <input type="number" name="quantity[]" placeholder="SL" min="1" value="1" style="width: 80px; padding: 8px; border: 2px solid #e5e7eb; border-radius: 6px;" onchange="app.calculateRowTotal(this)">
                        <input type="number" name="price[]" placeholder="ƒê∆°n gi√°" style="width: 120px; padding: 8px; border: 2px solid #e5e7eb; border-radius: 6px; background: #fff3cd; cursor: pointer;" title="Click ƒë·ªÉ s·ª≠a gi√°" onchange="app.calculateRowTotal(this)">
                        <input type="number" name="discount[]" placeholder="0" min="0" max="100" value="0" style="width: 100px; padding: 8px; border: 2px solid #e5e7eb; border-radius: 6px;" oninput="app.calculateRowTotal(this)">
                        <input type="text" name="subtotal[]" placeholder="Th√†nh ti·ªÅn" readonly style="width: 120px; padding: 8px; border: 2px solid #e5e7eb; border-radius: 6px; background: #f0f9ff; font-weight: 600; color: #1e40af;">
                        <button type="button" onclick="app.removeProductRow(this)" style="background: #ef4444; color: white; border: none; padding: 8px 12px; border-radius: 6px; cursor: pointer; width: 60px;">X√≥a</button>
                    </div>
                `;
                document.getElementById('product-list').insertAdjacentHTML('beforeend', newRow);
            }

            removeProductRow(button) {
                button.closest('.product-row').remove();
                this.calculateOrderTotal();
            }

            updateProductRowPrice(selectElement) {
                const selectedOption = selectElement.options[selectElement.selectedIndex];
                const price = selectedOption.getAttribute('data-price') || 0;
                const row = selectElement.closest('.product-row');
                const priceInput = row.querySelector('input[name="price[]"]');
                priceInput.value = price;
                this.calculateRowTotal(row.querySelector('input[name="quantity[]"]'));
            }

            calculateRowTotal(element) {
                const row = element.closest('.product-row');
                if (!row) {
                    console.error('Kh√¥ng t√¨m th·∫•y product-row');
                    return;
                }
                
                const quantityInput = row.querySelector('input[name="quantity[]"]');
                const priceInput = row.querySelector('input[name="price[]"]');
                const discountInput = row.querySelector('input[name="discount[]"]');
                const subtotalInput = row.querySelector('input[name="subtotal[]"]');
                
                if (!quantityInput || !priceInput || !discountInput || !subtotalInput) {
                    console.error('Kh√¥ng t√¨m th·∫•y m·ªôt s·ªë input field');
                    return;
                }
                
                const quantity = parseInt(quantityInput.value) || 0;
                const price = parseInt(priceInput.value) || 0;
                const discount = parseInt(discountInput.value) || 0;
                
                console.log('T√≠nh to√°n:', {quantity, price, discount}); // Debug
                
                // T√≠nh th√†nh ti·ªÅn sau gi·∫£m gi√°
                const beforeDiscount = quantity * price;
                const discountAmount = beforeDiscount * discount / 100;
                const subtotal = beforeDiscount - discountAmount;
                
                console.log('K·∫øt qu·∫£:', {beforeDiscount, discountAmount, subtotal}); // Debug
                
                // C·∫≠p nh·∫≠t th√†nh ti·ªÅn cho d√≤ng n√†y
                if (subtotal > 0) {
                    if (discount > 0) {
                        subtotalInput.value = `${subtotal.toLocaleString('vi-VN')} VNƒê (-${discount}%)`;
                    } else {
                        subtotalInput.value = `${subtotal.toLocaleString('vi-VN')} VNƒê`;
                    }
                } else {
                    subtotalInput.value = '';
                }
                
                // T√≠nh l·∫°i t·ªïng ti·ªÅn
                this.calculateOrderTotal();
            }

            calculateOrderTotal() {
                const productRows = document.querySelectorAll('.product-row');
                let total = 0;
                
                productRows.forEach(row => {
                    const quantity = parseInt(row.querySelector('input[name="quantity[]"]').value) || 0;
                    const price = parseInt(row.querySelector('input[name="price[]"]').value) || 0;
                    const discount = parseInt(row.querySelector('input[name="discount[]"]').value) || 0;
                    
                    // T√≠nh th√†nh ti·ªÅn sau gi·∫£m gi√° cho t·ª´ng d√≤ng
                    const beforeDiscount = quantity * price;
                    const discountAmount = beforeDiscount * discount / 100;
                    const subtotal = beforeDiscount - discountAmount;
                    
                    total += subtotal;
                });
                
                const totalElement = document.getElementById('order-total');
                if (totalElement) {
                    totalElement.textContent = total.toLocaleString('vi-VN') + ' VNƒê';
                } else {
                    console.error('Kh√¥ng t√¨m th·∫•y element order-total');
                }
            }

            // Custom Dropdown Functions
            toggleCustomerDropdown(element) {
                const dropdown = element.closest('.custom-dropdown');
                const dropdownList = dropdown.querySelector('.dropdown-list');
                const arrow = dropdown.querySelector('.dropdown-arrow');
                
                // Close other dropdowns
                this.closeAllDropdowns();
                
                // Toggle current dropdown
                if (dropdownList.style.display === 'none' || !dropdownList.style.display) {
                    dropdownList.style.display = 'block';
                    arrow.style.transform = 'rotate(180deg)';
                    
                    // Focus search input
                    const searchInput = dropdown.querySelector('.dropdown-search');
                    setTimeout(() => searchInput.focus(), 100);
                } else {
                    dropdownList.style.display = 'none';
                    arrow.style.transform = 'rotate(0deg)';
                }
            }
            
            toggleProductDropdown(element) {
                const dropdown = element.closest('.custom-dropdown');
                const dropdownList = dropdown.querySelector('.dropdown-list');
                const arrow = dropdown.querySelector('.dropdown-arrow');
                
                // Close other dropdowns
                this.closeAllDropdowns();
                
                // Toggle current dropdown
                if (dropdownList.style.display === 'none' || !dropdownList.style.display) {
                    dropdownList.style.display = 'block';
                    arrow.style.transform = 'rotate(180deg)';
                    
                    // Focus search input
                    const searchInput = dropdown.querySelector('.dropdown-search');
                    setTimeout(() => searchInput.focus(), 100);
                } else {
                    dropdownList.style.display = 'none';
                    arrow.style.transform = 'rotate(0deg)';
                }
            }
            
            closeAllDropdowns() {
                const allDropdowns = document.querySelectorAll('.dropdown-list');
                const allArrows = document.querySelectorAll('.dropdown-arrow');
                
                allDropdowns.forEach(dropdown => {
                    dropdown.style.display = 'none';
                });
                
                allArrows.forEach(arrow => {
                    arrow.style.transform = 'rotate(0deg)';
                });
            }
            
            selectCustomer(element, customerId, customerName) {
                const dropdown = element.closest('.custom-dropdown');
                const selectedText = dropdown.querySelector('.selected-text');
                const hiddenInput = dropdown.querySelector('input[type="hidden"]');
                
                selectedText.textContent = customerName;
                selectedText.style.color = '#374151';
                hiddenInput.value = customerId;
                
                this.closeAllDropdowns();
            }
            
            selectProduct(element, productId, productName, price) {
                const dropdown = element.closest('.custom-dropdown');
                const selectedText = dropdown.querySelector('.selected-text');
                const hiddenInput = dropdown.querySelector('input[type="hidden"]');
                
                selectedText.textContent = productName;
                selectedText.style.color = '#374151';
                hiddenInput.value = productId;
                
                // Update price in the row - check both possible field names
                const productRow = dropdown.closest('.product-item, .product-row');
                let priceInput = productRow.querySelector('input[name="prices[]"]');
                if (!priceInput) {
                    priceInput = productRow.querySelector('input[name="price[]"]');
                }
                
                if (priceInput) {
                    priceInput.value = price;
                    // Call the appropriate calculation function
                    if (typeof this.calculateTotal === 'function') {
                        this.calculateTotal();
                    }
                    if (typeof this.calculateRowTotal === 'function') {
                        this.calculateRowTotal(priceInput);
                    }
                    if (typeof this.calculateOrderTotal === 'function') {
                        this.calculateOrderTotal();
                    }
                }
                
                this.closeAllDropdowns();
                
                // ‚ú® T·ª∞ ƒê·ªòNG TH√äM D√íNG S·∫¢N PH·∫®M M·ªöI
                // Check if this is the form "T·∫°o ƒë∆°n h√†ng m·ªõi" (c√≥ product-list container)
                const productList = document.getElementById('product-list');
                if (productList) {
                    // Check if this is the last row without a selected product 
                    const allRows = productList.querySelectorAll('.product-row');
                    const currentRowIndex = Array.from(allRows).indexOf(productRow);
                    const isLastRow = currentRowIndex === allRows.length - 1;
                    
                    // If this is the last row and a product is selected, add a new empty row
                    if (isLastRow) {
                        console.log('üöÄ Auto-adding new product row after selection');
                        this.addProductRow();
                    }
                }
            }
            
            filterDropdownItems(searchInput, type) {
                const searchTerm = searchInput.value.toLowerCase();
                const dropdown = searchInput.closest('.custom-dropdown');
                const options = dropdown.querySelectorAll('.dropdown-option');
                
                options.forEach(option => {
                    const text = option.textContent.toLowerCase();
                    if (text.includes(searchTerm)) {
                        option.style.display = 'block';
                    } else {
                        option.style.display = 'none';
                    }
                });
            }

            createOrder(event) {
                event.preventDefault();
                const form = event.target;
                const formData = new FormData(form);
                
                const customer = this.demoData.customers.find(c => c.id === formData.get('customer'));
                if (!customer) {
                    this.showNotification('Vui l√≤ng ch·ªçn kh√°ch h√†ng', 'error');
                    return;
                }

                const products = [];
                const productIds = formData.getAll('product[]');
                const quantities = formData.getAll('quantity[]');
                const prices = formData.getAll('price[]');
                const discounts = formData.getAll('discount[]');
                
                // Ki·ªÉm tra t·ªìn kho tr∆∞·ªõc khi t·∫°o ƒë∆°n h√†ng
                const stockWarnings = [];
                const outOfStockItems = [];
                
                for (let i = 0; i < productIds.length; i++) {
                    // Ch·ªâ x·ª≠ l√Ω d√≤ng ƒë√£ ch·ªçn s·∫£n ph·∫©m v√† c√≥ ƒë·∫ßy ƒë·ªß th√¥ng tin
                    if (productIds[i] && productIds[i].trim() !== '' && quantities[i] && prices[i]) {
                        const product = this.demoData.products.find(p => p.id === productIds[i]);
                        if (product) {
                            const requestedQty = parseInt(quantities[i]) || 1;
                            
                            // Ki·ªÉm tra t·ªìn kho
                            if (product.stock < requestedQty) {
                                outOfStockItems.push(`${product.name}: c·∫ßn ${requestedQty}, ch·ªâ c√≤n ${product.stock}`);
                                continue; // B·ªè qua s·∫£n ph·∫©m n√†y
                            }
                            
                            products.push({
                                id: productIds[i],
                                name: product.name,
                                quantity: requestedQty,
                                price: parseInt(prices[i]) || 0,
                                discount: parseInt(discounts[i]) || 0
                            });
                        }
                    }
                }
                
                // Th√¥ng b√°o l·ªói n·∫øu c√≥ s·∫£n ph·∫©m h·∫øt h√†ng
                if (outOfStockItems.length > 0) {
                    this.showNotification(`Kh√¥ng ƒë·ªß h√†ng: ${outOfStockItems.join(', ')}`, 'error');
                    return;
                }

                if (products.length === 0) {
                    this.showNotification('Vui l√≤ng ch·ªçn √≠t nh·∫•t m·ªôt s·∫£n ph·∫©m', 'error');
                    return;
                }

                const total = products.reduce((sum, product) => {
                    const beforeDiscount = product.quantity * product.price;
                    const discountAmount = beforeDiscount * product.discount / 100;
                    return sum + (beforeDiscount - discountAmount);
                }, 0);
                // S·ª≠ d·ª•ng ng√†y gi·ªù Vi·ªát Nam (UTC+7) cho ƒë∆°n h√†ng m·ªõi  
                const vietnamTime = this.getVietnamTime();
                
                // Get payment status to determine order status
                const paymentStatus = formData.get('paymentStatus') || 'C√¥ng n·ª£';
                
                // T·∫°o ID ƒë∆°n h√†ng d·ª±a tr√™n timestamp ƒë·ªÉ ƒë·∫£m b·∫£o th·ª© t·ª± ƒë√∫ng
                const orderCount = this.demoData.orders.length;
                const newOrder = {
                    id: 'DH' + String(orderCount + 1).padStart(4, '0'),
                    customerId: customer.id,
                    customerName: customer.name,
                    date: vietnamTime.toISOString().split('T')[0],
                    time: vietnamTime.toTimeString().split(' ')[0].substring(0, 5),
                    products: products,
                    notes: formData.get('orderNotes') || '',
                    total: total,
                    status: paymentStatus === 'ƒê√£ thanh to√°n' ? 'Ho√†n th√†nh' : 'ƒêang x·ª≠ l√Ω',
                    paymentMethod: formData.get('paymentMethod'),
                    paymentStatus: paymentStatus
                };

                // TR·ª™ T·ªíN KHO T·ª∞ ƒê·ªòNG
                const lowStockAlerts = [];
                products.forEach(ordPhuocITroduct => {
                    const productIndex = this.demoData.products.findIndex(p => p.id === ordPhuocITroduct.id);
                    if (productIndex !== -1) {
                        // Tr·ª´ t·ªìn kho
                        this.demoData.products[productIndex].stock -= ordPhuocITroduct.quantity;
                        
                        // Ki·ªÉm tra c·∫£nh b√°o t·ªìn kho th·∫•p
                        const updatedProduct = this.demoData.products[productIndex];
                        if (updatedProduct.stock <= updatedProduct.minStock) {
                            lowStockAlerts.push({
                                name: updatedProduct.name,
                                current: updatedProduct.stock,
                                minimum: updatedProduct.minStock
                            });
                        }
                    }
                });

                // TH√äM ƒê∆†N H√ÄNG M·ªöI V√ÄO ƒê·∫¶U DANH S√ÅCH thay v√¨ cu·ªëi
                this.demoData.orders.unshift(newOrder);
                console.log('‚úÖ ƒê∆°n h√†ng m·ªõi ƒë∆∞·ª£c th√™m v√†o ƒê·∫¶U danh s√°ch:', newOrder.id);
                
                // Update customer debt if payment status is "C√¥ng n·ª£"
                if (paymentStatus === 'C√¥ng n·ª£') {
                    customer.debt += newOrder.total;
                    console.log(`C·∫≠p nh·∫≠t c√¥ng n·ª£ kh√°ch h√†ng ${customer.name}: +${newOrder.total.toLocaleString('vi-VN')} VNƒê (${paymentStatus})`);
                }
                
                this.saveToLocalStorage();
                
                // Ghi log ho·∫°t ƒë·ªông
                this.addActivityLog('success', 'üìã', `T·∫°o ƒë∆°n h√†ng ${newOrder.id}`, 
                    `Kh√°ch h√†ng: ${customer.name} - Gi√° tr·ªã: ${total.toLocaleString('vi-VN')} VNƒê - ${products.length} s·∫£n ph·∫©m - ${paymentStatus}`, 'order');
                
                // Ghi log ho·∫°t ƒë·ªông tr·ª´ t·ªìn kho
                products.forEach(ordPhuocITroduct => {
                    this.addActivityLog('info', 'üì¶', `Tr·ª´ t·ªìn kho`, 
                        `S·∫£n ph·∫©m: ${ordPhuocITroduct.name} - S·ªë l∆∞·ª£ng: ${ordPhuocITroduct.quantity}`, 'inventory');
                });
                
                // Hi·ªÉn th·ªã th√¥ng b√°o th√†nh c√¥ng
                let successMessage = `ƒê√£ t·∫°o ƒë∆°n h√†ng ${newOrder.id}`;
                
                // Hi·ªÉn th·ªã c·∫£nh b√°o t·ªìn kho th·∫•p n·∫øu c√≥
                if (lowStockAlerts.length > 0) {
                    const alertMessages = lowStockAlerts.map(alert => 
                        `${alert.name}: c√≤n ${alert.current}/${alert.minimum}`
                    ).join(', ');
                    
                    setTimeout(() => {
                        this.showNotification(`‚ö†Ô∏è C·∫£nh b√°o t·ªìn kho th·∫•p: ${alertMessages}`, 'warning');
                    }, 1000);
                }
                
                this.showNotification(successMessage, 'success');
                this.loadPage('orders');
                const modal = form.closest("div[style*=\"fixed\"]"); if(modal) modal.remove();
            }

            viewOrderDetails(index) {
                console.log('üîç FIXED viewOrderDetails v2.2 BOLD UPDATE - timestamp:', new Date().toISOString());
                const order = this.demoData.orders[index];
                if (!order) {
                    console.error('Order not found at index:', index);
                    return;
                }
                
                // T√¨m kh√°ch h√†ng tr·ª±c ti·∫øp t·ª´ m·∫£ng customers - KH√îNG d√πng getCustomerDetails
                let customer = null;
                
                // T√¨m trong demoData tr∆∞·ªõc - t√¨m theo ID ho·∫∑c t√™n
                for (let i = 0; i < this.demoData.customers.length; i++) {
                    if (this.demoData.customers[i].id === order.customerId || 
                        this.demoData.customers[i].name === order.customerId ||
                        this.demoData.customers[i].id === order.customerName ||
                        this.demoData.customers[i].name === order.customerName) {
                        customer = this.demoData.customers[i];
                        break;
                    }
                }
                
                // N·∫øu kh√¥ng t√¨m th·∫•y, t√¨m trong localStorage
                if (!customer) {
                    try {
                        const savedCustomers = JSON.parse(localStorage.getItem('customers') || '[]');
                        for (let i = 0; i < savedCustomers.length; i++) {
                            if (savedCustomers[i].id === order.customerId || 
                                savedCustomers[i].name === order.customerId ||
                                savedCustomers[i].id === order.customerName ||
                                savedCustomers[i].name === order.customerName) {
                                customer = savedCustomers[i];
                                break;
                            }
                        }
                    } catch (e) {
                        console.log('Error reading localStorage customers:', e);
                    }
                }
                
                const customerDisplay = customer ? customer.name : order.customerName;
                console.log('üîç Order:', order.id, 'customerId:', order.customerId, 'customerName:', order.customerName);
                console.log('üîç Found customer:', customer);
                
                // T·∫°o th√¥ng tin doanh nghi·ªáp n·∫øu c√≥
                let businessInfo = '';
                if (customer && customer.type === 'doanh-nghiep') {
                    let companyDetails = [];
                    if (customer.companyName) {
                        companyDetails.push(`<strong>C√¥ng ty:</strong> ${customer.companyName}`);
                    }
                    if (customer.department) {
                        companyDetails.push(`<strong>Ph√≤ng ban:</strong> ${customer.department}`);
                    }
                    if (customer.taxCode) {
                        companyDetails.push(`<strong>MST:</strong> ${customer.taxCode}`);
                    }
                    
                    if (companyDetails.length > 0) {
                        businessInfo = `<div style="margin-top: 8px; font-size: 14px; color: #374151; line-height: 1.4;">
                            ${companyDetails.join(' ‚Ä¢ ')}
                        </div>`;
                    }
                }
                
                const productsList = order.products.map(p => 
                    `<div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #e5e7eb;">
                        <span>${p.name} x ${p.quantity}</span>
                        <span>${(p.quantity * p.price).toLocaleString('vi-VN')} VNƒê</span>
                    </div>`
                ).join('');

                const detailHTML = `
                    <div style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1001; display: flex; justify-content: center; align-items: center;" onclick="closeModal(this)">
                        <div style="background: white; padding: 32px; border-radius: 12px; width: 500px; max-width: 90vw;" onclick="event.stopPropagation()">
                            <h3 style="margin-bottom: 24px; color: var(--text-primary);">Chi ti·∫øt ƒë∆°n h√†ng ${order.id}</h3>
                            
                            <div style="margin-bottom: 16px;">
                                <strong>Kh√°ch h√†ng:</strong> ${customerDisplay}${businessInfo}<br>
                                <strong>Th·ªùi gian:</strong> ${order.date} ${order.time}<br>
                                <strong>Tr·∫°ng th√°i:</strong> ${order.status}<br>
                                <strong>Thanh to√°n:</strong> ${order.paymentMethod}
                                ${order.notes ? `<br><strong>Ghi ch√∫:</strong> ${order.notes}` : ''}
                            </div>
                            
                            <div style="margin-bottom: 16px;">
                                <strong>S·∫£n ph·∫©m:</strong>
                                <div style="margin-top: 8px; border: 1px solid #e5e7eb; border-radius: 8px; padding: 12px;">
                                    ${productsList}
                                    <div style="display: flex; justify-content: space-between; padding: 12px 0; font-weight: 600; font-size: 16px; border-top: 2px solid #e5e7eb; margin-top: 8px;">
                                        <span>T·ªïng c·ªông:</span>
                                        <span>${order.total.toLocaleString('vi-VN')} VNƒê</span>
                                    </div>
                                </div>
                            </div>
                            
                            <div style="display: flex; gap: 12px; justify-content: center;">
                                <button onclick="closeModal(this.closest('div[style*=fixed]')); app.editOrder(${index});" 
                                        style="padding: 12px 24px; background: var(--primary-blue); color: white; border: none; border-radius: 8px; cursor: pointer;">‚úèÔ∏è S·ª≠a</button>
                                <button onclick="closeModal(this.closest('div[style*=fixed]'))" 
                                        style="padding: 12px 24px; border: 2px solid #e5e7eb; background: white; border-radius: 8px; cursor: pointer;">ƒê√≥ng</button>
                            </div>
                        </div>
                    </div>
                `;
                document.body.insertAdjacentHTML('beforeend', detailHTML);
            }

            editOrder(index) {
                const order = this.demoData.orders[index];
                const customerOptions = this.demoData.customers.map(c => 
                    `<option value="${c.id}" ${c.id === order.customerId ? 'selected' : ''}>${c.name}</option>`
                ).join('');
                
                const productRows = order.products.map((p, i) => `
                    <div style="display: flex; gap: 8px; margin-bottom: 8px; align-items: center;" data-product-row="${i}">
                        <select name="productId_${i}" style="flex: 2; padding: 8px; border: 1px solid #e5e7eb; border-radius: 4px;">
                            ${this.demoData.products.map(prod => 
                                `<option value="${prod.id}" ${prod.id === p.id ? 'selected' : ''}>${prod.name}</option>`
                            ).join('')}
                        </select>
                        <input type="number" name="price_${i}" value="${p.price}" min="0" style="flex: 1; padding: 8px; border: 1px solid #e5e7eb; border-radius: 4px;" placeholder="Gi√° b√°n">
                        <input type="number" name="quantity_${i}" value="${p.quantity}" min="1" style="flex: 1; padding: 8px; border: 1px solid #e5e7eb; border-radius: 4px;" placeholder="SL">
                        <input type="number" name="discount_${i}" value="${p.discount || 0}" min="0" max="100" style="flex: 1; padding: 8px; border: 1px solid #e5e7eb; border-radius: 4px;" placeholder="CK%">
                        <button type="button" onclick="this.parentElement.remove()" style="padding: 8px; background: #ef4444; color: white; border: none; border-radius: 4px; cursor: pointer;">üóëÔ∏è</button>
                    </div>
                `).join('');
                
                const formHTML = `
                    <div style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1001; display: flex; justify-content: center; align-items: center;" onclick="closeModal(this)">
                        <div style="background: white; padding: 32px; border-radius: 12px; width: 900px; max-width: 90vw; max-height: 90vh; overflow-y: auto;" onclick="event.stopPropagation()">
                            <h3 style="margin-bottom: 24px; color: var(--text-primary);">S·ª≠a ƒë∆°n h√†ng ${order.id}</h3>
                            <form onsubmit="app.updateOrderComplete(event, ${index})">
                                <div style="margin-bottom: 16px;">
                                    <label style="display: block; margin-bottom: 8px; font-weight: 600;">Kh√°ch h√†ng:</label>
                                    <select name="customerId" required style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px;">
                                        ${customerOptions}
                                    </select>
                                </div>
                                
                                <div style="margin-bottom: 16px;">
                                    <label style="display: block; margin-bottom: 8px; font-weight: 600;">S·∫£n ph·∫©m:</label>
                                    <div style="margin-bottom: 8px; font-size: 12px; color: #666; display: flex; gap: 8px;">
                                        <span style="flex: 2;">T√™n s·∫£n ph·∫©m</span>
                                        <span style="flex: 1;">Gi√° b√°n</span>
                                        <span style="flex: 1;">S·ªë l∆∞·ª£ng</span>
                                        <span style="flex: 1;">Chi·∫øt kh·∫•u (%)</span>
                                        <span style="width: 40px;">X√≥a</span>
                                    </div>
                                    <div id="products-container">
                                        ${productRows}
                                    </div>
                                    <button type="button" onclick="app.addProductRowEdit()" style="margin-top: 8px; padding: 8px 16px; background: var(--primary-green); color: white; border: none; border-radius: 4px; cursor: pointer;">+ Th√™m s·∫£n ph·∫©m</button>
                                </div>
                                
                                <div style="margin-bottom: 16px;">
                                    <label style="display: block; margin-bottom: 8px; font-weight: 600;">Tr·∫°ng th√°i thanh to√°n:</label>
                                    <select name="paymentStatus" required style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px;">
                                        <option value="C√¥ng n·ª£" ${order.paymentStatus === 'C√¥ng n·ª£' ? 'selected' : ''}>C√¥ng n·ª£</option>
                                        <option value="ƒê√£ thanh to√°n" ${order.paymentStatus === 'ƒê√£ thanh to√°n' ? 'selected' : ''}>ƒê√£ thanh to√°n</option>
                                    </select>
                                </div>
                                
                                <div style="margin-bottom: 16px;">
                                    <label style="display: block; margin-bottom: 8px; font-weight: 600;">Tr·∫°ng th√°i ƒë∆°n h√†ng:</label>
                                    <select name="status" required style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px;">
                                        <option value="ƒêang x·ª≠ l√Ω" ${order.status === 'ƒêang x·ª≠ l√Ω' ? 'selected' : ''}>ƒêang x·ª≠ l√Ω</option>
                                        <option value="Ho√†n th√†nh" ${order.status === 'Ho√†n th√†nh' ? 'selected' : ''}>Ho√†n th√†nh</option>
                                        <option value="ƒê√£ giao" ${order.status === 'ƒê√£ giao' ? 'selected' : ''}>ƒê√£ giao</option>
                                        <option value="H·ªßy" ${order.status === 'H·ªßy' ? 'selected' : ''}>H·ªßy</option>
                                    </select>
                                </div>
                                
                                <div style="margin-bottom: 16px;">
                                    <label style="display: block; margin-bottom: 8px; font-weight: 600;">Ph∆∞∆°ng th·ª©c thanh to√°n:</label>
                                    <select name="paymentMethod" required style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px;">
                                        <option value="Ti·ªÅn m·∫∑t" ${order.paymentMethod === 'Ti·ªÅn m·∫∑t' ? 'selected' : ''}>Ti·ªÅn m·∫∑t</option>
                                        <option value="Chuy·ªÉn kho·∫£n" ${order.paymentMethod === 'Chuy·ªÉn kho·∫£n' ? 'selected' : ''}>Chuy·ªÉn kho·∫£n</option>
                                        <option value="Th·∫ª t√≠n d·ª•ng" ${order.paymentMethod === 'Th·∫ª t√≠n d·ª•ng' ? 'selected' : ''}>Th·∫ª t√≠n d·ª•ng</option>
                                    </select>
                                </div>
                                
                                <div style="margin-bottom: 24px;">
                                    <label style="display: block; margin-bottom: 8px; font-weight: 600;">Ghi ch√∫:</label>
                                    <textarea name="notes" placeholder="Nh·∫≠p ghi ch√∫ cho ƒë∆°n h√†ng..." style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; resize: vertical; height: 100px; font-family: inherit;">${order.notes || ''}</textarea>
                                </div>
                                
                                <div style="display: flex; gap: 12px; justify-content: flex-end;">
                                    <button type="button" onclick="closeModal(this.closest('div[style*=fixed]'))" 
                                            style="padding: 12px 24px; border: 2px solid #e5e7eb; background: white; border-radius: 8px; cursor: pointer;">H·ªßy</button>
                                    <button type="submit" 
                                            style="padding: 12px 24px; background: var(--primary-blue); color: white; border: none; border-radius: 8px; cursor: pointer;">C·∫≠p nh·∫≠t ƒë∆°n h√†ng</button>
                                </div>
                            </form>
                        </div>
                    </div>
                `;
                document.body.insertAdjacentHTML('beforeend', formHTML);
            }

            addProductRowEdit() {
                const container = document.getElementById('products-container');
                const rowCount = container.children.length;
                const firstProduct = this.demoData.products[0];
                const newRow = `
                    <div style="display: flex; gap: 8px; margin-bottom: 8px; align-items: center;" data-product-row="${rowCount}">
                        <select name="productId_${rowCount}" style="flex: 2; padding: 8px; border: 1px solid #e5e7eb; border-radius: 4px;" onchange="app.updateProductPriceInEdit(this, ${rowCount})">
                            ${this.demoData.products.map(prod => 
                                `<option value="${prod.id}" data-price="${prod.price}">${prod.name}</option>`
                            ).join('')}
                        </select>
                        <input type="number" name="price_${rowCount}" value="${firstProduct ? firstProduct.price : 0}" min="0" style="flex: 1; padding: 8px; border: 1px solid #e5e7eb; border-radius: 4px;" placeholder="Gi√° b√°n">
                        <input type="number" name="quantity_${rowCount}" value="1" min="1" style="flex: 1; padding: 8px; border: 1px solid #e5e7eb; border-radius: 4px;" placeholder="SL">
                        <input type="number" name="discount_${rowCount}" value="0" min="0" max="100" style="flex: 1; padding: 8px; border: 1px solid #e5e7eb; border-radius: 4px;" placeholder="CK%">
                        <button type="button" onclick="this.parentElement.remove()" style="padding: 8px; background: #ef4444; color: white; border: none; border-radius: 4px; cursor: pointer;">üóëÔ∏è</button>
                    </div>
                `;
                container.insertAdjacentHTML('beforeend', newRow);
            }

            updateProductPriceInEdit(selectElement, rowIndex) {
                const selectedOption = selectElement.options[selectElement.selectedIndex];
                const price = selectedOption.getAttribute('data-price');
                const priceInput = document.querySelector(`input[name="price_${rowIndex}"]`);
                if (priceInput && price) {
                    priceInput.value = price;
                }
            }

            updateOrderComplete(event, index) {
                event.preventDefault();
                const form = event.target;
                const formData = new FormData(form);
                
                const order = this.demoData.orders[index];
                const oldCustomer = this.demoData.customers.find(c => c.id === order.customerId);
                const newCustomer = this.demoData.customers.find(c => c.id === formData.get('customerId'));
                
                if (!oldCustomer || !newCustomer) {
                    this.showNotification('Kh√¥ng t√¨m th·∫•y th√¥ng tin kh√°ch h√†ng', 'error');
                    return;
                }
                
                // Ho√†n tr·∫£ debt c·ªßa kh√°ch h√†ng c≈© n·∫øu ƒë∆°n h√†ng ƒëang ·ªü tr·∫°ng th√°i c√¥ng n·ª£ ho·∫∑c ch∆∞a thanh to√°n
                if (order.paymentStatus === 'C√¥ng n·ª£') {
                    oldCustomer.debt -= order.total;
                    if (oldCustomer.debt < 0) oldCustomer.debt = 0;
                    console.log(`Ho√†n tr·∫£ debt cho ${oldCustomer.name}: -${order.total.toLocaleString('vi-VN')} VNƒê (${order.paymentStatus})`);
                }
                
                // L·∫•y th√¥ng tin s·∫£n ph·∫©m m·ªõi
                const products = [];
                const productElements = form.querySelectorAll('[data-product-row]');
                
                productElements.forEach((row, i) => {
                    const productId = formData.get(`productId_${i}`);
                    const price = parseInt(formData.get(`price_${i}`)) || 0;
                    const quantity = parseInt(formData.get(`quantity_${i}`)) || 1;
                    const discount = parseInt(formData.get(`discount_${i}`)) || 0;
                    
                    if (productId) {
                        const product = this.demoData.products.find(p => p.id === productId);
                        if (product) {
                            products.push({
                                id: productId,
                                name: product.name,
                                quantity: quantity,
                                price: price, // S·ª≠ d·ª•ng gi√° ƒë√£ ch·ªânh s·ª≠a t·ª´ form
                                discount: discount
                            });
                        }
                    }
                });
                
                if (products.length === 0) {
                    this.showNotification('Vui l√≤ng ch·ªçn √≠t nh·∫•t m·ªôt s·∫£n ph·∫©m', 'error');
                    return;
                }
                
                // T√≠nh t·ªïng ti·ªÅn m·ªõi
                const newTotal = products.reduce((sum, product) => {
                    const beforeDiscount = product.quantity * product.price;
                    const discountAmount = beforeDiscount * product.discount / 100;
                    return sum + (beforeDiscount - discountAmount);
                }, 0);
                
                // C·∫≠p nh·∫≠t ƒë∆°n h√†ng
                const newPaymentStatus = formData.get('paymentStatus');
                const newStatus = formData.get('status');
                
                order.customerId = newCustomer.id;
                order.customerName = newCustomer.name;
                order.products = products;
                order.total = newTotal;
                order.paymentStatus = newPaymentStatus;
                order.status = newStatus;
                order.paymentMethod = formData.get('paymentMethod');
                order.notes = formData.get('notes') || '';
                
                // C·∫≠p nh·∫≠t debt c·ªßa kh√°ch h√†ng m·ªõi n·∫øu c·∫ßn
                if (newPaymentStatus === 'C√¥ng n·ª£') {
                    newCustomer.debt += newTotal;
                    console.log(`Th√™m debt cho ${newCustomer.name}: +${newTotal.toLocaleString('vi-VN')} VNƒê (${newPaymentStatus})`);
                }
                
                this.saveToLocalStorage();
                this.showNotification(`ƒê√£ c·∫≠p nh·∫≠t ƒë∆°n h√†ng ${order.id}`, 'success');
                this.loadPage('orders');
                const modal = form.closest("div[style*=\"fixed\"]"); if(modal) modal.remove();
            }

            updateOrder(event, index) {
                event.preventDefault();
                const form = event.target;
                const formData = new FormData(form);
                
                this.demoData.orders[index].status = formData.get('status');
                this.demoData.orders[index].paymentMethod = formData.get('paymentMethod');
                
                this.saveToLocalStorage();
                this.showNotification(`ƒê√£ c·∫≠p nh·∫≠t ƒë∆°n h√†ng ${this.demoData.orders[index].id}`, 'success');
                this.loadPage('orders');
                const modal = form.closest("div[style*=\"fixed\"]"); if(modal) modal.remove();
            }

            deleteOrder(index) {
                const order = this.demoData.orders[index];
                if (confirm(`B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a ƒë∆°n h√†ng ${order.id}?`)) {
                    this.demoData.orders.splice(index, 1);
                    this.saveToLocalStorage();
                    this.showNotification(`ƒê√£ x√≥a ƒë∆°n h√†ng ${order.id}`, 'success');
                    this.loadPage('orders');
                }
            }

            togglePaymentStatus(index) {
                const order = this.demoData.orders[index];
                const customer = this.demoData.customers.find(c => c.id === order.customerId);
                
                if (!customer) {
                    this.showNotification('Kh√¥ng t√¨m th·∫•y kh√°ch h√†ng', 'error');
                    return;
                }

                // X√°c ƒë·ªãnh tr·∫°ng th√°i s·∫Ω chuy·ªÉn sang
                let newStatus, newPaymentStatus, statusDescription;
                
                if (order.paymentStatus === 'ƒê√£ thanh to√°n') {
                    newPaymentStatus = 'C√¥ng n·ª£';
                    newStatus = order.status !== 'H·ªßy' ? 'ƒêang x·ª≠ l√Ω' : order.status;
                    statusDescription = `<span style="color: #22c55e; font-weight: 600;">ƒê√£ thanh to√°n</span> ‚Üí <span style="color: #ef4444; font-weight: 600;">C√¥ng n·ª£</span>`;
                } else if (order.paymentStatus === 'C√¥ng n·ª£') {
                    newPaymentStatus = 'ƒê√£ thanh to√°n';
                    newStatus = order.status !== 'H·ªßy' ? 'Ho√†n th√†nh' : order.status;
                    statusDescription = `<span style="color: #ef4444; font-weight: 600;">C√¥ng n·ª£</span> ‚Üí <span style="color: #22c55e; font-weight: 600;">ƒê√£ thanh to√°n</span>`;
                } else {
                    newPaymentStatus = 'ƒê√£ thanh to√°n';
                    newStatus = order.status !== 'H·ªßy' ? 'Ho√†n th√†nh' : order.status;
                    statusDescription = `<span style="color: #f59e0b; font-weight: 600;">C√¥ng n·ª£</span> ‚Üí <span style="color: #22c55e; font-weight: 600;">ƒê√£ thanh to√°n</span>`;
                }

                // Hi·ªÉn th·ªã popup x√°c nh·∫≠n
                const confirmHTML = `
                    <div style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1001; display: flex; justify-content: center; align-items: center;" onclick="closeModal(this)">
                        <div style="background: white; padding: 32px; border-radius: 12px; width: 500px; max-width: 90vw;" onclick="event.stopPropagation()">
                            <h3 style="margin-bottom: 24px; color: var(--text-primary); display: flex; align-items: center; gap: 8px;">
                                <span>üí≥</span> X√°c nh·∫≠n thay ƒë·ªïi tr·∫°ng th√°i thanh to√°n
                            </h3>
                            
                            <div style="background: #f8fafc; padding: 20px; border-radius: 8px; margin-bottom: 24px;">
                                <div style="margin-bottom: 12px;">
                                    <strong>M√£ ƒë∆°n h√†ng:</strong> ${order.id}
                                </div>
                                <div style="margin-bottom: 12px;">
                                    <strong>Kh√°ch h√†ng:</strong> ${customer.name}
                                </div>
                                <div style="margin-bottom: 12px;">
                                    <strong>T·ªïng ti·ªÅn:</strong> <span style="color: var(--primary-blue); font-weight: 600;">${order.total.toLocaleString('vi-VN')} VNƒê</span>
                                </div>
                                <div style="margin-bottom: 12px;">
                                    <strong>Thay ƒë·ªïi:</strong> ${statusDescription}
                                </div>
                            </div>

                            <div style="background: #fff7ed; border: 2px solid #fdba74; padding: 16px; border-radius: 8px; margin-bottom: 24px;">
                                <div style="display: flex; align-items: center; gap: 8px; color: #ea580c;">
                                    <span>‚ö†Ô∏è</span>
                                    <strong>L∆∞u √Ω:</strong>
                                </div>
                                <div style="margin-top: 8px; color: #9a3412;">
                                    Thao t√°c n√†y s·∫Ω c·∫≠p nh·∫≠t c√¥ng n·ª£ c·ªßa kh√°ch h√†ng v√† kh√¥ng th·ªÉ ho√†n t√°c.
                                </div>
                            </div>
                            
                            <div style="display: flex; gap: 12px; justify-content: flex-end;">
                                <button type="button" onclick="closeModal(this.closest('div[style*=fixed]'))" 
                                        style="padding: 12px 24px; border: 2px solid #e5e7eb; background: white; border-radius: 8px; cursor: pointer; font-weight: 600;">H·ªßy</button>
                                <button type="button" onclick="app.confirmTogglePaymentStatus(${index}, '${newPaymentStatus}', '${newStatus}'); closeModal(this.closest('div[style*=fixed]'))"
                                        style="padding: 12px 24px; background: var(--primary-blue); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">X√°c nh·∫≠n</button>
                            </div>
                        </div>
                    </div>
                `;
                
                document.body.insertAdjacentHTML('beforeend', confirmHTML);
            }

            confirmTogglePaymentStatus(index, newPaymentStatus, newStatus) {
                const order = this.demoData.orders[index];
                const customer = this.demoData.customers.find(c => c.id === order.customerId);
                
                const oldPaymentStatus = order.paymentStatus;
                
                // C·∫≠p nh·∫≠t tr·∫°ng th√°i
                order.paymentStatus = newPaymentStatus;
                order.status = newStatus;
                
                // C·∫≠p nh·∫≠t debt
                if (oldPaymentStatus === 'ƒê√£ thanh to√°n' && newPaymentStatus === 'C√¥ng n·ª£') {
                    // T·ª´ "ƒê√£ thanh to√°n" ‚Üí "C√¥ng n·ª£": c·ªông debt
                    customer.debt += order.total;
                    console.log(`Toggle: Th√™m debt cho ${customer.name}: +${order.total.toLocaleString('vi-VN')} VNƒê`);
                } else if (oldPaymentStatus === 'C√¥ng n·ª£' && newPaymentStatus === 'ƒê√£ thanh to√°n') {
                    // T·ª´ "C√¥ng n·ª£" ‚Üí "ƒê√£ thanh to√°n": tr·ª´ debt
                    customer.debt -= order.total;
                    if (customer.debt < 0) customer.debt = 0; // ƒê·∫£m b·∫£o debt kh√¥ng √¢m
                    console.log(`Toggle: Tr·ª´ debt cho ${customer.name}: -${order.total.toLocaleString('vi-VN')} VNƒê`);
                } else if (oldPaymentStatus === 'C√¥ng n·ª£' && newPaymentStatus === 'ƒê√£ thanh to√°n') {
                    // T·ª´ "C√¥ng n·ª£" ‚Üí "ƒê√£ thanh to√°n": tr·ª´ debt
                    customer.debt -= order.total;
                    if (customer.debt < 0) customer.debt = 0; // ƒê·∫£m b·∫£o debt kh√¥ng √¢m
                    console.log(`Toggle: Tr·ª´ debt cho ${customer.name}: -${order.total.toLocaleString('vi-VN')} VNƒê`);
                }
                
                this.saveToLocalStorage();
                this.refreshAllCustomerDisplays();
                
                // Ghi log ho·∫°t ƒë·ªông
                const statusChange = `${oldPaymentStatus} ‚Üí ${newPaymentStatus}`;
                this.addActivityLog('success', 'üí≥', `C·∫≠p nh·∫≠t thanh to√°n ${order.id}`, 
                    `Kh√°ch h√†ng: ${customer.name} - Thay ƒë·ªïi: ${statusChange} - Gi√° tr·ªã: ${order.total.toLocaleString('vi-VN')} VNƒê`, 'payment');
                
                this.showNotification(`‚úÖ ƒê√£ c·∫≠p nh·∫≠t: ${order.id} - ${newPaymentStatus}. N·ª£ ${customer.name}: ${customer.debt.toLocaleString('vi-VN')} VNƒê`, 'success');
                
                // C·∫≠p nh·∫≠t giao di·ªán ngay l·∫≠p t·ª©c thay v√¨ t·∫£i l·∫°i trang
                this.updateOrderRowDisplay(index);
            }

            updateOrderRowDisplay(orderIndex) {
                const order = this.demoData.orders[orderIndex];
                if (!order) return;
                
                // T√¨m d√≤ng ƒë∆°n h√†ng trong b·∫£ng hi·ªán t·∫°i
                const orderRows = document.querySelectorAll('tbody tr[data-order-index]');
                let targetRow = null;
                
                orderRows.forEach(row => {
                    if (parseInt(row.getAttribute('data-order-index')) === orderIndex) {
                        targetRow = row;
                    }
                });
                
                if (!targetRow) {
                    // N·∫øu kh√¥ng t√¨m th·∫•y row, t·∫£i l·∫°i trang
                    this.loadPage('orders');
                    return;
                }
                
                // C·∫≠p nh·∫≠t cell tr·∫°ng th√°i ƒë∆°n h√†ng
                const statusCell = targetRow.querySelector('.status-cell');
                if (statusCell) {
                    const statusColor = order.status === 'Ho√†n th√†nh' ? '#16a34a' : 
                                      order.status === 'H·ªßy' ? '#dc2626' : '#f59e0b';
                    statusCell.innerHTML = `<span style="background: ${statusColor}; color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: 600;">${order.status}</span>`;
                }
                
                // C·∫≠p nh·∫≠t cell tr·∫°ng th√°i thanh to√°n v·ªõi n√∫t ƒë√∫p click
                const paymentCell = targetRow.querySelector('.payment-cell');
                if (paymentCell) {
                    const buttonColor = order.paymentStatus === 'ƒê√£ thanh to√°n' ? '#22c55e' : '#f59e0b';
                    const buttonText = order.paymentStatus === 'ƒê√£ thanh to√°n' ? '‚úì ƒê√£ TT' : 'C√¥ng n·ª£';
                    
                    paymentCell.innerHTML = `
                        <button ondblclick="app.togglePaymentStatus(${orderIndex})" style="
                            background: ${buttonColor}; 
                            color: white; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: 600;
                            transition: all 0.3s ease;
                        ">
                            ${buttonText}
                        </button>
                    `;
                }
            }

            filterOrdersByPeriod(period) {
                const now = this.getVietnamTime();
                const today = now.toISOString().split('T')[0];
                
                // T√≠nh to√°n ng√†y b·∫Øt ƒë·∫ßu c·ªßa tu·∫ßn (th·ª© 2)
                const startOfWeek = new Date(now);
                const day = startOfWeek.getDay();
                const diff = startOfWeek.getDate() - day + (day === 0 ? -6 : 1); // ƒêi·ªÅu ch·ªânh ƒë·ªÉ th·ª© 2 l√† ng√†y ƒë·∫ßu tu·∫ßn
                startOfWeek.setDate(diff);
                const weekStart = startOfWeek.toISOString().split('T')[0];
                
                // L·ªçc ƒë∆°n h√†ng theo th·ªùi gian
                let filteredOrders = [];
                if (period === 'today') {
                    filteredOrders = this.demoData.orders.filter(order => order.date === today);
                } else if (period === 'week') {
                    filteredOrders = this.demoData.orders.filter(order => order.date >= weekStart);
                } else {
                    filteredOrders = this.demoData.orders;
                }
                
                // ·∫®n t·∫•t c·∫£ c√°c d√≤ng trong b·∫£ng
                const rows = document.querySelectorAll('#orders-table tbody tr');
                rows.forEach(row => row.style.display = 'none');
                
                // Hi·ªÉn th·ªã ch·ªâ nh·ªØng ƒë∆°n h√†ng ƒë∆∞·ª£c l·ªçc
                filteredOrders.forEach((order, index) => {
                    const originalIndex = this.demoData.orders.findIndex(o => o.id === order.id);
                    const row = document.querySelector(`#orders-table tbody tr:nth-child(${originalIndex + 1})`);
                    if (row) {
                        row.style.display = '';
                    }
                });
                
                // C·∫≠p nh·∫≠t ti√™u ƒë·ªÅ v√† th√¥ng b√°o
                const periodText = period === 'today' ? 'h√¥m nay' : period === 'week' ? 'tu·∫ßn n√†y' : 't·∫•t c·∫£';
                const headerElement = document.querySelector('#orders-table').previousElementSibling;
                if (headerElement && headerElement.tagName === 'H3') {
                    headerElement.innerHTML = `<span>üìã</span> ƒê∆°n h√†ng ${periodText} (${filteredOrders.length})`;
                }
                
                this.showNotification(`Hi·ªÉn th·ªã ${filteredOrders.length} ƒë∆°n h√†ng ${periodText}`, 'success');
            }

            searchOrders(searchTerm) {
                const rows = document.querySelectorAll('#orders-table tbody tr');
                rows.forEach(row => {
                    const text = row.textContent.toLowerCase();
                    const isVisible = text.includes(searchTerm.toLowerCase());
                    row.style.display = isVisible ? '' : 'none';
                });
            }

            exportOrdersReport(mode = null) {
                if (!mode) {
                    this.showExportOptions('Xu·∫•t b√°o c√°o ƒë∆°n h√†ng', 'orders', 'exportOrdersReport');
                    return;
                }

                if (mode === 'view') {
                    const columns = [
                        { header: 'M√£ ƒë∆°n', getValue: order => order.id },
                        { header: 'Kh√°ch h√†ng', getValue: order => order.customerName },
                        { header: 'Ng√†y', getValue: order => order.date },
                        { header: 'Gi·ªù', getValue: order => order.time },
                        { header: 'T·ªïng ti·ªÅn (VNƒê)', getValue: order => order.total.toLocaleString('vi-VN') },
                        { header: 'Tr·∫°ng th√°i', getValue: order => order.status },
                        { header: 'Thanh to√°n', getValue: order => order.paymentMethod }
                    ];
                    this.showDataViewer('B√°o c√°o ƒë∆°n h√†ng', this.demoData.orders, columns);
                } else if (mode === 'download') {
                    // T·∫°o d·ªØ li·ªáu chi ti·∫øt cho Excel
                    let csvContent = "data:text/csv;charset=utf-8,\uFEFF";
                    csvContent += "M√£ ƒë∆°n,Kh√°ch h√†ng,Ng√†y,Gi·ªù,S·∫£n ph·∫©m,S·ªë l∆∞·ª£ng,ƒê∆°n gi√°,Th√†nh ti·ªÅn,T·ªïng ƒë∆°n h√†ng,Tr·∫°ng th√°i,Thanh to√°n\n";
                    
                    this.demoData.orders.forEach(order => {
                        order.products.forEach((product, productIndex) => {
                            const row = `${productIndex === 0 ? order.id : ''},"${productIndex === 0 ? order.customerName : ''}","${productIndex === 0 ? order.date : ''}","${productIndex === 0 ? order.time : ''}","${product.name}",${product.quantity},${product.price},${product.quantity * product.price},"${productIndex === 0 ? order.total : ''}","${productIndex === 0 ? order.status : ''}","${productIndex === 0 ? order.paymentMethod : ''}"`;
                            csvContent += row + "\n";
                        });
                    });
                    
                    const encodedUri = encodeURI(csvContent);
                    const link = document.createElement("a");
                    link.setAttribute("href", encodedUri);
                    link.setAttribute("download", `don_hang_${this.getVietnamTime().toISOString().split('T')[0]}.csv`);
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    
                    this.showNotification('ƒê√£ t·∫£i xu·ªëng b√°o c√°o ƒë∆°n h√†ng chi ti·∫øt', 'success');
                }
            }
            
            // Additional Report Functions
            exportTopProductsReport(mode = null) {
                this.showTopProductsExportWithFilter();
            }
            
            exportFinancialReport(mode = null) {
                this.showFinancialExportWithFilter();
            }
            
            showTrendAnalysis() {
                // T√≠nh to√°n d·ªØ li·ªáu ph√¢n t√≠ch
                const totalRevenue = this.demoData.orders.reduce((sum, order) => sum + order.total, 0);
                const avgOrderValue = this.demoData.orders.length > 0 ? totalRevenue / this.demoData.orders.length : 0;
                const totalDebt = this.demoData.customers.reduce((sum, c) => sum + c.debt, 0);
                const paidOrders = this.demoData.orders.filter(order => order.paymentStatus === 'ƒê√£ thanh to√°n').length;
                const unpaidOrders = this.demoData.orders.filter(order => order.paymentStatus === 'C√¥ng n·ª£').length;
                const completedOrders = this.demoData.orders.filter(order => order.status === 'Ho√†n th√†nh').length;
                
                // T√≠nh doanh thu theo th√°ng (gi·∫£ l·∫≠p 6 th√°ng g·∫ßn ƒë√¢y)
                const monthlyRevenue = [
                    { month: 'T6/2025', revenue: 75000000 },
                    { month: 'T7/2025', revenue: 89000000 },
                    { month: 'T8/2025', revenue: 125000000 },
                    { month: 'T9/2025', revenue: 98000000 },
                    { month: 'T10/2025', revenue: 115000000 },
                    { month: 'T11/2025', revenue: totalRevenue }
                ];
                
                // Top s·∫£n ph·∫©m b√°n ch·∫°y
                const productSales = {};
                this.demoData.orders.forEach(order => {
                    order.products.forEach(product => {
                        if (!productSales[product.name]) {
                            productSales[product.name] = 0;
                        }
                        productSales[product.name] += product.quantity;
                    });
                });
                const topProducts = Object.entries(productSales)
                    .sort((a, b) => b[1] - a[1])
                    .slice(0, 5);
                
                // Ph√¢n t√≠ch t·ªìn kho
                const lowStockProducts = this.demoData.products.filter(p => p.stock < 10);
                const normalStockProducts = this.demoData.products.filter(p => p.stock >= 10 && p.stock < 50);
                const highStockProducts = this.demoData.products.filter(p => p.stock >= 50);
                
                const analysisHTML = `
                    <div style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.85); z-index: 1001; display: flex; justify-content: center; align-items: flex-start; padding: 20px; overflow-y: auto;" onclick="closeModal(this)">
                        <div style="background: white; padding: 32px; border-radius: 16px; width: 1200px; max-width: 95vw; max-height: 90vh; overflow-y: auto; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);" onclick="event.stopPropagation()">
                            <div style="text-align: center; margin-bottom: 32px; border-bottom: 2px solid #f3f4f6; padding-bottom: 20px;">
                                <h2 style="color: var(--text-primary); font-size: 28px; margin: 0;">üìä B√°o c√°o Ph√¢n t√≠ch Xu h∆∞·ªõng Kinh doanh</h2>
                                <p style="color: #6b7280; margin: 8px 0 0 0; font-size: 16px;">T·ªïng quan hi·ªáu su·∫•t v√† d·ª± b√°o ph√°t tri·ªÉn</p>
                            </div>
                            
                            <!-- KPI Cards -->
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 32px;">
                                <div style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; padding: 20px; border-radius: 12px; text-align: center;">
                                    <div style="font-size: 32px; font-weight: bold; margin-bottom: 8px;">${totalRevenue.toLocaleString('vi-VN')}</div>
                                    <div style="font-size: 14px; opacity: 0.9;">T·ªïng Doanh Thu (VNƒê)</div>
                                </div>
                                <div style="background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%); color: white; padding: 20px; border-radius: 12px; text-align: center;">
                                    <div style="font-size: 32px; font-weight: bold; margin-bottom: 8px;">${avgOrderValue.toLocaleString('vi-VN')}</div>
                                    <div style="font-size: 14px; opacity: 0.9;">Gi√° tr·ªã ƒêH TB (VNƒê)</div>
                                </div>
                                <div style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white; padding: 20px; border-radius: 12px; text-align: center;">
                                    <div style="font-size: 32px; font-weight: bold; margin-bottom: 8px;">${this.demoData.orders.length}</div>
                                    <div style="font-size: 14px; opacity: 0.9;">T·ªïng ƒê∆°n H√†ng</div>
                                </div>
                                <div style="background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%); color: white; padding: 20px; border-radius: 12px; text-align: center;">
                                    <div style="font-size: 32px; font-weight: bold; margin-bottom: 8px;">${this.demoData.customers.length}</div>
                                    <div style="font-size: 14px; opacity: 0.9;">Kh√°ch H√†ng</div>
                                </div>
                            </div>
                            
                            <!-- Charts Row 1: Revenue Trend & Payment Status -->
                            <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 24px; margin-bottom: 32px;">
                                <!-- Bi·ªÉu ƒë·ªì doanh thu 6 th√°ng -->
                                <div style="background: #f9fafb; padding: 24px; border-radius: 12px; border: 1px solid #e5e7eb;">
                                    <h3 style="color: var(--text-primary); margin-bottom: 20px; text-align: center;">üìà Xu h∆∞·ªõng Doanh thu 6 th√°ng</h3>
                                    <div style="height: 200px; position: relative; display: flex; align-items: end; justify-content: space-between; padding: 0 10px; border-bottom: 2px solid #d1d5db;">
                                        ${monthlyRevenue.map((item, index) => {
                                            const maxRevenue = Math.max(...monthlyRevenue.map(m => m.revenue));
                                            const height = (item.revenue / maxRevenue) * 160;
                                            const color = index === monthlyRevenue.length - 1 ? '#10b981' : '#6b7280';
                                            return `
                                                <div style="display: flex; flex-direction: column; align-items: center;">
                                                    <div style="background: ${color}; width: 40px; height: ${height}px; border-radius: 4px 4px 0 0; margin-bottom: 8px; position: relative; transition: all 0.3s;">
                                                        <div style="position: absolute; top: -25px; left: 50%; transform: translateX(-50%); font-size: 11px; color: #374151; font-weight: 600;">
                                                            ${(item.revenue / 1000000).toFixed(0)}M
                                                        </div>
                                                    </div>
                                                    <div style="font-size: 12px; color: #6b7280; font-weight: 500; text-align: center;">
                                                        ${item.month}
                                                    </div>
                                                </div>
                                            `;
                                        }).join('')}
                                    </div>
                                </div>
                                
                                <!-- Bi·ªÉu ƒë·ªì tr√≤n tr·∫°ng th√°i thanh to√°n -->
                                <div style="background: #f9fafb; padding: 24px; border-radius: 12px; border: 1px solid #e5e7eb;">
                                    <h3 style="color: var(--text-primary); margin-bottom: 20px; text-align: center;">üí≥ Tr·∫°ng th√°i Thanh to√°n</h3>
                                    <div style="position: relative; width: 120px; height: 120px; margin: 0 auto 20px;">
                                        <svg width="120" height="120" style="transform: rotate(-90deg);">
                                            <!-- Background circle -->
                                            <circle cx="60" cy="60" r="50" fill="none" stroke="#e5e7eb" stroke-width="12"></circle>
                                            <!-- Paid orders -->
                                            <circle cx="60" cy="60" r="50" fill="none" stroke="#10b981" stroke-width="12" 
                                                    stroke-dasharray="${(paidOrders / this.demoData.orders.length * 314).toFixed(1)} 314"
                                                    stroke-linecap="round"></circle>
                                            <!-- Unpaid orders -->
                                            <circle cx="60" cy="60" r="35" fill="none" stroke="#f59e0b" stroke-width="8" 
                                                    stroke-dasharray="${(unpaidOrders / this.demoData.orders.length * 220).toFixed(1)} 220"
                                                    stroke-linecap="round"></circle>
                                        </svg>
                                        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center;">
                                            <div style="font-size: 18px; font-weight: bold; color: #374151;">${this.demoData.orders.length}</div>
                                            <div style="font-size: 11px; color: #6b7280;">ƒê∆°n h√†ng</div>
                                        </div>
                                    </div>
                                    <div style="text-align: center;">
                                        <div style="margin-bottom: 8px;">
                                            <span style="display: inline-block; width: 12px; height: 12px; background: #10b981; border-radius: 50%; margin-right: 8px;"></span>
                                            <span style="font-size: 13px; color: #374151;">ƒê√£ TT: ${paidOrders}</span>
                                        </div>
                                        <div>
                                            <span style="display: inline-block; width: 12px; height: 12px; background: #f59e0b; border-radius: 50%; margin-right: 8px;"></span>
                                            <span style="font-size: 13px; color: #374151;">C√¥ng n·ª£: ${unpaidOrders}</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Charts Row 2: Top Products & Inventory -->
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px; margin-bottom: 32px;">
                                <!-- Top s·∫£n ph·∫©m b√°n ch·∫°y -->
                                <div style="background: #f9fafb; padding: 24px; border-radius: 12px; border: 1px solid #e5e7eb;">
                                    <h3 style="color: var(--text-primary); margin-bottom: 20px; text-align: center;">üèÜ Top 5 S·∫£n ph·∫©m b√°n ch·∫°y</h3>
                                    <div style="space-y: 12px;">
                                        ${topProducts.map((product, index) => {
                                            const maxQuantity = topProducts[0][1];
                                            const percentage = (product[1] / maxQuantity) * 100;
                                            const colors = ['#10b981', '#3b82f6', '#f59e0b', '#8b5cf6', '#ef4444'];
                                            return `
                                                <div style="margin-bottom: 12px;">
                                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px;">
                                                        <span style="font-size: 13px; color: #374151; font-weight: 500;">${product[0]}</span>
                                                        <span style="font-size: 13px; color: #6b7280; font-weight: 600;">${product[1]}</span>
                                                    </div>
                                                    <div style="background: #e5e7eb; height: 8px; border-radius: 4px; overflow: hidden;">
                                                        <div style="background: ${colors[index]}; height: 100%; width: ${percentage}%; border-radius: 4px; transition: width 0.5s ease;"></div>
                                                    </div>
                                                </div>
                                            `;
                                        }).join('')}
                                    </div>
                                </div>
                                
                                <!-- Ph√¢n t√≠ch t·ªìn kho -->
                                <div style="background: #f9fafb; padding: 24px; border-radius: 12px; border: 1px solid #e5e7eb;">
                                    <h3 style="color: var(--text-primary); margin-bottom: 20px; text-align: center;">üì¶ Ph√¢n t√≠ch T·ªìn kho</h3>
                                    <div style="display: flex; justify-content: center; margin-bottom: 20px;">
                                        <div style="position: relative; width: 100px; height: 100px;">
                                            <svg width="100" height="100" style="transform: rotate(-90deg);">
                                                <circle cx="50" cy="50" r="40" fill="none" stroke="#e5e7eb" stroke-width="10"></circle>
                                                <circle cx="50" cy="50" r="40" fill="none" stroke="#dc2626" stroke-width="10" 
                                                        stroke-dasharray="${(lowStockProducts.length / this.demoData.products.length * 251).toFixed(1)} 251"></circle>
                                                <circle cx="50" cy="50" r="30" fill="none" stroke="#f59e0b" stroke-width="8" 
                                                        stroke-dasharray="${(normalStockProducts.length / this.demoData.products.length * 188).toFixed(1)} 188"></circle>
                                                <circle cx="50" cy="50" r="20" fill="none" stroke="#10b981" stroke-width="6" 
                                                        stroke-dasharray="${(highStockProducts.length / this.demoData.products.length * 126).toFixed(1)} 126"></circle>
                                            </svg>
                                        </div>
                                    </div>
                                    <div style="text-align: center; font-size: 12px;">
                                        <div style="margin-bottom: 6px;">
                                            <span style="display: inline-block; width: 10px; height: 10px; background: #dc2626; border-radius: 50%; margin-right: 6px;"></span>
                                            S·∫Øp h·∫øt: ${lowStockProducts.length}
                                        </div>
                                        <div style="margin-bottom: 6px;">
                                            <span style="display: inline-block; width: 10px; height: 10px; background: #f59e0b; border-radius: 50%; margin-right: 6px;"></span>
                                            B√¨nh th∆∞·ªùng: ${normalStockProducts.length}
                                        </div>
                                        <div>
                                            <span style="display: inline-block; width: 10px; height: 10px; background: #10b981; border-radius: 50%; margin-right: 6px;"></span>
                                            D·ªìi d√†o: ${highStockProducts.length}
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Analysis Summary -->
                            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; margin-bottom: 32px;">
                                <div style="background: #f0fdf4; padding: 20px; border-radius: 12px; border: 1px solid #bbf7d0;">
                                    <h4 style="color: #059669; margin-bottom: 12px; display: flex; align-items: center;">
                                        ‚úÖ ƒêi·ªÉm m·∫°nh
                                    </h4>
                                    <ul style="list-style: none; padding: 0; margin: 0;">
                                        <li style="padding: 6px 0; font-size: 13px; color: #065f46;">‚Ä¢ ${this.demoData.customers.length} kh√°ch h√†ng ·ªïn ƒë·ªãnh</li>
                                        <li style="padding: 6px 0; font-size: 13px; color: #065f46;">‚Ä¢ ƒê∆°n h√†ng TB: ${avgOrderValue.toLocaleString('vi-VN')} VNƒê</li>
                                        <li style="padding: 6px 0; font-size: 13px; color: #065f46;">‚Ä¢ ${this.demoData.products.length} s·∫£n ph·∫©m ƒëa d·∫°ng</li>
                                        <li style="padding: 6px 0; font-size: 13px; color: #065f46;">‚Ä¢ T·ª∑ l·ªá ho√†n th√†nh: ${((completedOrders/this.demoData.orders.length)*100).toFixed(1)}%</li>
                                    </ul>
                                </div>
                                
                                <div style="background: #fef2f2; padding: 20px; border-radius: 12px; border: 1px solid #fecaca;">
                                    <h4 style="color: #dc2626; margin-bottom: 12px; display: flex; align-items: center;">
                                        ‚ö†Ô∏è C·∫ßn c·∫£i thi·ªán
                                    </h4>
                                    <ul style="list-style: none; padding: 0; margin: 0;">
                                        <li style="padding: 6px 0; font-size: 13px; color: #991b1b;">‚Ä¢ ${lowStockProducts.length} SP s·∫Øp h·∫øt h√†ng</li>
                                        <li style="padding: 6px 0; font-size: 13px; color: #991b1b;">‚Ä¢ C√¥ng n·ª£: ${totalDebt.toLocaleString('vi-VN')} VNƒê</li>
                                        <li style="padding: 6px 0; font-size: 13px; color: #991b1b;">‚Ä¢ ${unpaidOrders} ƒë∆°n ch∆∞a thanh to√°n</li>
                                        <li style="padding: 6px 0; font-size: 13px; color: #991b1b;">‚Ä¢ C·∫ßn thu h·ªìi c√¥ng n·ª£</li>
                                    </ul>
                                </div>
                                
                                <div style="background: #f0f9ff; padding: 20px; border-radius: 12px; border: 1px solid #bfdbfe;">
                                    <h4 style="color: #0369a1; margin-bottom: 12px; display: flex; align-items: center;">
                                        üéØ Khuy·∫øn ngh·ªã
                                    </h4>
                                    <ul style="list-style: none; padding: 0; margin: 0;">
                                        <li style="padding: 6px 0; font-size: 13px; color: #0c4a6e;">‚Ä¢ Nh·∫≠p th√™m h√†ng b√°n ch·∫°y</li>
                                        <li style="padding: 6px 0; font-size: 13px; color: #0c4a6e;">‚Ä¢ Khuy·∫øn m√£i s·∫£n ph·∫©m ·∫ø</li>
                                        <li style="padding: 6px 0; font-size: 13px; color: #0c4a6e;">‚Ä¢ TƒÉng gi√° tr·ªã ƒë∆°n h√†ng</li>
                                        <li style="padding: 6px 0; font-size: 13px; color: #0c4a6e;">‚Ä¢ Marketing kh√°ch h√†ng m·ªõi</li>
                                    </ul>
                                </div>
                            </div>
                            
                            <div style="text-align: center; border-top: 2px solid #f3f4f6; padding-top: 20px;">
                                <button onclick="closeModal(this.closest('div[style*=fixed]'))" 
                                        style="padding: 14px 40px; background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%); color: white; border: none; border-radius: 10px; cursor: pointer; font-size: 16px; font-weight: 600; box-shadow: 0 4px 14px rgba(59, 130, 246, 0.3); transition: all 0.3s;"
                                        onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(59, 130, 246, 0.4)'"
                                        onmouseout="this.style.transform=''; this.style.boxShadow='0 4px 14px rgba(59, 130, 246, 0.3)'">
                                    ƒê√≥ng b√°o c√°o
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                document.body.insertAdjacentHTML('beforeend', analysisHTML);
            }

            // Customer Search and Quick Add Functions
            filterCustomers(searchTerm) {
                const customerSelect = document.getElementById('customer-select');
                if (!customerSelect) return;

                const options = customerSelect.querySelectorAll('option');
                let hasVisibleOptions = false;

                options.forEach((option, index) => {
                    if (index === 0) { // Keep the placeholder option
                        option.style.display = '';
                        return;
                    }

                    const text = option.textContent.toLowerCase();
                    const matches = text.includes(searchTerm.toLowerCase());
                    option.style.display = matches ? '' : 'none';
                    
                    if (matches) hasVisibleOptions = true;
                });

                // If no matches, show a "not found" option temporarily
                if (!hasVisibleOptions && searchTerm) {
                    const notFoundOption = customerSelect.querySelector('.not-found-option');
                    if (notFoundOption) {
                        notFoundOption.remove();
                    }
                    
                    const newOption = document.createElement('option');
                    newOption.value = '';
                    newOption.textContent = '‚ùå Kh√¥ng t√¨m th·∫•y kh√°ch h√†ng';
                    newOption.className = 'not-found-option';
                    newOption.disabled = true;
                    customerSelect.appendChild(newOption);
                } else {
                    // Remove not found option if exists
                    const notFoundOption = customerSelect.querySelector('.not-found-option');
                    if (notFoundOption) {
                        notFoundOption.remove();
                    }
                }
            }

            showQuickAddCustomer() {
                const quickAddHTML = `
                    <div style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.6); z-index: 1002; display: flex; justify-content: center; align-items: center;" onclick="closeModal(this)">
                        <div style="background: white; padding: 32px; border-radius: 12px; width: 600px; max-width: 90vw;" onclick="event.stopPropagation()">
                            <h3 style="margin-bottom: 24px; color: var(--text-primary);">‚ûï Th√™m kh√°ch h√†ng m·ªõi</h3>
                            <form onsubmit="app.quickAddCustomer(event)">
                                <!-- H√†ng 1: T√™n KH v√† Lo·∫°i KH -->
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px;">
                                    <div>
                                        <label style="display: block; margin-bottom: 8px; font-weight: 600;">T√™n kh√°ch h√†ng: *</label>
                                        <input type="text" name="customerName" required 
                                               style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px;">
                                    </div>
                                    <div>
                                        <label style="display: block; margin-bottom: 8px; font-weight: 600;">Lo·∫°i kh√°ch h√†ng: *</label>
                                        <select name="customerType" required onchange="app.toggleCustomerFields(this.value)"
                                               style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px;">
                                            <option value="">Ch·ªçn lo·∫°i</option>
                                            <option value="ca-nhan">C√° nh√¢n</option>
                                            <option value="doanh-nghiep">Doanh nghi·ªáp</option>
                                        </select>
                                    </div>
                                </div>

                                <!-- H√†ng 2: T√™n c√¥ng ty v√† Ph√≤ng ban (·∫©n/hi·ªán) -->
                                <div id="company-field" style="margin-bottom: 16px; display: none;">
                                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                                        <div>
                                            <label style="display: block; margin-bottom: 8px; font-weight: 600;">T√™n c√¥ng ty: *</label>
                                            <input type="text" name="companyName" 
                                                   style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px;">
                                        </div>
                                        <div>
                                            <label style="display: block; margin-bottom: 8px; font-weight: 600;">Ph√≤ng ban:</label>
                                            <input type="text" name="department" placeholder="VD: Ph√≤ng k·∫ø to√°n, Ph√≤ng kinh doanh..."
                                                   style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px;">
                                        </div>
                                    </div>
                                </div>

                                <!-- H√†ng 3: ƒêi·ªán tho·∫°i v√† M√£ s·ªë thu·∫ø -->
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px;">
                                    <div>
                                        <label style="display: block; margin-bottom: 8px; font-weight: 600;">S·ªë ƒëi·ªán tho·∫°i: *</label>
                                        <input type="tel" name="customPhuocIThone" required 
                                               style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px;">
                                    </div>
                                    <div id="tax-field" style="display: none;">
                                        <label style="display: block; margin-bottom: 8px; font-weight: 600;">M√£ s·ªë thu·∫ø:</label>
                                        <input type="text" name="taxCode"
                                               style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px;">
                                    </div>
                                </div>
                                
                                <!-- H√†ng 4: Email -->
                                <div style="margin-bottom: 16px;">
                                    <label style="display: block; margin-bottom: 8px; font-weight: 600;">Email:</label>
                                    <input type="email" name="customerEmail"
                                           style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px;">
                                </div>
                                
                                <!-- H√†ng 5: ƒê·ªãa ch·ªâ -->
                                <div style="margin-bottom: 16px;">
                                    <label style="display: block; margin-bottom: 8px; font-weight: 600;">ƒê·ªãa ch·ªâ:</label>
                                    <textarea name="customerAddress" rows="2"
                                              style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; resize: vertical;"></textarea>
                                </div>

                                <!-- H√†ng 6: Ghi ch√∫ -->
                                <div style="margin-bottom: 24px;">
                                    <label style="display: block; margin-bottom: 8px; font-weight: 600;">Ghi ch√∫ kh√°ch h√†ng:</label>
                                    <textarea name="customerNotes" rows="3" placeholder="Nh·∫≠p ghi ch√∫ v·ªÅ kh√°ch h√†ng (kh√¥ng b·∫Øt bu·ªôc)"
                                              style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; resize: vertical;"></textarea>
                                </div>
                                
                                <div style="display: flex; gap: 12px; justify-content: flex-end;">
                                    <button type="button" onclick="closeModal(this.closest('div[style*=fixed]'))" 
                                            style="padding: 12px 24px; border: 2px solid #e5e7eb; background: white; border-radius: 8px; cursor: pointer;">H·ªßy</button>
                                    <button type="submit" 
                                            style="padding: 12px 24px; background: var(--primary-green); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">Th√™m kh√°ch h√†ng</button>
                                </div>
                            </form>
                        </div>
                    </div>
                `;
                document.body.insertAdjacentHTML('beforeend', quickAddHTML);
            }

            toggleCustomerFields(customerType) {
                const companyField = document.getElementById('company-field');
                const taxField = document.getElementById('tax-field');
                const companyInput = document.querySelector('input[name="companyName"]');
                const departmentInput = document.querySelector('input[name="department"]');
                
                if (customerType === 'doanh-nghiep') {
                    companyField.style.display = 'block';
                    taxField.style.display = 'block';
                    companyInput.required = true;
                } else {
                    companyField.style.display = 'none';
                    taxField.style.display = 'none';
                    companyInput.required = false;
                    companyInput.value = '';
                    if (departmentInput) departmentInput.value = '';
                    document.querySelector('input[name="taxCode"]').value = '';
                }
            }

            quickAddCustomer(event) {
                event.preventDefault();
                const formData = new FormData(event.target);
                
                const newCustomer = {
                    id: 'KH' + String(Date.now()).slice(-6),
                    name: formData.get('customerName'),
                    type: formData.get('customerType'),
                    companyName: formData.get('companyName') || '',
                    department: formData.get('department') || '',
                    phone: formData.get('customPhuocIThone'),
                    email: formData.get('customerEmail') || '',
                    address: formData.get('customerAddress') || '',
                    taxCode: formData.get('taxCode') || '',
                    notes: formData.get('customerNotes') || '',
                    debt: 0,
                    totalOrders: 0
                };

                // Add to demo data
                this.demoData.customers.push(newCustomer);

                // Update customer select in the current form
                const customerSelect = document.getElementById('customer-select');
                if (customerSelect) {
                    const newOption = document.createElement('option');
                    newOption.value = newCustomer.id;
                    newOption.textContent = `${newCustomer.name} - ${newCustomer.phone}`;
                    customerSelect.appendChild(newOption);
                    
                    // Select the newly added customer
                    customerSelect.value = newCustomer.id;
                }

                // Close the modal
                const modal = event.target.closest("div[style*=\"fixed\"]");
                if (modal) modal.remove();
                
                // Clear search box
                const searchInput = document.getElementById('customer-search');
                if (searchInput) {
                    searchInput.value = '';
                    this.filterCustomers(''); // Reset filter
                }

                this.showNotification(`ƒê√£ th√™m kh√°ch h√†ng "${newCustomer.name}" v√† ch·ªçn t·ª± ƒë·ªông`, 'success');
            }

            // Show print options popup when clicking "IN" button
            showPrintOptionsPopup(index) {
                console.log('=== SHOWING PRINT OPTIONS ===');
                console.log('Index:', index);
                
                try {
                    const order = this.demoData.orders[index];
                    
                    if (!order) {
                        this.showNotification('‚ùå Kh√¥ng t√¨m th·∫•y ƒë∆°n h√†ng!', 'error');
                        return;
                    }

                    const printOptionsHTML = `
                        <div style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); z-index: 1001; display: flex; justify-content: center; align-items: center;" onclick="closeModal(this)">
                            <div style="background: white; padding: 32px; border-radius: 12px; width: 480px; max-width: 90vw;" onclick="event.stopPropagation()">
                                <h3 style="margin-bottom: 20px; color: #22c55e; text-align: center; display: flex; align-items: center; justify-content: center; gap: 8px;">
                                    üñ®Ô∏è Ch·ªçn lo·∫°i h√≥a ƒë∆°n in
                                </h3>
                                <p style="margin-bottom: 25px; color: #666; text-align: center; font-size: 15px;">
                                    ƒê∆°n h√†ng <strong>${order.id}</strong> - ${order.total.toLocaleString('vi-VN')} ƒë
                                </p>
                                
                                <div style="display: flex; flex-direction: column; gap: 15px;">
                                    <button onclick="app.testPrintInvoice(${index}); closeModal(this.closest('[style*=fixed]'))" 
                                            style="background: #22c55e; color: white; border: none; padding: 16px 24px; border-radius: 10px; cursor: pointer; font-weight: 600; font-size: 16px; display: flex; align-items: center; justify-content: center; gap: 10px; transition: all 0.2s ease;">
                                        üìÑ IN ƒë√∫ng gi√°
                                        <span style="font-size: 13px; opacity: 0.9;">(Gi√° g·ªëc kh√¥ng VAT)</span>
                                    </button>
                                    
                                    <button onclick="app.printInvoiceWithVAT(${index}); closeModal(this.closest('[style*=fixed]'))" 
                                            style="background: #8B5CF6; color: white; border: none; padding: 16px 24px; border-radius: 10px; cursor: pointer; font-weight: 600; font-size: 16px; display: flex; align-items: center; justify-content: center; gap: 10px; transition: all 0.2s ease;">
                                        üìä In c√≥ VAT
                                        <span style="font-size: 13px; opacity: 0.9;">(C√≥ t√≠nh thu·∫ø GTGT)</span>
                                    </button>
                                </div>
                                
                                <div style="text-align: center; margin-top: 20px;">
                                    <button onclick="closeModal(this.closest('[style*=fixed]'))" 
                                            style="background: #ef4444; color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: 600;">
                                        ‚ùå H·ªßy
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                    
                    document.body.insertAdjacentHTML('beforeend', printOptionsHTML);
                    
                } catch (error) {
                    console.error('L·ªói hi·ªÉn th·ªã popup:', error);
                    this.showNotification('‚ùå L·ªói hi·ªÉn th·ªã popup: ' + error.message, 'error');
                }
            }

            // Helper function to format customer info for display
            formatCustomerInfo(customer, includePaymentStatus = false, order = null) {
                let customerInfo = `
                    <div class="info-row">
                        <span class="info-label">T√™n kh√°ch h√†ng:</span>
                        <span class="info-value">${customer.name}</span>
                    </div>`;
                
                if (customer.type === 'doanh-nghiep' && customer.companyName) {
                    customerInfo += `
                    <div class="info-row">
                        <span class="info-label">C√¥ng ty:</span>
                        <span class="info-value">${customer.companyName}</span>
                    </div>`;
                }
                
                if (customer.type === 'doanh-nghiep' && customer.department) {
                    customerInfo += `
                    <div class="info-row">
                        <span class="info-label">Ph√≤ng ban:</span>
                        <span class="info-value">${customer.department}</span>
                    </div>`;
                }
                
                customerInfo += `
                    <div class="info-row">
                        <span class="info-label">S·ªë ƒëi·ªán tho·∫°i:</span>
                        <span class="info-value">${customer.phone}</span>
                    </div>`;
                
                if (customer.type === 'doanh-nghiep' && customer.taxCode) {
                    customerInfo += `
                    <div class="info-row">
                        <span class="info-label">M√£ s·ªë thu·∫ø:</span>
                        <span class="info-value">${customer.taxCode}</span>
                    </div>`;
                }
                
                customerInfo += `
                    <div class="info-row">
                        <span class="info-label">ƒê·ªãa ch·ªâ:</span>
                        <span class="info-value">${customer.address || 'Kh√¥ng c√≥'}</span>
                    </div>`;
                
                if (includePaymentStatus && order) {
                    customerInfo += `
                    <div class="info-row">
                        <span class="info-label">Tr·∫°ng th√°i TT:</span>
                        <span class="info-value" style="color: ${order.paymentStatus === 'ƒê√£ thanh to√°n' ? '#22c55e' : '#f59e0b'}; font-weight: 600;">
                            ${order.paymentStatus}
                        </span>
                    </div>`;
                }
                
                return customerInfo;
            }

            // Professional Vietnamese Invoice Print Function
            testPrintInvoice(index) {
                console.log('=== PRINTING PROFESSIONAL INVOICE ===');
                console.log('Index:', index);
                
                try {
                    const order = this.demoData.orders[index];
                    console.log('Order data:', order);
                    
                    if (!order) {
                        this.showNotification('‚ùå Kh√¥ng t√¨m th·∫•y ƒë∆°n h√†ng!', 'error');
                        return;
                    }

                    // Check if products exist
                    if (!order.products || !Array.isArray(order.products)) {
                        console.error('Order products not found or not an array:', order.products);
                        this.showNotification('‚ùå ƒê∆°n h√†ng kh√¥ng c√≥ s·∫£n ph·∫©m!', 'error');
                        return;
                    }

                    // Find customer info
                    const customer = this.demoData.customers.find(c => c.id === order.customerId) || { 
                        name: order.customerName, 
                        phone: order.customPhuocIThone || 'Kh√¥ng c√≥', 
                        address: order.customerAddress || 'Kh√¥ng c√≥' 
                    };
                    
                    // HOSTING SOLUTION: Get company settings + global assets
                    const companySettings = this.getCompanySettings();
                    
                    // Override with global assets if available (for hosting)
                    if (window.companyAssets && window.companyAssets.logo) {
                        companySettings.logo = window.companyAssets.logo;
                    }
                    if (window.companyAssets && window.companyAssets.qr) {
                        companySettings.qrCode = window.companyAssets.qr;
                    }
                    
                    console.log('‚úÖ HOSTING READY - Logo/QR from global assets');
                    console.log('Logo data:', companySettings.logo ? 'Found' : 'Not found');
                    console.log('QR data:', companySettings.qrCode ? 'Found' : 'Not found');
                    
                    // Professional invoice window
                    const invoiceWindow = window.open('', '_blank', 'width=800,height=900');
                    
                    if (!invoiceWindow) {
                        this.showNotification('‚ùå Popup b·ªã ch·∫∑n! H√£y cho ph√©p popup.', 'error');
                        return;
                    }
                    
                    invoiceWindow.document.write(`
                        <!DOCTYPE html>
                        <html lang="vi">
                        <head>
                            <meta charset="UTF-8">
                            <meta name="viewport" content="width=device-width, initial-scale=1.0">
                            <title>H√≥a ƒë∆°n ${order.id}</title>
                            <style>
                                * { margin: 0; padding: 0; box-sizing: border-box; }
                                body { 
                                    font-family: 'Times New Roman', serif; 
                                    font-size: 14px; 
                                    line-height: 1.6; 
                                    color: #333; 
                                    padding: 20px;
                                    background: white;
                                }
                                .invoice-container { max-width: 800px; margin: 0 auto; background: white; }
                                
                                .invoice-header { 
                                    display: flex;
                                    align-items: center;
                                    justify-content: space-between;
                                    border-bottom: 3px solid #2563eb; 
                                    padding-bottom: 20px; 
                                    margin-bottom: 30px; 
                                    gap: 20px;
                                }
                                .header-logo, .header-qr {
                                    flex: 0 0 120px;
                                    text-align: center;
                                }
                                .header-company {
                                    flex: 1;
                                    text-align: center;
                                }
                                .header-logo img, .header-qr img {
                                    max-width: 120px;
                                    max-height: 120px;
                                    object-fit: contain;
                                }
                                .company-name { 
                                    font-size: 28px; 
                                    font-weight: bold; 
                                    color: #2563eb; 
                                    margin-bottom: 5px; 
                                }
                                .company-info { 
                                    font-size: 13px; 
                                    color: #666; 
                                    margin-bottom: 15px; 
                                }
                                .invoice-title { 
                                    font-size: 24px; 
                                    font-weight: bold; 
                                    margin-top: 15px;
                                    color: #1a1a1a;
                                }
                                
                                .invoice-details { 
                                    display: flex; 
                                    justify-content: space-between; 
                                    margin-bottom: 30px; 
                                    gap: 40px;
                                }
                                .invoice-info, .customer-info { 
                                    flex: 1;
                                }
                                .section-title { 
                                    font-weight: bold; 
                                    font-size: 16px;
                                    border-bottom: 2px solid #e5e7eb; 
                                    padding-bottom: 8px; 
                                    margin-bottom: 15px;
                                    color: #2563eb;
                                }
                                .info-row { 
                                    margin-bottom: 8px; 
                                    display: flex;
                                }
                                .info-label { 
                                    font-weight: 600; 
                                    min-width: 120px;
                                    color: #555;
                                }
                                .info-value { 
                                    color: #333;
                                }
                                
                                .products-table { 
                                    width: 100%; 
                                    border-collapse: collapse; 
                                    margin-bottom: 30px;
                                    border: 2px solid #2563eb;
                                }
                                .products-table th { 
                                    background: #2563eb; 
                                    color: white; 
                                    padding: 12px 8px; 
                                    text-align: center; 
                                    font-weight: bold;
                                    font-size: 14px;
                                }
                                .products-table td { 
                                    padding: 10px 8px; 
                                    border-bottom: 1px solid #e5e7eb; 
                                    text-align: center;
                                }
                                .products-table tr:nth-child(even) { 
                                    background: #f8fafc; 
                                }
                                .product-name { text-align: left !important; font-weight: 500; }
                                
                                .totals-section { 
                                    float: right; 
                                    width: 350px; 
                                    margin-bottom: 30px;
                                }
                                .total-row { 
                                    display: flex; 
                                    justify-content: space-between; 
                                    padding: 8px 0; 
                                    border-bottom: 1px solid #e5e7eb;
                                }
                                .total-row.final { 
                                    font-weight: bold; 
                                    font-size: 18px; 
                                    color: #2563eb;
                                    border-bottom: 3px solid #2563eb;
                                    border-top: 2px solid #2563eb;
                                    margin-top: 10px;
                                    padding: 12px 0;
                                }
                                
                                .footer-info { 
                                    clear: both; 
                                    margin-top: 40px; 
                                    padding-top: 20px; 
                                    border-top: 2px solid #e5e7eb;
                                    text-align: center;
                                    font-size: 13px;
                                    color: #666;
                                }
                                .signature-section {
                                    display: flex;
                                    justify-content: space-between;
                                    margin-top: 40px;
                                    text-align: center;
                                }
                                .signature-box {
                                    width: 200px;
                                }
                                .signature-title {
                                    font-weight: bold;
                                    margin-bottom: 50px;
                                    color: #2563eb;
                                }
                                
                                @media print {
                                    body { margin: 0; padding: 15px; }
                                    .no-print { display: none !important; }
                                    .invoice-container { box-shadow: none; }
                                }
                                
                                .print-buttons {
                                    text-align: center;
                                    margin: 30px 0;
                                    padding: 20px;
                                    background: #f8fafc;
                                    border-radius: 8px;
                                }
                                .btn {
                                    padding: 12px 24px;
                                    margin: 0 10px;
                                    border: none;
                                    border-radius: 6px;
                                    font-weight: 600;
                                    cursor: pointer;
                                    font-size: 14px;
                                }
                                .btn-print { background: #22c55e; color: white; }
                                .btn-close { background: #ef4444; color: white; }
                                .btn:hover { opacity: 0.9; transform: translateY(-1px); }
                            </style>
                        </head>
                        <body>
                            <div class="invoice-container">
                                <!-- Header -->
                                <div class="invoice-header">
                                    <!-- Logo Section -->
                                    <div class="header-logo">
                                        ${companySettings.logo ? 
                                            `<img src="${companySettings.logo}" alt="Logo" style="max-width: 120px; max-height: 120px; object-fit: contain;">` :
                                            '<div style="color: #ccc; font-size: 12px; height: 80px; display: flex; align-items: center; justify-content: center;">Logo</div>'
                                        }
                                    </div>
                                    
                                    <!-- Company Info Section -->
                                    <div class="header-company">
                                        <div class="company-name">${companySettings.companyName || 'C√îNG TY C·ªî PH·∫¶N ABC'}</div>
                                        <div class="company-info">
                                            ${companySettings.address || '123 ƒê∆∞·ªùng ABC, Qu·∫≠n 1, TP.HCM'}<br>
                                            ƒêi·ªán tho·∫°i: ${companySettings.phone || '(028) 1234-5678'}${companySettings.email ? ' | Email: ' + companySettings.email : ''}<br>
                                            ${companySettings.taxCode ? 'MST: ' + companySettings.taxCode : ''}
                                            ${companySettings.description ? '<br><em>' + companySettings.description + '</em>' : ''}
                                        </div>
                                        <div class="invoice-title">H√ìA ƒê∆†N B√ÅN H√ÄNG</div>
                                    </div>
                                    
                                    <!-- QR Code Section -->
                                    <div class="header-qr">
                                        ${companySettings.qrCode ? 
                                            `<img src="${companySettings.qrCode}" alt="QR Code" style="max-width: 120px; max-height: 120px; object-fit: contain;">` :
                                            '<div style="color: #ccc; font-size: 12px; height: 80px; display: flex; align-items: center; justify-content: center;">QR Code</div>'
                                        }
                                    </div>
                                </div>

                                <!-- Invoice & Customer Details -->
                                <div class="invoice-details">
                                    <div class="invoice-info">
                                        <div class="section-title">Th√¥ng tin h√≥a ƒë∆°n</div>
                                        <div class="info-row">
                                            <span class="info-label">S·ªë h√≥a ƒë∆°n:</span>
                                            <span class="info-value">${order.id}</span>
                                        </div>
                                        <div class="info-row">
                                            <span class="info-label">Ng√†y l·∫≠p:</span>
                                            <span class="info-value">${order.date}</span>
                                        </div>
                                        <div class="info-row">
                                            <span class="info-label">Gi·ªù l·∫≠p:</span>
                                            <span class="info-value">${order.time}</span>
                                        </div>
                                        <div class="info-row">
                                            <span class="info-label">H√¨nh th·ª©c TT:</span>
                                            <span class="info-value">${order.paymentMethod}</span>
                                        </div>
                                    </div>
                                    
                                    <div class="customer-info">
                                        <div class="section-title">Th√¥ng tin kh√°ch h√†ng</div>
                                        <div class="info-row">
                                            <span class="info-label">T√™n kh√°ch h√†ng:</span>
                                            <span class="info-value">${customer.name}</span>
                                        </div>
                                        <div class="info-row">
                                            <span class="info-label">S·ªë ƒëi·ªán tho·∫°i:</span>
                                            <span class="info-value">${customer.phone}</span>
                                        </div>
                                        <div class="info-row">
                                            <span class="info-label">ƒê·ªãa ch·ªâ:</span>
                                            <span class="info-value">${customer.address}</span>
                                        </div>
                                        <div class="info-row">
                                            <span class="info-label">Tr·∫°ng th√°i TT:</span>
                                            <span class="info-value" style="color: ${order.paymentStatus === 'ƒê√£ thanh to√°n' ? '#22c55e' : '#f59e0b'}; font-weight: 600;">
                                                ${order.paymentStatus}
                                            </span>
                                        </div>
                                    </div>
                                </div>

                                <!-- Products Table -->
                                <table class="products-table">
                                    <thead>
                                        <tr>
                                            <th style="width: 5%;">STT</th>
                                            <th style="width: 35%;">T√™n s·∫£n ph·∫©m</th>
                                            <th style="width: 15%;">ƒê∆°n gi√°</th>
                                            <th style="width: 10%;">SL</th>
                                            <th style="width: 15%;">Gi·∫£m gi√°</th>
                                            <th style="width: 20%;">Th√†nh ti·ªÅn</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${(order.products || []).map((item, index) => {
                                            const discount = item.discount || 0;
                                            const subtotal = item.price * item.quantity * (1 - discount / 100);
                                            return `
                                            <tr>
                                                <td>${index + 1}</td>
                                                <td class="product-name">${item.name || 'N/A'}</td>
                                                <td>${(item.price || 0).toLocaleString('vi-VN')} ƒë</td>
                                                <td>${item.quantity || 0}</td>
                                                <td>${discount}%</td>
                                                <td style="font-weight: 600;">${subtotal.toLocaleString('vi-VN')} ƒë</td>
                                            </tr>
                                            `;
                                        }).join('')}
                                    </tbody>
                                </table>

                                <!-- Totals -->
                                <div class="totals-section">
                                    <div style="background: #f0f9ff; padding: 12px; border-radius: 8px; margin-bottom: 15px; border: 1px solid #0ea5e9;">
                                        <div style="text-align: center; color: #0c4a6e; font-size: 14px; font-weight: 600;">
                                            üí° Gi√° ƒë√∫ng - Kh√¥ng t√≠nh th√™m VAT
                                        </div>
                                    </div>
                                    <div class="total-row final">
                                        <span>T·ªîNG C·ªòNG:</span>
                                        <span>${order.total.toLocaleString('vi-VN')} ƒë</span>
                                    </div>
                                </div>

                                <!-- Signature Section -->
                                <div class="signature-section">
                                    <div class="signature-box">
                                        <div class="signature-title">Ng∆∞·ªùi mua h√†ng</div>
                                        <div>(K√Ω v√† ghi r√µ h·ªç t√™n)</div>
                                    </div>
                                    <div class="signature-box">
                                        <div class="signature-title">Ng∆∞·ªùi b√°n h√†ng</div>
                                        <div>(K√Ω v√† ghi r√µ h·ªç t√™n)</div>
                                    </div>
                                </div>

                                <!-- Print Buttons -->
                                <div class="print-buttons no-print">
                                    <button class="btn btn-print" onclick="window.print()">üñ®Ô∏è In h√≥a ƒë∆°n</button>
                                    <button class="btn btn-close" onclick="window.close()">‚ùå ƒê√≥ng</button>
                                </div>

                                <!-- Footer -->
                                <div class="footer-info">
                                    <p><strong>C·∫£m ∆°n qu√Ω kh√°ch ƒë√£ s·ª≠ d·ª•ng d·ªãch v·ª•!</strong></p>
                                    <p>H√≥a ƒë∆°n ƒë∆∞·ª£c t·∫°o t·ª± ƒë·ªông b·ªüi h·ªá th·ªëng PITC - ${this.getVietnamTime().toLocaleString('vi-VN', { 
                                        timeZone: 'Asia/Ho_Chi_Minh',
                                        year: 'numeric',
                                        month: '2-digit', 
                                        day: '2-digit',
                                        hour: '2-digit',
                                        minute: '2-digit',
                                        second: '2-digit'
                                    })}</p>
                                </div>
                            </div>
                        </body>
                        </html>
                    `);
                    
                    invoiceWindow.document.close();
                    invoiceWindow.focus();
                    
                    this.showNotification(`‚úÖ ƒê√£ m·ªü h√≥a ƒë∆°n chuy√™n nghi·ªáp ${order.id}`, 'success');
                    
                } catch (error) {
                    console.error('L·ªói in h√≥a ƒë∆°n:', error);
                    this.showNotification('‚ùå L·ªói in h√≥a ƒë∆°n: ' + error.message, 'error');
                }
            }

            // Professional Vietnamese Invoice Print Function with VAT
            printInvoiceWithVAT(index) {
                console.log('=== PRINTING INVOICE WITH VAT ===');
                console.log('Index:', index);
                
                try {
                    const order = this.demoData.orders[index];
                    console.log('Order data:', order);
                    
                    if (!order) {
                        this.showNotification('‚ùå Kh√¥ng t√¨m th·∫•y ƒë∆°n h√†ng!', 'error');
                        return;
                    }

                    // Show VAT adjustment popup
                    this.showVATAdjustmentPopup(index);
                    
                } catch (error) {
                    console.error('L·ªói in h√≥a ƒë∆°n VAT:', error);
                    this.showNotification('‚ùå L·ªói in h√≥a ƒë∆°n VAT: ' + error.message, 'error');
                }
            }

            // Show VAT adjustment popup
            showVATAdjustmentPopup(orderIndex) {
                const order = this.demoData.orders[orderIndex];
                const vatPopupHTML = `
                    <div style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); z-index: 1001; display: flex; justify-content: center; align-items: center;" onclick="closeModal(this)">
                        <div style="background: white; padding: 32px; border-radius: 12px; width: 500px; max-width: 90vw;" onclick="event.stopPropagation()">
                            <h3 style="margin-bottom: 20px; color: #2563eb; text-align: center;">‚öôÔ∏è ƒêi·ªÅu ch·ªânh thu·∫ø VAT</h3>
                            <p style="margin-bottom: 20px; color: #666; text-align: center;">Ch·ªçn m·ª©c thu·∫ø VAT ƒë·ªÉ in h√≥a ƒë∆°n</p>
                            
                            <div style="margin-bottom: 20px;">
                                <label style="display: block; margin-bottom: 8px; font-weight: 600;">Thu·∫ø VAT (%):</label>
                                <input type="number" id="vatPercent" min="0" max="100" value="10" step="0.5" 
                                       style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 16px; text-align: center;"
                                       oninput="app.updateVATPreview(this.value, ${orderIndex})">
                            </div>
                            
                            <div id="vat-preview" style="background: #f8fafc; padding: 16px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #2563eb;">
                                <!-- VAT preview will be populated by JavaScript -->
                            </div>
                            
                            <div style="display: flex; gap: 12px; justify-content: center;">
                                <button onclick="app.printWithVATAmount(${orderIndex}, document.getElementById('vatPercent').value)" 
                                        style="background: #22c55e; color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-weight: 600;">
                                    üñ®Ô∏è In v·ªõi VAT
                                </button>
                                <button onclick="closeModal(this.closest('[style*=fixed]'))" 
                                        style="background: #ef4444; color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-weight: 600;">
                                    ‚ùå H·ªßy
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                
                document.body.insertAdjacentHTML('beforeend', vatPopupHTML);
                
                // Initialize VAT preview
                this.updateVATPreview(10, orderIndex);
            }

            // Update VAT preview calculation
            updateVATPreview(vatPercent, orderIndex) {
                const order = this.demoData.orders[orderIndex];
                const vatRate = parseFloat(vatPercent) || 0;
                const subtotal = order.total;
                const vatAmount = (subtotal * vatRate) / 100;
                const totalWithVAT = subtotal + vatAmount;
                
                const previewElement = document.getElementById('vat-preview');
                if (previewElement) {
                    previewElement.innerHTML = `
                        <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                            <span>T·∫°m t√≠nh:</span>
                            <span style="font-weight: 600;">${subtotal.toLocaleString('vi-VN')} ƒë</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 8px; color: #2563eb;">
                            <span>Thu·∫ø VAT (${vatRate}%):</span>
                            <span style="font-weight: 600;">+ ${vatAmount.toLocaleString('vi-VN')} ƒë</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; border-top: 2px solid #e5e7eb; padding-top: 8px; font-size: 18px;">
                            <span style="font-weight: bold;">T·ªïng c·ªông:</span>
                            <span style="font-weight: bold; color: #22c55e;">${totalWithVAT.toLocaleString('vi-VN')} ƒë</span>
                        </div>
                    `;
                }
            }

            // Print invoice with specified VAT amount
            printWithVATAmount(orderIndex, vatPercent) {
                try {
                    const order = this.demoData.orders[orderIndex];
                    const vatRate = parseFloat(vatPercent) || 0;
                    
                    if (!order) {
                        this.showNotification('‚ùå Kh√¥ng t√¨m th·∫•y ƒë∆°n h√†ng!', 'error');
                        return;
                    }

                    // Check if products exist
                    if (!order.products || !Array.isArray(order.products)) {
                        this.showNotification('‚ùå ƒê∆°n h√†ng kh√¥ng c√≥ s·∫£n ph·∫©m!', 'error');
                        return;
                    }

                    // Find customer info
                    const customer = this.demoData.customers.find(c => c.id === order.customerId) || { 
                        name: order.customerName, 
                        phone: order.customPhuocIThone || 'Kh√¥ng c√≥', 
                        address: order.customerAddress || 'Kh√¥ng c√≥' 
                    };
                    
                    // HOSTING SOLUTION: Get company settings + global assets
                    const companySettings = this.getCompanySettings();
                    
                    // Override with global assets if available (for hosting)
                    if (window.companyAssets && window.companyAssets.logo) {
                        companySettings.logo = window.companyAssets.logo;
                    }
                    if (window.companyAssets && window.companyAssets.qr) {
                        companySettings.qrCode = window.companyAssets.qr;
                    }
                    
                    console.log('‚úÖ HOSTING READY - Logo/QR from global assets');
                    console.log('Logo data:', companySettings.logo ? 'Found' : 'Not found');
                    console.log('QR data:', companySettings.qrCode ? 'Found' : 'Not found');

                    // Calculate VAT amounts
                    const subtotal = order.total;
                    const vatAmount = (subtotal * vatRate) / 100;
                    const totalWithVAT = subtotal + vatAmount;
                    
                    // Close the VAT popup
                    const popup = document.querySelector('div[style*="fixed"]');
                    if (popup) popup.remove();
                    
                    // Professional invoice window with VAT
                    const invoiceWindow = window.open('', '_blank', 'width=800,height=900');
                    
                    if (!invoiceWindow) {
                        this.showNotification('‚ùå Popup b·ªã ch·∫∑n! H√£y cho ph√©p popup.', 'error');
                        return;
                    }
                    
                    invoiceWindow.document.write(`
                        <!DOCTYPE html>
                        <html lang="vi">
                        <head>
                            <meta charset="UTF-8">
                            <meta name="viewport" content="width=device-width, initial-scale=1.0">
                            <title>H√≥a ƒë∆°n VAT ${order.id}</title>
                            <style>
                                * { margin: 0; padding: 0; box-sizing: border-box; }
                                body { 
                                    font-family: 'Times New Roman', serif; 
                                    font-size: 14px; 
                                    line-height: 1.6; 
                                    color: #333; 
                                    padding: 20px;
                                    background: white;
                                }
                                .invoice-container { max-width: 800px; margin: 0 auto; background: white; }
                                
                                .invoice-header { 
                                    display: flex;
                                    align-items: center;
                                    justify-content: space-between;
                                    border-bottom: 3px solid #8B5CF6; 
                                    padding-bottom: 20px; 
                                    margin-bottom: 30px; 
                                    gap: 20px;
                                }
                                .header-logo, .header-qr {
                                    flex: 0 0 120px;
                                    text-align: center;
                                }
                                .header-company {
                                    flex: 1;
                                    text-align: center;
                                }
                                .header-logo img, .header-qr img {
                                    max-width: 120px;
                                    max-height: 120px;
                                    object-fit: contain;
                                }
                                .company-name { 
                                    font-size: 28px; 
                                    font-weight: bold; 
                                    color: #8B5CF6; 
                                    margin-bottom: 5px; 
                                }
                                .company-info { 
                                    font-size: 13px; 
                                    color: #666; 
                                    margin-bottom: 15px; 
                                }
                                .invoice-title { 
                                    font-size: 24px; 
                                    font-weight: bold; 
                                    margin-top: 15px;
                                    color: #1a1a1a;
                                }
                                .vat-badge {
                                    background: #8B5CF6;
                                    color: white;
                                    padding: 6px 12px;
                                    border-radius: 6px;
                                    font-size: 12px;
                                    font-weight: bold;
                                    margin-left: 10px;
                                }
                                
                                .invoice-details { 
                                    display: flex; 
                                    justify-content: space-between; 
                                    margin-bottom: 30px; 
                                    gap: 40px;
                                }
                                .invoice-info, .customer-info { 
                                    flex: 1;
                                }
                                .section-title { 
                                    font-weight: bold; 
                                    font-size: 16px;
                                    border-bottom: 2px solid #e5e7eb; 
                                    padding-bottom: 8px; 
                                    margin-bottom: 15px;
                                    color: #8B5CF6;
                                }
                                .info-row { 
                                    margin-bottom: 8px; 
                                    display: flex;
                                }
                                .info-label { 
                                    font-weight: 600; 
                                    min-width: 120px;
                                    color: #555;
                                }
                                .info-value { 
                                    color: #333;
                                }
                                
                                .products-table { 
                                    width: 100%; 
                                    border-collapse: collapse; 
                                    margin-bottom: 30px;
                                    border: 2px solid #8B5CF6;
                                }
                                .products-table th { 
                                    background: #8B5CF6; 
                                    color: white; 
                                    padding: 12px 8px; 
                                    text-align: center; 
                                    font-weight: bold;
                                    font-size: 14px;
                                }
                                .products-table td { 
                                    padding: 10px 8px; 
                                    text-align: center; 
                                    border-bottom: 1px solid #e5e7eb;
                                }
                                .product-name { text-align: left !important; font-weight: 500; }
                                
                                .summary-section { 
                                    background: #f8fafc; 
                                    padding: 20px; 
                                    border-radius: 12px; 
                                    margin-bottom: 30px;
                                    border: 2px solid #8B5CF6;
                                }
                                .summary-row { 
                                    display: flex; 
                                    justify-content: space-between; 
                                    margin-bottom: 12px; 
                                    font-size: 16px;
                                }
                                .summary-subtotal { font-weight: 500; }
                                .summary-vat { 
                                    font-weight: 600; 
                                    color: #8B5CF6; 
                                    background: white;
                                    padding: 8px 12px;
                                    border-radius: 6px;
                                    border: 1px solid #8B5CF6;
                                }
                                .summary-total { 
                                    font-weight: bold; 
                                    font-size: 20px; 
                                    color: #22c55e;
                                    border-top: 2px solid #8B5CF6;
                                    padding-top: 12px;
                                }
                                
                                .footer-info { 
                                    text-align: center; 
                                    color: #666; 
                                    font-size: 12px; 
                                    border-top: 2px solid #e5e7eb; 
                                    padding-top: 20px;
                                }
                                
                                .print-buttons { 
                                    text-align: center; 
                                    margin: 30px 0; 
                                    gap: 15px; 
                                    display: flex; 
                                    justify-content: center;
                                }
                                @media print {
                                    .no-print { display: none !important; }
                                    body { padding: 0; }
                                    .invoice-container { box-shadow: none; }
                                }
                                .btn { 
                                    padding: 12px 24px;
                                    margin: 0 10px;
                                    border: none;
                                    border-radius: 6px;
                                    font-weight: 600;
                                    cursor: pointer;
                                    font-size: 14px;
                                }
                                .btn-print { background: #8B5CF6; color: white; }
                                .btn-close { background: #ef4444; color: white; }
                                .btn:hover { opacity: 0.9; transform: translateY(-1px); }
                            </style>
                        </head>
                        <body>
                            <div class="invoice-container">
                                <!-- Header -->
                                <div class="invoice-header">
                                    <!-- Logo Section -->
                                    <div class="header-logo">
                                        ${companySettings.logo ? 
                                            `<img src="${companySettings.logo}" alt="Logo" style="max-width: 120px; max-height: 120px; object-fit: contain;">` :
                                            '<div style="color: #ccc; font-size: 12px; height: 80px; display: flex; align-items: center; justify-content: center;">Logo</div>'
                                        }
                                    </div>
                                    
                                    <!-- Company Info Section -->
                                    <div class="header-company">
                                        <div class="company-name">${companySettings.companyName || 'C√îNG TY C·ªî PH·∫¶N ABC'}</div>
                                        <div class="company-info">
                                            ${companySettings.address || '123 ƒê∆∞·ªùng ABC, Qu·∫≠n 1, TP.HCM'}<br>
                                            ƒêi·ªán tho·∫°i: ${companySettings.phone || '(028) 1234-5678'}${companySettings.email ? ' | Email: ' + companySettings.email : ''}<br>
                                            ${companySettings.taxCode ? 'MST: ' + companySettings.taxCode : ''}
                                            ${companySettings.description ? '<br><em>' + companySettings.description + '</em>' : ''}
                                        </div>
                                        <div class="invoice-title">
                                            H√ìA ƒê∆†N GTGT
                                            <span class="vat-badge">VAT ${vatRate}%</span>
                                        </div>
                                    </div>
                                    
                                    <!-- QR Code Section -->
                                    <div class="header-qr">
                                        ${companySettings.qrCode ? 
                                            `<img src="${companySettings.qrCode}" alt="QR Code" style="max-width: 120px; max-height: 120px; object-fit: contain;">` :
                                            '<div style="color: #ccc; font-size: 12px; height: 80px; display: flex; align-items: center; justify-content: center;">QR Code</div>'
                                        }
                                    </div>
                                </div>

                                <!-- Invoice & Customer Details -->
                                <div class="invoice-details">
                                    <div class="invoice-info">
                                        <div class="section-title">Th√¥ng tin h√≥a ƒë∆°n</div>
                                        <div class="info-row">
                                            <span class="info-label">S·ªë h√≥a ƒë∆°n:</span>
                                            <span class="info-value">${order.id}</span>
                                        </div>
                                        <div class="info-row">
                                            <span class="info-label">Ng√†y l·∫≠p:</span>
                                            <span class="info-value">${order.date}</span>
                                        </div>
                                        <div class="info-row">
                                            <span class="info-label">Gi·ªù l·∫≠p:</span>
                                            <span class="info-value">${order.time}</span>
                                        </div>
                                        <div class="info-row">
                                            <span class="info-label">H√¨nh th·ª©c TT:</span>
                                            <span class="info-value">${order.paymentMethod}</span>
                                        </div>
                                        <div class="info-row">
                                            <span class="info-label">Thu·∫ø GTGT:</span>
                                            <span class="info-value" style="color: #8B5CF6; font-weight: 600;">${vatRate}%</span>
                                        </div>
                                    </div>
                                    
                                    <div class="customer-info">
                                        <div class="section-title">Th√¥ng tin kh√°ch h√†ng</div>
                                        <div class="info-row">
                                            <span class="info-label">T√™n kh√°ch h√†ng:</span>
                                            <span class="info-value">${customer.name}</span>
                                        </div>
                                        <div class="info-row">
                                            <span class="info-label">S·ªë ƒëi·ªán tho·∫°i:</span>
                                            <span class="info-value">${customer.phone}</span>
                                        </div>
                                        <div class="info-row">
                                            <span class="info-label">ƒê·ªãa ch·ªâ:</span>
                                            <span class="info-value">${customer.address}</span>
                                        </div>
                                        <div class="info-row">
                                            <span class="info-label">Tr·∫°ng th√°i TT:</span>
                                            <span class="info-value" style="color: ${order.paymentStatus === 'ƒê√£ thanh to√°n' ? '#22c55e' : '#f59e0b'}; font-weight: 600;">
                                                ${order.paymentStatus}
                                            </span>
                                        </div>
                                    </div>
                                </div>

                                <!-- Products Table -->
                                <table class="products-table">
                                    <thead>
                                        <tr>
                                            <th style="width: 5%;">STT</th>
                                            <th style="width: 35%;">T√™n s·∫£n ph·∫©m</th>
                                            <th style="width: 15%;">ƒê∆°n gi√°</th>
                                            <th style="width: 10%;">SL</th>
                                            <th style="width: 15%;">Gi·∫£m gi√°</th>
                                            <th style="width: 20%;">Th√†nh ti·ªÅn</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${(order.products || []).map((item, index) => {
                                            const discount = item.discount || 0;
                                            const subtotal = item.price * item.quantity * (1 - discount / 100);
                                            return `
                                            <tr>
                                                <td>${index + 1}</td>
                                                <td class="product-name">${item.name || 'N/A'}</td>
                                                <td>${(item.price || 0).toLocaleString('vi-VN')} ƒë</td>
                                                <td>${item.quantity || 0}</td>
                                                <td>${discount}%</td>
                                                <td style="font-weight: 600;">${subtotal.toLocaleString('vi-VN')} ƒë</td>
                                            </tr>
                                            `;
                                        }).join('')}
                                    </tbody>
                                </table>

                                <!-- Summary with VAT -->
                                <div class="summary-section">
                                    <div class="summary-row summary-subtotal">
                                        <span>T·∫°m t√≠nh (ch∆∞a VAT):</span>
                                        <span>${subtotal.toLocaleString('vi-VN')} ƒë</span>
                                    </div>
                                    <div class="summary-row summary-vat">
                                        <span>Thu·∫ø GTGT (${vatRate}%):</span>
                                        <span>+ ${vatAmount.toLocaleString('vi-VN')} ƒë</span>
                                    </div>
                                    <div class="summary-row summary-total">
                                        <span>T·ªîNG C·ªòNG:</span>
                                        <span>${totalWithVAT.toLocaleString('vi-VN')} ƒë</span>
                                    </div>
                                </div>

                                <!-- Print Buttons -->
                                <div class="print-buttons no-print">
                                    <button class="btn btn-print" onclick="window.print()">üñ®Ô∏è In h√≥a ƒë∆°n VAT</button>
                                    <button class="btn btn-close" onclick="window.close()">‚ùå ƒê√≥ng</button>
                                </div>

                                <!-- Footer -->
                                <div class="footer-info">
                                    <p><strong>C·∫£m ∆°n qu√Ω kh√°ch ƒë√£ s·ª≠ d·ª•ng d·ªãch v·ª•!</strong></p>
                                    <p>H√≥a ƒë∆°n GTGT ƒë∆∞·ª£c t·∫°o t·ª± ƒë·ªông b·ªüi h·ªá th·ªëng PITC - ${this.getVietnamTime().toLocaleString('vi-VN', { 
                                        timeZone: 'Asia/Ho_Chi_Minh',
                                        year: 'numeric',
                                        month: '2-digit', 
                                        day: '2-digit',
                                        hour: '2-digit',
                                        minute: '2-digit',
                                        second: '2-digit'
                                    })}</p>
                                </div>
                            </div>
                        </body>
                        </html>
                    `);
                    
                    invoiceWindow.document.close();
                    invoiceWindow.focus();
                    
                    this.showNotification(`‚úÖ ƒê√£ m·ªü h√≥a ƒë∆°n VAT ${vatRate}% cho ƒë∆°n h√†ng ${order.id}`, 'success');
                    
                } catch (error) {
                    console.error('L·ªói in h√≥a ƒë∆°n VAT:', error);
                    this.showNotification('‚ùå L·ªói in h√≥a ƒë∆°n VAT: ' + error.message, 'error');
                }
            }

            // Print debt report for a customer
            printDebtReport(customerId) {
                try {
                    const customer = this.demoData.customers.find(c => c.id === customerId);
                    if (!customer) {
                        this.showNotification('‚ùå Kh√¥ng t√¨m th·∫•y kh√°ch h√†ng!', 'error');
                        return;
                    }

                    // Get company settings for report header
                    const companySettings = this.getCompanySettings();
                    
                    // Override with global assets if available (for hosting)
                    if (window.companyAssets && window.companyAssets.logo) {
                        companySettings.logo = window.companyAssets.logo;
                    }
                    if (window.companyAssets && window.companyAssets.qr) {
                        companySettings.qrCode = window.companyAssets.qr;
                    }

                    // Find all unpaid orders for this customer
                    const unpaidOrders = this.demoData.orders.filter(order => {
                        const matchById = order.customerId === customerId;
                        const matchByName = order.customer === customer.name || order.customerName === customer.name;
                        const isUnpaid = order.paymentStatus === 'C√¥ng n·ª£' ||
                                        order.status === 'C√¥ng n·ª£';
                        return (matchById || matchByName) && isUnpaid;
                    });

                    if (unpaidOrders.length === 0) {
                        this.showNotification('‚ùå Kh√°ch h√†ng n√†y kh√¥ng c√≥ c√¥ng n·ª£!', 'error');
                        return;
                    }

                    // Calculate total debt
                    const totalDebt = unpaidOrders.reduce((sum, order) => sum + order.total, 0);

                    // Generate debt report window
                    const reportWindow = window.open('', '_blank');
                    reportWindow.document.write(`
                        <!DOCTYPE html>
                        <html>
                        <head>
                            <meta charset="utf-8">
                            <title>B√°o c√°o c√¥ng n·ª£ - ${customer.name}</title>
                            <style>
                                * { margin: 0; padding: 0; box-sizing: border-box; }
                                body { 
                                    font-family: 'Times New Roman', serif; 
                                    font-size: 13px; 
                                    line-height: 1.4; 
                                    padding: 20px; 
                                    color: #333;
                                }
                                .report-container { 
                                    max-width: 800px; 
                                    margin: 0 auto; 
                                    background: white;
                                }
                                .report-header { 
                                    display: flex;
                                    align-items: center;
                                    justify-content: space-between;
                                    margin-bottom: 30px; 
                                    border-bottom: 3px solid #dc2626; 
                                    padding-bottom: 20px;
                                    gap: 20px;
                                }
                                .header-logo, .header-qr {
                                    flex: 0 0 100px;
                                    text-align: center;
                                }
                                .header-company {
                                    flex: 1;
                                    text-align: center;
                                }
                                .header-logo img, .header-qr img {
                                    max-width: 100px;
                                    max-height: 100px;
                                    object-fit: contain;
                                }
                                .company-name { 
                                    font-size: 20px; 
                                    font-weight: bold; 
                                    color: #dc2626; 
                                    margin-bottom: 8px;
                                }
                                .company-info { 
                                    font-size: 12px; 
                                    color: #666; 
                                    margin-bottom: 15px; 
                                }
                                .report-title { 
                                    font-size: 22px; 
                                    font-weight: bold; 
                                    margin-top: 15px;
                                    color: #1a1a1a;
                                    text-transform: uppercase;
                                }
                                .debt-badge {
                                    background: #dc2626;
                                    color: white;
                                    padding: 6px 12px;
                                    border-radius: 6px;
                                    font-size: 12px;
                                    font-weight: bold;
                                    margin-left: 10px;
                                }
                                
                                .report-details { 
                                    display: flex; 
                                    justify-content: space-between; 
                                    margin-bottom: 30px; 
                                    gap: 40px;
                                }
                                .report-info, .customer-info { 
                                    flex: 1;
                                }
                                .section-title { 
                                    font-weight: bold; 
                                    font-size: 16px;
                                    border-bottom: 2px solid #e5e7eb; 
                                    padding-bottom: 8px; 
                                    margin-bottom: 15px;
                                    color: #dc2626;
                                }
                                .info-row { 
                                    margin-bottom: 8px; 
                                    display: flex;
                                }
                                .info-label { 
                                    font-weight: 600; 
                                    min-width: 120px;
                                    color: #555;
                                }
                                .info-value { 
                                    color: #333;
                                }
                                
                                .orders-table { 
                                    width: 100%; 
                                    border-collapse: collapse; 
                                    margin-bottom: 30px;
                                    border: 2px solid #dc2626;
                                }
                                .orders-table th { 
                                    background: #dc2626; 
                                    color: white; 
                                    padding: 12px 8px; 
                                    text-align: center; 
                                    font-weight: bold;
                                    font-size: 14px;
                                }
                                .orders-table td { 
                                    padding: 10px 8px; 
                                    text-align: center; 
                                    border-bottom: 1px solid #e5e7eb;
                                }
                                .order-id { text-align: left !important; font-weight: 600; }
                                .product-name { text-align: left !important; font-weight: 500; }
                                .amount { 
                                    text-align: right !important; 
                                    font-weight: 600; 
                                    color: #dc2626;
                                }
                                
                                .totals-section { 
                                    background: #fee2e2; 
                                    padding: 20px; 
                                    border-radius: 8px; 
                                    margin-bottom: 30px;
                                    border: 2px solid #dc2626;
                                }
                                .summary-row { 
                                    display: flex; 
                                    justify-content: space-between; 
                                    padding: 8px 12px;
                                    border-radius: 6px;
                                    border: 1px solid #dc2626;
                                }
                                .summary-total { 
                                    font-weight: bold; 
                                    font-size: 18px; 
                                    color: #dc2626;
                                    border-top: 2px solid #dc2626;
                                    padding-top: 12px;
                                    background: white;
                                }
                                
                                .footer-info { 
                                    text-align: center; 
                                    color: #666; 
                                    font-size: 12px; 
                                    border-top: 2px solid #e5e7eb; 
                                    padding-top: 20px;
                                }
                                
                                .print-buttons { 
                                    text-align: center; 
                                    margin: 30px 0; 
                                    gap: 15px; 
                                    display: flex; 
                                    justify-content: center;
                                }
                                @media print {
                                    .no-print { display: none !important; }
                                    body { padding: 0; }
                                    .report-container { box-shadow: none; }
                                }
                                .btn { 
                                    padding: 12px 24px;
                                    margin: 0 10px;
                                    border: none;
                                    border-radius: 6px;
                                    font-weight: 600;
                                    cursor: pointer;
                                    font-size: 14px;
                                }
                                .btn-print { background: #dc2626; color: white; }
                                .btn-close { background: #6b7280; color: white; }
                                .btn:hover { opacity: 0.9; transform: translateY(-1px); }
                                
                                .products-detail { 
                                    background: #f9fafb; 
                                    padding: 8px; 
                                    margin: 4px 0;
                                    border-radius: 4px;
                                    border-left: 3px solid #dc2626;
                                }
                            </style>
                        </head>
                        <body>
                            <div class="report-container">
                                <!-- Header -->
                                <div class="report-header">
                                    <!-- Logo Section -->
                                    <div class="header-logo">
                                        ${companySettings.logo ? 
                                            `<img src="${companySettings.logo}" alt="Logo" style="max-width: 100px; max-height: 100px; object-fit: contain;">` :
                                            '<div style="color: #ccc; font-size: 11px; height: 60px; display: flex; align-items: center; justify-content: center;">Logo</div>'
                                        }
                                    </div>
                                    
                                    <!-- Company Info Section -->
                                    <div class="header-company">
                                        <div class="company-name">${companySettings.companyName || 'C√îNG TY C·ªî PH·∫¶N ABC'}</div>
                                        <div class="company-info">
                                            ${companySettings.address || '123 ƒê∆∞·ªùng ABC, Qu·∫≠n 1, TP.HCM'}<br>
                                            ƒêi·ªán tho·∫°i: ${companySettings.phone || '(028) 1234-5678'}${companySettings.email ? ' | Email: ' + companySettings.email : ''}<br>
                                            ${companySettings.taxCode ? 'MST: ' + companySettings.taxCode : ''}
                                            ${companySettings.description ? '<br><em>' + companySettings.description + '</em>' : ''}
                                        </div>
                                        <div class="report-title">
                                            B√ÅO C√ÅO C√îNG N·ª¢ KH√ÅCH H√ÄNG
                                            <span class="debt-badge">${unpaidOrders.length} ƒë∆°n h√†ng</span>
                                        </div>
                                    </div>
                                    
                                    <!-- QR Code Section -->
                                    <div class="header-qr">
                                        ${companySettings.qrCode ? 
                                            `<img src="${companySettings.qrCode}" alt="QR Code" style="max-width: 100px; max-height: 100px; object-fit: contain;">` :
                                            '<div style="color: #ccc; font-size: 11px; height: 60px; display: flex; align-items: center; justify-content: center;">QR Code</div>'
                                        }
                                    </div>
                                </div>

                                <!-- Report & Customer Details -->
                                <div class="report-details">
                                    <div class="report-info">
                                        <div class="section-title">Th√¥ng tin b√°o c√°o</div>
                                        <div class="info-row">
                                            <span class="info-label">Ng√†y l·∫≠p:</span>
                                            <span class="info-value">${this.getVietnamTime().toLocaleDateString('vi-VN')}</span>
                                        </div>
                                        <div class="info-row">
                                            <span class="info-label">Gi·ªù l·∫≠p:</span>
                                            <span class="info-value">${this.getVietnamTime().toLocaleTimeString('vi-VN')}</span>
                                        </div>
                                        <div class="info-row">
                                            <span class="info-label">S·ªë ƒë∆°n n·ª£:</span>
                                            <span class="info-value" style="color: #dc2626; font-weight: 600;">${unpaidOrders.length} ƒë∆°n h√†ng</span>
                                        </div>
                                        <div class="info-row">
                                            <span class="info-label">T·ªïng c√¥ng n·ª£:</span>
                                            <span class="info-value" style="color: #dc2626; font-weight: 700; font-size: 16px;">${totalDebt.toLocaleString('vi-VN')} ƒë</span>
                                        </div>
                                    </div>
                                    
                                    <div class="customer-info">
                                        <div class="section-title">Th√¥ng tin kh√°ch h√†ng</div>
                                        <div class="info-row">
                                            <span class="info-label">M√£ KH:</span>
                                            <span class="info-value">${customer.id}</span>
                                        </div>
                                        <div class="info-row">
                                            <span class="info-label">T√™n kh√°ch h√†ng:</span>
                                            <span class="info-value">${customer.name}</span>
                                        </div>
                                        <div class="info-row">
                                            <span class="info-label">S·ªë ƒëi·ªán tho·∫°i:</span>
                                            <span class="info-value">${customer.phone}</span>
                                        </div>
                                        <div class="info-row">
                                            <span class="info-label">ƒê·ªãa ch·ªâ:</span>
                                            <span class="info-value">${customer.address}</span>
                                        </div>
                                    </div>
                                </div>

                                <!-- Orders Table with Product Details -->
                                <table class="orders-table">
                                    <thead>
                                        <tr>
                                            <th style="width: 12%">M√£ ƒë∆°n</th>
                                            <th style="width: 12%">Ng√†y</th>
                                            <th style="width: 35%">Chi ti·∫øt s·∫£n ph·∫©m</th>
                                            <th style="width: 15%">Ph∆∞∆°ng th·ª©c TT</th>
                                            <th style="width: 12%">Tr·∫°ng th√°i</th>
                                            <th style="width: 14%">S·ªë ti·ªÅn</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${unpaidOrders.map(order => `
                                            <tr>
                                                <td class="order-id">${order.id}</td>
                                                <td>${order.date}</td>
                                                <td class="product-name">
                                                    ${order.products && order.products.length > 0 ? 
                                                        order.products.map(product => `
                                                            <div class="products-detail">
                                                                <strong>${product.name}</strong><br>
                                                                <span style="color: #666; font-size: 12px;">
                                                                    SL: ${product.quantity} √ó ${product.price.toLocaleString('vi-VN')}ƒë = 
                                                                    <strong style="color: #dc2626;">${(product.quantity * product.price).toLocaleString('vi-VN')}ƒë</strong>
                                                                </span>
                                                            </div>
                                                        `).join('') 
                                                        : '<span style="color: #999;">Kh√¥ng c√≥ chi ti·∫øt</span>'
                                                    }
                                                </td>
                                                <td>${order.paymentMethod}</td>
                                                <td>
                                                    <span style="background: #fbbf24; color: white; padding: 4px 8px; border-radius: 4px; font-size: 11px; font-weight: bold;">
                                                        ${order.paymentStatus}
                                                    </span>
                                                </td>
                                                <td class="amount">${order.total.toLocaleString('vi-VN')} ƒë</td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>

                                <!-- Total Summary -->
                                <div class="totals-section">
                                    <div class="summary-row summary-total">
                                        <span>T·ªîNG C√îNG N·ª¢:</span>
                                        <span>${totalDebt.toLocaleString('vi-VN')} ƒë</span>
                                    </div>
                                    <div style="text-align: center; margin-top: 15px; font-size: 12px; color: #dc2626;">
                                        <strong>Ghi ch√∫:</strong> B√°o c√°o bao g·ªìm ${unpaidOrders.length} ƒë∆°n h√†ng ch∆∞a thanh to√°n v·ªõi t·ªïng gi√° tr·ªã ${totalDebt.toLocaleString('vi-VN')} ƒë·ªìng
                                    </div>
                                </div>

                                <!-- Print Buttons -->
                                <div class="print-buttons no-print">
                                    <button class="btn btn-print" onclick="window.print()">üñ®Ô∏è In b√°o c√°o c√¥ng n·ª£</button>
                                    <button class="btn btn-close" onclick="window.close()">‚ùå ƒê√≥ng</button>
                                </div>

                                <!-- Footer -->
                                <div class="footer-info">
                                    <p><strong>B√°o c√°o ƒë∆∞·ª£c t·∫°o t·ª± ƒë·ªông b·ªüi h·ªá th·ªëng PhuocIT</strong></p>
                                    <p>Th·ªùi gian t·∫°o: ${this.getVietnamTime().toLocaleString('vi-VN', { 
                                        timeZone: 'Asia/Ho_Chi_Minh',
                                        year: 'numeric',
                                        month: '2-digit', 
                                        day: '2-digit',
                                        hour: '2-digit',
                                        minute: '2-digit',
                                        second: '2-digit'
                                    })}</p>
                                    <p style="color: #dc2626; font-weight: 600;">
                                        Vui l√≤ng li√™n h·ªá kh√°ch h√†ng ƒë·ªÉ thu h·ªìi c√¥ng n·ª£ k·ªãp th·ªùi
                                    </p>
                                </div>
                            </div>
                        </body>
                        </html>
                    `);
                    
                    reportWindow.document.close();
                    reportWindow.focus();
                    
                    this.showNotification(`‚úÖ ƒê√£ t·∫°o b√°o c√°o c√¥ng n·ª£ cho kh√°ch h√†ng ${customer.name} (${unpaidOrders.length} ƒë∆°n h√†ng)`, 'success');
                    
                } catch (error) {
                    console.error('L·ªói t·∫°o b√°o c√°o c√¥ng n·ª£:', error);
                    this.showNotification('‚ùå L·ªói t·∫°o b√°o c√°o c√¥ng n·ª£: ' + error.message, 'error');
                }
            }

            // Function to close modal/popup
            closeModal(element) {
                if (element) {
                    element.remove();
                    return;
                }
                // Try to find and remove modal by common selectors
                const modals = document.querySelectorAll('div[style*="fixed"]');
                if (modals.length > 0) {
                    modals[modals.length - 1].remove(); // Remove the last modal
                }
            }

            // ===== B·ªò L·ªåC NG√ÄY TH√ÅNG CHO B√ÅO C√ÅO =====
            
            // Kh·ªüi t·∫°o filter state
            initFilterState() {
                if (!this.filterState) {
                    this.filterState = {
                        fromDate: this.getDefaultFromDate(),
                        toDate: this.getDefaultToDate(),
                        isCollapsed: false
                    };
                }
            }

            getDefaultFromDate() {
                // M·∫∑c ƒë·ªãnh l√† ƒë·∫ßu th√°ng n√†y (gi·ªù Vi·ªát Nam)
                const vietnamTime = this.getVietnamTime();
                vietnamTime.setDate(1);
                return vietnamTime.toISOString().split('T')[0];
            }

            getDefaultToDate() {
                // M·∫∑c ƒë·ªãnh l√† h√¥m nay (gi·ªù Vi·ªát Nam)
                return this.getVietnamTime().toISOString().split('T')[0];
            }

            formatDateForDisplay(dateString) {
                const date = new Date(dateString);
                return date.toLocaleDateString('vi-VN');
            }

            // Toggle hi·ªÉn th·ªã/·∫©n b·ªô l·ªçc
            toggleFilterSection() {
                const content = document.getElementById('filter-content');
                const icon = document.getElementById('filter-toggle-icon');
                
                if (content.style.display === 'none') {
                    content.style.display = 'block';
                    icon.textContent = 'üìÅ';
                    this.filterState.isCollapsed = false;
                } else {
                    content.style.display = 'none';
                    icon.textContent = 'üìÇ';
                    this.filterState.isCollapsed = true;
                }
            }

            // √Åp d·ª•ng l·ª±a ch·ªçn nhanh
            applyQuickFilter(value) {
                const fromDateInput = document.getElementById('filter-from-date');
                const toDateInput = document.getElementById('filter-to-date');
                const today = this.getVietnamTime();
                let fromDate, toDate;

                switch(value) {
                    case 'today':
                        fromDate = toDate = this.getVietnamTime();
                        break;
                    case 'yesterday':
                        fromDate = toDate = new Date(today.getTime() - 24 * 60 * 60 * 1000);
                        break;
                    case 'this-week':
                        const startOfWeek = new Date(today);
                        startOfWeek.setDate(today.getDate() - today.getDay() + 1); // Th·ª© 2
                        fromDate = startOfWeek;
                        toDate = today;
                        break;
                    case 'last-week':
                        const startOfLastWeek = new Date(today);
                        startOfLastWeek.setDate(today.getDate() - today.getDay() - 6);
                        const endOfLastWeek = new Date(today);
                        endOfLastWeek.setDate(today.getDate() - today.getDay());
                        fromDate = startOfLastWeek;
                        toDate = endOfLastWeek;
                        break;
                    case 'this-month':
                        fromDate = new Date(today.getFullYear(), today.getMonth(), 1);
                        toDate = today;
                        break;
                    case 'last-month':
                        fromDate = new Date(today.getFullYear(), today.getMonth() - 1, 1);
                        toDate = new Date(today.getFullYear(), today.getMonth(), 0);
                        break;
                    case 'last-30-days':
                        fromDate = new Date(today.getTime() - 30 * 24 * 60 * 60 * 1000);
                        toDate = today;
                        break;
                    case 'last-90-days':
                        fromDate = new Date(today.getTime() - 90 * 24 * 60 * 60 * 1000);
                        toDate = today;
                        break;
                    case 'this-year':
                        fromDate = new Date(today.getFullYear(), 0, 1);
                        toDate = today;
                        break;
                    case 'last-year':
                        fromDate = new Date(today.getFullYear() - 1, 0, 1);
                        toDate = new Date(today.getFullYear() - 1, 11, 31);
                        break;
                    default:
                        return;
                }

                if (fromDate && toDate) {
                    fromDateInput.value = fromDate.toISOString().split('T')[0];
                    toDateInput.value = toDate.toISOString().split('T')[0];
                }
            }

            // √Åp d·ª•ng b·ªô l·ªçc ng√†y th√°ng
            applyDateFilter() {
                const fromDate = document.getElementById('filter-from-date').value;
                const toDate = document.getElementById('filter-to-date').value;
                
                if (!fromDate || !toDate) {
                    this.showNotification('Vui l√≤ng ch·ªçn ƒë·∫ßy ƒë·ªß ng√†y b·∫Øt ƒë·∫ßu v√† k·∫øt th√∫c', 'warning');
                    return;
                }

                if (new Date(fromDate) > new Date(toDate)) {
                    this.showNotification('Ng√†y b·∫Øt ƒë·∫ßu kh√¥ng th·ªÉ sau ng√†y k·∫øt th√∫c', 'error');
                    return;
                }

                // L∆∞u tr·∫°ng th√°i filter
                this.filterState.fromDate = fromDate;
                this.filterState.toDate = toDate;

                // C·∫≠p nh·∫≠t th√¥ng tin hi·ªÉn th·ªã
                const filterInfo = document.getElementById('filter-info');
                if (filterInfo) {
                    filterInfo.innerHTML = `Hi·ªÉn th·ªã d·ªØ li·ªáu t·ª´ <strong>${this.formatDateForDisplay(fromDate)}</strong> ƒë·∫øn <strong>${this.formatDateForDisplay(toDate)}</strong>`;
                }

                // L·ªçc v√† c·∫≠p nh·∫≠t d·ªØ li·ªáu b√°o c√°o
                this.filterReportsData(fromDate, toDate);
                this.showNotification(`ƒê√£ √°p d·ª•ng b·ªô l·ªçc t·ª´ ${this.formatDateForDisplay(fromDate)} ƒë·∫øn ${this.formatDateForDisplay(toDate)}`, 'success');
            }

            // Reset b·ªô l·ªçc v·ªÅ m·∫∑c ƒë·ªãnh
            resetDateFilter() {
                const fromDate = this.getDefaultFromDate();
                const toDate = this.getDefaultToDate();
                
                document.getElementById('filter-from-date').value = fromDate;
                document.getElementById('filter-to-date').value = toDate;
                document.getElementById('filter-quick-select').value = '';
                
                this.filterState.fromDate = fromDate;
                this.filterState.toDate = toDate;
                
                const filterInfo = document.getElementById('filter-info');
                if (filterInfo) {
                    filterInfo.innerHTML = `Hi·ªÉn th·ªã d·ªØ li·ªáu t·ª´ <strong>${this.formatDateForDisplay(fromDate)}</strong> ƒë·∫øn <strong>${this.formatDateForDisplay(toDate)}</strong>`;
                }
                
                this.filterReportsData(fromDate, toDate);
                this.showNotification('ƒê√£ ƒë·∫∑t l·∫°i b·ªô l·ªçc v·ªÅ m·∫∑c ƒë·ªãnh', 'info');
            }

            // L·ªçc d·ªØ li·ªáu b√°o c√°o theo kho·∫£ng th·ªùi gian
            filterReportsData(fromDate, toDate) {
                const startDate = new Date(fromDate);
                const endDate = new Date(toDate);
                endDate.setHours(23, 59, 59, 999); // Include to√†n b·ªô ng√†y cu·ªëi

                // L·ªçc ƒë∆°n h√†ng theo kho·∫£ng th·ªùi gian
                const filteredOrders = this.demoData.orders.filter(order => {
                    const orderDate = new Date(order.date);
                    return orderDate >= startDate && orderDate <= endDate;
                });

                // T√≠nh to√°n l·∫°i c√°c s·ªë li·ªáu th·ªëng k√™
                const totalRevenue = filteredOrders.reduce((sum, order) => {
                    return order.paymentStatus === 'ƒê√£ thanh to√°n' ? sum + order.total : sum;
                }, 0);

                const totalProfit = filteredOrders.reduce((sum, order) => {
                    const profit = order.paymentStatus === 'ƒê√£ thanh to√°n' ? order.total * 0.25 : 0; // Gi·∫£ s·ª≠ l·ª£i nhu·∫≠n 25%
                    return sum + profit;
                }, 0);

                const totalDebt = filteredOrders.reduce((sum, order) => {
                    return order.paymentStatus === 'C√¥ng n·ª£' ? sum + order.total : sum;
                }, 0);

                // C·∫≠p nh·∫≠t display th·ªëng k√™
                this.updateFilteredStats(totalRevenue, totalProfit, totalDebt, filteredOrders.length);

                // C·∫≠p nh·∫≠t danh s√°ch ƒë∆°n h√†ng hi·ªÉn th·ªã
                this.updateOrdersList(filteredOrders);
            }

            // C·∫≠p nh·∫≠t hi·ªÉn th·ªã th·ªëng k√™ sau khi l·ªçc
            updateFilteredStats(revenue, profit, debt, orderCount) {
                // C·∫≠p nh·∫≠t c√°c card th·ªëng k√™
                const revenueCard = document.querySelector('.stat-card.revenue .stat-value');
                const profitCard = document.querySelector('.stat-card.info .stat-value');
                
                if (revenueCard) {
                    revenueCard.textContent = revenue.toLocaleString('vi-VN') + ' VNƒê';
                }
                if (profitCard) {
                    profitCard.textContent = profit.toLocaleString('vi-VN') + ' VNƒê';
                }

                // C·∫≠p nh·∫≠t th√¥ng tin t√≥m t·∫Øt
                const activityDesc = document.querySelector('.activity-desc');
                if (activityDesc) {
                    const profitMargin = revenue > 0 ? ((profit / revenue) * 100).toFixed(1) : 0;
                    activityDesc.textContent = `Doanh thu: ${revenue.toLocaleString('vi-VN')} VNƒê - ${orderCount} ƒë∆°n h√†ng - L·ª£i nhu·∫≠n: ${profitMargin}%`;
                }
            }

            // C·∫≠p nh·∫≠t danh s√°ch ƒë∆°n h√†ng hi·ªÉn th·ªã theo b·ªô l·ªçc
            updateOrdersList(filteredOrders) {
                // T√¨m container ch·ª©a danh s√°ch ƒë∆°n h√†ng
                const ordersContainer = document.querySelector('.orders-list, .order-list, .recent-orders, .order-table tbody');
                if (!ordersContainer) return;

                // T·∫°o HTML cho danh s√°ch ƒë∆°n h√†ng ƒë√£ l·ªçc
                let ordersHTML = '';
                
                if (filteredOrders.length === 0) {
                    ordersHTML = '<tr><td colspan="6" style="text-align: center; padding: 20px; color: #6b7280;">Kh√¥ng c√≥ ƒë∆°n h√†ng n√†o trong kho·∫£ng th·ªùi gian n√†y</td></tr>';
                } else {
                    ordersHTML = filteredOrders.slice(0, 10).map(order => {
                        const customer = this.demoData.customers.find(c => c.id === order.customerId);
                        const customerName = customer ? customer.name : 'N/A';
                        const statusClass = order.status === 'Ho√†n th√†nh' ? 'success' : (order.status === 'ƒêang x·ª≠ l√Ω' ? 'warning' : 'info');
                        const paymentClass = order.paymentStatus === 'ƒê√£ thanh to√°n' ? 'success' : 'warning';
                        
                        return `
                            <tr>
                                <td>#${order.id}</td>
                                <td>${customerName}</td>
                                <td>${order.date}</td>
                                <td>${order.total.toLocaleString('vi-VN')} VNƒê</td>
                                <td><span class="status ${statusClass}">${order.status}</span></td>
                                <td><span class="status ${paymentClass}">${order.paymentStatus}</span></td>
                            </tr>
                        `;
                    }).join('');
                }

                // C·∫≠p nh·∫≠t n·ªôi dung
                if (ordersContainer.tagName === 'TBODY') {
                    ordersContainer.innerHTML = ordersHTML;
                } else {
                    ordersContainer.innerHTML = `<table class="order-table"><tbody>${ordersHTML}</tbody></table>`;
                }
            }



            // Hi·ªÉn th·ªã popup export b√°o c√°o doanh thu v·ªõi b·ªô l·ªçc
            showSalesExportWithFilter() {
                const exportHTML = `
                    <div style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); z-index: 1001; display: flex; justify-content: center; align-items: center;" onclick="closeModal(this)">
                        <div style="background: white; padding: 25px; border-radius: 12px; width: 500px; max-height: 80vh; overflow-y: auto;" onclick="event.stopPropagation()">
                            <div style="text-align: center; margin-bottom: 20px;">
                                <h3 style="margin: 0; font-size: 20px; color: #1f2937;">Xu·∫•t b√°o c√°o doanh thu</h3>
                                <p style="margin: 10px 0; color: #6b7280;">B·∫°n mu·ªën xem d·ªØ li·ªáu hay t·∫£i v·ªÅ file?</p>
                            </div>

                            <!-- B·ªô l·ªçc th·ªùi gian -->
                            <div style="background: #f8fafc; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                                <h4 style="margin: 0 0 15px 0; color: #374151; font-size: 14px;">üìÖ Ch·ªçn kho·∫£ng th·ªùi gian:</h4>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 10px;">
                                    <div>
                                        <label style="display: block; margin-bottom: 5px; font-size: 12px; color: #6b7280;">T·ª´ ng√†y:</label>
                                        <input type="date" id="exportSalesFromDate" style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px;">
                                    </div>
                                    <div>
                                        <label style="display: block; margin-bottom: 5px; font-size: 12px; color: #6b7280;">ƒê·∫øn ng√†y:</label>
                                        <input type="date" id="exportSalesToDate" style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px;">
                                    </div>
                                </div>
                                <div style="font-size: 12px; color: #6b7280; font-style: italic;">
                                    * B√°o c√°o s·∫Ω d·ª±a tr√™n kho·∫£ng th·ªùi gian ƒë√£ ch·ªçn
                                </div>
                            </div>

                            <!-- N√∫t h√†nh ƒë·ªông -->
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                                <button onclick="app.processSalesExport('view')" 
                                        style="background: #3b82f6; color: white; border: none; padding: 12px; border-radius: 8px; cursor: pointer; font-size: 16px; display: flex; align-items: center; justify-content: center; gap: 8px;">
                                    üëÅÔ∏è Xem d·ªØ li·ªáu
                                </button>
                                <button onclick="app.processSalesExport('download')" 
                                        style="background: #059669; color: white; border: none; padding: 12px; border-radius: 8px; cursor: pointer; font-size: 16px; display: flex; align-items: center; justify-content: center; gap: 8px;">
                                    üì• T·∫£i v·ªÅ
                                </button>
                            </div>

                        </div>
                    </div>
                `;
                
                document.body.insertAdjacentHTML('beforeend', exportHTML);

                // Set ng√†y m·∫∑c ƒë·ªãnh (th√°ng n√†y)
                const today = this.getVietnamTime();
                const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
                document.getElementById('exportSalesFromDate').value = firstDay.toISOString().split('T')[0];
                document.getElementById('exportSalesToDate').value = today.toISOString().split('T')[0];
            }

            // X·ª≠ l√Ω export b√°o c√°o doanh thu
            processSalesExport(mode) {
                const fromDate = document.getElementById('exportSalesFromDate').value;
                const toDate = document.getElementById('exportSalesToDate').value;

                if (!fromDate || !toDate) {
                    this.showNotification('Vui l√≤ng ch·ªçn kho·∫£ng th·ªùi gian', 'error');
                    return;
                }

                if (new Date(fromDate) > new Date(toDate)) {
                    this.showNotification('Ng√†y b·∫Øt ƒë·∫ßu kh√¥ng ƒë∆∞·ª£c l·ªõn h∆°n ng√†y k·∫øt th√∫c', 'error');
                    return;
                }

                // L·ªçc d·ªØ li·ªáu ƒë∆°n h√†ng theo th·ªùi gian
                const startDate = new Date(fromDate);
                const endDate = new Date(toDate);
                endDate.setHours(23, 59, 59, 999);

                const filteredOrders = this.demoData.orders.filter(order => {
                    const orderDate = new Date(order.date);
                    return orderDate >= startDate && orderDate <= endDate;
                });

                // S·∫Øp x·∫øp v√† t·∫°o d·ªØ li·ªáu b√°o c√°o
                const sortedFilteredOrders = this.sortOrdersByDate(filteredOrders);
                const salesData = sortedFilteredOrders.map(order => {
                    const customer = this.demoData.customers.find(c => c.id === order.customerId);
                    // S·ª≠ d·ª•ng order.products thay v√¨ order.items
                    const itemCount = order.products ? order.products.length : 0;
                    return {
                        id: order.id,
                        customer: customer ? customer.name : 'N/A',
                        date: order.date,
                        items: itemCount,
                        total: order.total,
                        paymentStatus: order.paymentStatus,
                        status: order.status
                    };
                });

                // ƒê√≥ng popup export
                const exportModal = document.querySelector('div[style*="position: fixed"]');
                if (exportModal) {
                    exportModal.remove();
                }

                if (salesData.length === 0) {
                    this.showNotification('Kh√¥ng c√≥ ƒë∆°n h√†ng n√†o trong kho·∫£ng th·ªùi gian n√†y', 'info');
                    return;
                }

                if (mode === 'view') {
                    // Hi·ªÉn th·ªã d·ªØ li·ªáu
                    const columns = [
                        { header: 'M√£ ƒë∆°n', getValue: sale => sale.id },
                        { header: 'Kh√°ch h√†ng', getValue: sale => sale.customer },
                        { header: 'Ng√†y', getValue: sale => sale.date },
                        { header: 'S·ªë s·∫£n ph·∫©m', getValue: sale => sale.items },
                        { header: 'T·ªïng ti·ªÅn (VNƒê)', getValue: sale => sale.total.toLocaleString('vi-VN') },
                        { header: 'Thanh to√°n', getValue: sale => sale.paymentStatus },
                        { header: 'Tr·∫°ng th√°i', getValue: sale => sale.status }
                    ];
                    
                    const title = `B√°o c√°o doanh thu (${this.formatDateForDisplay(fromDate)} - ${this.formatDateForDisplay(toDate)})`;
                    this.showDataViewer(title, salesData, columns);

                } else if (mode === 'download') {
                    // T·∫£i xu·ªëng CSV
                    const csvContent = "data:text/csv;charset=utf-8,\uFEFF" + 
                        `B√°o c√°o Doanh thu (${this.formatDateForDisplay(fromDate)} - ${this.formatDateForDisplay(toDate)})\n` +
                        "M√£ ƒë∆°n,Kh√°ch h√†ng,Ng√†y,S·ªë s·∫£n ph·∫©m,T·ªïng ti·ªÅn,Thanh to√°n,Tr·∫°ng th√°i\n" +
                        salesData.map(s => 
                            `${s.id},"${s.customer}","${s.date}",${s.items},${s.total},"${s.paymentStatus}","${s.status}"`
                        ).join('\n');
                    
                    const encodedUri = encodeURI(csvContent);
                    const link = document.createElement("a");
                    link.setAttribute("href", encodedUri);
                    link.setAttribute("download", `doanh_thu_${fromDate}_${toDate}.csv`);
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    
                    this.showNotification(`ƒê√£ t·∫£i xu·ªëng b√°o c√°o doanh thu (${salesData.length} ƒë∆°n h√†ng)`, 'success');
                }
            }

            // Hi·ªÉn th·ªã popup export b√°o c√°o Top s·∫£n ph·∫©m v·ªõi b·ªô l·ªçc
            showTopProductsExportWithFilter() {
                const exportHTML = `
                    <div style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); z-index: 1001; display: flex; justify-content: center; align-items: center;" onclick="closeModal(this)">
                        <div style="background: white; padding: 25px; border-radius: 12px; width: 500px; max-height: 80vh; overflow-y: auto;" onclick="event.stopPropagation()">
                            <div style="text-align: center; margin-bottom: 20px;">
                                <h3 style="margin: 0; font-size: 20px; color: #1f2937;">Xu·∫•t top s·∫£n ph·∫©m b√°n ch·∫°y</h3>
                                <p style="margin: 10px 0; color: #6b7280;">B·∫°n mu·ªën xem d·ªØ li·ªáu hay t·∫£i v·ªÅ file?</p>
                            </div>

                            <!-- B·ªô l·ªçc th·ªùi gian -->
                            <div style="background: #f8fafc; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                                <h4 style="margin: 0 0 15px 0; color: #374151; font-size: 14px;">üìÖ Ch·ªçn kho·∫£ng th·ªùi gian:</h4>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 10px;">
                                    <div>
                                        <label style="display: block; margin-bottom: 5px; font-size: 12px; color: #6b7280;">T·ª´ ng√†y:</label>
                                        <input type="date" id="exportProductsFromDate" style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px;">
                                    </div>
                                    <div>
                                        <label style="display: block; margin-bottom: 5px; font-size: 12px; color: #6b7280;">ƒê·∫øn ng√†y:</label>
                                        <input type="date" id="exportProductsToDate" style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px;">
                                    </div>
                                </div>
                                <div style="font-size: 12px; color: #6b7280; font-style: italic;">
                                    * Th·ªëng k√™ top 10 s·∫£n ph·∫©m b√°n ch·∫°y nh·∫•t
                                </div>
                            </div>

                            <!-- N√∫t h√†nh ƒë·ªông -->
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                                <button onclick="app.processProductsExport('view')" 
                                        style="background: #3b82f6; color: white; border: none; padding: 12px; border-radius: 8px; cursor: pointer; font-size: 16px; display: flex; align-items: center; justify-content: center; gap: 8px;">
                                    üëÅÔ∏è Xem d·ªØ li·ªáu
                                </button>
                                <button onclick="app.processProductsExport('download')" 
                                        style="background: #059669; color: white; border: none; padding: 12px; border-radius: 8px; cursor: pointer; font-size: 16px; display: flex; align-items: center; justify-content: center; gap: 8px;">
                                    üì• T·∫£i v·ªÅ
                                </button>
                            </div>

                            <button onclick="closeModal(this.closest('div[style*=\"position: fixed\"]'))" 
                                    style="width: 100%; background: #6b7280; color: white; border: none; padding: 10px; border-radius: 8px; cursor: pointer;">
                        </div>
                    </div>
                `;
                
                document.body.insertAdjacentHTML('beforeend', exportHTML);

                // Set ng√†y m·∫∑c ƒë·ªãnh (th√°ng n√†y)
                const today = this.getVietnamTime();
                const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
                document.getElementById('exportProductsFromDate').value = firstDay.toISOString().split('T')[0];
                document.getElementById('exportProductsToDate').value = today.toISOString().split('T')[0];
            }

            // X·ª≠ l√Ω export b√°o c√°o Top s·∫£n ph·∫©m
            processProductsExport(mode) {
                const fromDate = document.getElementById('exportProductsFromDate').value;
                const toDate = document.getElementById('exportProductsToDate').value;

                if (!fromDate || !toDate) {
                    this.showNotification('Vui l√≤ng ch·ªçn kho·∫£ng th·ªùi gian', 'error');
                    return;
                }

                if (new Date(fromDate) > new Date(toDate)) {
                    this.showNotification('Ng√†y b·∫Øt ƒë·∫ßu kh√¥ng ƒë∆∞·ª£c l·ªõn h∆°n ng√†y k·∫øt th√∫c', 'error');
                    return;
                }

                // L·ªçc d·ªØ li·ªáu ƒë∆°n h√†ng theo th·ªùi gian
                const startDate = new Date(fromDate);
                const endDate = new Date(toDate);
                endDate.setHours(23, 59, 59, 999);

                const filteredOrders = this.demoData.orders.filter(order => {
                    const orderDate = new Date(order.date);
                    return orderDate >= startDate && orderDate <= endDate;
                });

                // S·∫Øp x·∫øp ƒë∆°n h√†ng tr∆∞·ªõc khi t√≠nh to√°n
                const sortedFilteredOrders = this.sortOrdersByDate(filteredOrders);
                
                // T√≠nh to√°n top s·∫£n ph·∫©m
                const productSales = {};
                sortedFilteredOrders.forEach(order => {
                    // S·ª≠ d·ª•ng order.products 
                    const orderItems = order.products || [];
                    
                    if (Array.isArray(orderItems)) {
                        orderItems.forEach(item => {
                            const productId = item.id;
                            if (!productSales[productId]) {
                                const product = this.demoData.products.find(p => p.id === productId);
                                productSales[productId] = {
                                    id: productId,
                                    name: item.name || (product ? product.name : 'N/A'),
                                    price: item.price,
                                    sold: 0,
                                    revenue: 0,
                                    stock: product ? product.stock : 0
                                };
                            }
                            const quantity = item.quantity || 1;
                            const price = item.price || 0;
                            productSales[productId].sold += quantity;
                            productSales[productId].revenue += quantity * price;
                        });
                    }
                });

                const topProducts = Object.values(productSales)
                    .sort((a, b) => b.sold - a.sold)
                    .slice(0, 10);

                // ƒê√≥ng popup export
                const exportModal = document.querySelector('div[style*="position: fixed"]');
                if (exportModal) {
                    exportModal.remove();
                }

                if (topProducts.length === 0) {
                    this.showNotification('Kh√¥ng c√≥ s·∫£n ph·∫©m n√†o ƒë∆∞·ª£c b√°n trong kho·∫£ng th·ªùi gian n√†y', 'info');
                    return;
                }

                if (mode === 'view') {
                    // Hi·ªÉn th·ªã d·ªØ li·ªáu
                    const columns = [
                        { header: 'X·∫øp h·∫°ng', getValue: (product, index) => index + 1 },
                        { header: 'M√£ SP', getValue: product => product.id },
                        { header: 'T√™n s·∫£n ph·∫©m', getValue: product => product.name },
                        { header: 'ƒê√£ b√°n', getValue: product => product.sold },
                        { header: 'T·ªìn kho', getValue: product => product.stock },
                        { header: 'Doanh thu (VNƒê)', getValue: product => product.revenue.toLocaleString('vi-VN') }
                    ];
                    
                    const title = `Top s·∫£n ph·∫©m b√°n ch·∫°y (${this.formatDateForDisplay(fromDate)} - ${this.formatDateForDisplay(toDate)})`;
                    this.showDataViewer(title, topProducts, columns);

                } else if (mode === 'download') {
                    // T·∫£i xu·ªëng CSV
                    const csvContent = "data:text/csv;charset=utf-8,\uFEFF" + 
                        `Top s·∫£n ph·∫©m b√°n ch·∫°y (${this.formatDateForDisplay(fromDate)} - ${this.formatDateForDisplay(toDate)})\n` +
                        "X·∫øp h·∫°ng,M√£ SP,T√™n s·∫£n ph·∫©m,ƒê√£ b√°n,T·ªìn kho,Doanh thu\n" +
                        topProducts.map((p, index) => 
                            `${index + 1},${p.id},"${p.name}",${p.sold},${p.stock},${p.revenue}`
                        ).join('\n');
                    
                    const encodedUri = encodeURI(csvContent);
                    const link = document.createElement("a");
                    link.setAttribute("href", encodedUri);
                    link.setAttribute("download", `top_sanpham_${fromDate}_${toDate}.csv`);
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    
                    this.showNotification(`ƒê√£ t·∫£i xu·ªëng b√°o c√°o top s·∫£n ph·∫©m (${topProducts.length} s·∫£n ph·∫©m)`, 'success');
                }
            }

            // Hi·ªÉn th·ªã popup export b√°o c√°o t√†i ch√≠nh v·ªõi b·ªô l·ªçc
            showFinancialExportWithFilter() {
                const exportHTML = `
                    <div style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); z-index: 1001; display: flex; justify-content: center; align-items: center;" onclick="closeModal(this)">
                        <div style="background: white; padding: 25px; border-radius: 12px; width: 500px; max-height: 80vh; overflow-y: auto;" onclick="event.stopPropagation()">
                            <div style="text-align: center; margin-bottom: 20px;">
                                <h3 style="margin: 0; font-size: 20px; color: #1f2937;">Xu·∫•t b√°o c√°o t√†i ch√≠nh</h3>
                                <p style="margin: 10px 0; color: #6b7280;">B·∫°n mu·ªën xem d·ªØ li·ªáu hay t·∫£i v·ªÅ file?</p>
                            </div>

                            <!-- B·ªô l·ªçc th·ªùi gian -->
                            <div style="background: #f8fafc; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                                <h4 style="margin: 0 0 15px 0; color: #374151; font-size: 14px;">üìÖ Ch·ªçn kho·∫£ng th·ªùi gian:</h4>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 10px;">
                                    <div>
                                        <label style="display: block; margin-bottom: 5px; font-size: 12px; color: #6b7280;">T·ª´ ng√†y:</label>
                                        <input type="date" id="exportFinancialFromDate" style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px;">
                                    </div>
                                    <div>
                                        <label style="display: block; margin-bottom: 5px; font-size: 12px; color: #6b7280;">ƒê·∫øn ng√†y:</label>
                                        <input type="date" id="exportFinancialToDate" style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px;">
                                    </div>
                                </div>
                                <div style="font-size: 12px; color: #6b7280; font-style: italic;">
                                    * B√°o c√°o t·ªïng quan t√¨nh h√¨nh t√†i ch√≠nh doanh nghi·ªáp
                                </div>
                            </div>

                            <!-- N√∫t h√†nh ƒë·ªông -->
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                                <button onclick="app.processFinancialExport('view')" 
                                        style="background: #3b82f6; color: white; border: none; padding: 12px; border-radius: 8px; cursor: pointer; font-size: 16px; display: flex; align-items: center; justify-content: center; gap: 8px;">
                                    üëÅÔ∏è Xem d·ªØ li·ªáu
                                </button>
                                <button onclick="app.processFinancialExport('download')" 
                                        style="background: #059669; color: white; border: none; padding: 12px; border-radius: 8px; cursor: pointer; font-size: 16px; display: flex; align-items: center; justify-content: center; gap: 8px;">
                                    üì• T·∫£i v·ªÅ
                                </button>
                            </div>

                            <button onclick="closeModal(this.closest('div[style*=\"position: fixed\"]'))" 
                                    style="width: 100%; background: #6b7280; color: white; border: none; padding: 10px; border-radius: 8px; cursor: pointer;">
                        </div>
                    </div>
                `;
                
                document.body.insertAdjacentHTML('beforeend', exportHTML);

                // Set ng√†y m·∫∑c ƒë·ªãnh (th√°ng n√†y)
                const today = this.getVietnamTime();
                const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
                document.getElementById('exportFinancialFromDate').value = firstDay.toISOString().split('T')[0];
                document.getElementById('exportFinancialToDate').value = today.toISOString().split('T')[0];
            }

            // X·ª≠ l√Ω export b√°o c√°o t√†i ch√≠nh
            processFinancialExport(mode) {
                const fromDate = document.getElementById('exportFinancialFromDate').value;
                const toDate = document.getElementById('exportFinancialToDate').value;

                if (!fromDate || !toDate) {
                    this.showNotification('Vui l√≤ng ch·ªçn kho·∫£ng th·ªùi gian', 'error');
                    return;
                }

                if (new Date(fromDate) > new Date(toDate)) {
                    this.showNotification('Ng√†y b·∫Øt ƒë·∫ßu kh√¥ng ƒë∆∞·ª£c l·ªõn h∆°n ng√†y k·∫øt th√∫c', 'error');
                    return;
                }

                // L·ªçc d·ªØ li·ªáu ƒë∆°n h√†ng theo th·ªùi gian
                const startDate = new Date(fromDate);
                const endDate = new Date(toDate);
                endDate.setHours(23, 59, 59, 999);

                const filteredOrders = this.demoData.orders.filter(order => {
                    const orderDate = new Date(order.date);
                    return orderDate >= startDate && orderDate <= endDate;
                });

                // T√≠nh to√°n c√°c ch·ªâ s·ªë t√†i ch√≠nh
                const totalRevenue = filteredOrders.filter(order => order.paymentStatus === 'ƒê√£ thanh to√°n').reduce((sum, order) => sum + order.total, 0);
                const totalDebt = this.demoData.customers.reduce((sum, customer) => sum + customer.debt, 0);
                const totalInventoryValue = this.demoData.products.reduce((sum, p) => sum + (p.price * p.stock), 0);

                const financialData = [
                    { category: 'B√ÅO C√ÅO T√ÄI CH√çNH T·ªîNG QUAN', value: '' },
                    { category: 'Kho·∫£ng th·ªùi gian', value: `${this.formatDateForDisplay(fromDate)} - ${this.formatDateForDisplay(toDate)}` },
                    { category: 'Ng√†y b√°o c√°o', value: this.getVietnamTime().toLocaleDateString('vi-VN') },
                    { category: '', value: '' },
                    { category: 'DOANH THU V√Ä B√ÅN H√ÄNG', value: '' },
                    { category: 'T·ªïng doanh thu', value: totalRevenue.toLocaleString('vi-VN') + ' VNƒê' },
                    { category: 'S·ªë ƒë∆°n h√†ng', value: filteredOrders.length.toString() },
                    { category: 'ƒê∆°n ho√†n th√†nh', value: filteredOrders.filter(o => o.status === 'Ho√†n th√†nh').length.toString() },
                    { category: 'ƒê∆°n ƒë√£ thanh to√°n', value: filteredOrders.filter(o => o.paymentStatus === 'ƒê√£ thanh to√°n').length.toString() },
                    { category: '', value: '' },
                    { category: 'KH√ÅCH H√ÄNG V√Ä C√îNG N·ª¢', value: '' },
                    { category: 'T·ªïng kh√°ch h√†ng', value: this.demoData.customers.length.toString() },
                    { category: 'Kh√°ch h√†ng c√≥ n·ª£', value: this.demoData.customers.filter(c => c.debt > 0).length.toString() },
                    { category: 'T·ªïng c√¥ng n·ª£', value: totalDebt.toLocaleString('vi-VN') + ' VNƒê' },
                    { category: '', value: '' },
                    { category: 'T√ÄI S·∫¢N V√Ä H√ÄNG T·ªíN KHO', value: '' },
                    { category: 'S·ªë m·∫∑t h√†ng', value: this.demoData.products.length.toString() },
                    { category: 'Gi√° tr·ªã t·ªìn kho', value: totalInventoryValue.toLocaleString('vi-VN') + ' VNƒê' },
                    { category: 'H√†ng s·∫Øp h·∫øt', value: this.demoData.products.filter(p => p.stock < 10).length.toString() },
                    { category: '', value: '' },
                    { category: 'NH√Ä CUNG C·∫§P', value: '' },
                    { category: 'T·ªïng nh√† cung c·∫•p', value: this.demoData.suppliers.length.toString() }
                ];

                // ƒê√≥ng popup export
                const exportModal = document.querySelector('div[style*="position: fixed"]');
                if (exportModal) {
                    exportModal.remove();
                }

                if (mode === 'view') {
                    // Hi·ªÉn th·ªã d·ªØ li·ªáu
                    const columns = [
                        { header: 'Danh m·ª•c', getValue: item => item.category },
                        { header: 'Gi√° tr·ªã', getValue: item => item.value }
                    ];
                    
                    const title = `B√°o c√°o t√†i ch√≠nh (${this.formatDateForDisplay(fromDate)} - ${this.formatDateForDisplay(toDate)})`;
                    this.showDataViewer(title, financialData, columns);

                } else if (mode === 'download') {
                    // T·∫£i xu·ªëng CSV
                    const csvContent = "data:text/csv;charset=utf-8,\uFEFF" + 
                        financialData.map(row => `"${row.category}","${row.value}"`).join('\n');
                    
                    const encodedUri = encodeURI(csvContent);
                    const link = document.createElement("a");
                    link.setAttribute("href", encodedUri);
                    link.setAttribute("download", `baocao_taichinh_${fromDate}_${toDate}.csv`);
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    
                    this.showNotification('ƒê√£ t·∫£i xu·ªëng b√°o c√°o t√†i ch√≠nh t·ªïng h·ª£p', 'success');
                }
            }

            // Hi·ªÉn th·ªã popup export b√°o c√°o t·ªìn kho v·ªõi b·ªô l·ªçc
            showInventoryExportWithFilter() {
                const exportHTML = `
                    <div style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); z-index: 1001; display: flex; justify-content: center; align-items: center;" onclick="closeModal(this)">
                        <div style="background: white; padding: 25px; border-radius: 12px; width: 500px; max-height: 80vh; overflow-y: auto;" onclick="event.stopPropagation()">
                            <div style="text-align: center; margin-bottom: 20px;">
                                <h3 style="margin: 0; font-size: 20px; color: #1f2937;">Xu·∫•t b√°o c√°o t·ªìn kho</h3>
                                <p style="margin: 10px 0; color: #6b7280;">B·∫°n mu·ªën xem d·ªØ li·ªáu hay t·∫£i v·ªÅ file?</p>
                            </div>

                            <!-- T√πy ch·ªçn b·ªô l·ªçc -->
                            <div style="background: #f8fafc; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                                <h4 style="margin: 0 0 15px 0; color: #374151; font-size: 14px;">üì¶ T√πy ch·ªçn l·ªçc:</h4>
                                <div style="margin-bottom: 15px;">
                                    <label style="display: block; margin-bottom: 8px; font-size: 13px; color: #6b7280;">L·ªçc theo t√¨nh tr·∫°ng:</label>
                                    <select id="inventoryFilter" style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px;">
                                        <option value="all">T·∫•t c·∫£ s·∫£n ph·∫©m</option>
                                        <option value="lowStock">S·∫£n ph·∫©m s·∫Øp h·∫øt (< 10)</option>
                                        <option value="outOfStock">S·∫£n ph·∫©m h·∫øt h√†ng (= 0)</option>
                                        <option value="highStock">S·∫£n ph·∫©m nhi·ªÅu h√†ng (‚â• 50)</option>
                                    </select>
                                </div>
                                <div style="margin-bottom: 10px;">
                                    <label style="display: block; margin-bottom: 8px; font-size: 13px; color: #6b7280;">L·ªçc theo danh m·ª•c:</label>
                                    <select id="categoryFilter" style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px;">
                                        <option value="all">T·∫•t c·∫£ danh m·ª•c</option>
                                    </select>
                                </div>
                                <div style="font-size: 12px; color: #6b7280; font-style: italic;">
                                    * B√°o c√°o t√¨nh tr·∫°ng t·ªìn kho hi·ªán t·∫°i
                                </div>
                            </div>

                            <!-- N√∫t h√†nh ƒë·ªông -->
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                                <button onclick="app.processInventoryExport('view')" 
                                        style="background: #3b82f6; color: white; border: none; padding: 12px; border-radius: 8px; cursor: pointer; font-size: 16px; display: flex; align-items: center; justify-content: center; gap: 8px;">
                                    üëÅÔ∏è Xem d·ªØ li·ªáu
                                </button>
                                <button onclick="app.processInventoryExport('download')" 
                                        style="background: #059669; color: white; border: none; padding: 12px; border-radius: 8px; cursor: pointer; font-size: 16px; display: flex; align-items: center; justify-content: center; gap: 8px;">
                                    üì• T·∫£i v·ªÅ
                                </button>
                            </div>

                            <button onclick="closeModal(this.closest('div[style*=\"position: fixed\"]'))" 
                                    style="width: 100%; background: #6b7280; color: white; border: none; padding: 10px; border-radius: 8px; cursor: pointer;">
                        </div>
                    </div>
                `;
                
                document.body.insertAdjacentHTML('beforeend', exportHTML);

                // T·∫£i danh m·ª•c v√†o select
                const categorySelect = document.getElementById('categoryFilter');
                const categories = [...new Set(this.demoData.products.map(p => p.category))];
                categories.forEach(category => {
                    if (category) {
                        const option = document.createElement('option');
                        option.value = category;
                        option.textContent = category;
                        categorySelect.appendChild(option);
                    }
                });
            }

            // X·ª≠ l√Ω export b√°o c√°o t·ªìn kho
            processInventoryExport(mode) {
                const inventoryFilter = document.getElementById('inventoryFilter').value;
                const categoryFilter = document.getElementById('categoryFilter').value;

                // L·ªçc s·∫£n ph·∫©m theo ƒëi·ªÅu ki·ªán
                let filteredProducts = this.demoData.products;

                // L·ªçc theo t√¨nh tr·∫°ng t·ªìn kho
                if (inventoryFilter === 'lowStock') {
                    filteredProducts = filteredProducts.filter(p => p.stock > 0 && p.stock < 10);
                } else if (inventoryFilter === 'outOfStock') {
                    filteredProducts = filteredProducts.filter(p => p.stock === 0);
                } else if (inventoryFilter === 'highStock') {
                    filteredProducts = filteredProducts.filter(p => p.stock >= 50);
                }

                // L·ªçc theo danh m·ª•c
                if (categoryFilter !== 'all') {
                    filteredProducts = filteredProducts.filter(p => p.category === categoryFilter);
                }

                // ƒê√≥ng popup export
                const exportModal = document.querySelector('div[style*="position: fixed"]');
                if (exportModal) {
                    exportModal.remove();
                }

                if (mode === 'view') {
                    // Hi·ªÉn th·ªã d·ªØ li·ªáu
                    const columns = [
                        { header: 'M√£ SP', getValue: product => product.id },
                        { header: 'T√™n s·∫£n ph·∫©m', getValue: product => product.name },
                        { header: 'Danh m·ª•c', getValue: product => product.category },
                        { header: 'Gi√° b√°n (VNƒê)', getValue: product => product.price.toLocaleString('vi-VN') },
                        { header: 'T·ªìn kho', getValue: product => product.stock },
                        { header: 'Gi√° tr·ªã (VNƒê)', getValue: product => (product.price * product.stock).toLocaleString('vi-VN') },
                        { header: 'Nh√† cung c·∫•p', getValue: product => product.supplier || 'N/A' }
                    ];
                    
                    const filterDesc = this.getInventoryFilterDescription(inventoryFilter, categoryFilter);
                    const title = `B√°o c√°o t·ªìn kho - ${filterDesc}`;
                    this.showDataViewer(title, filteredProducts, columns);

                } else if (mode === 'download') {
                    // T·∫£i xu·ªëng CSV
                    const filterDesc = this.getInventoryFilterDescription(inventoryFilter, categoryFilter);
                    const csvContent = "data:text/csv;charset=utf-8,\uFEFF" + 
                        `B√°o c√°o T·ªìn kho - ${filterDesc}\n` +
                        "M√£ SP,T√™n s·∫£n ph·∫©m,Danh m·ª•c,Gi√° b√°n,T·ªìn kho,Gi√° tr·ªã,Nh√† cung c·∫•p\n" +
                        filteredProducts.map(p => 
                            `${p.id},"${p.name}","${p.category}",${p.price},${p.stock},${p.price * p.stock},"${p.supplier || ''}"`
                        ).join('\n');
                    
                    const encodedUri = encodeURI(csvContent);
                    const link = document.createElement("a");
                    link.setAttribute("href", encodedUri);
                    const filename = `ton_kho_${inventoryFilter}_${this.getVietnamTime().toISOString().split('T')[0]}.csv`;
                    link.setAttribute("download", filename);
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    
                    this.showNotification(`ƒê√£ t·∫£i xu·ªëng b√°o c√°o t·ªìn kho (${filteredProducts.length} s·∫£n ph·∫©m)`, 'success');
                }
            }

            // M√¥ t·∫£ b·ªô l·ªçc t·ªìn kho
            getInventoryFilterDescription(inventoryFilter, categoryFilter) {
                let desc = '';
                
                if (inventoryFilter === 'lowStock') desc = 'S·∫Øp h·∫øt h√†ng';
                else if (inventoryFilter === 'outOfStock') desc = 'H·∫øt h√†ng';  
                else if (inventoryFilter === 'highStock') desc = 'Nhi·ªÅu h√†ng';
                else desc = 'T·∫•t c·∫£';
                
                if (categoryFilter !== 'all') {
                    desc += ` - ${categoryFilter}`;
                }
                
                return desc;
            }

            // Hi·ªÉn th·ªã popup export b√°o c√°o c√¥ng n·ª£ v·ªõi b·ªô l·ªçc
            showDebtExportWithFilter() {
                const customersWithDebt = this.demoData.customers.filter(c => c.debt > 0);
                if (customersWithDebt.length === 0) {
                    this.showNotification('Kh√¥ng c√≥ kh√°ch h√†ng n√†o ƒëang n·ª£', 'info');
                    return;
                }

                const exportHTML = `
                    <div style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); z-index: 1001; display: flex; justify-content: center; align-items: center;" onclick="closeModal(this)">
                        <div style="background: white; padding: 25px; border-radius: 12px; width: 500px; max-height: 80vh; overflow-y: auto;" onclick="event.stopPropagation()">
                            <div style="text-align: center; margin-bottom: 20px;">
                                <h3 style="margin: 0; font-size: 20px; color: #1f2937;">Xu·∫•t b√°o c√°o c√¥ng n·ª£</h3>
                                <p style="margin: 10px 0; color: #6b7280;">B·∫°n mu·ªën xem d·ªØ li·ªáu hay t·∫£i v·ªÅ file?</p>
                            </div>

                            <!-- T√πy ch·ªçn b·ªô l·ªçc -->
                            <div style="background: #f8fafc; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                                <h4 style="margin: 0 0 15px 0; color: #374151; font-size: 14px;">üí∞ T√πy ch·ªçn l·ªçc:</h4>
                                <div style="margin-bottom: 15px;">
                                    <label style="display: block; margin-bottom: 8px; font-size: 13px; color: #6b7280;">L·ªçc theo m·ª©c n·ª£:</label>
                                    <select id="debtFilter" style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px;">
                                        <option value="all">T·∫•t c·∫£ kh√°ch h√†ng c√≥ n·ª£</option>
                                        <option value="low">N·ª£ th·∫•p (< 1 tri·ªáu)</option>
                                        <option value="medium">N·ª£ trung b√¨nh (1-10 tri·ªáu)</option>
                                        <option value="high">N·ª£ cao (> 10 tri·ªáu)</option>
                                    </select>
                                </div>
                                <div style="margin-bottom: 15px;">
                                    <label style="display: block; margin-bottom: 8px; font-size: 13px; color: #6b7280;">L·ªçc theo lo·∫°i kh√°ch h√†ng:</label>
                                    <select id="customerTypeFilter" style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px;">
                                        <option value="all">T·∫•t c·∫£ lo·∫°i</option>
                                        <option value="ca-nhan">C√° nh√¢n</option>
                                        <option value="doanh-nghiep">Doanh nghi·ªáp</option>
                                    </select>
                                </div>
                                <div style="font-size: 12px; color: #6b7280; font-style: italic;">
                                    * B√°o c√°o t√¨nh tr·∫°ng c√¥ng n·ª£ kh√°ch h√†ng hi·ªán t·∫°i
                                </div>
                            </div>

                            <!-- Th√¥ng tin t·ªïng quan -->
                            <div style="background: #fef2f2; border: 1px solid #fecaca; padding: 12px; border-radius: 6px; margin-bottom: 20px;">
                                <div style="font-size: 13px; color: #991b1b; display: flex; justify-content: space-between;">
                                    <span>T·ªïng s·ªë KH c√≥ n·ª£:</span>
                                    <strong>${customersWithDebt.length}</strong>
                                </div>
                                <div style="font-size: 13px; color: #991b1b; display: flex; justify-content: space-between;">
                                    <span>T·ªïng s·ªë n·ª£:</span>
                                    <strong>${customersWithDebt.reduce((sum, c) => sum + c.debt, 0).toLocaleString('vi-VN')} VNƒê</strong>
                                </div>
                            </div>

                            <!-- N√∫t h√†nh ƒë·ªông -->
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                                <button onclick="app.processDebtExport('view')" 
                                        style="background: #3b82f6; color: white; border: none; padding: 12px; border-radius: 8px; cursor: pointer; font-size: 16px; display: flex; align-items: center; justify-content: center; gap: 8px;">
                                    üëÅÔ∏è Xem d·ªØ li·ªáu
                                </button>
                                <button onclick="app.processDebtExport('download')" 
                                        style="background: #059669; color: white; border: none; padding: 12px; border-radius: 8px; cursor: pointer; font-size: 16px; display: flex; align-items: center; justify-content: center; gap: 8px;">
                                    üì• T·∫£i v·ªÅ
                                </button>
                            </div>

                            <button onclick="closeModal(this.closest('div[style*=\"position: fixed\"]'))" 
                                    style="width: 100%; background: #6b7280; color: white; border: none; padding: 10px; border-radius: 8px; cursor: pointer;">
                        </div>
                    </div>
                `;
                
                document.body.insertAdjacentHTML('beforeend', exportHTML);
            }

            // X·ª≠ l√Ω export b√°o c√°o c√¥ng n·ª£
            processDebtExport(mode) {
                const debtFilter = document.getElementById('debtFilter').value;
                const customerTypeFilter = document.getElementById('customerTypeFilter').value;

                // L·ªçc kh√°ch h√†ng c√≥ n·ª£
                let customersWithDebt = this.demoData.customers.filter(c => c.debt > 0);

                // L·ªçc theo m·ª©c n·ª£
                if (debtFilter === 'low') {
                    customersWithDebt = customersWithDebt.filter(c => c.debt < 1000000);
                } else if (debtFilter === 'medium') {
                    customersWithDebt = customersWithDebt.filter(c => c.debt >= 1000000 && c.debt <= 10000000);
                } else if (debtFilter === 'high') {
                    customersWithDebt = customersWithDebt.filter(c => c.debt > 10000000);
                }

                // L·ªçc theo lo·∫°i kh√°ch h√†ng
                if (customerTypeFilter !== 'all') {
                    customersWithDebt = customersWithDebt.filter(c => c.type === customerTypeFilter);
                }

                // ƒê√≥ng popup export
                const exportModal = document.querySelector('div[style*="position: fixed"]');
                if (exportModal) {
                    exportModal.remove();
                }

                if (customersWithDebt.length === 0) {
                    this.showNotification('Kh√¥ng c√≥ kh√°ch h√†ng n√†o ph√π h·ª£p v·ªõi ƒëi·ªÅu ki·ªán l·ªçc', 'info');
                    return;
                }

                if (mode === 'view') {
                    // Hi·ªÉn th·ªã d·ªØ li·ªáu
                    const columns = [
                        { header: 'M√£ KH', getValue: customer => customer.id },
                        { header: 'T√™n kh√°ch h√†ng', getValue: customer => customer.name },
                        { header: 'Lo·∫°i KH', getValue: customer => customer.type === 'doanh-nghiep' ? 'Doanh nghi·ªáp' : 'C√° nh√¢n' },
                        { header: 'ƒêi·ªán tho·∫°i', getValue: customer => customer.phone || 'N/A' },
                        { header: 'Email', getValue: customer => customer.email || 'N/A' },
                        { header: 'S·ªë n·ª£ (VNƒê)', getValue: customer => customer.debt.toLocaleString('vi-VN') },
                        { header: 'H√†nh ƒë·ªông', getValue: customer => `
                            <button onclick="app.showCustomerDebtDetail('${customer.id}')" style="
                                background: #059669; 
                                color: white; 
                                border: none; 
                                padding: 6px 12px; 
                                border-radius: 4px; 
                                cursor: pointer; 
                                font-size: 12px; 
                                font-weight: 600;
                            ">
                                Chi ti·∫øt
                            </button>
                        ` }
                    ];
                    
                    const filterDesc = this.getDebtFilterDescription(debtFilter, customerTypeFilter);
                    const title = `B√°o c√°o c√¥ng n·ª£ - ${filterDesc}`;
                    this.showDataViewer(title, customersWithDebt, columns);

                } else if (mode === 'download') {
                    // T·∫£i xu·ªëng CSV
                    const filterDesc = this.getDebtFilterDescription(debtFilter, customerTypeFilter);
                    const totalDebt = customersWithDebt.reduce((sum, c) => sum + c.debt, 0);
                    
                    const csvContent = "data:text/csv;charset=utf-8,\uFEFF" + 
                        `B√°o c√°o C√¥ng n·ª£ - ${filterDesc}\n` +
                        `T·ªïng s·ªë kh√°ch h√†ng: ${customersWithDebt.length}\n` +
                        `T·ªïng s·ªë n·ª£: ${totalDebt.toLocaleString('vi-VN')} VNƒê\n` +
                        `Ng√†y b√°o c√°o: ${this.getVietnamTime().toLocaleDateString('vi-VN')}\n\n` +
                        "M√£ KH,T√™n kh√°ch h√†ng,Lo·∫°i KH,ƒêi·ªán tho·∫°i,Email,S·ªë n·ª£\n" +
                        customersWithDebt.map(c => 
                            `${c.id},"${c.name}","${c.type === 'doanh-nghiep' ? 'Doanh nghi·ªáp' : 'C√° nh√¢n'}","${c.phone || ''}","${c.email || ''}",${c.debt}`
                        ).join('\n');
                    
                    const encodedUri = encodeURI(csvContent);
                    const link = document.createElement("a");
                    link.setAttribute("href", encodedUri);
                    const filename = `cong_no_${debtFilter}_${this.getVietnamTime().toISOString().split('T')[0]}.csv`;
                    link.setAttribute("download", filename);
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    
                    this.showNotification(`ƒê√£ t·∫£i xu·ªëng b√°o c√°o c√¥ng n·ª£ (${customersWithDebt.length} kh√°ch h√†ng)`, 'success');
                }
            }

            // M√¥ t·∫£ b·ªô l·ªçc c√¥ng n·ª£
            getDebtFilterDescription(debtFilter, customerTypeFilter) {
                let desc = '';
                
                if (debtFilter === 'low') desc = 'N·ª£ th·∫•p';
                else if (debtFilter === 'medium') desc = 'N·ª£ trung b√¨nh';
                else if (debtFilter === 'high') desc = 'N·ª£ cao';
                else desc = 'T·∫•t c·∫£ m·ª©c n·ª£';
                
                if (customerTypeFilter === 'ca-nhan') {
                    desc += ' - C√° nh√¢n';
                } else if (customerTypeFilter === 'doanh-nghiep') {
                    desc += ' - Doanh nghi·ªáp';
                }
                
                return desc;
            }
        }
        
        // Notification styles
        const notificationStyles = `
            .notification {
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 16px 20px;
                border-radius: 8px;
                color: white;
                font-weight: 600;
                z-index: 1000;
                transform: translateX(400px);
                transition: transform 0.3s ease;
                max-width: 300px;
                box-shadow: 0 8px 32px rgba(0,0,0,0.15);
            }
            
            .notification.show {
                transform: translateX(0);
            }
            
            .notification.success {
                background: var(--success-gradient);
            }
            
            .notification.error {
                background: var(--danger-gradient);
            }
            
            .notification.warning {
                background: var(--warning-gradient);
                color: var(--text-primary);
            }
            
            .notification.info {
                background: var(--header-gradient);
            }
        `;
        
        // Add notification styles to head
        const styleSheet = document.createElement('style');
        styleSheet.textContent = notificationStyles;
        document.head.appendChild(styleSheet);
        
        // Login functionality
        document.getElementById('loginForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const errorMessage = document.getElementById('errorMessage');
            
            console.log('üîê Login attempt:', { username, password });
            console.log('üîê Expected: Admin / Matkhau@123');
            
            // Check credentials
            if (username === 'Admin' && password === 'Matkhau@123') {
                // Hide login screen
                document.getElementById('loginScreen').style.display = 'none';
                // Show main app
                document.getElementById('appContainer').style.display = 'flex';
                
                // Initialize the application with a small delay to ensure DOM is ready
                setTimeout(() => {
                    app = new VietnamesePhuocIT();
                    window.app = app; // Make app globally accessible
                    // Force setup navigation again to ensure it works
                    setTimeout(() => {
                        if (app) {
                            app.setupNavigation();
                            console.log('Navigation re-setup completed');
                            console.log('App is now available globally as window.app');
                        }
                    }, 200);
                    showNotification('ƒêƒÉng nh·∫≠p th√†nh c√¥ng! Ch√†o m·ª´ng Admin', 'success');
                }, 100);
            } else {
                // Show error message
                errorMessage.style.display = 'block';
                setTimeout(() => {
                    errorMessage.style.display = 'none';
                }, 3000);
            }
        });
        
        // Logout functionality
        function logout() {
            if (confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën ƒëƒÉng xu·∫•t?')) {
                // Hide main app
                document.getElementById('appContainer').style.display = 'none';
                // Show login screen
                document.getElementById('loginScreen').style.display = 'flex';
                
                // Clear form
                document.getElementById('username').value = '';
                document.getElementById('password').value = '';
                
                showNotification('ƒê√£ ƒëƒÉng xu·∫•t th√†nh c√¥ng', 'info');
            }
        }
        
        // Initialize the application
        let app;
        
        // Global function to close modal (called from onclick)
        function closeModal(element) {
            if (element) {
                element.remove();
                return;
            }
            // Try to find and remove modal by common selectors
            const modals = document.querySelectorAll('div[style*="fixed"]');
            if (modals.length > 0) {
                modals[modals.length - 1].remove(); // Remove the last modal
            }
        }

        // Global function for notifications
        function showNotification(message, type = 'info') {
            if (app) {
                app.showNotification(message, type);
            }
        }

        // Mobile menu toggle function
        function toggleMobileMenu() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('mobileOverlay');
            
            if (sidebar && overlay) {
                const isOpen = sidebar.classList.contains('mobile-open');
                
                if (isOpen) {
                    // Close menu
                    sidebar.classList.remove('mobile-open');
                    overlay.classList.remove('active');
                } else {
                    // Open menu
                    sidebar.classList.add('mobile-open');
                    overlay.classList.add('active');
                }
            }
        }

        // Close mobile menu when clicking nav items
        document.addEventListener('DOMContentLoaded', function() {
            const navItems = document.querySelectorAll('.nav-item');
            navItems.forEach(item => {
                item.addEventListener('click', function() {
                    // Close mobile menu after navigation
                    const sidebar = document.getElementById('sidebar');
                    const overlay = document.getElementById('mobileOverlay');
                    if (sidebar && overlay) {
                        sidebar.classList.remove('mobile-open');
                        overlay.classList.remove('active');
                    }
                });
            });

            // Handle window resize
            window.addEventListener('resize', function() {
                const sidebar = document.getElementById('sidebar');
                const overlay = document.getElementById('mobileOverlay');
                
                // Close mobile menu on larger screens
                if (window.innerWidth > 768) {
                    if (sidebar && overlay) {
                        sidebar.classList.remove('mobile-open');
                        overlay.classList.remove('active');
                    }
                }
            });
        });
    </script>
</body>
</html>